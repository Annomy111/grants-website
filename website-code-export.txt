WEBSITE SOURCE CODE EXPORT - 2025-07-13T12:52:34.838Z
Project: Ukrainian Civil Society Grants Database
Export Type: Core Application Code Only
================================================================================

FILE STRUCTURE:
----------------------------------------

client/src/ (67 files)
  App.css
  App.js
  components/AccessibleModal.js
  components/BackToTop.js
  components/Breadcrumbs.js
  components/Footer.js
  components/GrantAnalytics.js
  components/GrantBookmark.js
  components/GrantComparisonModal.js
  components/GrantDeadlineIndicator.js
  components/GrantEditModal.js
  components/GrantInsights.js
  components/GrantsChatWidget.js
  components/Header.js
  components/LoadingSkeleton.js
  components/ProtectedRoute.js
  components/QuillEditor.js
  components/SEOHead.js
  components/StructuredData.js
  components/TrendingGrants.js
  components/VideoHero.js
  components/infographics/ProfessionalInfographics.js
  context/AuthContext.js
  context/LanguageContext.js
  context/ThemeContext.js
  hooks/useInfiniteScroll.js
  hooks/useQuillLoader.js
  i18n/i18n.js
  index.css
  index.js
  lib/supabase.js
  pages/AboutPage.js
  pages/AdminAnalytics.js
  pages/AdminBlog.js
  pages/AdminBlogEditor.js
  pages/AdminBlogEditorSimple.js
  pages/AdminDashboard.js
  pages/AdminGrants.js
  pages/AdminLoginPage.js
  pages/AdminOverview.js
  pages/AdminPage.js
  pages/AdminProfile.js
  pages/BlogPage.js
  pages/BlogPostPage.js
  pages/GrantDetail.js
  pages/GrantsPage.js
  pages/GrantsPageOptimized.js
  pages/HomePage.js
  pages/NotFoundPage.js
  reportWebVitals.js
  setupTests.js
  styles/mobile-optimizations.css
  styles/video-hero.css
  utils/adminApiHelper.js
  utils/analytics.js
  utils/cache.js
  utils/createFavicon.js
  utils/createLogo.js
  utils/createLogo512.js
  utils/crypto.js
  utils/debounce.js
  utils/debugEnv.js
  utils/generateSitemap.js
  utils/lazyLoad.js
  utils/quillUtils.js
  utils/sanitize.js
  utils/validate.js

client/netlify/functions/ (10 files)
  analytics.js
  auth-enhanced.js
  auth.js
  blog.js
  chat.js
  email-digest-template.js
  grants-debug.js
  grants.js
  middleware/auth.js
  middleware/rateLimiter.js

================================================================================

SOURCE CODE:
================================================================================

================================================================================
FILE: package.json
SIZE: 1582 bytes
================================================================================

{
  "name": "civil-society-grants",
  "version": "1.0.0",
  "description": "Civil Society Grants Database - Full Stack Application",
  "scripts": {
    "test": "cd client && npm test",
    "start": "cd client && netlify dev",
    "start:client": "cd client && npm start",
    "dev": "cd client && netlify dev",
    "build": "cd client && npm run build",
    "deploy": "cd client && netlify deploy --prod",
    "backup": "chmod +x scripts/backup-database.sh && ./scripts/backup-database.sh",
    "install:all": "npm install && cd client && npm install",
    "import:grants": "node scripts/import-grants.js",
    "update:static-grants": "node scripts/update-static-grants.js",
    "test:supabase": "node scripts/test-supabase-connection.js",
    "setup:admin-users": "node scripts/setup-admin-users.js",
    "cleanup": "./scripts/cleanup-project.sh",
    "verify:db": "node scripts/database-verification-agents.js",
    "branch:feature": "./scripts/create-feature-branch.sh",
    "branch:bugfix": "git checkout develop && git pull && git checkout -b bugfix/",
    "branch:hotfix": "git checkout main && git pull && git checkout -b hotfix/"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.49.10",
    "csv-parse": "^5.6.0",
    "csv-parser": "^3.2.0",
    "dotenv": "^16.5.0",
    "playwright-core": "^1.52.0",
    "serverless-http": "^3.2.0",
    "sqlite3": "^5.1.7"
  },
  "devDependencies": {
    "axios": "^1.9.0",
    "concurrently": "^9.1.2",
    "eslint": "^8.57.1",
    "eslint-config-react-app": "^7.0.1",
    "prettier": "^3.5.3",
    "puppeteer": "^24.12.1"
  }
}



================================================================================
FILE: CLAUDE.md
SIZE: 6757 bytes
================================================================================

# Hey Claude ðŸ‘‹ this CLAUDE.md file was created by the doctor command. It should help you quickly understand how this codebase is organized and works. This is a living document - feel free to add to it!

If this is your first time here, please run the following at the start and end of your session:

- `npm run doctor` to check system status and available commands
- `npm run commit` to stage and commit your changes

Remember: Never commit secrets or API keys. Keep them in .env files!

## Architectural Memories

- Make sure you know the structure of this project at all times: Supabase for DB and log in etc - Netlify for mainly frontend

## Common Commands

### Development

```bash
# Install all dependencies (root + client + server)
npm run install:all

# Start development environment (recommended)
cd client && netlify dev

# Alternative: Run client and server separately
cd client && npm start     # React app on :3000
cd client && netlify functions:serve  # Functions on :8888

# Build for production
cd client && npm run build

# Run tests
npm test
node tests/comprehensive-test.js
```

### Linting & Type Checking

```bash
# Client linting (if configured)
cd client && npm run lint

# No TypeScript configured yet - consider adding it
```

### Database & Data Management

```bash
# Import grants from CSV
node scripts/import-grants.js

# Setup admin users
node scripts/setup-admin-users.js

# Run Supabase migrations
cd supabase && supabase db push
```

### Deployment

```bash
# Deploy to Netlify (auto-deploys on push to main)
git push origin main

# Manual Netlify deploy
cd client && netlify deploy --prod --dir=build
```

## High-Level Code Architecture

This is a **Civil Society Grants Database** - a multilingual (English/Ukrainian) web application for discovering grants with AI-powered assistance.

### Frontend Architecture (React 18)

- **Entry Point**: `client/src/App.js` - Main router with loading animation, context providers
- **Key Contexts**:
  - `AuthContext` - Supabase authentication
  - `LanguageContext` - i18n language switching
  - `ThemeContext` - Dark/light mode
- **Routing**: React Router v6 with public/admin separation
- **State Management**: React hooks + Context API (no Redux)
- **Styling**: Tailwind CSS with dark mode support
- **i18n**: Using i18next with translations in `client/public/locales/`

### Backend Architecture

- **Primary**: Netlify Functions (serverless) in `client/netlify/functions/`
- **Secondary**: Express server in `server/` (local dev only)
- **Database**: Supabase (PostgreSQL) with Row Level Security
- **Auth**: Supabase Auth with JWT tokens
- **File Storage**: Local `uploads/` directory (consider moving to cloud storage)

### Key User Flows

1. **Grant Discovery**: HomePage â†’ GrantsPage (filtered list) â†’ GrantDetail
2. **AI Chat**: Floating widget using Google Gemini API for grant recommendations
3. **Admin Panel**: `/admin/login` â†’ Dashboard with grant/blog/user management
4. **Blog System**: Public blog with AI-powered content generation for admins

### Data Flow

1. **Grants**: Supabase DB â†’ Netlify Functions â†’ React components
2. **Fallback**: Static JSON files in `client/public/data/` if DB fails
3. **Images**: Organization logos stored as SVGs in `client/public/images/logos/`
4. **Blog Media**: Uploaded to `uploads/blog/` directory

## Recent Changes & Known Issues

### Recent Work

- Simplified UX based on user feedback (reduced filters from 6+ to 3)
- Fixed blog creation with simplified editor (`AdminBlogEditorSimple.js`)
- Enhanced homepage with accurate statistics (107 grants, â‚¬63M+ funding)
- Fixed mobile responsiveness issues
- Added Ukrainian translations for all content

### Known Issues

- Quill editor has loading issues (using simple textarea workaround)
- Blog images stored locally (should migrate to CDN)
- No proper test suite configured
- Missing TypeScript despite React 18 support

### Active Workarounds

- Using `AdminBlogEditorSimple.js` instead of Quill-based editor
- Static JSON fallback when Supabase is unavailable
- Manual grant data updates via CSV import scripts

## Database Schema

### Main Tables (Supabase)

- `grants` - Grant information with multilingual fields
- `app_users` - Admin accounts (separate from Supabase auth.users)
- `blog_posts` - Blog content with translations
- `blog_generations` - AI-generated content tracking

### Key Grant Fields

- Basic: name, organization, website, deadline
- Multilingual: description_en/uk, eligibility_en/uk, focus_areas_en/uk
- Metadata: grant_size_min/max, type, geographic_focus
- UI: logo_url, application_url

## Environment Variables

### Required for Production

```bash
REACT_APP_SUPABASE_URL          # Supabase project URL
REACT_APP_SUPABASE_ANON_KEY     # Supabase anonymous key
SUPABASE_SERVICE_ROLE_KEY       # Server-side Supabase key
GOOGLE_GEMINI_API_KEY           # For AI chat functionality
```

### Development Helpers

```bash
REACT_APP_USE_STATIC_DATA       # Use JSON files instead of DB
REACT_APP_API_URL               # API endpoint override
```

## Debugging Tips

1. **Grant Display Issues**: Check `client/public/data/grants.json` format
2. **Logo Missing**: Verify SVG exists in `client/public/images/logos/`
3. **Translation Missing**: Check `client/public/locales/[lang]/translation.json`
4. **API Errors**: Netlify Functions logs in Netlify dashboard
5. **Auth Issues**: Check Supabase dashboard for user status

## Project Patterns

### Component Structure

```javascript
// Consistent pattern across pages
const ComponentName = () => {
  const { darkMode } = useContext(ThemeContext);
  const { t, i18n } = useTranslation();
  // ... state and effects
  return <div className={darkMode ? 'dark-styles' : 'light-styles'}>{/* Content */}</div>;
};
```

### API Call Pattern

```javascript
// Using axios with error handling
try {
  const response = await axios.get('/api/endpoint');
  setData(response.data);
} catch (error) {
  console.error('Error:', error);
  // Fallback to static data if available
}
```

### Tailwind Dark Mode

```javascript
// Consistent dark mode classes
className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900'}`}
```

## Important Files Reference

- **Main App Logic**: `client/src/App.js`
- **Grant Display**: `client/src/pages/GrantsPage.js`
- **Homepage**: `client/src/pages/HomePage.js`
- **Admin Blog Editor**: `client/src/pages/AdminBlogEditorSimple.js`
- **API Routes**: `client/netlify/functions/*.js`
- **Grant Data Import**: `scripts/import-grants.js`
- **Database Schema**: `supabase/migrations/*.sql`

Remember: This is a public service project for civil society organizations. Keep the UX simple, accessible, and focused on helping users find relevant grants quickly!



================================================================================
FILE: client/src/App.css
SIZE: 807 bytes
================================================================================

.App {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.App main {
  flex: 1;
}

/* Animation for loading spinner */
@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* Chat widget animations */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out;
}

.animate-spin {
  animation: spin 1s linear infinite;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #aaa;
}



================================================================================
FILE: client/src/App.js
SIZE: 10658 bytes
================================================================================

import React, { useState, useEffect, lazy, Suspense } from 'react';
import { Routes, Route } from 'react-router-dom';
import { useTranslation } from 'react-i18next';

// Import Components
import Header from './components/Header';
import Footer from './components/Footer';
import GrantsChatWidget from './components/GrantsChatWidget';
import ProtectedRoute from './components/ProtectedRoute';

// Import Contexts
import { LanguageContext } from './context/LanguageContext';
import { ThemeProvider } from './context/ThemeContext';
import { AuthProvider } from './context/AuthContext';

// Import styles
import './App.css';
import './styles/mobile-optimizations.css';
import './styles/video-hero.css';

// Import utilities
import { debugEnv } from './utils/debugEnv';

// Lazy load pages for code splitting
const HomePage = lazy(() => import('./pages/HomePage'));
const GrantsPage = lazy(() => import('./pages/GrantsPage'));
const GrantDetail = lazy(() => import('./pages/GrantDetail'));
const AdminPage = lazy(() => import('./pages/AdminPage'));
const AboutPage = lazy(() => import('./pages/AboutPage'));
const NotFoundPage = lazy(() => import('./pages/NotFoundPage'));

// Lazy load Admin Components
const AdminLoginPage = lazy(() => import('./pages/AdminLoginPage'));
const AdminDashboard = lazy(() => import('./pages/AdminDashboard'));
const AdminOverview = lazy(() => import('./pages/AdminOverview'));
const AdminGrants = lazy(() => import('./pages/AdminGrants'));
const AdminBlog = lazy(() => import('./pages/AdminBlog'));
const AdminBlogEditor = lazy(() => import('./pages/AdminBlogEditorSimple')); // Using simplified version temporarily
const AdminProfile = lazy(() => import('./pages/AdminProfile'));
const AdminAnalytics = lazy(() => import('./pages/AdminAnalytics'));

// Lazy load Blog Components
const BlogPage = lazy(() => import('./pages/BlogPage'));
const BlogPostPage = lazy(() => import('./pages/BlogPostPage'));

// Debug environment on load
debugEnv();

// Loader animation component
const LoadingAnimation = () => (
  <div className="fixed inset-0 flex items-center justify-center bg-white dark:bg-gray-900 z-50 transition-opacity duration-500">
    <div className="relative">
      <div className="h-24 w-24 rounded-full border-t-4 border-b-4 border-blue-500 dark:border-blue-400 animate-spin"></div>
      <div
        className="absolute top-0 left-0 h-24 w-24 rounded-full border-t-4 border-b-4 border-blue-300 dark:border-blue-600 animate-spin"
        style={{ animationDirection: 'reverse', animationDuration: '1.5s' }}
      ></div>
    </div>
  </div>
);

// Page loading component for Suspense
const PageLoader = () => (
  <div className="flex items-center justify-center min-h-[60vh]">
    <div className="relative">
      <div className="h-16 w-16 rounded-full border-t-4 border-b-4 border-blue-500 dark:border-blue-400 animate-spin"></div>
      <div
        className="absolute top-0 left-0 h-16 w-16 rounded-full border-t-4 border-b-4 border-blue-300 dark:border-blue-600 animate-spin"
        style={{ animationDirection: 'reverse', animationDuration: '1.5s' }}
      ></div>
    </div>
  </div>
);

function App() {
  const { i18n } = useTranslation();
  const [language, setLanguage] = useState(i18n.language);
  const [loading, setLoading] = useState(true);

  // Simulate initial loading
  useEffect(() => {
    const timer = setTimeout(() => {
      setLoading(false);
    }, 1500);
    return () => clearTimeout(timer);
  }, []);

  const changeLanguage = lng => {
    i18n.changeLanguage(lng);
    setLanguage(lng);
  };

  return (
    <AuthProvider>
      <ThemeProvider>
        <LanguageContext.Provider value={{ language, changeLanguage }}>
          {loading ? (
            <LoadingAnimation />
          ) : (
            <Routes>
              {/* Public routes with header/footer */}
              <Route
                path="/"
                element={
                  <div className="App min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
                    <Header />
                    <main id="main-content" className="flex-grow container mx-auto px-4 py-8 transition-all duration-300 ease-in-out" role="main">
                      <Suspense fallback={<PageLoader />}>
                        <HomePage />
                      </Suspense>
                    </main>
                    <Footer />
                    <GrantsChatWidget />
                  </div>
                }
              />
              <Route
                path="/grants"
                element={
                  <div className="App min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
                    <Header />
                    <main id="main-content" className="flex-grow container mx-auto px-4 py-8 transition-all duration-300 ease-in-out" role="main">
                      <Suspense fallback={<PageLoader />}>
                        <GrantsPage />
                      </Suspense>
                    </main>
                    <Footer />
                    <GrantsChatWidget />
                  </div>
                }
              />
              <Route
                path="/grants/:id"
                element={
                  <div className="App min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
                    <Header />
                    <main id="main-content" className="flex-grow container mx-auto px-4 py-8 transition-all duration-300 ease-in-out" role="main">
                      <Suspense fallback={<PageLoader />}>
                        <GrantDetail />
                      </Suspense>
                    </main>
                    <Footer />
                    <GrantsChatWidget />
                  </div>
                }
              />
              <Route
                path="/about"
                element={
                  <div className="App min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
                    <Header />
                    <main id="main-content" className="flex-grow container mx-auto px-4 py-8 transition-all duration-300 ease-in-out" role="main">
                      <Suspense fallback={<PageLoader />}>
                        <AboutPage />
                      </Suspense>
                    </main>
                    <Footer />
                    <GrantsChatWidget />
                  </div>
                }
              />
              <Route
                path="/blog"
                element={
                  <div className="App min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
                    <Header />
                    <main id="main-content" className="flex-grow" role="main">
                      <Suspense fallback={<PageLoader />}>
                        <BlogPage />
                      </Suspense>
                    </main>
                    <Footer />
                    <GrantsChatWidget />
                  </div>
                }
              />
              <Route
                path="/blog/:slug"
                element={
                  <div className="App min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
                    <Header />
                    <main id="main-content" className="flex-grow" role="main">
                      <Suspense fallback={<PageLoader />}>
                        <BlogPostPage />
                      </Suspense>
                    </main>
                    <Footer />
                    <GrantsChatWidget />
                  </div>
                }
              />

              {/* Old admin page redirect */}
              <Route
                path="/admin"
                element={
                  <div className="App min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
                    <Header />
                    <main id="main-content" className="flex-grow container mx-auto px-4 py-8 transition-all duration-300 ease-in-out" role="main">
                      <Suspense fallback={<PageLoader />}>
                        <AdminPage />
                      </Suspense>
                    </main>
                    <Footer />
                  </div>
                }
              />

              {/* Admin routes without header/footer */}
              <Route path="/admin/login" element={<Suspense fallback={<PageLoader />}><AdminLoginPage /></Suspense>} />
              <Route
                path="/admin/*"
                element={
                  <ProtectedRoute>
                    <Suspense fallback={<PageLoader />}>
                      <AdminDashboard />
                    </Suspense>
                  </ProtectedRoute>
                }
              >
                <Route path="dashboard" element={<Suspense fallback={<PageLoader />}><AdminOverview /></Suspense>} />
                <Route path="analytics" element={<Suspense fallback={<PageLoader />}><AdminAnalytics /></Suspense>} />
                <Route path="grants" element={<Suspense fallback={<PageLoader />}><AdminGrants /></Suspense>} />
                <Route path="blog" element={<Suspense fallback={<PageLoader />}><AdminBlog /></Suspense>} />
                <Route path="blog/new" element={<Suspense fallback={<PageLoader />}><AdminBlogEditor /></Suspense>} />
                <Route path="blog/edit/:id" element={<Suspense fallback={<PageLoader />}><AdminBlogEditor /></Suspense>} />
                {/* Removed routes for blog-generation and users - require Express server */}
                <Route path="profile" element={<Suspense fallback={<PageLoader />}><AdminProfile /></Suspense>} />
              </Route>

              <Route
                path="*"
                element={
                  <div className="App min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
                    <Header />
                    <main id="main-content" className="flex-grow container mx-auto px-4 py-8 transition-all duration-300 ease-in-out" role="main">
                      <Suspense fallback={<PageLoader />}>
                        <NotFoundPage />
                      </Suspense>
                    </main>
                    <Footer />
                    <GrantsChatWidget />
                  </div>
                }
              />
            </Routes>
          )}
        </LanguageContext.Provider>
      </ThemeProvider>
    </AuthProvider>
  );
}

export default App;



================================================================================
FILE: client/src/components/AccessibleModal.js
SIZE: 5996 bytes
================================================================================

import React, { useEffect, useRef, useContext } from 'react';
import ReactDOM from 'react-dom';
import { ThemeContext } from '../context/ThemeContext';

const AccessibleModal = ({
  isOpen,
  onClose,
  title,
  children,
  size = 'medium',
  closeOnOverlayClick = true,
  showCloseButton = true,
  className = '',
  modalId,
}) => {
  const { darkMode } = useContext(ThemeContext);
  const modalRef = useRef(null);
  const previousActiveElement = useRef(null);

  // Size classes
  const sizeClasses = {
    small: 'max-w-md',
    medium: 'max-w-lg',
    large: 'max-w-2xl',
    fullscreen: 'max-w-full h-full',
  };

  // Handle ESC key press
  useEffect(() => {
    const handleEscape = (e) => {
      if (e.key === 'Escape' && isOpen) {
        onClose();
      }
    };

    if (isOpen) {
      document.addEventListener('keydown', handleEscape);
      // Store the currently focused element
      previousActiveElement.current = document.activeElement;
      // Focus the modal
      setTimeout(() => {
        if (modalRef.current) {
          modalRef.current.focus();
        }
      }, 100);
    }

    return () => {
      document.removeEventListener('keydown', handleEscape);
      // Return focus to the previously focused element
      if (previousActiveElement.current && previousActiveElement.current.focus) {
        previousActiveElement.current.focus();
      }
    };
  }, [isOpen, onClose]);

  // Trap focus within modal
  useEffect(() => {
    if (!isOpen || !modalRef.current) return;

    const focusableElements = modalRef.current.querySelectorAll(
      'a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])'
    );

    const firstFocusable = focusableElements[0];
    const lastFocusable = focusableElements[focusableElements.length - 1];

    const handleTabKey = (e) => {
      if (e.key !== 'Tab') return;

      if (e.shiftKey) {
        if (document.activeElement === firstFocusable) {
          e.preventDefault();
          lastFocusable?.focus();
        }
      } else {
        if (document.activeElement === lastFocusable) {
          e.preventDefault();
          firstFocusable?.focus();
        }
      }
    };

    modalRef.current.addEventListener('keydown', handleTabKey);

    return () => {
      modalRef.current?.removeEventListener('keydown', handleTabKey);
    };
  }, [isOpen]);

  // Prevent body scroll when modal is open
  useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }

    return () => {
      document.body.style.overflow = '';
    };
  }, [isOpen]);

  if (!isOpen) return null;

  const modalContent = (
    <div
      className="fixed inset-0 z-50 overflow-y-auto"
      aria-labelledby={modalId ? `${modalId}-title` : 'modal-title'}
      aria-modal="true"
      role="dialog"
    >
      {/* Overlay */}
      <div
        className={`fixed inset-0 transition-opacity ${
          darkMode ? 'bg-black bg-opacity-75' : 'bg-gray-500 bg-opacity-75'
        }`}
        aria-hidden="true"
        onClick={closeOnOverlayClick ? onClose : undefined}
      />

      {/* Modal Container */}
      <div className="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        {/* This element is to trick the browser into centering the modal contents. */}
        <span className="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">
          &#8203;
        </span>

        {/* Modal Panel */}
        <div
          ref={modalRef}
          className={`inline-block align-bottom rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle ${sizeClasses[size]} w-full ${className} ${
            darkMode ? 'bg-gray-800' : 'bg-white'
          }`}
          tabIndex={-1}
        >
          {/* Header */}
          <div
            className={`px-6 py-4 ${
              darkMode ? 'bg-gray-900 border-b border-gray-700' : 'bg-gray-50 border-b border-gray-200'
            }`}
          >
            <div className="flex items-center justify-between">
              <h3
                id={modalId ? `${modalId}-title` : 'modal-title'}
                className={`text-lg font-medium leading-6 ${
                  darkMode ? 'text-white' : 'text-gray-900'
                }`}
              >
                {title}
              </h3>
              {showCloseButton && (
                <button
                  type="button"
                  onClick={onClose}
                  className={`rounded-md p-2 inline-flex items-center justify-center ${
                    darkMode
                      ? 'text-gray-400 hover:text-gray-200 hover:bg-gray-700 focus:bg-gray-700'
                      : 'text-gray-400 hover:text-gray-500 hover:bg-gray-200 focus:bg-gray-200'
                  } focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500`}
                  aria-label="Close modal"
                >
                  <svg
                    className="h-5 w-5"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    aria-hidden="true"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              )}
            </div>
          </div>

          {/* Body */}
          <div className={`px-6 py-4 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
            {children}
          </div>
        </div>
      </div>
    </div>
  );

  // Portal render
  return ReactDOM.createPortal(modalContent, document.body);
};

export default AccessibleModal;


================================================================================
FILE: client/src/components/BackToTop.js
SIZE: 4369 bytes
================================================================================

import React, { useState, useEffect, useContext } from 'react';
import { ThemeContext } from '../context/ThemeContext';

const BackToTop = () => {
  const { darkMode } = useContext(ThemeContext);
  const [isVisible, setIsVisible] = useState(false);
  const [isScrolling, setIsScrolling] = useState(false);

  useEffect(() => {
    const toggleVisibility = () => {
      if (window.pageYOffset > 300) {
        setIsVisible(true);
      } else {
        setIsVisible(false);
      }
    };

    const handleScroll = () => {
      setIsScrolling(true);
      toggleVisibility();
      
      // Reset scrolling state after scrolling stops
      clearTimeout(window.scrollTimeout);
      window.scrollTimeout = setTimeout(() => {
        setIsScrolling(false);
      }, 150);
    };

    window.addEventListener('scroll', handleScroll);
    
    // Check initial scroll position
    toggleVisibility();

    return () => {
      window.removeEventListener('scroll', handleScroll);
      clearTimeout(window.scrollTimeout);
    };
  }, []);

  const scrollToTop = () => {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  };

  if (!isVisible) {
    return null;
  }

  return (
    <button
      onClick={scrollToTop}
      className={`
        fixed bottom-6 right-6 z-40 p-3 rounded-full shadow-lg
        transition-all duration-300 transform
        ${isVisible ? 'translate-y-0 opacity-100' : 'translate-y-16 opacity-0'}
        ${isScrolling ? 'scale-90' : 'scale-100'}
        ${darkMode 
          ? 'bg-gray-800 hover:bg-gray-700 text-gray-200' 
          : 'bg-white hover:bg-gray-50 text-gray-700'
        }
        hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2
        ${darkMode ? 'focus:ring-gray-600' : 'focus:ring-gray-400'}
        group
      `}
      aria-label="Back to top"
      title="Back to top"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        className="h-6 w-6 transition-transform duration-300 group-hover:-translate-y-0.5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        strokeWidth={2}
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="M5 10l7-7m0 0l7 7m-7-7v18"
        />
      </svg>
      
      {/* Progress ring */}
      <svg
        className="absolute inset-0 w-full h-full -rotate-90"
        viewBox="0 0 48 48"
      >
        <circle
          cx="24"
          cy="24"
          r="22"
          fill="none"
          stroke={darkMode ? '#374151' : '#E5E7EB'}
          strokeWidth="2"
        />
        <circle
          cx="24"
          cy="24"
          r="22"
          fill="none"
          stroke={darkMode ? '#60A5FA' : '#3B82F6'}
          strokeWidth="2"
          strokeDasharray={`${2 * Math.PI * 22}`}
          strokeDashoffset={`${2 * Math.PI * 22 * (1 - Math.min(window.pageYOffset / (document.documentElement.scrollHeight - window.innerHeight), 1))}`}
          className="transition-all duration-150"
        />
      </svg>
    </button>
  );
};

// Alternative minimal version
export const MinimalBackToTop = () => {
  const { darkMode } = useContext(ThemeContext);
  const [isVisible, setIsVisible] = useState(false);

  useEffect(() => {
    const toggleVisibility = () => {
      setIsVisible(window.pageYOffset > 500);
    };

    window.addEventListener('scroll', toggleVisibility);
    toggleVisibility();

    return () => window.removeEventListener('scroll', toggleVisibility);
  }, []);

  if (!isVisible) return null;

  return (
    <button
      onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
      className={`
        fixed bottom-20 right-6 z-40 p-2 rounded-lg
        transition-all duration-300
        ${darkMode 
          ? 'bg-gray-800/80 hover:bg-gray-700 text-gray-300' 
          : 'bg-white/80 hover:bg-white text-gray-600'
        }
        backdrop-blur-sm shadow-md hover:shadow-lg
      `}
      aria-label="Back to top"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        className="h-5 w-5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        strokeWidth={2}
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="M7 11l5-5m0 0l5 5m-5-5v12"
        />
      </svg>
    </button>
  );
};

export default BackToTop;


================================================================================
FILE: client/src/components/Breadcrumbs.js
SIZE: 3732 bytes
================================================================================

import React, { useContext } from 'react';
import { Link, useLocation } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { ThemeContext } from '../context/ThemeContext';

const Breadcrumbs = ({ customItems = [] }) => {
  const { darkMode } = useContext(ThemeContext);
  const { t } = useTranslation();
  const location = useLocation();

  // Generate breadcrumb items based on current path
  const generateBreadcrumbs = () => {
    const pathSegments = location.pathname.split('/').filter(Boolean);
    const breadcrumbs = [
      { label: t('breadcrumbs.home', 'Home'), path: '/' }
    ];

    let currentPath = '';
    pathSegments.forEach((segment, index) => {
      currentPath += `/${segment}`;
      
      // Map route segments to labels
      const labelMap = {
        'grants': t('breadcrumbs.grants', 'Grants'),
        'about': t('breadcrumbs.about', 'About'),
        'blog': t('breadcrumbs.blog', 'Blog'),
        'admin': t('breadcrumbs.admin', 'Admin'),
        'login': t('breadcrumbs.login', 'Login'),
        'dashboard': t('breadcrumbs.dashboard', 'Dashboard'),
        'profile': t('breadcrumbs.profile', 'Profile'),
        'overview': t('breadcrumbs.overview', 'Overview'),
      };

      const label = labelMap[segment] || segment.charAt(0).toUpperCase() + segment.slice(1);
      
      breadcrumbs.push({
        label,
        path: currentPath,
        isLast: index === pathSegments.length - 1
      });
    });

    // If custom items are provided, use them instead
    if (customItems.length > 0) {
      return [breadcrumbs[0], ...customItems];
    }

    return breadcrumbs;
  };

  const breadcrumbs = generateBreadcrumbs();

  // Don't show breadcrumbs on homepage
  if (location.pathname === '/') {
    return null;
  }

  return (
    <nav
      className={`
        flex items-center space-x-2 text-sm mb-6
        ${darkMode ? 'text-gray-400' : 'text-gray-600'}
      `}
      aria-label="Breadcrumb"
    >
      {breadcrumbs.map((item, index) => (
        <React.Fragment key={item.path}>
          {index > 0 && (
            <svg
              xmlns="http://www.w3.org/2000/svg"
              className="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M9 5l7 7-7 7"
              />
            </svg>
          )}
          {item.isLast || index === breadcrumbs.length - 1 ? (
            <span
              className={`font-medium ${
                darkMode ? 'text-gray-200' : 'text-gray-900'
              }`}
            >
              {item.label}
            </span>
          ) : (
            <Link
              to={item.path}
              className={`
                hover:underline transition-colors
                ${darkMode 
                  ? 'hover:text-gray-200' 
                  : 'hover:text-gray-900'
                }
              `}
            >
              {item.label}
            </Link>
          )}
        </React.Fragment>
      ))}
    </nav>
  );
};

// Structured data for SEO
export const BreadcrumbStructuredData = ({ items }) => {
  const structuredData = {
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: items.map((item, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      name: item.label,
      item: window.location.origin + item.path
    }))
  };

  return (
    <script
      type="application/ld+json"
      dangerouslySetInnerHTML={{ __html: JSON.stringify(structuredData) }}
    />
  );
};

export default Breadcrumbs;


================================================================================
FILE: client/src/components/Footer.js
SIZE: 10219 bytes
================================================================================

import React, { useContext } from 'react';
import { Link } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { ThemeContext } from '../context/ThemeContext';

const Footer = () => {
  const { t } = useTranslation();
  const { darkMode } = useContext(ThemeContext);
  const currentYear = new Date().getFullYear();

  return (
    <footer
      className={`${darkMode ? 'bg-gray-900 text-gray-300 border-t border-gray-800' : 'bg-white text-gray-600 border-t border-gray-200'} py-8 transition-colors duration-300`}
    >
      <div className="container mx-auto px-4">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
          {/* Logo and info */}
          <div className="col-span-1 md:col-span-1">
            <div className="flex items-center mb-4">
              <img
                src="/images/ukraine-grants-logo.png"
                alt="Ukrainian Civil Society Grants Database"
                className="h-12 w-auto"
                style={{ maxWidth: '200px' }}
              />
            </div>
            <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'} mb-4 max-w-xs`}>
              Helping civil society organizations find funding opportunities in Ukraine and
              internationally.
            </p>
            <div className="flex space-x-4">
              {/* Social media icons - placeholder */}
              <a
                href="https://twitter.com"
                target="_blank"
                rel="noopener noreferrer"
                className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-blue-600'} transition-colors duration-200`}
              >
                <span className="sr-only">Twitter</span>
                <svg className="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84" />
                </svg>
              </a>
              <a
                href="https://facebook.com"
                target="_blank"
                rel="noopener noreferrer"
                className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-blue-600'} transition-colors duration-200`}
              >
                <span className="sr-only">Facebook</span>
                <svg className="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    fillRule="evenodd"
                    d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"
                    clipRule="evenodd"
                  />
                </svg>
              </a>
              <a
                href="https://www.linkedin.com/in/fedo-hagge-kubat-36814415b/"
                target="_blank"
                rel="noopener noreferrer"
                className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-blue-600'} transition-colors duration-200`}
              >
                <span className="sr-only">LinkedIn</span>
                <svg className="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    fillRule="evenodd"
                    d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"
                    clipRule="evenodd"
                  />
                </svg>
              </a>
            </div>
          </div>

          {/* Quick links */}
          <div className="col-span-1">
            <h3
              className={`text-sm font-semibold uppercase tracking-wider ${darkMode ? 'text-gray-100' : 'text-gray-900'} mb-4`}
            >
              Quick Links
            </h3>
            <ul className="space-y-2">
              <li>
                <Link
                  to="/"
                  className={`text-sm ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-blue-600'} transition-colors duration-200`}
                >
                  {t('navigation.home')}
                </Link>
              </li>
              <li>
                <Link
                  to="/grants"
                  className={`text-sm ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-blue-600'} transition-colors duration-200`}
                >
                  {t('navigation.grants')}
                </Link>
              </li>
              <li>
                <Link
                  to="/about"
                  className={`text-sm ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-blue-600'} transition-colors duration-200`}
                >
                  {t('navigation.about')}
                </Link>
              </li>
              <li>
                <Link
                  to="/admin"
                  className={`text-sm ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-blue-600'} transition-colors duration-200`}
                >
                  {t('navigation.admin')}
                </Link>
              </li>
            </ul>
          </div>

          {/* Contact */}
          <div className="col-span-1">
            <h3
              className={`text-sm font-semibold uppercase tracking-wider ${darkMode ? 'text-gray-100' : 'text-gray-900'} mb-4`}
            >
              Contact
            </h3>
            <div className="mb-2">
              <p className={`text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                Fedo Hagge-Kubat
              </p>
            </div>
            <ul className="space-y-2">
              <li
                className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'} flex items-center`}
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-4 w-4 mr-2"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                  />
                </svg>
                +49 174 403 1399
              </li>
              <li
                className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'} flex items-center`}
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-4 w-4 mr-2"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  />
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                Prenlauer Alle 229, 10405 Berlin
              </li>
              <li
                className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'} flex items-center`}
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-4 w-4 mr-2"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M4 6h16M4 12h16m-7 6h7"
                  />
                </svg>
                <a
                  href="https://www.linkedin.com/in/fedo-hagge-kubat-36814415b/"
                  target="_blank"
                  rel="noopener noreferrer"
                  className={`${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-800'} transition-colors duration-200`}
                >
                  LinkedIn Profile
                </a>
              </li>
            </ul>
          </div>

          {/* Disclaimer */}
          <div className="col-span-1">
            <h3
              className={`text-sm font-semibold uppercase tracking-wider ${darkMode ? 'text-gray-100' : 'text-gray-900'} mb-4`}
            >
              Disclaimer
            </h3>
            <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
              {t('footer.disclaimer')}
            </p>
          </div>
        </div>

        <div
          className={`mt-8 pt-8 ${darkMode ? 'border-t border-gray-800' : 'border-t border-gray-200'}`}
        >
          <p className={`text-sm text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
            &copy; {currentYear} Fedo Hagge-Kubat - {t('appName')}. {t('footer.rights')}
          </p>
        </div>
      </div>
    </footer>
  );
};

export default Footer;



================================================================================
FILE: client/src/components/GrantAnalytics.js
SIZE: 7214 bytes
================================================================================

import React, { useContext, useEffect, useState } from 'react';
import { useTranslation } from 'react-i18next';
import { ThemeContext } from '../context/ThemeContext';
import {
  BarChart, Bar, LineChart, Line, PieChart, Pie, Cell,
  XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
} from 'recharts';
import { 
  ChartBarIcon, TrendingUpIcon, CalendarIcon, 
  EyeIcon, SearchIcon, ExternalLinkIcon 
} from '@heroicons/react/24/outline';

const GrantAnalytics = ({ grantId, grantName }) => {
  const { darkMode } = useContext(ThemeContext);
  const { t } = useTranslation();
  const [analytics, setAnalytics] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    fetchGrantAnalytics();
  }, [grantId]);

  const fetchGrantAnalytics = async () => {
    try {
      const response = await fetch(`/.netlify/functions/analytics?action=grantStats&grantId=${grantId}`);
      if (!response.ok) throw new Error('Failed to fetch analytics');
      const data = await response.json();
      setAnalytics(data);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className={`p-6 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-gray-100'}`}>
        <div className="animate-pulse">
          <div className="h-4 bg-gray-300 rounded w-1/4 mb-4"></div>
          <div className="h-64 bg-gray-300 rounded"></div>
        </div>
      </div>
    );
  }

  if (error || !analytics) {
    return null;
  }

  const chartColors = {
    primary: darkMode ? '#60A5FA' : '#3B82F6',
    secondary: darkMode ? '#A78BFA' : '#8B5CF6',
    tertiary: darkMode ? '#34D399' : '#10B981',
    background: darkMode ? '#1F2937' : '#F3F4F6',
    text: darkMode ? '#E5E7EB' : '#374151'
  };

  return (
    <div className={`p-6 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
      <h3 className={`text-xl font-semibold mb-6 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
        {t('grantAnalytics.title')}
      </h3>

      {/* Key Metrics */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
          <div className="flex items-center justify-between">
            <div>
              <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                {t('grantAnalytics.totalViews')}
              </p>
              <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {analytics.view_count || 0}
              </p>
            </div>
            <EyeIcon className="h-8 w-8 text-blue-500" />
          </div>
        </div>

        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
          <div className="flex items-center justify-between">
            <div>
              <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                {t('grantAnalytics.last30Days')}
              </p>
              <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {analytics.viewsLast30Days || 0}
              </p>
            </div>
            <CalendarIcon className="h-8 w-8 text-green-500" />
          </div>
        </div>

        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
          <div className="flex items-center justify-between">
            <div>
              <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                {t('grantAnalytics.externalClicks')}
              </p>
              <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {analytics.external_clicks || 0}
              </p>
            </div>
            <ExternalLinkIcon className="h-8 w-8 text-purple-500" />
          </div>
        </div>

        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
          <div className="flex items-center justify-between">
            <div>
              <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                {t('grantAnalytics.searchAppearances')}
              </p>
              <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {analytics.search_appearances || 0}
              </p>
            </div>
            <SearchIcon className="h-8 w-8 text-yellow-500" />
          </div>
        </div>
      </div>

      {/* View Timeline Chart */}
      {analytics.viewTimeline && analytics.viewTimeline.length > 0 && (
        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} mb-6`}>
          <h4 className={`text-lg font-semibold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            {t('grantAnalytics.viewsOverTime')}
          </h4>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={analytics.viewTimeline}>
              <CartesianGrid strokeDasharray="3 3" stroke={chartColors.text} opacity={0.1} />
              <XAxis 
                dataKey="date" 
                stroke={chartColors.text}
                tick={{ fill: chartColors.text }}
                tickFormatter={(date) => new Date(date).toLocaleDateString('en', { month: 'short', day: 'numeric' })}
              />
              <YAxis 
                stroke={chartColors.text}
                tick={{ fill: chartColors.text }}
              />
              <Tooltip 
                contentStyle={{ 
                  backgroundColor: chartColors.background,
                  border: 'none',
                  borderRadius: '8px',
                  color: chartColors.text
                }}
              />
              <Line 
                type="monotone" 
                dataKey="count" 
                stroke={chartColors.primary} 
                strokeWidth={2}
                dot={{ fill: chartColors.primary }}
                activeDot={{ r: 8 }}
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      )}

      {/* Additional Insights */}
      <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
        <h4 className={`text-lg font-semibold mb-3 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
          {t('grantAnalytics.insights')}
        </h4>
        <ul className={`space-y-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
          {analytics.last_viewed && (
            <li>
              {t('grantAnalytics.lastViewed')}: {new Date(analytics.last_viewed).toLocaleString()}
            </li>
          )}
          {analytics.click_through_rate && (
            <li>
              {t('grantAnalytics.clickThroughRate')}: {analytics.click_through_rate}%
            </li>
          )}
          {analytics.average_time_on_page && (
            <li>
              {t('grantAnalytics.avgTimeOnPage')}: {Math.round(analytics.average_time_on_page / 60)} minutes
            </li>
          )}
        </ul>
      </div>
    </div>
  );
};

export default GrantAnalytics;


================================================================================
FILE: client/src/components/GrantBookmark.js
SIZE: 4792 bytes
================================================================================

import React, { useState, useEffect, useContext } from 'react';
import { ThemeContext } from '../context/ThemeContext';

const GrantBookmark = ({ grant, className = '' }) => {
  const { darkMode } = useContext(ThemeContext);
  const [isBookmarked, setIsBookmarked] = useState(false);
  const [isAnimating, setIsAnimating] = useState(false);

  // Get grant ID (support both database and static JSON formats)
  const getGrantId = () => {
    return grant.id || grant['Grant Name'] || '';
  };

  // Load bookmarked state from localStorage
  useEffect(() => {
    const bookmarks = JSON.parse(localStorage.getItem('bookmarkedGrants') || '[]');
    setIsBookmarked(bookmarks.includes(getGrantId()));
  }, [grant]);

  const toggleBookmark = (e) => {
    e.stopPropagation(); // Prevent card click event
    e.preventDefault();

    const grantId = getGrantId();
    const bookmarks = JSON.parse(localStorage.getItem('bookmarkedGrants') || '[]');

    let newBookmarks;
    if (isBookmarked) {
      newBookmarks = bookmarks.filter(id => id !== grantId);
    } else {
      newBookmarks = [...bookmarks, grantId];
    }

    localStorage.setItem('bookmarkedGrants', JSON.stringify(newBookmarks));
    setIsBookmarked(!isBookmarked);

    // Trigger animation
    setIsAnimating(true);
    setTimeout(() => setIsAnimating(false), 300);

    // Dispatch custom event for other components to listen to
    window.dispatchEvent(new CustomEvent('bookmarksUpdated', { 
      detail: { grantId, isBookmarked: !isBookmarked }
    }));
  };

  return (
    <button
      onClick={toggleBookmark}
      className={`
        relative p-2 rounded-lg transition-all duration-200
        ${darkMode 
          ? 'hover:bg-gray-700/50' 
          : 'hover:bg-gray-100'
        }
        ${className}
      `}
      aria-label={isBookmarked ? 'Remove bookmark' : 'Add bookmark'}
      title={isBookmarked ? 'Remove bookmark' : 'Add bookmark'}
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        className={`
          h-5 w-5 transition-all duration-200
          ${isAnimating ? 'scale-125' : 'scale-100'}
          ${isBookmarked 
            ? darkMode ? 'text-yellow-400 fill-yellow-400' : 'text-yellow-500 fill-yellow-500'
            : darkMode ? 'text-gray-400' : 'text-gray-500'
          }
        `}
        fill={isBookmarked ? 'currentColor' : 'none'}
        viewBox="0 0 24 24"
        stroke="currentColor"
        strokeWidth={2}
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"
        />
      </svg>

      {/* Animation effect */}
      {isAnimating && (
        <span className="absolute inset-0 rounded-lg animate-ping opacity-75">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            className={`
              h-5 w-5 m-2
              ${isBookmarked 
                ? 'text-yellow-400' 
                : 'text-gray-400'
              }
            `}
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            strokeWidth={2}
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"
            />
          </svg>
        </span>
      )}
    </button>
  );
};

// Hook to get bookmarked grants
export const useBookmarkedGrants = () => {
  const [bookmarkedIds, setBookmarkedIds] = useState([]);

  useEffect(() => {
    // Load initial bookmarks
    const loadBookmarks = () => {
      const bookmarks = JSON.parse(localStorage.getItem('bookmarkedGrants') || '[]');
      setBookmarkedIds(bookmarks);
    };

    loadBookmarks();

    // Listen for bookmark updates
    const handleBookmarkUpdate = () => {
      loadBookmarks();
    };

    window.addEventListener('bookmarksUpdated', handleBookmarkUpdate);
    window.addEventListener('storage', handleBookmarkUpdate);

    return () => {
      window.removeEventListener('bookmarksUpdated', handleBookmarkUpdate);
      window.removeEventListener('storage', handleBookmarkUpdate);
    };
  }, []);

  return bookmarkedIds;
};

// Bookmarks counter badge
export const BookmarksCounter = ({ className = '' }) => {
  const bookmarkedIds = useBookmarkedGrants();
  const { darkMode } = useContext(ThemeContext);

  if (bookmarkedIds.length === 0) return null;

  return (
    <span
      className={`
        inline-flex items-center justify-center px-2 py-0.5 
        text-xs font-bold rounded-full
        ${darkMode 
          ? 'bg-yellow-900/30 text-yellow-400' 
          : 'bg-yellow-100 text-yellow-700'
        }
        ${className}
      `}
    >
      {bookmarkedIds.length}
    </span>
  );
};

export default GrantBookmark;


================================================================================
FILE: client/src/components/GrantComparisonModal.js
SIZE: 9278 bytes
================================================================================

import React, { useContext, useEffect } from 'react';
import { ThemeContext } from '../context/ThemeContext';
import { useTranslation } from 'react-i18next';
import { format } from 'date-fns';

const GrantComparisonModal = ({ grants, isOpen, onClose }) => {
  const { darkMode } = useContext(ThemeContext);
  const { t } = useTranslation();

  // Close on escape key
  useEffect(() => {
    const handleEscape = (e) => {
      if (e.key === 'Escape') onClose();
    };
    if (isOpen) {
      document.addEventListener('keydown', handleEscape);
      document.body.style.overflow = 'hidden';
    }
    return () => {
      document.removeEventListener('keydown', handleEscape);
      document.body.style.overflow = 'unset';
    };
  }, [isOpen, onClose]);

  if (!isOpen || !grants || grants.length < 2) return null;

  const formatDate = (dateString) => {
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      return format(date, 'MMM d, yyyy');
    } catch (error) {
      return dateString;
    }
  };

  const getFieldValue = (grant, field) => {
    // Support both database and static JSON formats
    const fieldMap = {
      name: grant.grant_name || grant['Grant Name'],
      organization: grant.funding_organization || grant['Funding Organization'],
      amount: grant.grant_amount || grant['Grant Amount'],
      deadline: grant.application_deadline || grant['Application Deadline'],
      duration: grant.duration || grant['Duration'],
      eligibility: grant.eligibility_criteria || grant['Eligibility Criteria'],
      focusAreas: grant.focus_areas || grant['Focus Areas'],
      region: grant.country_region || grant['Country/Region'],
      website: grant.website_link || grant['Website Link'],
    };
    return fieldMap[field] || 'N/A';
  };

  const calculateDaysRemaining = (deadline) => {
    if (!deadline || deadline === 'Rolling') return null;
    const today = new Date();
    const deadlineDate = new Date(deadline);
    if (isNaN(deadlineDate.getTime())) return null;
    return Math.round((deadlineDate - today) / (1000 * 60 * 60 * 24));
  };

  const ComparisonRow = ({ label, field, format }) => (
    <tr className={`border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
      <td className={`py-4 px-4 font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
        {label}
      </td>
      {grants.map((grant, index) => {
        const value = getFieldValue(grant, field);
        const formattedValue = format ? format(value) : value;
        
        return (
          <td
            key={index}
            className={`py-4 px-4 ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}
          >
            {field === 'deadline' && value !== 'Rolling' && value !== 'N/A' ? (
              <div>
                <div>{formatDate(value)}</div>
                {calculateDaysRemaining(value) !== null && (
                  <div
                    className={`text-xs mt-1 ${
                      calculateDaysRemaining(value) < 0
                        ? 'text-red-500'
                        : calculateDaysRemaining(value) <= 7
                        ? 'text-orange-500'
                        : 'text-green-500'
                    }`}
                  >
                    {calculateDaysRemaining(value) < 0
                      ? 'Expired'
                      : `${calculateDaysRemaining(value)} days left`}
                  </div>
                )}
              </div>
            ) : (
              <div className={field === 'focusAreas' || field === 'eligibility' ? 'text-sm' : ''}>
                {formattedValue}
              </div>
            )}
          </td>
        );
      })}
    </tr>
  );

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onClick={onClose}
      />

      {/* Modal */}
      <div
        className={`
          relative max-w-6xl w-full max-h-[90vh] overflow-hidden rounded-2xl shadow-2xl
          ${darkMode ? 'bg-gray-900' : 'bg-white'}
          animate-in fade-in zoom-in duration-300
        `}
      >
        {/* Header */}
        <div
          className={`
            sticky top-0 z-10 px-6 py-4 border-b
            ${darkMode 
              ? 'bg-gray-800 border-gray-700' 
              : 'bg-gray-50 border-gray-200'
            }
          `}
        >
          <div className="flex items-center justify-between">
            <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
              {t('grants.compareGrants', 'Compare Grants')}
            </h2>
            <button
              onClick={onClose}
              className={`
                p-2 rounded-lg transition-colors
                ${darkMode 
                  ? 'hover:bg-gray-700 text-gray-400 hover:text-gray-200' 
                  : 'hover:bg-gray-200 text-gray-600 hover:text-gray-900'
                }
              `}
              aria-label="Close comparison"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                className="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>

        {/* Content */}
        <div className="overflow-auto max-h-[calc(90vh-80px)]">
          <table className="w-full">
            <thead
              className={`sticky top-0 ${
                darkMode ? 'bg-gray-800' : 'bg-gray-50'
              }`}
            >
              <tr className={`border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                <th className="py-3 px-4 text-left font-medium">
                  <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                    Criteria
                  </span>
                </th>
                {grants.map((grant, index) => (
                  <th key={index} className="py-3 px-4 text-left">
                    <div className={darkMode ? 'text-white' : 'text-gray-900'}>
                      <div className="font-semibold text-lg">
                        {getFieldValue(grant, 'name')}
                      </div>
                      <div
                        className={`text-sm font-normal ${
                          darkMode ? 'text-gray-400' : 'text-gray-600'
                        }`}
                      >
                        {getFieldValue(grant, 'organization')}
                      </div>
                    </div>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              <ComparisonRow label="Grant Amount" field="amount" />
              <ComparisonRow label="Application Deadline" field="deadline" />
              <ComparisonRow label="Duration" field="duration" />
              <ComparisonRow label="Region" field="region" />
              <ComparisonRow label="Focus Areas" field="focusAreas" />
              <ComparisonRow label="Eligibility Criteria" field="eligibility" />
            </tbody>
          </table>

          {/* Action buttons */}
          <div
            className={`
              sticky bottom-0 px-6 py-4 border-t
              ${darkMode 
                ? 'bg-gray-800 border-gray-700' 
                : 'bg-gray-50 border-gray-200'
              }
            `}
          >
            <div className="flex justify-between items-center">
              <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Comparing {grants.length} grants
              </p>
              <div className="flex gap-3">
                <button
                  onClick={onClose}
                  className={`
                    px-4 py-2 rounded-lg font-medium transition-colors
                    ${darkMode
                      ? 'bg-gray-700 hover:bg-gray-600 text-gray-200'
                      : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                    }
                  `}
                >
                  Close
                </button>
                {grants.map((grant, index) => (
                  <a
                    key={index}
                    href={getFieldValue(grant, 'website')}
                    target="_blank"
                    rel="noopener noreferrer"
                    className={`
                      px-4 py-2 rounded-lg font-medium transition-colors
                      ${darkMode
                        ? 'bg-blue-600 hover:bg-blue-500 text-white'
                        : 'bg-blue-600 hover:bg-blue-700 text-white'
                      }
                    `}
                  >
                    Apply to {getFieldValue(grant, 'organization')}
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default GrantComparisonModal;


================================================================================
FILE: client/src/components/GrantDeadlineIndicator.js
SIZE: 6911 bytes
================================================================================

import React, { useContext } from 'react';
import { ThemeContext } from '../context/ThemeContext';

const GrantDeadlineIndicator = ({ deadline, className = '' }) => {
  const { darkMode } = useContext(ThemeContext);

  const calculateDaysRemaining = (deadlineString) => {
    if (!deadlineString) return null;
    
    // Handle non-date strings like "Annual calls", "Rolling deadlines", etc.
    if (typeof deadlineString === 'string' && !deadlineString.match(/^\d{4}-\d{2}-\d{2}/)) {
      return null;
    }
    
    const today = new Date();
    const deadlineDate = new Date(deadlineString);
    if (isNaN(deadlineDate.getTime())) return null;
    return Math.round((deadlineDate - today) / (1000 * 60 * 60 * 24));
  };

  const getUrgencyLevel = (days) => {
    if (days === null) return 'unknown';
    if (days < 0) return 'expired';
    if (days <= 7) return 'urgent';
    if (days <= 30) return 'soon';
    return 'normal';
  };

  const getIndicatorStyles = (urgencyLevel) => {
    switch (urgencyLevel) {
      case 'expired':
        return {
          bg: darkMode ? 'bg-red-900/20' : 'bg-red-100',
          border: darkMode ? 'border-red-700' : 'border-red-300',
          text: darkMode ? 'text-red-400' : 'text-red-700',
          icon: 'âš ï¸',
          pulse: false,
        };
      case 'urgent':
        return {
          bg: darkMode ? 'bg-orange-900/20' : 'bg-orange-100',
          border: darkMode ? 'border-orange-700' : 'border-orange-300',
          text: darkMode ? 'text-orange-400' : 'text-orange-700',
          icon: 'ðŸ”¥',
          pulse: true,
        };
      case 'soon':
        return {
          bg: darkMode ? 'bg-yellow-900/20' : 'bg-yellow-100',
          border: darkMode ? 'border-yellow-700' : 'border-yellow-300',
          text: darkMode ? 'text-yellow-400' : 'text-yellow-700',
          icon: 'â°',
          pulse: false,
        };
      case 'normal':
        return {
          bg: darkMode ? 'bg-green-900/20' : 'bg-green-100',
          border: darkMode ? 'border-green-700' : 'border-green-300',
          text: darkMode ? 'text-green-400' : 'text-green-700',
          icon: 'âœ…',
          pulse: false,
        };
      default:
        return {
          bg: darkMode ? 'bg-gray-700/50' : 'bg-gray-100',
          border: darkMode ? 'border-gray-600' : 'border-gray-300',
          text: darkMode ? 'text-gray-400' : 'text-gray-600',
          icon: 'ðŸ“…',
          pulse: false,
        };
    }
  };

  const formatDeadlineText = (days, urgencyLevel) => {
    if (urgencyLevel === 'unknown') {
      // For non-date deadlines, show the original text
      if (deadline && typeof deadline === 'string' && !deadline.match(/^\d{4}-\d{2}-\d{2}/)) {
        return deadline;
      }
      return 'No deadline';
    }
    if (urgencyLevel === 'expired') {
      return `Expired ${Math.abs(days)} days ago`;
    }
    if (days === 0) {
      return 'Deadline today!';
    }
    if (days === 1) {
      return 'Tomorrow';
    }
    return `${days} days left`;
  };

  const days = calculateDaysRemaining(deadline);
  const urgencyLevel = getUrgencyLevel(days);
  const styles = getIndicatorStyles(urgencyLevel);
  const text = formatDeadlineText(days, urgencyLevel);

  // Progress bar width calculation
  const getProgressWidth = () => {
    if (urgencyLevel === 'expired' || urgencyLevel === 'unknown') return 0;
    if (days > 90) return 100;
    return Math.max(0, Math.min(100, (days / 90) * 100));
  };

  return (
    <div className={`inline-flex flex-col ${className}`}>
      {/* Main indicator */}
      <div
        className={`
          inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold
          border ${styles.bg} ${styles.border} ${styles.text}
          ${styles.pulse ? 'animate-pulse' : ''}
          transition-all duration-300
        `}
      >
        <span className="mr-1.5 text-sm">{styles.icon}</span>
        <span>{text}</span>
      </div>

      {/* Progress bar for non-expired grants */}
      {urgencyLevel !== 'expired' && urgencyLevel !== 'unknown' && days !== null && (
        <div className="mt-1 w-full">
          <div className={`h-1 rounded-full ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>
            <div
              className={`h-full rounded-full transition-all duration-500 ${
                urgencyLevel === 'urgent'
                  ? 'bg-gradient-to-r from-orange-500 to-red-500'
                  : urgencyLevel === 'soon'
                  ? 'bg-gradient-to-r from-yellow-500 to-orange-500'
                  : 'bg-gradient-to-r from-green-500 to-emerald-500'
              }`}
              style={{ width: `${getProgressWidth()}%` }}
            />
          </div>
        </div>
      )}
    </div>
  );
};

// Compact version for use in cards
export const CompactDeadlineIndicator = ({ deadline }) => {
  const { darkMode } = useContext(ThemeContext);

  const calculateDaysRemaining = (deadlineString) => {
    if (!deadlineString) return null;
    
    // Handle non-date strings like "Annual calls", "Rolling deadlines", etc.
    if (typeof deadlineString === 'string' && !deadlineString.match(/^\d{4}-\d{2}-\d{2}/)) {
      return null;
    }
    
    const today = new Date();
    const deadlineDate = new Date(deadlineString);
    if (isNaN(deadlineDate.getTime())) return null;
    return Math.round((deadlineDate - today) / (1000 * 60 * 60 * 24));
  };

  const days = calculateDaysRemaining(deadline);
  
  if (days === null) {
    // Show the actual deadline text for non-date deadlines
    const displayText = deadline && typeof deadline === 'string' && !deadline.match(/^\d{4}-\d{2}-\d{2}/) 
      ? deadline 
      : 'Rolling deadline';
    return (
      <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
        {displayText}
      </span>
    );
  }

  const isExpired = days < 0;
  const isUrgent = days >= 0 && days <= 7;
  const isSoon = days > 7 && days <= 30;

  return (
    <div className="flex items-center gap-1">
      {isExpired && (
        <>
          <div className="w-2 h-2 rounded-full bg-red-500" />
          <span className="text-xs text-red-500 font-medium">Expired</span>
        </>
      )}
      {isUrgent && (
        <>
          <div className="w-2 h-2 rounded-full bg-orange-500 animate-pulse" />
          <span className="text-xs text-orange-500 font-medium">{days}d left</span>
        </>
      )}
      {isSoon && (
        <>
          <div className="w-2 h-2 rounded-full bg-yellow-500" />
          <span className="text-xs text-yellow-500 font-medium">{days}d left</span>
        </>
      )}
      {!isExpired && !isUrgent && !isSoon && (
        <>
          <div className="w-2 h-2 rounded-full bg-green-500" />
          <span className="text-xs text-green-500 font-medium">{days}d left</span>
        </>
      )}
    </div>
  );
};

export default GrantDeadlineIndicator;


================================================================================
FILE: client/src/components/GrantEditModal.js
SIZE: 11446 bytes
================================================================================

import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { XMarkIcon } from '@heroicons/react/24/outline';

const GrantEditModal = ({ grant, onClose, onSave, darkMode }) => {
  const [formData, setFormData] = useState({
    grant_name: '',
    funding_organization: '',
    country_region: '',
    eligibility_criteria: '',
    focus_areas: '',
    grant_amount: '',
    application_deadline: '',
    duration: '',
    website_link: '',
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  useEffect(() => {
    if (grant) {
      // Convert date to YYYY-MM-DD format for input
      const deadline = grant.application_deadline
        ? new Date(grant.application_deadline).toISOString().split('T')[0]
        : '';

      setFormData({
        ...grant,
        application_deadline: deadline,
      });
    }
  }, [grant]);

  const handleChange = e => {
    setFormData({
      ...formData,
      [e.target.name]: e.target.value,
    });
  };

  const handleSubmit = async e => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const token = localStorage.getItem('authToken');
      const headers = token ? { Authorization: `Bearer ${token}` } : {};

      if (grant) {
        // Update existing grant
        await axios.put(`/.netlify/functions/grants/${grant.id}`, formData, { headers });
      } else {
        // Create new grant
        await axios.post('/.netlify/functions/grants', formData, { headers });
      }
      onSave();
    } catch (error) {
      console.error('Failed to save grant:', error);
      setError(error.response?.data?.error || 'Failed to save grant');
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 z-50 overflow-y-auto">
      <div className="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div className="fixed inset-0 transition-opacity" onClick={onClose}>
          <div className="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>

        <div
          className={`inline-block align-bottom rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full ${
            darkMode ? 'bg-gray-800' : 'bg-white'
          }`}
        >
          <div className={`px-4 pt-5 pb-4 sm:p-6 sm:pb-4 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
            <div className="flex justify-between items-center mb-4">
              <h3 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {grant ? 'Edit Grant' : 'Add New Grant'}
              </h3>
              <button
                onClick={onClose}
                className={`${darkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-500 hover:text-gray-700'}`}
              >
                <XMarkIcon className="h-6 w-6" />
              </button>
            </div>

            {error && (
              <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
                <p className="text-red-800">{error}</p>
              </div>
            )}

            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label
                    className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
                  >
                    Grant Name *
                  </label>
                  <input
                    type="text"
                    name="grant_name"
                    value={formData.grant_name}
                    onChange={handleChange}
                    required
                    className={`w-full px-3 py-2 rounded-md border ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white'
                        : 'bg-white border-gray-300 text-gray-900'
                    } focus:ring-2 focus:ring-blue-500`}
                  />
                </div>

                <div>
                  <label
                    className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
                  >
                    Funding Organization *
                  </label>
                  <input
                    type="text"
                    name="funding_organization"
                    value={formData.funding_organization}
                    onChange={handleChange}
                    required
                    className={`w-full px-3 py-2 rounded-md border ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white'
                        : 'bg-white border-gray-300 text-gray-900'
                    } focus:ring-2 focus:ring-blue-500`}
                  />
                </div>

                <div>
                  <label
                    className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
                  >
                    Country/Region
                  </label>
                  <input
                    type="text"
                    name="country_region"
                    value={formData.country_region}
                    onChange={handleChange}
                    className={`w-full px-3 py-2 rounded-md border ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white'
                        : 'bg-white border-gray-300 text-gray-900'
                    } focus:ring-2 focus:ring-blue-500`}
                  />
                </div>

                <div>
                  <label
                    className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
                  >
                    Grant Amount
                  </label>
                  <input
                    type="text"
                    name="grant_amount"
                    value={formData.grant_amount}
                    onChange={handleChange}
                    placeholder="e.g., $10,000 - $50,000"
                    className={`w-full px-3 py-2 rounded-md border ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white'
                        : 'bg-white border-gray-300 text-gray-900'
                    } focus:ring-2 focus:ring-blue-500`}
                  />
                </div>

                <div>
                  <label
                    className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
                  >
                    Application Deadline
                  </label>
                  <input
                    type="date"
                    name="application_deadline"
                    value={formData.application_deadline}
                    onChange={handleChange}
                    className={`w-full px-3 py-2 rounded-md border ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white'
                        : 'bg-white border-gray-300 text-gray-900'
                    } focus:ring-2 focus:ring-blue-500`}
                  />
                </div>

                <div>
                  <label
                    className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
                  >
                    Duration
                  </label>
                  <input
                    type="text"
                    name="duration"
                    value={formData.duration}
                    onChange={handleChange}
                    placeholder="e.g., 12 months"
                    className={`w-full px-3 py-2 rounded-md border ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white'
                        : 'bg-white border-gray-300 text-gray-900'
                    } focus:ring-2 focus:ring-blue-500`}
                  />
                </div>
              </div>

              <div>
                <label
                  className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
                >
                  Focus Areas
                </label>
                <textarea
                  name="focus_areas"
                  value={formData.focus_areas}
                  onChange={handleChange}
                  rows={2}
                  className={`w-full px-3 py-2 rounded-md border ${
                    darkMode
                      ? 'bg-gray-700 border-gray-600 text-white'
                      : 'bg-white border-gray-300 text-gray-900'
                  } focus:ring-2 focus:ring-blue-500`}
                />
              </div>

              <div>
                <label
                  className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
                >
                  Eligibility Criteria
                </label>
                <textarea
                  name="eligibility_criteria"
                  value={formData.eligibility_criteria}
                  onChange={handleChange}
                  rows={3}
                  className={`w-full px-3 py-2 rounded-md border ${
                    darkMode
                      ? 'bg-gray-700 border-gray-600 text-white'
                      : 'bg-white border-gray-300 text-gray-900'
                  } focus:ring-2 focus:ring-blue-500`}
                />
              </div>

              <div>
                <label
                  className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
                >
                  Website Link
                </label>
                <input
                  type="text"
                  name="website_link"
                  value={formData.website_link}
                  onChange={handleChange}
                  placeholder="https://..."
                  className={`w-full px-3 py-2 rounded-md border ${
                    darkMode
                      ? 'bg-gray-700 border-gray-600 text-white'
                      : 'bg-white border-gray-300 text-gray-900'
                  } focus:ring-2 focus:ring-blue-500`}
                />
              </div>

              <div className="flex justify-end space-x-3 pt-4">
                <button
                  type="button"
                  onClick={onClose}
                  className={`px-4 py-2 rounded-md ${
                    darkMode
                      ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  } transition-colors`}
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={loading}
                  className={`px-4 py-2 rounded-md text-white ${
                    loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'
                  } transition-colors`}
                >
                  {loading ? 'Saving...' : grant ? 'Update Grant' : 'Add Grant'}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  );
};

export default GrantEditModal;



================================================================================
FILE: client/src/components/GrantInsights.js
SIZE: 13731 bytes
================================================================================

import React, { useContext, useEffect, useState } from 'react';
import { useTranslation } from 'react-i18next';
import { ThemeContext } from '../context/ThemeContext';
import { 
  LightBulbIcon, ChartBarIcon, CalendarIcon, 
  ExclamationTriangleIcon, CheckCircleIcon, ArrowTrendingUpIcon 
} from '@heroicons/react/24/outline';
import axios from 'axios';

const GrantInsights = ({ grant }) => {
  const { darkMode } = useContext(ThemeContext);
  const { t } = useTranslation();
  const [insights, setInsights] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (grant) {
      generateInsights();
    }
  }, [grant]);

  const generateInsights = async () => {
    try {
      // Generate local insights first
      const localInsights = analyzeGrant(grant);
      setInsights(localInsights);

      // If AI is available, enhance with AI insights
      if (process.env.REACT_APP_GOOGLE_GEMINI_API_KEY) {
        const aiInsights = await getAIInsights(grant);
        if (aiInsights) {
          setInsights({ ...localInsights, ...aiInsights });
        }
      }
    } catch (error) {
      console.error('Failed to generate insights:', error);
    } finally {
      setLoading(false);
    }
  };

  const analyzeGrant = (grant) => {
    const insights = {
      deadline: analyzeDeadline(grant.application_deadline),
      competition: analyzeCompetition(grant),
      fundingSize: analyzeFundingSize(grant.grant_amount),
      complexity: analyzeComplexity(grant),
      recommendations: generateRecommendations(grant),
      strengths: identifyStrengths(grant),
      warnings: identifyWarnings(grant)
    };

    return insights;
  };

  const analyzeDeadline = (deadline) => {
    if (!deadline) return { status: 'unknown', urgency: 'low' };

    const now = new Date();
    const deadlineDate = new Date(deadline);
    const daysUntil = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));

    if (daysUntil < 0) {
      return { status: 'expired', urgency: 'none', daysUntil };
    } else if (daysUntil <= 7) {
      return { status: 'urgent', urgency: 'critical', daysUntil };
    } else if (daysUntil <= 30) {
      return { status: 'soon', urgency: 'high', daysUntil };
    } else if (daysUntil <= 90) {
      return { status: 'upcoming', urgency: 'medium', daysUntil };
    } else {
      return { status: 'future', urgency: 'low', daysUntil };
    }
  };

  const analyzeCompetition = (grant) => {
    // Estimate competition based on various factors
    let competitionScore = 50; // Base score

    // Popular organizations tend to have more competition
    const popularOrgs = ['European Union', 'USAID', 'UN', 'World Bank'];
    if (popularOrgs.some(org => grant.funding_organization?.includes(org))) {
      competitionScore += 20;
    }

    // Larger grants attract more competition
    if (grant.grant_amount?.includes('million') || grant.grant_amount?.includes('M')) {
      competitionScore += 15;
    }

    // Broad focus areas have more competition
    if (grant.focus_areas?.split(',').length > 5) {
      competitionScore -= 10; // Less focused = easier
    }

    // View count indicates popularity
    if (grant.view_count > 100) {
      competitionScore += 10;
    }

    return {
      level: competitionScore > 70 ? 'high' : competitionScore > 40 ? 'medium' : 'low',
      score: competitionScore
    };
  };

  const analyzeFundingSize = (grantAmount) => {
    if (!grantAmount) return { category: 'unknown' };

    const amount = grantAmount.toLowerCase();
    
    if (amount.includes('million') || amount.includes('mâ‚¬') || amount.includes('m$')) {
      return { category: 'large', suitable: ['established-orgs', 'consortiums'] };
    } else if (amount.includes('kâ‚¬') || amount.includes('k$') || 
               (amount.match(/\d+/) && parseInt(amount.match(/\d+/)[0]) > 50000)) {
      return { category: 'medium', suitable: ['established-orgs', 'growing-orgs'] };
    } else {
      return { category: 'small', suitable: ['startups', 'small-orgs', 'individuals'] };
    }
  };

  const analyzeComplexity = (grant) => {
    let complexityScore = 0;

    // Check required documents
    if (grant.required_documents) {
      const docCount = grant.required_documents.split(',').length;
      complexityScore += docCount * 5;
    }

    // Check evaluation criteria
    if (grant.evaluation_criteria) {
      complexityScore += 15;
    }

    // Check reporting requirements
    if (grant.reporting_requirements?.includes('monthly') || 
        grant.reporting_requirements?.includes('quarterly')) {
      complexityScore += 20;
    }

    // Partnership requirements add complexity
    if (grant.partnership_requirements) {
      complexityScore += 25;
    }

    return {
      level: complexityScore > 50 ? 'high' : complexityScore > 25 ? 'medium' : 'low',
      score: complexityScore,
      timeEstimate: complexityScore > 50 ? '2-4 weeks' : complexityScore > 25 ? '1-2 weeks' : '3-7 days'
    };
  };

  const generateRecommendations = (grant) => {
    const recommendations = [];

    // Deadline-based recommendations
    const deadline = analyzeDeadline(grant.application_deadline);
    if (deadline.urgency === 'critical') {
      recommendations.push({
        type: 'urgent',
        text: t('insights.startImmediately'),
        priority: 'high'
      });
    }

    // Complexity-based recommendations
    const complexity = analyzeComplexity(grant);
    if (complexity.level === 'high') {
      recommendations.push({
        type: 'preparation',
        text: t('insights.startEarly'),
        priority: 'medium'
      });
    }

    // Partnership recommendations
    if (grant.partnership_requirements) {
      recommendations.push({
        type: 'partnership',
        text: t('insights.findPartners'),
        priority: 'high'
      });
    }

    return recommendations;
  };

  const identifyStrengths = (grant) => {
    const strengths = [];

    if (grant.renewable) {
      strengths.push(t('insights.renewableGrant'));
    }

    if (!grant.application_fee) {
      strengths.push(t('insights.noApplicationFee'));
    }

    if (grant.language_requirements?.includes('English') && 
        grant.language_requirements?.includes('Ukrainian')) {
      strengths.push(t('insights.multilingualSupport'));
    }

    return strengths;
  };

  const identifyWarnings = (grant) => {
    const warnings = [];

    const deadline = analyzeDeadline(grant.application_deadline);
    if (deadline.status === 'expired') {
      warnings.push({
        type: 'critical',
        text: t('insights.grantExpired')
      });
    } else if (deadline.urgency === 'critical') {
      warnings.push({
        type: 'urgent',
        text: t('insights.deadlineSoon', { days: deadline.daysUntil })
      });
    }

    if (grant.application_fee) {
      warnings.push({
        type: 'info',
        text: t('insights.applicationFeeRequired', { fee: grant.application_fee })
      });
    }

    return warnings;
  };

  const getAIInsights = async (grant) => {
    try {
      const prompt = `Analyze this grant and provide strategic insights:
        Name: ${grant.grant_name}
        Organization: ${grant.funding_organization}
        Focus: ${grant.focus_areas}
        Amount: ${grant.grant_amount}
        Eligibility: ${grant.eligibility_criteria}
        
        Provide brief insights on:
        1. Key success factors for this grant
        2. Common mistakes to avoid
        3. Strategic positioning tips`;

      const response = await axios.post('/.netlify/functions/chat', {
        message: prompt,
        context: 'grant_analysis'
      });

      if (response.data.insights) {
        return response.data.insights;
      }
    } catch (error) {
      console.error('AI insights failed:', error);
    }
    return null;
  };

  if (loading) {
    return (
      <div className={`p-6 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
        <div className="animate-pulse">
          <div className="h-6 bg-gray-300 rounded w-1/3 mb-4"></div>
          <div className="space-y-3">
            <div className="h-4 bg-gray-300 rounded w-3/4"></div>
            <div className="h-4 bg-gray-300 rounded w-2/3"></div>
          </div>
        </div>
      </div>
    );
  }

  if (!insights) return null;

  return (
    <div className={`p-6 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
      <div className="flex items-center mb-6">
        <LightBulbIcon className="h-6 w-6 text-yellow-500 mr-2" />
        <h3 className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
          {t('insights.title')}
        </h3>
      </div>

      {/* Warnings */}
      {insights.warnings && insights.warnings.length > 0 && (
        <div className="mb-6">
          {insights.warnings.map((warning, index) => (
            <div
              key={index}
              className={`p-4 rounded-lg mb-2 flex items-start ${
                warning.type === 'critical' 
                  ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                  : warning.type === 'urgent'
                  ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'
                  : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
              }`}
            >
              <ExclamationTriangleIcon className="h-5 w-5 mr-2 flex-shrink-0 mt-0.5" />
              <span>{warning.text}</span>
            </div>
          ))}
        </div>
      )}

      {/* Key Metrics */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
          <div className="flex items-center mb-2">
            <CalendarIcon className="h-5 w-5 mr-2 text-blue-500" />
            <span className={`text-sm font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
              {t('insights.deadline')}
            </span>
          </div>
          <p className={`text-lg font-bold ${
            insights.deadline.urgency === 'critical' ? 'text-red-500' :
            insights.deadline.urgency === 'high' ? 'text-yellow-500' :
            'text-green-500'
          }`}>
            {insights.deadline.status === 'expired' ? t('insights.expired') :
             insights.deadline.daysUntil === 0 ? t('insights.today') :
             insights.deadline.daysUntil === 1 ? t('insights.tomorrow') :
             t('insights.daysRemaining', { days: insights.deadline.daysUntil })}
          </p>
        </div>

        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
          <div className="flex items-center mb-2">
            <ChartBarIcon className="h-5 w-5 mr-2 text-purple-500" />
            <span className={`text-sm font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
              {t('insights.competition')}
            </span>
          </div>
          <p className={`text-lg font-bold ${
            insights.competition.level === 'high' ? 'text-red-500' :
            insights.competition.level === 'medium' ? 'text-yellow-500' :
            'text-green-500'
          }`}>
            {t(`insights.competition${insights.competition.level.charAt(0).toUpperCase() + insights.competition.level.slice(1)}`)}
          </p>
        </div>

        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
          <div className="flex items-center mb-2">
            <ArrowTrendingUpIcon className="h-5 w-5 mr-2 text-green-500" />
            <span className={`text-sm font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
              {t('insights.complexity')}
            </span>
          </div>
          <p className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            {insights.complexity.timeEstimate}
          </p>
        </div>
      </div>

      {/* Strengths */}
      {insights.strengths && insights.strengths.length > 0 && (
        <div className={`p-4 rounded-lg mb-4 ${darkMode ? 'bg-green-900' : 'bg-green-50'}`}>
          <h4 className={`font-semibold mb-2 flex items-center ${darkMode ? 'text-green-200' : 'text-green-800'}`}>
            <CheckCircleIcon className="h-5 w-5 mr-2" />
            {t('insights.strengths')}
          </h4>
          <ul className={`list-disc list-inside space-y-1 ${darkMode ? 'text-green-300' : 'text-green-700'}`}>
            {insights.strengths.map((strength, index) => (
              <li key={index}>{strength}</li>
            ))}
          </ul>
        </div>
      )}

      {/* Recommendations */}
      {insights.recommendations && insights.recommendations.length > 0 && (
        <div>
          <h4 className={`font-semibold mb-3 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            {t('insights.recommendations')}
          </h4>
          <div className="space-y-2">
            {insights.recommendations.map((rec, index) => (
              <div
                key={index}
                className={`p-3 rounded-lg flex items-start ${
                  darkMode ? 'bg-gray-700' : 'bg-gray-50'
                }`}
              >
                <span className={`inline-block w-2 h-2 rounded-full mt-1.5 mr-3 ${
                  rec.priority === 'high' ? 'bg-red-500' :
                  rec.priority === 'medium' ? 'bg-yellow-500' :
                  'bg-green-500'
                }`}></span>
                <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                  {rec.text}
                </span>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

export default GrantInsights;


================================================================================
FILE: client/src/components/GrantsChatWidget.js
SIZE: 18317 bytes
================================================================================

import React, { useState, useRef, useEffect, useContext, useCallback } from 'react';
import { useTranslation } from 'react-i18next';
import { ThemeContext } from '../context/ThemeContext';
import { LanguageContext } from '../context/LanguageContext';
import axios from 'axios';
import {
  ChatBubbleLeftRightIcon,
  XMarkIcon,
  PaperAirplaneIcon,
  SparklesIcon,
  ExclamationTriangleIcon,
} from '@heroicons/react/24/outline';

const GrantsChatWidget = () => {
  const { t } = useTranslation();
  const { darkMode } = useContext(ThemeContext);
  const { language } = useContext(LanguageContext);
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState([]);
  const [inputValue, setInputValue] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isTyping, setIsTyping] = useState(false);
  const messagesEndRef = useRef(null);

  // Initial welcome message based on language
  const getWelcomeMessage = () => {
    const welcomeMessages = {
      en: {
        text: "ðŸ‘‹ Hello! I'm your AI-powered grants assistant specializing in funding opportunities for Ukrainian civil society organizations.\n\nðŸŽ¯ I can help you with:\nâ€¢ Finding grants that match your organization's focus\nâ€¢ Understanding eligibility criteria and requirements\nâ€¢ Tracking application deadlines and timelines\nâ€¢ Discovering funding amounts and program details\n\nðŸ’¡ Try asking me about specific areas like women's rights, youth programs, education, or human rights work!",
        suggestions: [
          'ðŸ›ï¸ Show me EU funding opportunities',
          "ðŸ‘©â€âš–ï¸ What grants support women's organizations?",
          'â° Which grants have deadlines this month?',
          'ðŸŽ“ Find education and youth funding',
          'ðŸ’° Show grants under â‚¬50,000',
        ],
      },
      uk: {
        text: 'ðŸ‘‹ ÐŸÑ€Ð¸Ð²Ñ–Ñ‚! Ð¯ Ð²Ð°Ñˆ AI-Ð¿Ð¾Ð¼Ñ–Ñ‡Ð½Ð¸Ðº Ð· Ð³Ñ€Ð°Ð½Ñ‚Ñ–Ð², Ñ‰Ð¾ ÑÐ¿ÐµÑ†Ñ–Ð°Ð»Ñ–Ð·ÑƒÑ”Ñ‚ÑŒÑÑ Ð½Ð° Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ÑÑ‚ÑÑ… Ñ„Ñ–Ð½Ð°Ð½ÑÑƒÐ²Ð°Ð½Ð½Ñ Ð´Ð»Ñ ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ¸Ñ… Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð°Ñ†Ñ–Ð¹ Ð³Ñ€Ð¾Ð¼Ð°Ð´ÑÐ½ÑÑŒÐºÐ¾Ð³Ð¾ ÑÑƒÑÐ¿Ñ–Ð»ÑŒÑÑ‚Ð²Ð°.\n\nðŸŽ¯ Ð¯ Ð¼Ð¾Ð¶Ñƒ Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð³Ñ‚Ð¸ Ð²Ð°Ð¼ Ð·:\nâ€¢ ÐŸÐ¾ÑˆÑƒÐºÐ¾Ð¼ Ð³Ñ€Ð°Ð½Ñ‚Ñ–Ð², Ñ‰Ð¾ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°ÑŽÑ‚ÑŒ Ñ„Ð¾ÐºÑƒÑÑƒ Ð²Ð°ÑˆÐ¾Ñ— Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð°Ñ†Ñ–Ñ—\nâ€¢ Ð Ð¾Ð·ÑƒÐ¼Ñ–Ð½Ð½ÑÐ¼ ÐºÑ€Ð¸Ñ‚ÐµÑ€Ñ–Ñ—Ð² Ð²Ñ–Ð´Ð±Ð¾Ñ€Ñƒ Ñ‚Ð° Ð²Ð¸Ð¼Ð¾Ð³\nâ€¢ Ð’Ñ–Ð´ÑÑ‚ÐµÐ¶ÐµÐ½Ð½ÑÐ¼ Ñ‚ÐµÑ€Ð¼Ñ–Ð½Ñ–Ð² Ð¿Ð¾Ð´Ð°Ñ‡Ñ– Ð·Ð°ÑÐ²Ð¾Ðº\nâ€¢ Ð’Ð¸ÑÐ²Ð»ÐµÐ½Ð½ÑÐ¼ ÑÑƒÐ¼ Ñ„Ñ–Ð½Ð°Ð½ÑÑƒÐ²Ð°Ð½Ð½Ñ Ñ‚Ð° Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼\n\nðŸ’¡ Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð¿Ð¸Ñ‚Ð°Ñ‚Ð¸ Ð¼ÐµÐ½Ðµ Ð¿Ñ€Ð¾ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ– ÑÑ„ÐµÑ€Ð¸, ÑÐº Ð¿Ñ€Ð°Ð²Ð° Ð¶Ñ–Ð½Ð¾Ðº, Ð¼Ð¾Ð»Ð¾Ð´Ñ–Ð¶Ð½Ñ– Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¸, Ð¾ÑÐ²Ñ–Ñ‚Ð° Ð°Ð±Ð¾ Ð¿Ñ€Ð°Ð²Ð¾Ð·Ð°Ñ…Ð¸ÑÐ½Ð° Ñ€Ð¾Ð±Ð¾Ñ‚Ð°!',
        suggestions: [
          'ðŸ›ï¸ ÐŸÐ¾ÐºÐ°Ð¶Ñ–Ñ‚ÑŒ Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ– Ñ„Ñ–Ð½Ð°Ð½ÑÑƒÐ²Ð°Ð½Ð½Ñ Ð²Ñ–Ð´ Ð„Ð¡',
          'ðŸ‘©â€âš–ï¸ Ð¯ÐºÑ– Ð³Ñ€Ð°Ð½Ñ‚Ð¸ Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÑƒÑŽÑ‚ÑŒ Ð¶Ñ–Ð½Ð¾Ñ‡Ñ– Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð°Ñ†Ñ–Ñ—?',
          'â° Ð¯ÐºÑ– Ð³Ñ€Ð°Ð½Ñ‚Ð¸ Ð¼Ð°ÑŽÑ‚ÑŒ Ñ‚ÐµÑ€Ð¼Ñ–Ð½Ð¸ Ñ†ÑŒÐ¾Ð³Ð¾ Ð¼Ñ–ÑÑÑ†Ñ?',
          'ðŸŽ“ Ð—Ð½Ð°Ð¹Ð´Ñ–Ñ‚ÑŒ Ñ„Ñ–Ð½Ð°Ð½ÑÑƒÐ²Ð°Ð½Ð½Ñ Ð¾ÑÐ²Ñ–Ñ‚Ð¸ Ñ‚Ð° Ð¼Ð¾Ð»Ð¾Ð´Ñ–',
          'ðŸ’° ÐŸÐ¾ÐºÐ°Ð¶Ñ–Ñ‚ÑŒ Ð³Ñ€Ð°Ð½Ñ‚Ð¸ Ð´Ð¾ â‚¬50,000',
        ],
      },
      de: {
        text: 'ðŸ‘‹ Hallo! Ich bin Ihr KI-gestÃ¼tzter FÃ¶rderungsassistent, spezialisiert auf FinanzierungsmÃ¶glichkeiten fÃ¼r ukrainische Zivilgesellschaftsorganisationen.\n\nðŸŽ¯ Ich kann Ihnen helfen bei:\nâ€¢ Finden von FÃ¶rderungen, die zu Ihrer Organisation passen\nâ€¢ Verstehen von Berechtigung und Anforderungen\nâ€¢ Verfolgen von Bewerbungsfristen\nâ€¢ Entdecken von FÃ¶rderbetrÃ¤gen und Programmdetails\n\nðŸ’¡ Fragen Sie mich gerne nach spezifischen Bereichen wie Frauenrechte, Jugendprogramme, Bildung oder Menschenrechtsarbeit!',
        suggestions: [
          'ðŸ›ï¸ Zeigen Sie mir EU-FÃ¶rdermÃ¶glichkeiten',
          'ðŸ‘©â€âš–ï¸ Welche FÃ¶rderungen unterstÃ¼tzen Frauenorganisationen?',
          'â° Welche FÃ¶rderungen haben Fristen diesen Monat?',
          'ðŸŽ“ Finden Sie Bildungs- und JugendfÃ¶rderung',
          'ðŸ’° Zeigen Sie FÃ¶rderungen unter â‚¬50.000',
        ],
      },
    };
    return welcomeMessages[language] || welcomeMessages.en;
  };

  useEffect(() => {
    if (isOpen && messages.length === 0) {
      const welcome = getWelcomeMessage();
      setMessages([
        {
          id: 1,
          type: 'bot',
          content: welcome.text,
          suggestions: welcome.suggestions,
          timestamp: new Date(),
        },
      ]);
    }
  }, [isOpen, language]);

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  const handleSendMessage = useCallback(
    async (messageText = inputValue) => {
      if (!messageText.trim() || isLoading) return;

      const userMessage = {
        id: Date.now(),
        type: 'user',
        content: messageText.trim(),
        timestamp: new Date(),
      };

      setMessages(prev => [...prev, userMessage]);
      setInputValue('');
      setIsLoading(true);
      setIsTyping(true);

      try {
        const response = await axios.post(
          '/.netlify/functions/chat',
          {
            message: messageText.trim(),
            language: language,
            conversationHistory: messages.slice(-5), // Send last 5 messages for context
          },
          {
            timeout: 30000, // 30 second timeout
          }
        );

        setIsTyping(false);

        const botMessage = {
          id: Date.now() + 1,
          type: 'bot',
          content: response.data.response || 'No response received',
          grants: response.data.recommendedGrants || [],
          suggestions: response.data.suggestions || [],
          timestamp: new Date(),
        };

        setMessages(prev => [...prev, botMessage]);
      } catch (error) {
        setIsTyping(false);
        console.error('Chat error:', error);

        const errorMessages = {
          en: "I'm sorry, I'm having trouble connecting right now. Please try again in a moment.",
          uk: 'Ð’Ð¸Ð±Ð°Ñ‡Ñ‚Ðµ, Ñƒ Ð¼ÐµÐ½Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð¸ Ð· Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½ÑÐ¼. Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ñ‰Ðµ Ñ€Ð°Ð· Ñ‡ÐµÑ€ÐµÐ· Ñ…Ð²Ð¸Ð»Ð¸Ð½Ñƒ.',
          de: 'Es tut mir leid, ich habe gerade Verbindungsprobleme. Bitte versuchen Sie es in einem Moment erneut.',
        };

        const errorMessage = {
          id: Date.now() + 1,
          type: 'bot',
          content: errorMessages[language] || errorMessages.en,
          error: true,
          timestamp: new Date(),
        };

        setMessages(prev => [...prev, errorMessage]);
      } finally {
        setIsLoading(false);
      }
    },
    [inputValue, isLoading, messages, language]
  );

  const handleSuggestionClick = suggestion => {
    handleSendMessage(suggestion);
  };

  const formatMessage = content => {
    // Simple markdown-like formatting
    return content
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>');
  };

  const formatTimestamp = timestamp => {
    return timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  };

  return (
    <>
      {/* Chat Toggle Button */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className={`fixed bottom-6 right-6 z-50 p-4 rounded-full shadow-lg transition-all duration-300 ${
          darkMode
            ? 'bg-blue-600 hover:bg-blue-700 text-white'
            : 'bg-blue-600 hover:bg-blue-700 text-white'
        } ${isOpen ? 'scale-95' : 'scale-100 hover:scale-110'}`}
        aria-label={t('chat.toggle')}
      >
        {isOpen ? (
          <XMarkIcon className="h-6 w-6" />
        ) : (
          <ChatBubbleLeftRightIcon className="h-6 w-6" />
        )}
      </button>

      {/* Chat Widget */}
      {isOpen && (
        <div
          className={`fixed bottom-24 right-6 md:right-6 z-40 w-[calc(100vw-3rem)] md:w-96 h-[calc(100vh-12rem)] md:h-[32rem] max-w-[calc(100vw-3rem)] md:max-w-[24rem] max-h-[calc(100vh-8rem)] rounded-xl shadow-2xl border backdrop-blur-sm transition-all duration-300 transform ${
            darkMode ? 'bg-gray-800/95 border-gray-700/50' : 'bg-white/95 border-gray-200/50'
          } 
        /* Mobile adjustments */
        left-6 md:left-auto right-6`}
        >
          {/* Chat Header */}
          <div
            className={`flex items-center justify-between p-4 border-b ${
              darkMode
                ? 'border-gray-700/50 bg-gradient-to-r from-gray-900/80 to-gray-800/80'
                : 'border-gray-200/50 bg-gradient-to-r from-blue-50/80 to-indigo-50/80'
            } rounded-t-xl backdrop-blur-sm`}
          >
            <div className="flex items-center space-x-3">
              <div
                className={`p-2 rounded-full ${darkMode ? 'bg-blue-500/20' : 'bg-blue-500/10'} animate-pulse`}
              >
                <SparklesIcon
                  className={`h-5 w-5 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}
                />
              </div>
              <div>
                <h3 className={`font-bold text-sm ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                  ðŸ¤– AI Grants Assistant
                </h3>
                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  Powered by Gemini AI
                </p>
              </div>
            </div>
            <button
              onClick={() => setIsOpen(false)}
              className={`p-1 rounded-full hover:bg-gray-200 ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'text-gray-500'}`}
            >
              <XMarkIcon className="h-4 w-4" />
            </button>
          </div>

          {/* Messages Area */}
          <div
            className={`flex-1 overflow-y-auto p-4 space-y-4 h-80 ${
              darkMode
                ? 'bg-gradient-to-b from-gray-800/50 to-gray-900/50'
                : 'bg-gradient-to-b from-gray-50/50 to-white/50'
            } backdrop-blur-sm`}
          >
            {messages.map(message => (
              <div
                key={message.id}
                className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'} animate-fadeIn`}
              >
                <div
                  className={`max-w-[90%] rounded-xl p-4 transition-all duration-200 hover:shadow-lg ${
                    message.type === 'user'
                      ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg'
                      : message.error
                        ? `${darkMode ? 'bg-red-900/80 text-red-200' : 'bg-red-100/80 text-red-800'} shadow-md`
                        : `${darkMode ? 'bg-gray-700/80 text-gray-100 border border-gray-600/30' : 'bg-white/80 text-gray-800 border border-gray-200/30'} shadow-md backdrop-blur-sm`
                  }`}
                >
                  <div dangerouslySetInnerHTML={{ __html: formatMessage(message.content) }} />

                  {/* Display recommended grants */}
                  {message.grants && message.grants.length > 0 && (
                    <div className="mt-4 space-y-3">
                      <div
                        className={`text-sm font-bold flex items-center gap-2 ${darkMode ? 'text-blue-300' : 'text-blue-700'}`}
                      >
                        ðŸŽ¯ {t('chat.recommendedGrants', 'Recommended Grants')}
                      </div>
                      {message.grants.slice(0, 3).map((grant, idx) => (
                        <div
                          key={idx}
                          className={`p-3 rounded-lg border transition-all duration-200 hover:shadow-md ${
                            darkMode
                              ? 'border-gray-500/30 bg-gray-600/30 hover:bg-gray-600/50'
                              : 'border-blue-200/50 bg-blue-50/30 hover:bg-blue-50/50'
                          }`}
                        >
                          <div className="font-semibold text-sm mb-1 flex items-start gap-2">
                            <span className="text-yellow-500">ðŸ’°</span>
                            {grant.grant_name}
                          </div>
                          <div
                            className={`text-xs mb-1 flex items-center gap-1 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}
                          >
                            <span>ðŸ›ï¸</span>
                            {grant.funding_organization}
                          </div>
                          {grant.application_deadline && (
                            <div
                              className={`text-xs flex items-center gap-1 ${darkMode ? 'text-blue-300' : 'text-blue-600'}`}
                            >
                              <span>â°</span>
                              {t('chat.deadline', 'Deadline')}: {grant.application_deadline}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Display suggestions */}
                  {message.suggestions && message.suggestions.length > 0 && (
                    <div className="mt-4 space-y-2">
                      <div
                        className={`text-sm font-semibold flex items-center gap-2 ${darkMode ? 'text-purple-300' : 'text-purple-700'}`}
                      >
                        ðŸ’¡ Quick suggestions:
                      </div>
                      {message.suggestions.map((suggestion, idx) => (
                        <button
                          key={idx}
                          onClick={() => handleSuggestionClick(suggestion)}
                          className={`block w-full text-left text-sm p-3 rounded-lg border transition-all duration-200 hover:scale-[1.02] hover:shadow-md ${
                            darkMode
                              ? 'border-purple-500/30 bg-purple-900/20 hover:bg-purple-800/30 text-purple-200'
                              : 'border-purple-200/50 bg-purple-50/30 hover:bg-purple-100/50 text-purple-700'
                          }`}
                        >
                          {suggestion}
                        </button>
                      ))}
                    </div>
                  )}

                  <div
                    className={`text-xs mt-1 opacity-50 ${message.type === 'user' ? 'text-right' : 'text-left'}`}
                  >
                    {formatTimestamp(message.timestamp)}
                  </div>
                </div>
              </div>
            ))}

            {/* Typing Indicator */}
            {isTyping && (
              <div className="flex justify-start">
                <div
                  className={`rounded-lg p-3 ${darkMode ? 'bg-gray-700' : 'bg-white shadow-sm'}`}
                >
                  <div className="flex space-x-1">
                    <div
                      className={`w-2 h-2 rounded-full animate-bounce ${darkMode ? 'bg-gray-400' : 'bg-gray-500'}`}
                    ></div>
                    <div
                      className={`w-2 h-2 rounded-full animate-bounce ${darkMode ? 'bg-gray-400' : 'bg-gray-500'}`}
                      style={{ animationDelay: '0.1s' }}
                    ></div>
                    <div
                      className={`w-2 h-2 rounded-full animate-bounce ${darkMode ? 'bg-gray-400' : 'bg-gray-500'}`}
                      style={{ animationDelay: '0.2s' }}
                    ></div>
                  </div>
                </div>
              </div>
            )}

            <div ref={messagesEndRef} />
          </div>

          {/* Input Area */}
          <div
            className={`border-t p-4 ${darkMode ? 'border-gray-700/50 bg-gradient-to-r from-gray-900/80 to-gray-800/80' : 'border-gray-200/50 bg-gradient-to-r from-white/80 to-gray-50/80'} rounded-b-xl backdrop-blur-sm`}
          >
            <div className="flex space-x-3 items-end">
              <div className="flex-1">
                <input
                  type="text"
                  value={inputValue}
                  onChange={e => setInputValue(e.target.value)}
                  onKeyPress={e => e.key === 'Enter' && !isLoading && handleSendMessage()}
                  placeholder={t('chat.placeholder', 'ðŸ’¬ Ask about grants, funding, deadlines...')}
                  disabled={isLoading}
                  className={`w-full p-3 text-sm rounded-xl border-2 transition-all duration-200 ${
                    darkMode
                      ? 'bg-gray-700/80 border-gray-600/50 text-white placeholder-gray-400 focus:border-blue-400/50 focus:bg-gray-700'
                      : 'bg-white/80 border-gray-300/50 text-gray-900 placeholder-gray-500 focus:border-blue-500/50 focus:bg-white'
                  } focus:ring-2 focus:ring-blue-500/20 disabled:opacity-50 backdrop-blur-sm`}
                />
                {isLoading && (
                  <div
                    className={`text-xs mt-1 flex items-center gap-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}
                  >
                    <div className="animate-pulse">ðŸ¤–</div>
                    AI is thinking...
                  </div>
                )}
              </div>
              <button
                onClick={() => handleSendMessage()}
                disabled={!inputValue.trim() || isLoading}
                className={`p-3 rounded-xl transition-all duration-200 transform hover:scale-105 ${
                  !inputValue.trim() || isLoading
                    ? 'bg-gray-300/50 cursor-not-allowed'
                    : 'bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 shadow-lg'
                } text-white`}
              >
                {isLoading ? (
                  <div className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                ) : (
                  <PaperAirplaneIcon className="h-4 w-4" />
                )}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
};

export default GrantsChatWidget;



================================================================================
FILE: client/src/components/Header.js
SIZE: 13688 bytes
================================================================================

import React, { useContext, useState, useEffect } from 'react';
import { Link, useLocation } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { LanguageContext } from '../context/LanguageContext';
import { ThemeContext } from '../context/ThemeContext';

const Header = () => {
  const { t } = useTranslation();
  const { language, changeLanguage } = useContext(LanguageContext);
  const { darkMode, toggleDarkMode } = useContext(ThemeContext);
  const location = useLocation();
  const [scrolled, setScrolled] = useState(false);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

  // Handle scroll effect for sticky header
  useEffect(() => {
    const handleScroll = () => {
      const isScrolled = window.scrollY > 10;
      if (isScrolled !== scrolled) {
        setScrolled(isScrolled);
      }
    };

    window.addEventListener('scroll', handleScroll);
    return () => {
      window.removeEventListener('scroll', handleScroll);
    };
  }, [scrolled]);

  // Check if link is active
  const isActive = path => {
    return location.pathname === path;
  };

  return (
    <>
      {/* Skip navigation link for accessibility */}
      <a
        href="#main-content"
        className="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-blue-600 text-white px-4 py-2 rounded-md z-50"
      >
        {t('skipToMain', 'Skip to main content')}
      </a>
      
      <header
        className={`${darkMode ? 'bg-gray-900 text-white' : 'bg-white text-gray-800'} 
          ${scrolled ? 'shadow-lg' : 'shadow-md'} 
          sticky top-0 z-30 transition-all duration-300 ease-in-out`}
        role="banner"
      >
      <div className="container mx-auto px-4 py-3">
        <div className="flex justify-between items-center">
          {/* Logo */}
          <div className="flex items-center">
            <Link to="/" className="flex items-center" aria-label={t('homePageLink', 'Go to homepage')}>
              <img
                src="/images/ukraine-grants-logo.png"
                alt="Ukrainian Civil Society Grants Database"
                className="h-10 w-auto"
                style={{ maxWidth: '240px' }}
              />
            </Link>
          </div>

          {/* Desktop Navigation */}
          <nav className="hidden md:flex items-center space-x-4" role="navigation" aria-label={t('mainNavigation', 'Main navigation')}>
            {[
              { path: '/', label: t('navigation.home') },
              { path: '/grants', label: t('navigation.grants') },
              { path: '/blog', label: t('navigation.blog', 'Blog') },
              { path: '/about', label: t('navigation.about') },
              { path: '/admin', label: t('navigation.admin') },
            ].map(item => (
              <Link
                key={item.path}
                to={item.path}
                className={`px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200 
                  ${
                    isActive(item.path)
                      ? `${darkMode ? 'bg-gray-800 text-white' : 'bg-blue-100 text-blue-700'}`
                      : `${darkMode ? 'text-gray-300 hover:bg-gray-800 hover:text-white' : 'text-gray-700 hover:bg-gray-100 hover:text-blue-600'}`
                  }`}
              >
                {item.label}
              </Link>
            ))}

            {/* Theme Toggle */}
            <button
              onClick={toggleDarkMode}
              className={`p-2 rounded-full transition-colors duration-200 ${darkMode ? 'bg-gray-800 text-yellow-300 hover:bg-gray-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
              aria-label="Toggle dark mode"
            >
              {darkMode ? (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                  />
                </svg>
              ) : (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                  />
                </svg>
              )}
            </button>

            {/* Language Selector */}
            <div className="relative ml-3 border-l border-gray-300 dark:border-gray-700 pl-3 flex items-center">
              <div className="flex items-center space-x-2">
                <button
                  onClick={() => changeLanguage('en')}
                  className={`px-2 py-1 rounded text-sm transition-colors duration-200 ${
                    language === 'en'
                      ? `${darkMode ? 'bg-gray-800 text-white font-bold' : 'bg-blue-100 text-blue-700 font-bold'}`
                      : `${darkMode ? 'text-gray-300 hover:text-white' : 'text-gray-700 hover:text-blue-600'}`
                  }`}
                >
                  {t('languages.en')}
                </button>
                <span className={`${darkMode ? 'text-gray-600' : 'text-gray-400'}`}>|</span>
                <button
                  onClick={() => changeLanguage('uk')}
                  className={`px-2 py-1 rounded text-sm transition-colors duration-200 ${
                    language === 'uk'
                      ? `${darkMode ? 'bg-gray-800 text-white font-bold' : 'bg-blue-100 text-blue-700 font-bold'}`
                      : `${darkMode ? 'text-gray-300 hover:text-white' : 'text-gray-700 hover:text-blue-600'}`
                  }`}
                >
                  {t('languages.uk')}
                </button>
              </div>
            </div>
          </nav>

          {/* Mobile menu button */}
          <div className="flex md:hidden items-center space-x-2">
            {/* Mobile Language Switcher - Always Visible */}
            <div className="flex items-center space-x-1 text-sm">
              <button
                onClick={() => changeLanguage('en')}
                className={`px-2 py-1 rounded ${
                  language === 'en'
                    ? `${darkMode ? 'bg-gray-800 text-white font-bold' : 'bg-blue-100 text-blue-700 font-bold'}`
                    : `${darkMode ? 'text-gray-300' : 'text-gray-700'}`
                }`}
                aria-label="Switch to English"
              >
                EN
              </button>
              <span className={`${darkMode ? 'text-gray-600' : 'text-gray-400'} text-xs`}>|</span>
              <button
                onClick={() => changeLanguage('uk')}
                className={`px-2 py-1 rounded ${
                  language === 'uk'
                    ? `${darkMode ? 'bg-gray-800 text-white font-bold' : 'bg-blue-100 text-blue-700 font-bold'}`
                    : `${darkMode ? 'text-gray-300' : 'text-gray-700'}`
                }`}
                aria-label="Switch to Ukrainian"
              >
                UK
              </button>
            </div>

            <button
              onClick={toggleDarkMode}
              className={`p-2 rounded-full transition-colors duration-200 ${darkMode ? 'bg-gray-800 text-yellow-300' : 'bg-gray-100 text-gray-700'}`}
              aria-label="Toggle dark mode"
            >
              {darkMode ? (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                  />
                </svg>
              ) : (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                  />
                </svg>
              )}
            </button>

            <button
              type="button"
              onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
              className={`inline-flex items-center justify-center p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 ${darkMode ? 'text-gray-300 hover:text-white hover:bg-gray-700' : 'text-gray-700 hover:text-blue-600 hover:bg-gray-100'}`}
              aria-controls="mobile-menu"
              aria-expanded={mobileMenuOpen}
              data-testid="mobile-menu-button"
            >
              <span className="sr-only">Open main menu</span>
              {mobileMenuOpen ? (
                <svg
                  className="block h-6 w-6"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  aria-hidden="true"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              ) : (
                <svg
                  className="block h-6 w-6"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  aria-hidden="true"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d="M4 6h16M4 12h16M4 18h16"
                  />
                </svg>
              )}
            </button>
          </div>
        </div>
      </div>

      {/* Mobile menu */}
      <div
        className={`${mobileMenuOpen ? 'block' : 'hidden'} md:hidden transition-all duration-300 ease-in-out`}
        id="mobile-menu"
      >
        <div className={`px-2 pt-2 pb-3 space-y-1 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
          {[
            { path: '/', label: t('navigation.home') },
            { path: '/grants', label: t('navigation.grants') },
            { path: '/blog', label: t('navigation.blog', 'Blog') },
            { path: '/about', label: t('navigation.about') },
            { path: '/admin', label: t('navigation.admin') },
          ].map(item => (
            <Link
              key={item.path}
              to={item.path}
              className={`block px-3 py-2 rounded-md text-base font-medium ${
                isActive(item.path)
                  ? `${darkMode ? 'bg-gray-800 text-white' : 'bg-blue-100 text-blue-700'}`
                  : `${darkMode ? 'text-gray-300 hover:bg-gray-800 hover:text-white' : 'text-gray-700 hover:bg-gray-100 hover:text-blue-600'}`
              }`}
              onClick={() => setMobileMenuOpen(false)}
            >
              {item.label}
            </Link>
          ))}

          {/* Language Selector for Mobile */}
          <div className="flex items-center space-x-2 px-3 py-2 border-t border-gray-300 dark:border-gray-700 mt-2 pt-2">
            <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
              {t('languages')}
            </span>
            <button
              onClick={() => {
                changeLanguage('en');
                setMobileMenuOpen(false);
              }}
              className={`px-2 py-1 rounded text-sm transition-colors duration-200 ${
                language === 'en'
                  ? `${darkMode ? 'bg-gray-800 text-white font-bold' : 'bg-blue-100 text-blue-700 font-bold'}`
                  : `${darkMode ? 'text-gray-300 hover:text-white' : 'text-gray-700 hover:text-blue-600'}`
              }`}
            >
              {t('languages.en')}
            </button>
            <button
              onClick={() => {
                changeLanguage('uk');
                setMobileMenuOpen(false);
              }}
              className={`px-2 py-1 rounded text-sm transition-colors duration-200 ${
                language === 'uk'
                  ? `${darkMode ? 'bg-gray-800 text-white font-bold' : 'bg-blue-100 text-blue-700 font-bold'}`
                  : `${darkMode ? 'text-gray-300 hover:text-white' : 'text-gray-700 hover:text-blue-600'}`
              }`}
            >
              {t('languages.uk')}
            </button>
          </div>
        </div>
      </div>
      </header>
    </>
  );
};

export default Header;



================================================================================
FILE: client/src/components/LoadingSkeleton.js
SIZE: 9226 bytes
================================================================================

import React, { useContext } from 'react';
import { ThemeContext } from '../context/ThemeContext';

const LoadingSkeleton = ({ type = 'grant-card', count = 3 }) => {
  const { darkMode } = useContext(ThemeContext);

  const GrantCardSkeleton = () => (
    <div
      className={`rounded-2xl overflow-hidden ${
        darkMode
          ? 'bg-gray-800/50 backdrop-blur border border-gray-700/50'
          : 'bg-white/80 backdrop-blur border border-gray-200/50'
      } animate-pulse`}
    >
      <div className="p-6">
        <div className="flex justify-between items-start mb-4">
          <div className="flex items-start space-x-4 flex-1">
            {/* Logo skeleton */}
            <div
              className={`flex-shrink-0 w-14 h-14 rounded-xl ${
                darkMode ? 'bg-gray-700' : 'bg-gray-200'
              }`}
            />
            <div className="flex-1">
              {/* Title skeleton */}
              <div
                className={`h-6 ${
                  darkMode ? 'bg-gray-700' : 'bg-gray-200'
                } rounded-md mb-2 w-3/4`}
              />
              {/* Organization skeleton */}
              <div
                className={`h-4 ${
                  darkMode ? 'bg-gray-700' : 'bg-gray-200'
                } rounded-md w-1/2`}
              />
            </div>
          </div>
          {/* Status badge skeleton */}
          <div
            className={`ml-4 w-24 h-6 rounded-full ${
              darkMode ? 'bg-gray-700' : 'bg-gray-200'
            }`}
          />
        </div>

        {/* Pills skeleton */}
        <div className="flex flex-wrap gap-2 mb-4">
          {[1, 2, 3, 4].map((i) => (
            <div
              key={i}
              className={`h-8 rounded-full ${
                darkMode ? 'bg-gray-700' : 'bg-gray-200'
              }`}
              style={{ width: `${60 + Math.random() * 40}px` }}
            />
          ))}
        </div>

        {/* Description skeletons */}
        <div className="space-y-3 mb-4">
          <div>
            <div
              className={`h-4 ${
                darkMode ? 'bg-gray-700' : 'bg-gray-200'
              } rounded mb-2`}
            />
            <div
              className={`h-4 ${
                darkMode ? 'bg-gray-700' : 'bg-gray-200'
              } rounded w-5/6`}
            />
          </div>
          <div>
            <div
              className={`h-4 ${
                darkMode ? 'bg-gray-700' : 'bg-gray-200'
              } rounded mb-2`}
            />
            <div
              className={`h-4 ${
                darkMode ? 'bg-gray-700' : 'bg-gray-200'
              } rounded w-4/6`}
            />
          </div>
        </div>

        {/* Action buttons skeleton */}
        <div className="flex justify-end items-center gap-3 mt-6">
          <div
            className={`h-10 w-24 rounded-lg ${
              darkMode ? 'bg-gray-700' : 'bg-gray-200'
            }`}
          />
          <div
            className={`h-10 w-28 rounded-xl ${
              darkMode ? 'bg-blue-800' : 'bg-blue-200'
            }`}
          />
        </div>
      </div>
    </div>
  );

  const StatCardSkeleton = () => (
    <div
      className={`relative overflow-hidden rounded-3xl p-8 ${
        darkMode
          ? 'bg-gradient-to-br from-gray-800 to-gray-700'
          : 'bg-gradient-to-br from-white to-gray-50'
      } shadow-xl border ${
        darkMode ? 'border-gray-700' : 'border-gray-200'
      } animate-pulse`}
    >
      <div className="relative z-10">
        <div
          className={`inline-flex p-3 rounded-2xl ${
            darkMode ? 'bg-gray-600' : 'bg-gray-200'
          } mb-4 w-14 h-14`}
        />
        <div
          className={`h-12 ${
            darkMode ? 'bg-gray-600' : 'bg-gray-200'
          } rounded mb-2 w-24`}
        />
        <div
          className={`h-6 ${
            darkMode ? 'bg-gray-600' : 'bg-gray-200'
          } rounded w-32`}
        />
      </div>
    </div>
  );

  const BlogCardSkeleton = () => (
    <div
      className={`rounded-2xl overflow-hidden ${
        darkMode
          ? 'bg-gray-800 border-gray-700'
          : 'bg-white border-gray-200'
      } border shadow-lg animate-pulse`}
    >
      {/* Image skeleton */}
      <div
        className={`h-48 ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}
      />
      <div className="p-6">
        {/* Title skeleton */}
        <div
          className={`h-6 ${
            darkMode ? 'bg-gray-700' : 'bg-gray-200'
          } rounded mb-3`}
        />
        {/* Excerpt skeleton */}
        <div className="space-y-2 mb-4">
          <div
            className={`h-4 ${
              darkMode ? 'bg-gray-700' : 'bg-gray-200'
            } rounded`}
          />
          <div
            className={`h-4 ${
              darkMode ? 'bg-gray-700' : 'bg-gray-200'
            } rounded w-5/6`}
          />
        </div>
        {/* Meta skeleton */}
        <div className="flex justify-between items-center">
          <div
            className={`h-4 w-24 ${
              darkMode ? 'bg-gray-700' : 'bg-gray-200'
            } rounded`}
          />
          <div
            className={`h-4 w-20 ${
              darkMode ? 'bg-gray-700' : 'bg-gray-200'
            } rounded`}
          />
        </div>
      </div>
    </div>
  );

  const TableRowSkeleton = () => (
    <tr className="animate-pulse">
      <td className="px-6 py-4">
        <div
          className={`h-5 ${
            darkMode ? 'bg-gray-700' : 'bg-gray-200'
          } rounded w-3/4`}
        />
      </td>
      <td className="px-6 py-4">
        <div
          className={`h-5 ${
            darkMode ? 'bg-gray-700' : 'bg-gray-200'
          } rounded w-1/2`}
        />
      </td>
      <td className="px-6 py-4">
        <div
          className={`h-6 w-24 rounded-full ${
            darkMode ? 'bg-gray-700' : 'bg-gray-200'
          }`}
        />
      </td>
      <td className="px-6 py-4 text-right">
        <div
          className={`h-5 w-12 ${
            darkMode ? 'bg-gray-700' : 'bg-gray-200'
          } rounded ml-auto`}
        />
      </td>
    </tr>
  );

  const DetailPageSkeleton = () => (
    <div className="animate-pulse">
      {/* Back button skeleton */}
      <div
        className={`h-5 w-32 ${
          darkMode ? 'bg-gray-700' : 'bg-gray-200'
        } rounded mb-6`}
      />

      <div
        className={`rounded-lg shadow-lg overflow-hidden border ${
          darkMode ? 'border-gray-700' : 'border-gray-200'
        }`}
      >
        {/* Header skeleton */}
        <div
          className={`px-6 py-4 ${
            darkMode ? 'bg-gray-800' : 'bg-blue-700'
          }`}
        >
          <div className="h-8 bg-white/20 rounded mb-2 w-3/4" />
          <div className="h-6 bg-white/10 rounded w-1/2" />
        </div>

        {/* Content skeleton */}
        <div className="p-6">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {[1, 2].map((col) => (
              <div key={col} className="space-y-4">
                {[1, 2, 3].map((i) => (
                  <div key={i}>
                    <div
                      className={`h-5 ${
                        darkMode ? 'bg-gray-700' : 'bg-gray-200'
                      } rounded mb-2 w-24`}
                    />
                    <div
                      className={`h-4 ${
                        darkMode ? 'bg-gray-600' : 'bg-gray-300'
                      } rounded w-full`}
                    />
                  </div>
                ))}
              </div>
            ))}
          </div>

          {/* Apply button skeleton */}
          <div className="mt-8 text-center">
            <div
              className={`h-12 w-32 ${
                darkMode ? 'bg-blue-800' : 'bg-blue-200'
              } rounded-lg mx-auto`}
            />
          </div>
        </div>
      </div>
    </div>
  );

  const renderSkeletons = () => {
    switch (type) {
      case 'grant-card':
        return Array.from({ length: count }).map((_, i) => (
          <GrantCardSkeleton key={i} />
        ));
      case 'stat-card':
        return Array.from({ length: count }).map((_, i) => (
          <StatCardSkeleton key={i} />
        ));
      case 'blog-card':
        return Array.from({ length: count }).map((_, i) => (
          <BlogCardSkeleton key={i} />
        ));
      case 'table-row':
        return Array.from({ length: count }).map((_, i) => (
          <TableRowSkeleton key={i} />
        ));
      case 'detail-page':
        return <DetailPageSkeleton />;
      default:
        return Array.from({ length: count }).map((_, i) => (
          <GrantCardSkeleton key={i} />
        ));
    }
  };

  if (type === 'table-row') {
    return <>{renderSkeletons()}</>;
  }

  if (type === 'detail-page') {
    return renderSkeletons();
  }

  return (
    <div
      className={
        type === 'stat-card'
          ? 'grid grid-cols-1 md:grid-cols-3 gap-8'
          : type === 'blog-card'
          ? 'grid grid-cols-1 md:grid-cols-3 gap-8'
          : 'space-y-4'
      }
    >
      {renderSkeletons()}
    </div>
  );
};

export default LoadingSkeleton;


================================================================================
FILE: client/src/components/ProtectedRoute.js
SIZE: 557 bytes
================================================================================

import { Navigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

const ProtectedRoute = ({ children }) => {
  const { isAuthenticated, loading } = useAuth();

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
      </div>
    );
  }

  if (!isAuthenticated) {
    return <Navigate to="/admin/login" replace />;
  }

  return children;
};

export default ProtectedRoute;



================================================================================
FILE: client/src/components/QuillEditor.js
SIZE: 3619 bytes
================================================================================

import React, { Suspense, memo } from 'react';
import { useQuillLoader, FallbackEditor } from '../hooks/useQuillLoader';

// Loading component
const LoadingEditor = ({ darkMode }) => (
  <div
    className={`w-full min-h-[200px] flex items-center justify-center border rounded-md ${
      darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-300'
    }`}
  >
    <div className="flex items-center space-x-2">
      <div
        className={`animate-spin rounded-full h-5 w-5 border-b-2 ${
          darkMode ? 'border-white' : 'border-gray-900'
        }`}
      ></div>
      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
        Loading rich text editor...
      </span>
    </div>
  </div>
);

// Error Boundary for Quill Editor
class QuillErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }

  componentDidCatch(error, errorInfo) {
    console.error('QuillEditor Error:', error, errorInfo);

    // You could also send this to an error reporting service
    if (this.props.onError) {
      this.props.onError(error, errorInfo);
    }
  }

  render() {
    if (this.state.hasError) {
      return (
        <FallbackEditor
          value={this.props.value}
          onChange={this.props.onChange}
          placeholder={this.props.placeholder}
          className={this.props.className}
          darkMode={this.props.darkMode}
        />
      );
    }

    return this.props.children;
  }
}

// Memoized Quill component to prevent unnecessary re-renders
const MemoizedQuill = memo(({ QuillComponent, ...props }) => {
  if (!QuillComponent) return null;

  return <QuillComponent {...props} />;
});

/**
 * Enhanced QuillEditor component with proper error handling and lazy loading
 */
const QuillEditor = ({
  value,
  onChange,
  modules,
  theme = 'snow',
  placeholder = 'Enter your content here...',
  className = '',
  darkMode = false,
  onError,
  ...props
}) => {
  const { isLoading, error, QuillComponent } = useQuillLoader();

  // Default modules if not provided
  const defaultModules = {
    toolbar: [
      [{ header: [1, 2, 3, false] }],
      ['bold', 'italic', 'underline', 'strike'],
      ['blockquote', 'code-block'],
      [{ list: 'ordered' }, { list: 'bullet' }],
      ['link', 'image'],
      ['clean'],
    ],
  };

  const editorModules = modules || defaultModules;

  // Show loading state
  if (isLoading) {
    return <LoadingEditor darkMode={darkMode} />;
  }

  // Show fallback if there was an error loading Quill
  if (error || !QuillComponent) {
    return (
      <FallbackEditor
        value={value}
        onChange={onChange}
        placeholder={placeholder}
        className={className}
        darkMode={darkMode}
      />
    );
  }

  return (
    <QuillErrorBoundary
      value={value}
      onChange={onChange}
      placeholder={placeholder}
      className={className}
      darkMode={darkMode}
      onError={onError}
    >
      <div className={darkMode ? 'quill-dark' : ''}>
        <Suspense fallback={<LoadingEditor darkMode={darkMode} />}>
          <MemoizedQuill
            QuillComponent={QuillComponent}
            theme={theme}
            value={value}
            onChange={onChange}
            modules={editorModules}
            placeholder={placeholder}
            className={className}
            {...props}
          />
        </Suspense>
      </div>
    </QuillErrorBoundary>
  );
};

export default memo(QuillEditor);



================================================================================
FILE: client/src/components/SEOHead.js
SIZE: 3678 bytes
================================================================================

import React from 'react';
import { Helmet } from 'react-helmet-async';
import { useTranslation } from 'react-i18next';

const SEOHead = ({
  title,
  description,
  keywords,
  ogImage,
  ogType = 'website',
  canonicalUrl,
  noindex = false,
  additionalMeta = [],
}) => {
  const { i18n } = useTranslation();
  const currentLanguage = i18n.language;
  
  // Default values
  const siteTitle = 'Civil Society Grants Database';
  const defaultDescription = currentLanguage === 'uk' 
    ? 'Ð—Ð½Ð°Ð¹Ð´Ñ–Ñ‚ÑŒ Ð³Ñ€Ð°Ð½Ñ‚Ð¸ Ð´Ð»Ñ Ð³Ñ€Ð¾Ð¼Ð°Ð´ÑÐ½ÑÑŒÐºÐ¾Ð³Ð¾ ÑÑƒÑÐ¿Ñ–Ð»ÑŒÑÑ‚Ð²Ð° Ð² Ð£ÐºÑ€Ð°Ñ—Ð½Ñ– Ñ‚Ð° Ð¼Ñ–Ð¶Ð½Ð°Ñ€Ð¾Ð´Ð½Ñ– Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ– Ñ„Ñ–Ð½Ð°Ð½ÑÑƒÐ²Ð°Ð½Ð½Ñ. ÐŸÐ¾Ð½Ð°Ð´ 107 Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¸Ñ… Ð³Ñ€Ð°Ð½Ñ‚Ñ–Ð² Ð½Ð° ÑÑƒÐ¼Ñƒ â‚¬63M+.'
    : 'Find grants for civil society in Ukraine and international funding opportunities. Over 107 active grants worth â‚¬63M+.';
  const defaultKeywords = currentLanguage === 'uk'
    ? 'Ð³Ñ€Ð°Ð½Ñ‚Ð¸ ÑƒÐºÑ€Ð°Ñ—Ð½Ð°, Ð³Ñ€Ð¾Ð¼Ð°Ð´ÑÐ½ÑÑŒÐºÐµ ÑÑƒÑÐ¿Ñ–Ð»ÑŒÑÑ‚Ð²Ð¾, Ñ„Ñ–Ð½Ð°Ð½ÑÑƒÐ²Ð°Ð½Ð½Ñ ÐÐ“Ðž, Ð¼Ñ–Ð¶Ð½Ð°Ñ€Ð¾Ð´Ð½Ñ– Ð³Ñ€Ð°Ð½Ñ‚Ð¸, Ñ”Ð²Ñ€Ð¾Ð¿ÐµÐ¹ÑÑŒÐºÑ– Ð³Ñ€Ð°Ð½Ñ‚Ð¸'
    : 'ukraine grants, civil society funding, NGO funding, international grants, european grants';
  const defaultOgImage = '/images/og-image-default.jpg';
  
  // Build full title
  const fullTitle = title ? `${title} | ${siteTitle}` : siteTitle;
  
  // Canonical URL
  const baseUrl = 'https://ukrainecivilsocietygrants.org';
  const canonical = canonicalUrl || `${baseUrl}${window.location.pathname}`;
  
  return (
    <Helmet>
      {/* Basic Meta Tags */}
      <html lang={currentLanguage} />
      <title>{fullTitle}</title>
      <meta name="description" content={description || defaultDescription} />
      <meta name="keywords" content={keywords || defaultKeywords} />
      
      {/* Canonical URL */}
      <link rel="canonical" href={canonical} />
      
      {/* Language Alternates */}
      <link rel="alternate" hreflang="en" href={`${baseUrl}/en${window.location.pathname.replace(/^\/[a-z]{2}/, '')}`} />
      <link rel="alternate" hreflang="uk" href={`${baseUrl}/uk${window.location.pathname.replace(/^\/[a-z]{2}/, '')}`} />
      <link rel="alternate" hreflang="x-default" href={`${baseUrl}${window.location.pathname.replace(/^\/[a-z]{2}/, '')}`} />
      
      {/* Open Graph Tags */}
      <meta property="og:title" content={fullTitle} />
      <meta property="og:description" content={description || defaultDescription} />
      <meta property="og:type" content={ogType} />
      <meta property="og:url" content={canonical} />
      <meta property="og:image" content={`${baseUrl}${ogImage || defaultOgImage}`} />
      <meta property="og:locale" content={currentLanguage === 'uk' ? 'uk_UA' : 'en_US'} />
      <meta property="og:site_name" content={siteTitle} />
      
      {/* Twitter Card Tags */}
      <meta name="twitter:card" content="summary_large_image" />
      <meta name="twitter:title" content={fullTitle} />
      <meta name="twitter:description" content={description || defaultDescription} />
      <meta name="twitter:image" content={`${baseUrl}${ogImage || defaultOgImage}`} />
      
      {/* Additional Tags */}
      <meta name="robots" content={noindex ? 'noindex,nofollow' : 'index,follow'} />
      <meta name="googlebot" content={noindex ? 'noindex,nofollow' : 'index,follow'} />
      
      {/* Geo Tags for Ukraine */}
      <meta name="geo.region" content="UA" />
      <meta name="geo.placename" content="Ukraine" />
      
      {/* Additional custom meta tags */}
      {additionalMeta.map((meta, index) => (
        <meta key={index} {...meta} />
      ))}
    </Helmet>
  );
};

export default SEOHead;


================================================================================
FILE: client/src/components/StructuredData.js
SIZE: 4705 bytes
================================================================================

import React from 'react';
import { Helmet } from 'react-helmet-async';

const StructuredData = ({ type, data }) => {
  const generateStructuredData = () => {
    switch (type) {
      case 'organization':
        return {
          "@context": "https://schema.org",
          "@type": "NGO",
          "name": "Civil Society Grants Database",
          "alternateName": "Ukraine Civil Society Grants",
          "url": "https://ukrainecivilsocietygrants.org",
          "logo": "https://ukrainecivilsocietygrants.org/logo512.png",
          "description": "Comprehensive database of grants and funding opportunities for civil society organizations in Ukraine",
          "address": {
            "@type": "PostalAddress",
            "streetAddress": "Prenlauer Alle 229",
            "addressLocality": "Berlin",
            "postalCode": "10405",
            "addressCountry": "DE"
          },
          "contactPoint": {
            "@type": "ContactPoint",
            "telephone": "+49-174-403-1399",
            "contactType": "customer service",
            "availableLanguage": ["English", "Ukrainian", "German"]
          },
          "sameAs": [
            "https://www.linkedin.com/in/fedo-hagge-kubat-36814415b/"
          ]
        };

      case 'grant':
        if (!data) return null;
        return {
          "@context": "https://schema.org",
          "@type": "Grant",
          "name": data.name,
          "description": data.description,
          "funder": {
            "@type": "Organization",
            "name": data.organization
          },
          "amount": data.amount ? {
            "@type": "MonetaryAmount",
            "value": data.amount,
            "currency": "EUR"
          } : undefined,
          "applicationDeadline": data.deadline,
          "eligibleRegion": data.region || "Ukraine",
          "url": data.url
        };

      case 'website':
        return {
          "@context": "https://schema.org",
          "@type": "WebSite",
          "url": "https://ukrainecivilsocietygrants.org",
          "name": "Civil Society Grants Database",
          "description": "Find grants for civil society organizations in Ukraine",
          "potentialAction": {
            "@type": "SearchAction",
            "target": {
              "@type": "EntryPoint",
              "urlTemplate": "https://ukrainecivilsocietygrants.org/grants?query={search_term_string}"
            },
            "query-input": "required name=search_term_string"
          },
          "inLanguage": ["en", "uk"],
          "publisher": {
            "@type": "Person",
            "name": "Fedo Hagge-Kubat"
          }
        };

      case 'breadcrumb':
        if (!data || !data.items) return null;
        return {
          "@context": "https://schema.org",
          "@type": "BreadcrumbList",
          "itemListElement": data.items.map((item, index) => ({
            "@type": "ListItem",
            "position": index + 1,
            "name": item.name,
            "item": `https://ukrainecivilsocietygrants.org${item.url}`
          }))
        };

      case 'faq':
        if (!data || !data.questions) return null;
        return {
          "@context": "https://schema.org",
          "@type": "FAQPage",
          "mainEntity": data.questions.map(q => ({
            "@type": "Question",
            "name": q.question,
            "acceptedAnswer": {
              "@type": "Answer",
              "text": q.answer
            }
          }))
        };

      case 'article':
        if (!data) return null;
        return {
          "@context": "https://schema.org",
          "@type": "Article",
          "headline": data.title,
          "description": data.description,
          "image": data.image,
          "author": {
            "@type": "Person",
            "name": data.author || "Civil Society Grants Team"
          },
          "publisher": {
            "@type": "Organization",
            "name": "Civil Society Grants Database",
            "logo": {
              "@type": "ImageObject",
              "url": "https://ukrainecivilsocietygrants.org/logo512.png"
            }
          },
          "datePublished": data.datePublished,
          "dateModified": data.dateModified || data.datePublished,
          "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": data.url
          }
        };

      default:
        return null;
    }
  };

  const structuredData = generateStructuredData();

  if (!structuredData) return null;

  return (
    <Helmet>
      <script type="application/ld+json">
        {JSON.stringify(structuredData)}
      </script>
    </Helmet>
  );
};

export default StructuredData;


================================================================================
FILE: client/src/components/TrendingGrants.js
SIZE: 5927 bytes
================================================================================

import React, { useContext, useEffect, useState } from 'react';
import { Link } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { ThemeContext } from '../context/ThemeContext';
import { TrendingUpIcon, EyeIcon, ClockIcon } from '@heroicons/react/24/outline';
import analytics from '../utils/analytics';

const TrendingGrants = ({ limit = 5, showViewCount = true }) => {
  const { darkMode } = useContext(ThemeContext);
  const { t, i18n } = useTranslation();
  const [trendingGrants, setTrendingGrants] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchTrendingGrants();
  }, [limit]);

  const fetchTrendingGrants = async () => {
    try {
      const grants = await analytics.getPopularGrants(limit);
      setTrendingGrants(grants);
    } catch (error) {
      console.error('Failed to fetch trending grants:', error);
    } finally {
      setLoading(false);
    }
  };

  const formatDeadline = (deadline) => {
    if (!deadline) return t('grants.noDeadline');
    
    const date = new Date(deadline);
    const now = new Date();
    const daysUntil = Math.ceil((date - now) / (1000 * 60 * 60 * 24));
    
    if (daysUntil < 0) return t('grants.expired');
    if (daysUntil === 0) return t('grants.deadlineToday');
    if (daysUntil === 1) return t('grants.deadlineTomorrow');
    if (daysUntil <= 7) return t('grants.deadlineDays', { days: daysUntil });
    
    return date.toLocaleDateString(i18n.language, { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
  };

  if (loading) {
    return (
      <div className={`p-6 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
        <div className="animate-pulse">
          <div className="h-6 bg-gray-300 rounded w-1/3 mb-4"></div>
          {[1, 2, 3].map(i => (
            <div key={i} className="mb-4">
              <div className="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
              <div className="h-3 bg-gray-300 rounded w-1/2"></div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  if (trendingGrants.length === 0) {
    return null;
  }

  return (
    <div className={`p-6 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
      <div className="flex items-center mb-6">
        <TrendingUpIcon className="h-6 w-6 text-blue-500 mr-2" />
        <h3 className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
          {t('trendingGrants.title')}
        </h3>
      </div>

      <div className="space-y-4">
        {trendingGrants.map((grant, index) => (
          <Link
            key={grant.id}
            to={`/grants/${grant.id}`}
            className={`block p-4 rounded-lg transition-all duration-200 ${
              darkMode 
                ? 'bg-gray-700 hover:bg-gray-600' 
                : 'bg-gray-50 hover:bg-gray-100'
            }`}
          >
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <div className="flex items-center mb-1">
                  <span className={`text-lg font-bold mr-2 ${
                    index === 0 ? 'text-yellow-500' : 
                    index === 1 ? 'text-gray-400' : 
                    index === 2 ? 'text-orange-600' : 
                    darkMode ? 'text-gray-400' : 'text-gray-600'
                  }`}>
                    #{index + 1}
                  </span>
                  <h4 className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {grant.grant_name}
                  </h4>
                </div>
                
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                  {grant.funding_organization}
                </p>

                <div className="flex items-center space-x-4 text-sm">
                  {showViewCount && (
                    <div className="flex items-center">
                      <EyeIcon className="h-4 w-4 mr-1" />
                      <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                        {grant.view_count} {t('trendingGrants.views')}
                      </span>
                    </div>
                  )}
                  
                  <div className="flex items-center">
                    <ClockIcon className="h-4 w-4 mr-1" />
                    <span className={`${
                      new Date(grant.application_deadline) < new Date() 
                        ? 'text-red-500' 
                        : darkMode ? 'text-gray-400' : 'text-gray-600'
                    }`}>
                      {formatDeadline(grant.application_deadline)}
                    </span>
                  </div>
                </div>

                {grant.focus_areas && (
                  <div className="mt-2 flex flex-wrap gap-1">
                    {grant.focus_areas.split(',').slice(0, 3).map((area, idx) => (
                      <span
                        key={idx}
                        className={`text-xs px-2 py-1 rounded ${
                          darkMode 
                            ? 'bg-gray-600 text-gray-300' 
                            : 'bg-gray-200 text-gray-700'
                        }`}
                      >
                        {area.trim()}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </Link>
        ))}
      </div>

      <Link
        to="/grants"
        className={`block text-center mt-6 py-2 px-4 rounded-lg transition-colors duration-200 ${
          darkMode
            ? 'bg-blue-600 hover:bg-blue-700 text-white'
            : 'bg-blue-500 hover:bg-blue-600 text-white'
        }`}
      >
        {t('trendingGrants.viewAll')}
      </Link>
    </div>
  );
};

export default TrendingGrants;


================================================================================
FILE: client/src/components/VideoHero.js
SIZE: 7232 bytes
================================================================================

import React, { useState, useEffect, useRef } from 'react';
import { Link } from 'react-router-dom';

const VideoHero = ({ darkMode, title, subtitle, primaryCTA, secondaryCTA }) => {
  const videoRef = useRef(null);
  const [videoError, setVideoError] = useState(false);
  const [isVideoLoaded, setIsVideoLoaded] = useState(false);
  const [currentVideoIndex, setCurrentVideoIndex] = useState(0);

  // Video playlist
  const videos = ['/videos/ukrainian-aid-intro.mp4', '/videos/ukrainian-culture.mp4'];

  useEffect(() => {
    // Ensure video plays on mobile by re-triggering play
    const video = videoRef.current;
    if (video) {
      video.play().catch(err => {
        console.log('Autoplay failed:', err);
        // Fallback: show poster or static image
        setVideoError(true);
      });
    }
  }, [currentVideoIndex]);

  const handleVideoLoad = () => {
    setIsVideoLoaded(true);
  };

  const handleVideoError = () => {
    setVideoError(true);
    console.error('Video failed to load');
  };

  const handleVideoEnded = () => {
    // Move to next video in playlist
    setCurrentVideoIndex(prevIndex => (prevIndex + 1) % videos.length);
  };

  return (
    <section className="relative h-screen min-h-[600px] max-h-[900px] overflow-hidden">
      {/* Video Background */}
      {!videoError && (
        <div className="absolute inset-0 w-full h-full">
          <video
            ref={videoRef}
            autoPlay
            muted
            playsInline
            preload="auto"
            onLoadedData={handleVideoLoad}
            onError={handleVideoError}
            onEnded={handleVideoEnded}
            className={`absolute inset-0 w-full h-full object-cover ${
              isVideoLoaded ? 'opacity-100' : 'opacity-0'
            } transition-opacity duration-1000`}
            poster="/images/ukraine-aid-poster.jpg" // Add a poster image as fallback
            key={currentVideoIndex} // Force re-render when video changes
          >
            <source src={videos[currentVideoIndex]} type="video/mp4" />
          </video>

          {/* Loading placeholder */}
          {!isVideoLoaded && (
            <div
              className={`absolute inset-0 ${
                darkMode ? 'bg-gray-900' : 'bg-gray-100'
              } animate-pulse`}
            />
          )}
        </div>
      )}

      {/* Fallback gradient background if video fails */}
      {videoError && (
        <div
          className={`absolute inset-0 ${
            darkMode
              ? 'bg-gradient-to-b from-gray-900 to-gray-800'
              : 'bg-gradient-to-b from-blue-50 to-white'
          }`}
        />
      )}

      {/* Overlay gradient for text readability */}
      <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-black/40 to-black/60" />

      {/* Content */}
      <div className="relative h-full flex items-center justify-center">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
          <div className="space-y-8">
            {/* Title */}
            <h1 className="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-bold tracking-tight text-white drop-shadow-lg">
              {title.line1}
              <span className="block mt-2 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">
                {title.line2}
              </span>
            </h1>

            {/* Subtitle */}
            <p className="max-w-2xl mx-auto text-lg sm:text-xl md:text-2xl text-gray-100 drop-shadow-md">
              {subtitle}
            </p>

            {/* CTA Buttons */}
            <div className="flex flex-col sm:flex-row gap-4 justify-center pt-8">
              <Link
                to={primaryCTA.link}
                className="inline-flex items-center justify-center px-6 sm:px-8 py-3 sm:py-4 text-base sm:text-lg font-medium rounded-2xl text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 shadow-lg hover:shadow-xl transform transition-all duration-200 hover:-translate-y-0.5 backdrop-blur-sm bg-opacity-90"
              >
                {primaryCTA.text}
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-5 w-5 ml-2"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fillRule="evenodd"
                    d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z"
                    clipRule="evenodd"
                  />
                </svg>
              </Link>

              <Link
                to={secondaryCTA.link}
                className="inline-flex items-center justify-center px-6 sm:px-8 py-3 sm:py-4 text-base sm:text-lg font-medium rounded-2xl text-white border-2 border-white/80 hover:bg-white hover:text-gray-900 shadow-lg hover:shadow-xl transform transition-all duration-200 hover:-translate-y-0.5 backdrop-blur-sm"
              >
                {secondaryCTA.text}
              </Link>
            </div>

            {/* Scroll indicator */}
            <div className="absolute bottom-8 left-1/2 transform -translate-x-1/2 animate-bounce">
              <svg
                className="w-6 h-6 text-white/70"
                fill="none"
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth="2"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
              </svg>
            </div>
          </div>
        </div>
      </div>

      {/* Video controls for accessibility */}
      <div className="absolute bottom-4 right-4 z-10 flex flex-col gap-2">
        {/* Video playlist indicators */}
        <div className="flex gap-1 justify-end mb-2">
          {videos.map((_, index) => (
            <button
              key={index}
              onClick={() => setCurrentVideoIndex(index)}
              className={`w-2 h-2 rounded-full transition-all ${
                index === currentVideoIndex ? 'bg-white w-8' : 'bg-white/50 hover:bg-white/70'
              }`}
              aria-label={`Play video ${index + 1}`}
            />
          ))}
        </div>

        {/* Play/Pause button */}
        <button
          onClick={() => {
            const video = videoRef.current;
            if (video) {
              if (video.paused) {
                video.play();
              } else {
                video.pause();
              }
            }
          }}
          className="p-2 rounded-full bg-black/50 hover:bg-black/70 text-white backdrop-blur-sm transition-colors"
          aria-label="Toggle video playback"
        >
          <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path
              fillRule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
              clipRule="evenodd"
            />
          </svg>
        </button>
      </div>
    </section>
  );
};

export default VideoHero;



================================================================================
FILE: client/src/components/infographics/ProfessionalInfographics.js
SIZE: 46698 bytes
================================================================================

import React, { useEffect, useRef, useState } from 'react';

// Professional Key Statistics Infographic with animated counters
export const KeyStatisticsInfographic = ({ darkMode }) => {
  const [counters, setCounters] = useState({
    grants: 0,
    funding: 0,
    orgs: 0,
    beneficiaries: 0,
  });

  useEffect(() => {
    const duration = 2000;
    const steps = 60;
    const interval = duration / steps;
    let currentStep = 0;

    const timer = setInterval(() => {
      currentStep++;
      const progress = currentStep / steps;
      const easeOutQuart = 1 - Math.pow(1 - progress, 4);

      setCounters({
        grants: Math.floor(107 * easeOutQuart),
        funding: Math.floor(63.5 * easeOutQuart),
        orgs: Math.floor(89 * easeOutQuart),
        beneficiaries: Math.floor(2.7 * easeOutQuart * 10) / 10,
      });

      if (currentStep >= steps) clearInterval(timer);
    }, interval);

    return () => clearInterval(timer);
  }, []);

  const bgColor = darkMode ? '#0f172a' : '#ffffff';
  const cardBg = darkMode ? '#1e293b' : '#f8fafc';
  const textColor = darkMode ? '#e2e8f0' : '#1e293b';
  const accentColor = '#3b82f6';
  const secondaryColor = '#10b981';
  const tertiaryColor = '#f59e0b';
  const quaternaryColor = '#ef4444';

  return (
    <svg
      viewBox="0 0 1200 600"
      style={{
        width: '100%',
        height: 'auto',
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      }}
    >
      <defs>
        <linearGradient id="blueGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style={{ stopColor: accentColor, stopOpacity: 1 }} />
          <stop offset="100%" style={{ stopColor: '#2563eb', stopOpacity: 1 }} />
        </linearGradient>
        <linearGradient id="greenGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style={{ stopColor: secondaryColor, stopOpacity: 1 }} />
          <stop offset="100%" style={{ stopColor: '#059669', stopOpacity: 1 }} />
        </linearGradient>
        <linearGradient id="yellowGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style={{ stopColor: tertiaryColor, stopOpacity: 1 }} />
          <stop offset="100%" style={{ stopColor: '#d97706', stopOpacity: 1 }} />
        </linearGradient>
        <linearGradient id="redGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style={{ stopColor: quaternaryColor, stopOpacity: 1 }} />
          <stop offset="100%" style={{ stopColor: '#dc2626', stopOpacity: 1 }} />
        </linearGradient>
        <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur in="SourceAlpha" stdDeviation="3" />
          <feOffset dx="0" dy="2" result="offsetblur" />
          <feFlood floodColor="#000000" floodOpacity="0.1" />
          <feComposite in2="offsetblur" operator="in" />
          <feMerge>
            <feMergeNode />
            <feMergeNode in="SourceGraphic" />
          </feMerge>
        </filter>
      </defs>

      <rect width="1200" height="600" fill={bgColor} />

      <text x="600" y="50" textAnchor="middle" fontSize="32" fontWeight="700" fill={textColor}>
        Ukrainian Civil Society Impact Dashboard
      </text>
      <text x="600" y="85" textAnchor="middle" fontSize="18" fill={textColor} opacity="0.7">
        May-June 2025 Key Metrics
      </text>

      {/* Active Grants Card */}
      <g transform="translate(50, 130)">
        <rect width="250" height="180" rx="16" fill={cardBg} filter="url(#shadow)" />
        <rect width="250" height="8" rx="4" fill="url(#blueGradient)" />
        <circle
          cx="50"
          cy="50"
          r="30"
          fill="url(#blueGradient)"
          opacity="0.1"
          transform="translate(10, 30)"
        />
        <path
          d="M35 60 L35 40 L45 40 L45 60 M55 60 L55 30 L65 30 L65 60 M75 60 L75 50 L85 50 L85 60"
          fill="url(#blueGradient)"
          transform="translate(10, 30)"
        />
        <text x="125" y="110" textAnchor="middle" fontSize="48" fontWeight="700" fill={textColor}>
          {counters.grants}
        </text>
        <text x="125" y="140" textAnchor="middle" fontSize="16" fill={textColor} opacity="0.7">
          Active Grants
        </text>
        <text
          x="125"
          y="160"
          textAnchor="middle"
          fontSize="14"
          fill={secondaryColor}
          fontWeight="600"
        >
          +23% vs last quarter
        </text>
      </g>

      {/* Total Funding Card */}
      <g transform="translate(325, 130)">
        <rect width="250" height="180" rx="16" fill={cardBg} filter="url(#shadow)" />
        <rect width="250" height="8" rx="4" fill="url(#greenGradient)" />
        <circle
          cx="50"
          cy="50"
          r="30"
          fill="url(#greenGradient)"
          opacity="0.1"
          transform="translate(10, 30)"
        />
        <path
          d="M50 80 C30 80 30 40 50 40 C70 40 70 60 50 60 C70 60 70 80 50 80 Z"
          fill="url(#greenGradient)"
          transform="translate(10, 30)"
        />
        <text x="125" y="110" textAnchor="middle" fontSize="48" fontWeight="700" fill={textColor}>
          â‚¬{counters.funding}M
        </text>
        <text x="125" y="140" textAnchor="middle" fontSize="16" fill={textColor} opacity="0.7">
          Total Funding
        </text>
        <text
          x="125"
          y="160"
          textAnchor="middle"
          fontSize="14"
          fill={secondaryColor}
          fontWeight="600"
        >
          Available in 2025
        </text>
      </g>

      {/* Partner Organizations Card */}
      <g transform="translate(600, 130)">
        <rect width="250" height="180" rx="16" fill={cardBg} filter="url(#shadow)" />
        <rect width="250" height="8" rx="4" fill="url(#yellowGradient)" />
        <circle
          cx="50"
          cy="50"
          r="30"
          fill="url(#yellowGradient)"
          opacity="0.1"
          transform="translate(10, 30)"
        />
        <path
          d="M50 40 C50 40 30 50 30 70 C30 80 40 85 50 85 C60 85 70 80 70 70 C70 50 50 40 50 40 Z M50 60 L50 75 M40 65 L60 65"
          fill="url(#yellowGradient)"
          transform="translate(10, 30)"
        />
        <text x="125" y="110" textAnchor="middle" fontSize="48" fontWeight="700" fill={textColor}>
          {counters.orgs}
        </text>
        <text x="125" y="140" textAnchor="middle" fontSize="16" fill={textColor} opacity="0.7">
          Partner Orgs
        </text>
        <text
          x="125"
          y="160"
          textAnchor="middle"
          fontSize="14"
          fill={tertiaryColor}
          fontWeight="600"
        >
          International & Local
        </text>
      </g>

      {/* Beneficiaries Card */}
      <g transform="translate(875, 130)">
        <rect width="250" height="180" rx="16" fill={cardBg} filter="url(#shadow)" />
        <rect width="250" height="8" rx="4" fill="url(#redGradient)" />
        <circle
          cx="50"
          cy="50"
          r="30"
          fill="url(#redGradient)"
          opacity="0.1"
          transform="translate(10, 30)"
        />
        <g transform="translate(60, 80)">
          <circle cx="0" cy="0" r="8" fill="url(#redGradient)" />
          <circle cx="-20" cy="5" r="8" fill="url(#redGradient)" opacity="0.8" />
          <circle cx="20" cy="5" r="8" fill="url(#redGradient)" opacity="0.8" />
          <circle cx="-10" cy="20" r="8" fill="url(#redGradient)" opacity="0.6" />
          <circle cx="10" cy="20" r="8" fill="url(#redGradient)" opacity="0.6" />
        </g>
        <text x="125" y="110" textAnchor="middle" fontSize="48" fontWeight="700" fill={textColor}>
          {counters.beneficiaries}M
        </text>
        <text x="125" y="140" textAnchor="middle" fontSize="16" fill={textColor} opacity="0.7">
          Beneficiaries
        </text>
        <text
          x="125"
          y="160"
          textAnchor="middle"
          fontSize="14"
          fill={quaternaryColor}
          fontWeight="600"
        >
          People Helped
        </text>
      </g>

      {/* Bottom visualization */}
      <g transform="translate(50, 350)">
        <text x="0" y="0" fontSize="20" fontWeight="600" fill={textColor}>
          Grant Distribution by Sector
        </text>

        {[
          { name: 'Humanitarian Aid', value: 35, color: quaternaryColor },
          { name: 'Democracy & Governance', value: 25, color: accentColor },
          { name: 'Human Rights', value: 20, color: secondaryColor },
          { name: 'Media & Information', value: 12, color: tertiaryColor },
          { name: 'Environmental', value: 8, color: '#8b5cf6' },
        ].map((item, index) => {
          const y = 30 + index * 35;
          const width = (item.value / 35) * 400;

          return (
            <g key={index}>
              <text x="0" y={y + 15} fontSize="14" fill={textColor}>
                {item.name}
              </text>
              <rect x="200" y={y} width={width} height="20" rx="10" fill={item.color} opacity="0.8">
                <animate attributeName="width" from="0" to={width} dur="1.5s" fill="freeze" />
              </rect>
              <text x={210 + width} y={y + 15} fontSize="14" fontWeight="600" fill={textColor}>
                {item.value}%
              </text>
            </g>
          );
        })}
      </g>

      {/* Trend indicator */}
      <g transform="translate(750, 380)">
        <rect width="380" height="160" rx="12" fill={cardBg} filter="url(#shadow)" />
        <text x="20" y="30" fontSize="18" fontWeight="600" fill={textColor}>
          Monthly Grant Applications Trend
        </text>
        <polyline
          points="40,120 80,110 120,90 160,85 200,70 240,65 280,50 320,45 360,40"
          fill="none"
          stroke={accentColor}
          strokeWidth="3"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <animate
            attributeName="stroke-dasharray"
            from="0 1000"
            to="1000 0"
            dur="2s"
            fill="freeze"
          />
        </polyline>
        <text x="20" y="140" fontSize="24" fontWeight="700" fill={secondaryColor}>
          â†‘ 45%
        </text>
        <text x="85" y="140" fontSize="14" fill={textColor} opacity="0.7">
          increase in applications
        </text>
      </g>
    </svg>
  );
};

// Professional Focus Areas Donut Chart
export const FocusAreasInfographic = ({ darkMode }) => {
  const [hoveredSegment, setHoveredSegment] = useState(null);
  const bgColor = darkMode ? '#0f172a' : '#ffffff';
  const textColor = darkMode ? '#e2e8f0' : '#1e293b';

  const data = [
    { name: 'Humanitarian Response', value: 35, color: '#ef4444', icon: 'ðŸ¥' },
    { name: 'Human Rights', value: 25, color: '#3b82f6', icon: 'âš–ï¸' },
    { name: 'Democracy Building', value: 20, color: '#10b981', icon: 'ðŸ—³ï¸' },
    { name: 'Media Freedom', value: 12, color: '#f59e0b', icon: 'ðŸ“°' },
    { name: 'Environmental', value: 8, color: '#8b5cf6', icon: 'ðŸŒ±' },
  ];

  let cumulativePercentage = 0;

  return (
    <svg
      viewBox="0 0 1200 600"
      style={{
        width: '100%',
        height: 'auto',
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      }}
    >
      <defs>
        <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur in="SourceAlpha" stdDeviation="4" />
          <feOffset dx="0" dy="4" result="offsetblur" />
          <feFlood floodColor="#000000" floodOpacity="0.2" />
          <feComposite in2="offsetblur" operator="in" />
          <feMerge>
            <feMergeNode />
            <feMergeNode in="SourceGraphic" />
          </feMerge>
        </filter>
        {data.map((item, index) => (
          <linearGradient key={index} id={`gradient-${index}`} x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style={{ stopColor: item.color, stopOpacity: 1 }} />
            <stop offset="100%" style={{ stopColor: item.color, stopOpacity: 0.7 }} />
          </linearGradient>
        ))}
      </defs>

      <rect width="1200" height="600" fill={bgColor} />

      <text x="600" y="50" textAnchor="middle" fontSize="32" fontWeight="700" fill={textColor}>
        Civil Society Focus Areas 2025
      </text>

      {/* Main donut chart */}
      <g transform="translate(300, 300)">
        {data.map((segment, index) => {
          const startAngle = (cumulativePercentage * 360) / 100;
          cumulativePercentage += segment.value;
          const endAngle = (cumulativePercentage * 360) / 100;

          const startAngleRad = (startAngle * Math.PI) / 180;
          const endAngleRad = (endAngle * Math.PI) / 180;

          const largeArcFlag = endAngle - startAngle > 180 ? 1 : 0;
          const outerRadius = hoveredSegment === index ? 165 : 150;
          const innerRadius = 80;

          const x1 = Math.cos(startAngleRad) * outerRadius;
          const y1 = Math.sin(startAngleRad) * outerRadius;
          const x2 = Math.cos(endAngleRad) * outerRadius;
          const y2 = Math.sin(endAngleRad) * outerRadius;

          const x3 = Math.cos(startAngleRad) * innerRadius;
          const y3 = Math.sin(startAngleRad) * innerRadius;
          const x4 = Math.cos(endAngleRad) * innerRadius;
          const y4 = Math.sin(endAngleRad) * innerRadius;

          const pathData = [
            `M ${x1} ${y1}`,
            `A ${outerRadius} ${outerRadius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
            `L ${x4} ${y4}`,
            `A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${x3} ${y3}`,
            'Z',
          ].join(' ');

          return (
            <g key={index}>
              <path
                d={pathData}
                fill={`url(#gradient-${index})`}
                filter={hoveredSegment === index ? 'url(#shadow)' : ''}
                onMouseEnter={() => setHoveredSegment(index)}
                onMouseLeave={() => setHoveredSegment(null)}
                style={{ cursor: 'pointer', transition: 'all 0.3s ease' }}
              >
                <animate
                  attributeName="opacity"
                  from="0"
                  to="1"
                  dur="0.5s"
                  begin={`${index * 0.1}s`}
                  fill="freeze"
                />
              </path>

              {/* Percentage label */}
              <text
                x={Math.cos((startAngleRad + endAngleRad) / 2) * (outerRadius - 30)}
                y={Math.sin((startAngleRad + endAngleRad) / 2) * (outerRadius - 30)}
                textAnchor="middle"
                fontSize="20"
                fontWeight="700"
                fill="#ffffff"
                style={{ pointerEvents: 'none' }}
              >
                {segment.value}%
              </text>
            </g>
          );
        })}

        {/* Center text */}
        <text x="0" y="0" textAnchor="middle" fontSize="24" fontWeight="700" fill={textColor}>
          Focus Areas
        </text>
        <text x="0" y="25" textAnchor="middle" fontSize="16" fill={textColor} opacity="0.7">
          Distribution
        </text>
      </g>

      {/* Legend with details */}
      <g transform="translate(700, 150)">
        {data.map((item, index) => (
          <g key={index} transform={`translate(0, ${index * 80})`}>
            <rect
              x="0"
              y="0"
              width="400"
              height="60"
              rx="8"
              fill={darkMode ? '#1e293b' : '#f8fafc'}
              stroke={hoveredSegment === index ? item.color : 'transparent'}
              strokeWidth="2"
              style={{ cursor: 'pointer' }}
              onMouseEnter={() => setHoveredSegment(index)}
              onMouseLeave={() => setHoveredSegment(null)}
            />
            <text x="50" y="25" fontSize="24">
              {item.icon}
            </text>
            <rect x="10" y="20" width="20" height="20" rx="4" fill={item.color} />
            <text x="90" y="25" fontSize="16" fontWeight="600" fill={textColor}>
              {item.name}
            </text>
            <text x="90" y="45" fontSize="14" fill={textColor} opacity="0.7">
              {item.value}% of total funding
            </text>
            <text x="350" y="35" fontSize="20" fontWeight="700" fill={item.color}>
              {item.value}%
            </text>
          </g>
        ))}
      </g>

      {/* Bottom insight */}
      <rect
        x="50"
        y="520"
        width="1100"
        height="60"
        rx="8"
        fill={darkMode ? '#1e293b' : '#f1f5f9'}
      />
      <text x="600" y="555" textAnchor="middle" fontSize="16" fill={textColor}>
        ðŸ’¡ <tspan fontWeight="600">Key Insight:</tspan> Humanitarian response remains the top
        priority, receiving over 1/3 of all grant funding
      </text>
    </svg>
  );
};

// Professional Timeline Visualization
export const TimelineInfographic = ({ darkMode }) => {
  const bgColor = darkMode ? '#0f172a' : '#ffffff';
  const textColor = darkMode ? '#e2e8f0' : '#1e293b';
  const lineColor = darkMode ? '#334155' : '#e2e8f0';
  const accentColor = '#3b82f6';

  const events = [
    {
      date: 'May 1',
      title: 'Housing Initiative Launch',
      detail: '3,200 homes renovation project begins',
      type: 'milestone',
    },
    {
      date: 'May 15',
      title: 'Mental Health Expansion',
      detail: '250 psychologists network established',
      type: 'success',
    },
    {
      date: 'May 28',
      title: 'Youth Mobilization',
      detail: 'â‚´500M raised by youth organizations',
      type: 'achievement',
    },
    {
      date: 'Jun 5',
      title: 'Cultural Preservation',
      detail: '2.5M artifacts digitally preserved',
      type: 'milestone',
    },
    {
      date: 'Jun 18',
      title: 'International Partnership',
      detail: 'â‚¬450M channeled through civil society',
      type: 'success',
    },
    {
      date: 'Jun 30',
      title: 'Q2 Impact Report',
      detail: '2.7M beneficiaries reached',
      type: 'achievement',
    },
  ];

  return (
    <svg
      viewBox="0 0 1200 700"
      style={{
        width: '100%',
        height: 'auto',
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      }}
    >
      <defs>
        <linearGradient id="timelineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style={{ stopColor: accentColor, stopOpacity: 0.2 }} />
          <stop offset="50%" style={{ stopColor: accentColor, stopOpacity: 1 }} />
          <stop offset="100%" style={{ stopColor: accentColor, stopOpacity: 0.2 }} />
        </linearGradient>
        <filter id="glow">
          <feGaussianBlur stdDeviation="4" result="coloredBlur" />
          <feMerge>
            <feMergeNode in="coloredBlur" />
            <feMergeNode in="SourceGraphic" />
          </feMerge>
        </filter>
      </defs>

      <rect width="1200" height="700" fill={bgColor} />

      <text x="600" y="50" textAnchor="middle" fontSize="32" fontWeight="700" fill={textColor}>
        Civil Society Timeline: May-June 2025
      </text>

      {/* Main timeline line */}
      <line x1="100" y1="350" x2="1100" y2="350" stroke={lineColor} strokeWidth="4" />
      <line x1="100" y1="350" x2="1100" y2="350" stroke="url(#timelineGradient)" strokeWidth="4">
        <animate attributeName="x2" from="100" to="1100" dur="2s" fill="freeze" />
      </line>

      {/* Events */}
      {events.map((event, index) => {
        const x = 100 + index * 180;
        const isTop = index % 2 === 0;
        const y = isTop ? 200 : 500;
        const lineY = isTop ? 280 : 420;

        const getEventColor = () => {
          switch (event.type) {
            case 'milestone':
              return '#3b82f6';
            case 'success':
              return '#10b981';
            case 'achievement':
              return '#f59e0b';
            default:
              return accentColor;
          }
        };

        const color = getEventColor();

        return (
          <g key={index}>
            {/* Connection line */}
            <line
              x1={x}
              y1="350"
              x2={x}
              y2={lineY}
              stroke={color}
              strokeWidth="2"
              strokeDasharray="5,5"
              opacity="0"
            >
              <animate
                attributeName="opacity"
                from="0"
                to="0.5"
                dur="0.5s"
                begin={`${0.3 * index + 0.5}s`}
                fill="freeze"
              />
            </line>

            {/* Event card */}
            <g opacity="0">
              <rect
                x={x - 80}
                y={y - 60}
                width="160"
                height="100"
                rx="8"
                fill={darkMode ? '#1e293b' : '#ffffff'}
                stroke={color}
                strokeWidth="2"
              />
              <text
                x={x}
                y={y - 35}
                textAnchor="middle"
                fontSize="14"
                fontWeight="600"
                fill={color}
              >
                {event.date}
              </text>
              <text
                x={x}
                y={y - 15}
                textAnchor="middle"
                fontSize="14"
                fontWeight="600"
                fill={textColor}
              >
                {event.title}
              </text>
              <foreignObject x={x - 70} y={y - 5} width="140" height="40">
                <div
                  style={{
                    fontSize: '12px',
                    color: darkMode ? '#94a3b8' : '#64748b',
                    textAlign: 'center',
                    lineHeight: '1.3',
                  }}
                >
                  {event.detail}
                </div>
              </foreignObject>

              <animate
                attributeName="opacity"
                from="0"
                to="1"
                dur="0.5s"
                begin={`${0.3 * index + 0.5}s`}
                fill="freeze"
              />
            </g>

            {/* Timeline point */}
            <circle cx={x} cy="350" r="12" fill={color} filter="url(#glow)">
              <animate
                attributeName="r"
                from="0"
                to="12"
                dur="0.3s"
                begin={`${0.3 * index}s`}
                fill="freeze"
              />
            </circle>
            <circle cx={x} cy="350" r="6" fill="#ffffff" />
          </g>
        );
      })}

      {/* Month labels */}
      <text x="300" y="380" textAnchor="middle" fontSize="20" fontWeight="700" fill={textColor}>
        MAY 2025
      </text>
      <text x="900" y="380" textAnchor="middle" fontSize="20" fontWeight="700" fill={textColor}>
        JUNE 2025
      </text>

      {/* Progress indicator */}
      <g transform="translate(100, 600)">
        <rect width="1000" height="60" rx="30" fill={darkMode ? '#1e293b' : '#f1f5f9'} />
        <rect width="600" height="60" rx="30" fill={accentColor} opacity="0.2" />
        <rect width="600" height="60" rx="30" fill={accentColor}>
          <animate attributeName="width" from="0" to="600" dur="2s" fill="freeze" />
        </rect>
        <text x="500" y="38" textAnchor="middle" fontSize="18" fontWeight="600" fill="#ffffff">
          60% of 2025 Goals Achieved
        </text>
      </g>
    </svg>
  );
};

// Professional Regional Impact Map
export const RegionalImpactInfographic = ({ darkMode }) => {
  const bgColor = darkMode ? '#0f172a' : '#ffffff';
  const textColor = darkMode ? '#e2e8f0' : '#1e293b';
  const mapBg = darkMode ? '#1e293b' : '#f8fafc';

  const regions = [
    { name: 'Kyiv', x: 350, y: 200, impact: 95, beneficiaries: '450K' },
    { name: 'Kharkiv', x: 500, y: 180, impact: 88, beneficiaries: '380K' },
    { name: 'Dnipro', x: 450, y: 280, impact: 82, beneficiaries: '320K' },
    { name: 'Odesa', x: 300, y: 380, impact: 75, beneficiaries: '290K' },
    { name: 'Lviv', x: 150, y: 250, impact: 70, beneficiaries: '260K' },
    { name: 'Zaporizhzhia', x: 480, y: 350, impact: 90, beneficiaries: '410K' },
  ];

  return (
    <svg
      viewBox="0 0 1200 600"
      style={{
        width: '100%',
        height: 'auto',
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      }}
    >
      <defs>
        <radialGradient id="impactGradient">
          <stop offset="0%" style={{ stopColor: '#ef4444', stopOpacity: 0.8 }} />
          <stop offset="100%" style={{ stopColor: '#ef4444', stopOpacity: 0.2 }} />
        </radialGradient>
        <filter id="blur">
          <feGaussianBlur in="SourceGraphic" stdDeviation="3" />
        </filter>
      </defs>

      <rect width="1200" height="600" fill={bgColor} />

      <text x="600" y="50" textAnchor="middle" fontSize="32" fontWeight="700" fill={textColor}>
        Regional Impact Distribution
      </text>

      {/* Map container */}
      <g transform="translate(100, 100)">
        <rect
          width="600"
          height="400"
          rx="12"
          fill={mapBg}
          stroke={darkMode ? '#334155' : '#e2e8f0'}
          strokeWidth="2"
        />

        {/* Simplified Ukraine outline */}
        <path
          d="M 50 200 Q 100 150 200 140 L 350 130 Q 450 140 520 180 L 530 250 Q 520 320 480 360 L 400 380 L 300 390 Q 200 380 120 340 L 80 280 Z"
          fill={darkMode ? '#0f172a' : '#ffffff'}
          stroke={darkMode ? '#475569' : '#cbd5e1'}
          strokeWidth="2"
        />

        {/* Impact circles */}
        {regions.map((region, index) => {
          const radius = (region.impact / 100) * 40;

          return (
            <g key={index}>
              {/* Impact area */}
              <circle
                cx={region.x}
                cy={region.y}
                r={radius * 2}
                fill="url(#impactGradient)"
                filter="url(#blur)"
                opacity="0"
              >
                <animate
                  attributeName="opacity"
                  from="0"
                  to="0.6"
                  dur="0.5s"
                  begin={`${index * 0.2}s`}
                  fill="freeze"
                />
              </circle>

              {/* Main circle */}
              <circle cx={region.x} cy={region.y} r={radius} fill="#ef4444" opacity="0">
                <animate
                  attributeName="opacity"
                  from="0"
                  to="0.8"
                  dur="0.5s"
                  begin={`${index * 0.2}s`}
                  fill="freeze"
                />
                <animate
                  attributeName="r"
                  from="0"
                  to={radius}
                  dur="0.5s"
                  begin={`${index * 0.2}s`}
                  fill="freeze"
                />
              </circle>

              {/* Center point */}
              <circle cx={region.x} cy={region.y} r="4" fill="#ffffff" />

              {/* Label */}
              <text
                x={region.x}
                y={region.y - radius - 10}
                textAnchor="middle"
                fontSize="14"
                fontWeight="600"
                fill={textColor}
              >
                {region.name}
              </text>
              <text
                x={region.x}
                y={region.y + 5}
                textAnchor="middle"
                fontSize="12"
                fontWeight="700"
                fill="#ffffff"
              >
                {region.beneficiaries}
              </text>
            </g>
          );
        })}
      </g>

      {/* Statistics panel */}
      <g transform="translate(750, 120)">
        <text x="0" y="0" fontSize="20" fontWeight="600" fill={textColor}>
          Impact by Numbers
        </text>

        {[
          { label: 'Total Beneficiaries', value: '2.7M', color: '#ef4444' },
          { label: 'Communities Reached', value: '78', color: '#f59e0b' },
          { label: 'Active Programs', value: '234', color: '#10b981' },
          { label: 'Volunteer Hours', value: '5M/mo', color: '#3b82f6' },
        ].map((stat, index) => (
          <g key={index} transform={`translate(0, ${40 + index * 80})`}>
            <rect width="350" height="60" rx="8" fill={darkMode ? '#1e293b' : '#f8fafc'} />
            <circle cx="30" cy="30" r="20" fill={stat.color} opacity="0.2" />
            <circle cx="30" cy="30" r="12" fill={stat.color} />
            <text x="60" y="25" fontSize="14" fill={textColor} opacity="0.7">
              {stat.label}
            </text>
            <text x="60" y="45" fontSize="24" fontWeight="700" fill={textColor}>
              {stat.value}
            </text>
          </g>
        ))}
      </g>

      {/* Heat map legend */}
      <g transform="translate(100, 540)">
        <text x="0" y="0" fontSize="14" fontWeight="600" fill={textColor}>
          Impact Intensity:
        </text>
        <rect x="120" y="-15" width="200" height="20" rx="10" fill="url(#impactGradient)" />
        <text x="100" y="0" fontSize="12" fill={textColor}>
          Low
        </text>
        <text x="330" y="0" fontSize="12" fill={textColor}>
          High
        </text>
      </g>
    </svg>
  );
};

// Professional International Support Network
export const InternationalSupportInfographic = ({ darkMode }) => {
  const bgColor = darkMode ? '#0f172a' : '#ffffff';
  const textColor = darkMode ? '#e2e8f0' : '#1e293b';
  const nodeColor = darkMode ? '#334155' : '#e2e8f0';

  const centerX = 600;
  const centerY = 300;

  const supporters = [
    { name: 'European Union', amount: 'â‚¬180M', angle: 0, color: '#003399' },
    { name: 'United States', amount: 'â‚¬120M', angle: 60, color: '#b22234' },
    { name: 'Germany', amount: 'â‚¬45M', angle: 120, color: '#ffcc00' },
    { name: 'Canada', amount: 'â‚¬38M', angle: 180, color: '#ff0000' },
    { name: 'United Kingdom', amount: 'â‚¬32M', angle: 240, color: '#012169' },
    { name: 'Nordic Countries', amount: 'â‚¬35M', angle: 300, color: '#006aa7' },
  ];

  return (
    <svg
      viewBox="0 0 1200 600"
      style={{
        width: '100%',
        height: 'auto',
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      }}
    >
      <defs>
        <filter id="networkGlow">
          <feGaussianBlur stdDeviation="3" result="coloredBlur" />
          <feMerge>
            <feMergeNode in="coloredBlur" />
            <feMergeNode in="SourceGraphic" />
          </feMerge>
        </filter>
      </defs>

      <rect width="1200" height="600" fill={bgColor} />

      <text x="600" y="50" textAnchor="middle" fontSize="32" fontWeight="700" fill={textColor}>
        International Support Network
      </text>

      {/* Connection lines */}
      {supporters.map((supporter, index) => {
        const angleRad = (supporter.angle * Math.PI) / 180;
        const x = centerX + Math.cos(angleRad) * 200;
        const y = centerY + Math.sin(angleRad) * 200;

        return (
          <line
            key={index}
            x1={centerX}
            y1={centerY}
            x2={x}
            y2={y}
            stroke={supporter.color}
            strokeWidth="2"
            opacity="0.3"
            strokeDasharray="5,5"
          >
            <animate
              attributeName="stroke-dashoffset"
              from="10"
              to="0"
              dur="1s"
              repeatCount="indefinite"
            />
          </line>
        );
      })}

      {/* Central Ukraine node */}
      <g>
        <circle cx={centerX} cy={centerY} r="80" fill="#005bbb" filter="url(#networkGlow)" />
        <circle cx={centerX} cy={centerY} r="70" fill="#ffd700" />
        <text
          x={centerX}
          y={centerY - 10}
          textAnchor="middle"
          fontSize="20"
          fontWeight="700"
          fill="#005bbb"
        >
          UKRAINE
        </text>
        <text x={centerX} y={centerY + 15} textAnchor="middle" fontSize="16" fill="#005bbb">
          Civil Society
        </text>
        <text
          x={centerX}
          y={centerY + 35}
          textAnchor="middle"
          fontSize="24"
          fontWeight="700"
          fill="#005bbb"
        >
          â‚¬450M
        </text>
      </g>

      {/* Supporter nodes */}
      {supporters.map((supporter, index) => {
        const angleRad = (supporter.angle * Math.PI) / 180;
        const x = centerX + Math.cos(angleRad) * 200;
        const y = centerY + Math.sin(angleRad) * 200;
        const amountNum = parseInt(supporter.amount.replace(/[â‚¬M]/g, ''));
        const radius = 30 + amountNum / 10;

        return (
          <g key={index}>
            <circle cx={x} cy={y} r={radius} fill={supporter.color} opacity="0">
              <animate
                attributeName="opacity"
                from="0"
                to="0.8"
                dur="0.5s"
                begin={`${index * 0.1 + 0.5}s`}
                fill="freeze"
              />
            </circle>
            <circle cx={x} cy={y} r={radius - 5} fill={bgColor} />
            <text
              x={x}
              y={y - radius - 10}
              textAnchor="middle"
              fontSize="14"
              fontWeight="600"
              fill={textColor}
            >
              {supporter.name}
            </text>
            <text
              x={x}
              y={y + 5}
              textAnchor="middle"
              fontSize="16"
              fontWeight="700"
              fill={supporter.color}
            >
              {supporter.amount}
            </text>
          </g>
        );
      })}

      {/* Additional partnerships info */}
      <g transform="translate(100, 480)">
        <rect width="1000" height="80" rx="12" fill={darkMode ? '#1e293b' : '#f1f5f9'} />
        <text x="50" y="35" fontSize="18" fontWeight="600" fill={textColor}>
          Global Partnership Impact:
        </text>
        <text x="50" y="60" fontSize="16" fill={textColor} opacity="0.8">
          90 partner countries â€¢ 50 advocacy campaigns â€¢ 100+ knowledge exchange programs
        </text>

        {/* Animated flow indicators */}
        {[0, 200, 400, 600, 800].map((offset, i) => (
          <circle key={i} cx={offset} cy="20" r="3" fill="#3b82f6">
            <animate
              attributeName="cx"
              from={offset}
              to={offset + 200}
              dur="2s"
              repeatCount="indefinite"
            />
            <animate attributeName="opacity" values="0;1;0" dur="2s" repeatCount="indefinite" />
          </circle>
        ))}
      </g>
    </svg>
  );
};

// Professional Future Priorities Radar Chart
export const FuturePrioritiesInfographic = ({ darkMode }) => {
  const bgColor = darkMode ? '#0f172a' : '#ffffff';
  const textColor = darkMode ? '#e2e8f0' : '#1e293b';
  const gridColor = darkMode ? '#334155' : '#e2e8f0';

  const priorities = [
    { name: 'Winterization', value: 95, icon: 'â„ï¸' },
    { name: 'Mental Health', value: 88, icon: 'ðŸ§ ' },
    { name: 'Demining', value: 92, icon: 'âš ï¸' },
    { name: 'Economic Recovery', value: 78, icon: 'ðŸ“ˆ' },
    { name: 'Justice', value: 85, icon: 'âš–ï¸' },
    { name: 'Infrastructure', value: 82, icon: 'ðŸ—ï¸' },
  ];

  const levels = [20, 40, 60, 80, 100];
  const angleStep = 360 / priorities.length;
  const centerX = 400;
  const centerY = 300;
  const maxRadius = 180;

  return (
    <svg
      viewBox="0 0 1200 600"
      style={{
        width: '100%',
        height: 'auto',
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      }}
    >
      <defs>
        <linearGradient id="radarGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style={{ stopColor: '#3b82f6', stopOpacity: 0.6 }} />
          <stop offset="100%" style={{ stopColor: '#3b82f6', stopOpacity: 0.2 }} />
        </linearGradient>
      </defs>

      <rect width="1200" height="600" fill={bgColor} />

      <text x="600" y="50" textAnchor="middle" fontSize="32" fontWeight="700" fill={textColor}>
        Future Priorities Assessment
      </text>

      <g transform="translate(0, 0)">
        {/* Grid circles */}
        {levels.map((level, index) => (
          <circle
            key={index}
            cx={centerX}
            cy={centerY}
            r={(level / 100) * maxRadius}
            fill="none"
            stroke={gridColor}
            strokeWidth="1"
            opacity="0.5"
          />
        ))}

        {/* Grid lines */}
        {priorities.map((_, index) => {
          const angle = ((index * angleStep - 90) * Math.PI) / 180;
          const x = centerX + Math.cos(angle) * maxRadius;
          const y = centerY + Math.sin(angle) * maxRadius;

          return (
            <line
              key={index}
              x1={centerX}
              y1={centerY}
              x2={x}
              y2={y}
              stroke={gridColor}
              strokeWidth="1"
              opacity="0.5"
            />
          );
        })}

        {/* Data polygon */}
        <polygon
          points={priorities
            .map((priority, index) => {
              const angle = ((index * angleStep - 90) * Math.PI) / 180;
              const radius = (priority.value / 100) * maxRadius;
              const x = centerX + Math.cos(angle) * radius;
              const y = centerY + Math.sin(angle) * radius;
              return `${x},${y}`;
            })
            .join(' ')}
          fill="url(#radarGradient)"
          stroke="#3b82f6"
          strokeWidth="3"
          opacity="0"
        >
          <animate attributeName="opacity" from="0" to="1" dur="1.5s" fill="freeze" />
        </polygon>

        {/* Data points and labels */}
        {priorities.map((priority, index) => {
          const angle = ((index * angleStep - 90) * Math.PI) / 180;
          const dataRadius = (priority.value / 100) * maxRadius;
          const labelRadius = maxRadius + 40;
          const dataX = centerX + Math.cos(angle) * dataRadius;
          const dataY = centerY + Math.sin(angle) * dataRadius;
          const labelX = centerX + Math.cos(angle) * labelRadius;
          const labelY = centerY + Math.sin(angle) * labelRadius;

          return (
            <g key={index}>
              {/* Data point */}
              <circle cx={dataX} cy={dataY} r="6" fill="#3b82f6" />
              <circle cx={dataX} cy={dataY} r="3" fill="#ffffff" />

              {/* Label */}
              <text x={labelX} y={labelY - 10} textAnchor="middle" fontSize="24">
                {priority.icon}
              </text>
              <text
                x={labelX}
                y={labelY + 10}
                textAnchor="middle"
                fontSize="14"
                fontWeight="600"
                fill={textColor}
              >
                {priority.name}
              </text>
              <text
                x={labelX}
                y={labelY + 28}
                textAnchor="middle"
                fontSize="16"
                fontWeight="700"
                fill="#3b82f6"
              >
                {priority.value}%
              </text>
            </g>
          );
        })}
      </g>

      {/* Priority details */}
      <g transform="translate(700, 150)">
        <text x="0" y="0" fontSize="20" fontWeight="600" fill={textColor}>
          Priority Breakdown
        </text>

        {priorities.slice(0, 3).map((priority, index) => (
          <g key={index} transform={`translate(0, ${40 + index * 100})`}>
            <rect width="400" height="80" rx="8" fill={darkMode ? '#1e293b' : '#f8fafc'} />
            <text x="40" y="25" fontSize="24">
              {priority.icon}
            </text>
            <text x="80" y="25" fontSize="16" fontWeight="600" fill={textColor}>
              {priority.name}
            </text>
            <rect x="80" y="35" width="250" height="8" rx="4" fill={gridColor} />
            <rect
              x="80"
              y="35"
              width={(250 * priority.value) / 100}
              height="8"
              rx="4"
              fill="#3b82f6"
            >
              <animate
                attributeName="width"
                from="0"
                to={(250 * priority.value) / 100}
                dur="1s"
                fill="freeze"
              />
            </rect>
            <text x="80" y="60" fontSize="14" fill={textColor} opacity="0.7">
              Priority Score: {priority.value}/100
            </text>
            <text x="340" y="45" fontSize="20" fontWeight="700" fill="#3b82f6">
              {priority.value}%
            </text>
          </g>
        ))}
      </g>

      {/* Legend */}
      <rect
        x="700"
        y="480"
        width="400"
        height="80"
        rx="12"
        fill={darkMode ? '#1e293b' : '#f1f5f9'}
      />
      <circle cx="730" cy="520" r="15" fill="#3b82f6" opacity="0.2" />
      <circle cx="730" cy="520" r="8" fill="#3b82f6" />
      <text x="760" y="515" fontSize="14" fontWeight="600" fill={textColor}>
        Critical Priority Areas
      </text>
      <text x="760" y="535" fontSize="12" fill={textColor} opacity="0.7">
        Based on community needs assessment and stakeholder input
      </text>
    </svg>
  );
};

// Professional Call to Action
export const CallToActionInfographic = ({ darkMode }) => {
  const bgColor = darkMode ? '#0f172a' : '#ffffff';
  const textColor = darkMode ? '#e2e8f0' : '#1e293b';
  const accentColor = '#3b82f6';

  return (
    <svg
      viewBox="0 0 1200 600"
      style={{
        width: '100%',
        height: 'auto',
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      }}
    >
      <defs>
        <linearGradient id="ctaGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style={{ stopColor: '#3b82f6', stopOpacity: 1 }} />
          <stop offset="50%" style={{ stopColor: '#06b6d4', stopOpacity: 1 }} />
          <stop offset="100%" style={{ stopColor: '#10b981', stopOpacity: 1 }} />
        </linearGradient>
        <filter id="ctaShadow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur in="SourceAlpha" stdDeviation="10" />
          <feOffset dx="0" dy="5" result="offsetblur" />
          <feFlood floodColor="#000000" floodOpacity="0.2" />
          <feComposite in2="offsetblur" operator="in" />
          <feMerge>
            <feMergeNode />
            <feMergeNode in="SourceGraphic" />
          </feMerge>
        </filter>
      </defs>

      <rect width="1200" height="600" fill={bgColor} />

      {/* Background pattern */}
      <pattern id="dotPattern" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
        <circle cx="20" cy="20" r="2" fill={darkMode ? '#334155' : '#e2e8f0'} opacity="0.3" />
      </pattern>
      <rect width="1200" height="600" fill="url(#dotPattern)" />

      {/* Main CTA Card */}
      <g transform="translate(100, 100)">
        <rect width="1000" height="400" rx="20" fill="url(#ctaGradient)" filter="url(#ctaShadow)" />

        {/* Icon */}
        <g transform="translate(500, 80)">
          <circle cx="0" cy="0" r="50" fill="#ffffff" opacity="0.2" />
          <path
            d="M-20 -10 L-20 10 L0 20 L20 10 L20 -10 L0 -20 Z M-20 10 L0 0 L20 10 M0 0 L0 20"
            fill="none"
            stroke="#ffffff"
            strokeWidth="3"
            strokeLinecap="round"
            strokeLinejoin="round"
          />
        </g>

        {/* Main text */}
        <text x="500" y="180" textAnchor="middle" fontSize="48" fontWeight="700" fill="#ffffff">
          Support Ukrainian Civil Society
        </text>
        <text x="500" y="220" textAnchor="middle" fontSize="24" fill="#ffffff" opacity="0.9">
          Your contribution makes a lasting impact
        </text>

        {/* Action items */}
        <g transform="translate(150, 280)">
          {[
            { icon: 'ðŸ¤', text: 'Partner with NGOs', desc: 'Direct collaboration opportunities' },
            { icon: 'ðŸ’°', text: 'Fund Programs', desc: 'Support verified initiatives' },
            { icon: 'ðŸ“¢', text: 'Advocate', desc: 'Amplify Ukrainian voices' },
          ].map((item, index) => (
            <g key={index} transform={`translate(${index * 250}, 0)`}>
              <rect x="-10" y="-10" width="220" height="80" rx="12" fill="#ffffff" opacity="0.1" />
              <text x="20" y="20" fontSize="32">
                {item.icon}
              </text>
              <text x="70" y="15" fontSize="18" fontWeight="600" fill="#ffffff">
                {item.text}
              </text>
              <text x="70" y="35" fontSize="14" fill="#ffffff" opacity="0.8">
                {item.desc}
              </text>
            </g>
          ))}
        </g>
      </g>

      {/* Bottom action bar */}
      <g transform="translate(100, 540)">
        <rect
          width="1000"
          height="50"
          rx="25"
          fill={darkMode ? '#1e293b' : '#ffffff'}
          stroke={accentColor}
          strokeWidth="2"
        />
        <text x="500" y="32" textAnchor="middle" fontSize="18" fontWeight="600" fill={textColor}>
          Visit the Grant Portal â†’{' '}
          <tspan fill={accentColor} style={{ textDecoration: 'underline' }}>
            civil-society-grants-database.netlify.app
          </tspan>
        </text>
      </g>

      {/* Animated elements */}
      <g>
        {[...Array(5)].map((_, i) => (
          <circle key={i} cx={100 + i * 250} cy={50} r="3" fill={accentColor} opacity="0">
            <animate
              attributeName="opacity"
              values="0;1;0"
              dur="3s"
              begin={`${i * 0.5}s`}
              repeatCount="indefinite"
            />
            <animate
              attributeName="cy"
              from="50"
              to="550"
              dur="3s"
              begin={`${i * 0.5}s`}
              repeatCount="indefinite"
            />
          </circle>
        ))}
      </g>
    </svg>
  );
};

export default {
  KeyStatisticsInfographic,
  FocusAreasInfographic,
  TimelineInfographic,
  RegionalImpactInfographic,
  InternationalSupportInfographic,
  FuturePrioritiesInfographic,
  CallToActionInfographic,
};



================================================================================
FILE: client/src/context/AuthContext.js
SIZE: 2515 bytes
================================================================================

import React, { createContext, useState, useContext, useEffect } from 'react';
import axios from 'axios';
import { supabase } from '../lib/supabase';

const AuthContext = createContext();

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const token = localStorage.getItem('authToken');
    if (token) {
      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
      fetchUser();
    } else {
      setLoading(false);
    }
  }, []);

  const fetchUser = async () => {
    try {
      const response = await axios.get('/.netlify/functions/auth/me');
      setUser(response.data);
    } catch (error) {
      console.error('Failed to fetch user:', error);
      localStorage.removeItem('authToken');
      delete axios.defaults.headers.common['Authorization'];
    } finally {
      setLoading(false);
    }
  };

  const login = async (username, password) => {
    try {
      setError(null);
      const response = await axios.post('/.netlify/functions/auth/login', { username, password });
      const { token, user } = response.data;

      localStorage.setItem('authToken', token);
      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
      setUser(user);

      return { success: true };
    } catch (error) {
      const message = error.response?.data?.error || 'Login failed';
      setError(message);
      return { success: false, error: message };
    }
  };

  const logout = () => {
    localStorage.removeItem('authToken');
    delete axios.defaults.headers.common['Authorization'];
    setUser(null);
  };

  const changePassword = async (currentPassword, newPassword) => {
    try {
      await axios.post('/.netlify/functions/auth/change-password', {
        currentPassword,
        newPassword,
      });
      return { success: true };
    } catch (error) {
      const message = error.response?.data?.error || 'Failed to change password';
      return { success: false, error: message };
    }
  };

  const value = {
    user,
    loading,
    error,
    login,
    logout,
    changePassword,
    isAuthenticated: !!user,
  };

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};



================================================================================
FILE: client/src/context/LanguageContext.js
SIZE: 137 bytes
================================================================================

import { createContext } from 'react';

export const LanguageContext = createContext({
  language: 'en',
  changeLanguage: () => {},
});



================================================================================
FILE: client/src/context/ThemeContext.js
SIZE: 925 bytes
================================================================================

import { createContext, useState, useEffect } from 'react';

export const ThemeContext = createContext({
  darkMode: false,
  toggleDarkMode: () => {},
});

export const ThemeProvider = ({ children }) => {
  const [darkMode, setDarkMode] = useState(() => {
    const savedTheme = localStorage.getItem('theme');
    return (
      savedTheme === 'dark' ||
      (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)
    );
  });

  useEffect(() => {
    const root = window.document.documentElement;
    if (darkMode) {
      root.classList.add('dark');
      localStorage.setItem('theme', 'dark');
    } else {
      root.classList.remove('dark');
      localStorage.setItem('theme', 'light');
    }
  }, [darkMode]);

  const toggleDarkMode = () => {
    setDarkMode(!darkMode);
  };

  return (
    <ThemeContext.Provider value={{ darkMode, toggleDarkMode }}>{children}</ThemeContext.Provider>
  );
};



================================================================================
FILE: client/src/hooks/useInfiniteScroll.js
SIZE: 3997 bytes
================================================================================

import { useState, useEffect, useCallback, useRef } from 'react';

/**
 * Custom hook for infinite scroll functionality
 * @param {Function} fetchMore - Function to fetch more items
 * @param {boolean} hasMore - Whether there are more items to load
 * @param {Object} options - Configuration options
 * @returns {Object} - Hook state and utilities
 */
export function useInfiniteScroll(fetchMore, hasMore = true, options = {}) {
  const {
    threshold = 100, // pixels from bottom to trigger load
    initialLoad = true,
    delay = 0, // debounce delay
  } = options;

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [page, setPage] = useState(1);
  const observerRef = useRef(null);
  const loadingRef = useRef(false);
  const delayTimeoutRef = useRef(null);

  // Sentinel element to observe
  const sentinelRef = useCallback(node => {
    if (loading) return;
    
    if (observerRef.current) {
      observerRef.current.disconnect();
    }
    
    if (!node || !hasMore) return;
    
    observerRef.current = new IntersectionObserver(
      entries => {
        if (entries[0].isIntersecting && hasMore && !loadingRef.current) {
          loadMoreItems();
        }
      },
      {
        root: null,
        rootMargin: `${threshold}px`,
        threshold: 0
      }
    );
    
    observerRef.current.observe(node);
  }, [loading, hasMore, threshold]);

  const loadMoreItems = useCallback(async () => {
    if (loadingRef.current || !hasMore) return;
    
    // Clear any existing timeout
    if (delayTimeoutRef.current) {
      clearTimeout(delayTimeoutRef.current);
    }
    
    // Apply delay if specified
    delayTimeoutRef.current = setTimeout(async () => {
      loadingRef.current = true;
      setLoading(true);
      setError(null);
      
      try {
        await fetchMore(page);
        setPage(prev => prev + 1);
      } catch (err) {
        setError(err);
        console.error('Error loading more items:', err);
      } finally {
        loadingRef.current = false;
        setLoading(false);
      }
    }, delay);
  }, [fetchMore, hasMore, page, delay]);

  // Initial load
  useEffect(() => {
    if (initialLoad && page === 1) {
      loadMoreItems();
    }
  }, []);

  // Cleanup
  useEffect(() => {
    return () => {
      if (observerRef.current) {
        observerRef.current.disconnect();
      }
      if (delayTimeoutRef.current) {
        clearTimeout(delayTimeoutRef.current);
      }
    };
  }, []);

  // Manual trigger for loading more
  const loadMore = useCallback(() => {
    if (!loading && hasMore) {
      loadMoreItems();
    }
  }, [loading, hasMore, loadMoreItems]);

  // Reset pagination
  const reset = useCallback(() => {
    setPage(1);
    setError(null);
    if (observerRef.current) {
      observerRef.current.disconnect();
    }
  }, []);

  return {
    loading,
    error,
    page,
    sentinelRef,
    loadMore,
    reset,
  };
}

/**
 * Hook for virtualized list rendering
 * @param {Array} items - Full list of items
 * @param {number} itemHeight - Height of each item
 * @param {number} containerHeight - Height of the container
 * @param {number} overscan - Number of items to render outside viewport
 * @returns {Object} - Virtualization state
 */
export function useVirtualizedList(items, itemHeight, containerHeight, overscan = 3) {
  const [scrollTop, setScrollTop] = useState(0);
  
  const startIndex = Math.max(0, Math.floor(scrollTop / itemHeight) - overscan);
  const endIndex = Math.min(
    items.length - 1,
    Math.ceil((scrollTop + containerHeight) / itemHeight) + overscan
  );
  
  const visibleItems = items.slice(startIndex, endIndex + 1);
  const totalHeight = items.length * itemHeight;
  const offsetY = startIndex * itemHeight;
  
  const handleScroll = useCallback((e) => {
    setScrollTop(e.target.scrollTop);
  }, []);
  
  return {
    visibleItems,
    totalHeight,
    offsetY,
    handleScroll,
    startIndex,
    endIndex
  };
}


================================================================================
FILE: client/src/hooks/useQuillLoader.js
SIZE: 5355 bytes
================================================================================

import { useState, useEffect, useRef } from 'react';
import {
  isQuillLoaded,
  markQuillAsLoaded,
  incrementQuillErrorCount,
  createConsoleOverride,
  registerQuillInstance,
  unregisterQuillInstance,
} from '../utils/quillUtils';

// Global state to track if Quill is already loaded
let quillLoadingPromise = null;

/**
 * Custom hook to manage ReactQuill loading
 * Ensures Quill is only loaded once across all components
 */
export const useQuillLoader = () => {
  const [isLoading, setIsLoading] = useState(!isQuillLoaded());
  const [error, setError] = useState(null);
  const [QuillComponent, setQuillComponent] = useState(null);
  const mountedRef = useRef(true);
  const instanceId = useRef(
    `quill-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
  ).current;

  useEffect(() => {
    // Register this instance
    registerQuillInstance(instanceId);

    const loadQuill = async () => {
      // If already loaded, return immediately
      if (isQuillLoaded() && QuillComponent) {
        setIsLoading(false);
        return;
      }

      // If already loading, wait for the existing promise
      if (quillLoadingPromise) {
        try {
          const result = await quillLoadingPromise;
          if (mountedRef.current) {
            setQuillComponent(result);
            setIsLoading(false);
            markQuillAsLoaded();
          }
        } catch (err) {
          if (mountedRef.current) {
            incrementQuillErrorCount();
            setError(err);
            setIsLoading(false);
          }
        }
        return;
      }

      // Start loading Quill
      quillLoadingPromise = new Promise(async (resolve, reject) => {
        try {
          // Check if Quill is already in the global scope
          if (window.Quill && window.ReactQuill) {
            const { default: QuillModule } = await import('react-quill');
            resolve(QuillModule);
            return;
          }

          // Suppress console warnings during load
          const originalError = console.error;
          const originalWarn = console.warn;
          const consoleOverride = createConsoleOverride();

          // Check and prevent duplicate custom element registration
          if (window.customElements && window.customElements.get('autosize-textarea')) {
            console.debug('autosize-textarea already registered, skipping registration');
            // Override customElements.define temporarily
            const originalDefine = window.customElements.define;
            window.customElements.define = function (name, ...args) {
              if (name === 'autosize-textarea' && window.customElements.get(name)) {
                console.debug('Prevented duplicate registration of autosize-textarea');
                return;
              }
              return originalDefine.apply(this, [name, ...args]);
            };
          }

          // Dynamic import with timeout
          const loadWithTimeout = (ms = 10000) => {
            return Promise.race([
              Promise.all([import('react-quill'), import('react-quill/dist/quill.snow.css')]),
              new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Quill load timeout')), ms)
              ),
            ]);
          };

          const [QuillModule] = await loadWithTimeout();

          // Restore console methods
          setTimeout(() => {
            console.error = originalError;
            console.warn = originalWarn;
          }, 100);

          // Mark as loaded globally
          isQuillLoaded = true;
          resolve(QuillModule.default);
        } catch (err) {
          console.error('Failed to load ReactQuill:', err);
          reject(err);
        }
      });

      try {
        const result = await quillLoadingPromise;
        if (mountedRef.current) {
          setQuillComponent(result);
          setIsLoading(false);
        }
      } catch (err) {
        if (mountedRef.current) {
          setError(err);
          setIsLoading(false);
        }
      }
    };

    loadQuill();

    // Cleanup function
    return () => {
      mountedRef.current = false;
      unregisterQuillInstance(instanceId);
    };
  }, [QuillComponent, instanceId]);

  return {
    isLoading,
    error,
    QuillComponent,
    isQuillLoaded,
  };
};

/**
 * Fallback textarea component when Quill fails to load
 */
export const FallbackEditor = ({
  value,
  onChange,
  placeholder = 'Enter your content here...',
  className = '',
  darkMode = false,
}) => {
  return (
    <div className="space-y-2">
      <div
        className={`p-3 rounded-md border text-sm ${
          darkMode
            ? 'bg-yellow-900 text-yellow-200 border-yellow-700'
            : 'bg-yellow-50 text-yellow-800 border-yellow-200'
        }`}
      >
        <p>Rich text editor is not available. Using plain text editor.</p>
      </div>
      <textarea
        value={value}
        onChange={e => onChange(e.target.value)}
        placeholder={placeholder}
        className={`w-full min-h-[200px] p-3 border rounded-md resize-vertical ${className} ${
          darkMode
            ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400'
            : 'bg-white border-gray-300 text-gray-900 placeholder-gray-500'
        }`}
      />
    </div>
  );
};

export default useQuillLoader;



================================================================================
FILE: client/src/i18n/i18n.js
SIZE: 631 bytes
================================================================================

import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import LanguageDetector from 'i18next-browser-languagedetector';
import HttpBackend from 'i18next-http-backend';

i18n
  .use(HttpBackend)
  .use(LanguageDetector)
  .use(initReactI18next)
  .init({
    fallbackLng: 'en',
    supportedLngs: ['en', 'uk'],
    interpolation: {
      escapeValue: false,
    },
    detection: {
      order: ['localStorage', 'navigator'],
      caches: ['localStorage'],
    },
    react: {
      useSuspense: false,
    },
    backend: {
      loadPath: '/locales/{{lng}}/{{ns}}.json',
    },
  });

export default i18n;



================================================================================
FILE: client/src/index.css
SIZE: 2272 bytes
================================================================================

/* Tailwind directives */
/* purgecss start ignore */
@import 'tailwindcss/base';
@import 'tailwindcss/components';
@import 'tailwindcss/utilities';
/* purgecss end ignore */

/* Accessibility improvements */
/* Enhanced focus indicators */
:focus {
  outline: 2px solid #2563eb;
  outline-offset: 2px;
}

/* Remove default focus for mouse users, keep for keyboard users */
:focus:not(:focus-visible) {
  outline: none;
}

/* Visible focus for keyboard navigation */
:focus-visible {
  outline: 2px solid #2563eb;
  outline-offset: 2px;
  box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
}

/* Dark mode focus styles */
.dark :focus-visible {
  outline-color: #60a5fa;
  box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.1);
}

/* Skip navigation link styles */
.sr-only:focus {
  position: absolute;
  width: auto;
  height: auto;
  padding: 0.5rem 1rem;
  margin: 0;
  overflow: visible;
  clip: auto;
  white-space: normal;
  z-index: 9999;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  :focus-visible {
    outline-width: 3px;
    outline-style: solid;
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  background-color: #f5f7fa;
}

code {
  font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
    monospace;
}

.App {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Line clamp utility classes */
.line-clamp-1 {
  display: -webkit-box;
  -webkit-line-clamp: 1;
  line-clamp: 1;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.line-clamp-3 {
  display: -webkit-box;
  -webkit-line-clamp: 3;
  line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}



================================================================================
FILE: client/src/index.js
SIZE: 1358 bytes
================================================================================

import React from 'react';
import ReactDOM from 'react-dom/client';
import './index.css';
import App from './App';
import reportWebVitals from './reportWebVitals';
import { BrowserRouter } from 'react-router-dom';
import { HelmetProvider } from 'react-helmet-async';
import './i18n/i18n';

// Prevent duplicate custom element registration errors
if (window.customElements) {
  const originalDefine = window.customElements.define;
  window.customElements.define = function (name, constructor, options) {
    if (window.customElements.get(name)) {
      console.debug(`Custom element ${name} already defined, skipping registration`);
      return;
    }
    try {
      return originalDefine.call(this, name, constructor, options);
    } catch (error) {
      if (error.name === 'NotSupportedError' || error.message.includes('already been defined')) {
        console.debug(`Caught duplicate registration error for ${name}, safely ignoring`);
        return;
      }
      throw error;
    }
  };
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <React.StrictMode>
    <HelmetProvider>
      <BrowserRouter
        future={{
          v7_startTransition: true,
          v7_relativeSplatPath: true,
        }}
      >
        <App />
      </BrowserRouter>
    </HelmetProvider>
  </React.StrictMode>
);

reportWebVitals();



================================================================================
FILE: client/src/lib/supabase.js
SIZE: 5088 bytes
================================================================================

import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.REACT_APP_SUPABASE_URL;
const supabaseAnonKey = process.env.REACT_APP_SUPABASE_ANON_KEY;

// Log for debugging
console.log('Initializing Supabase with:', {
  url: supabaseUrl,
  hasKey: !!supabaseAnonKey,
});

if (!supabaseUrl || !supabaseAnonKey) {
  console.error('Missing Supabase environment variables!');
}

export const supabase = createClient(supabaseUrl || '', supabaseAnonKey || '', {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: true,
  },
  realtime: {
    params: {
      eventsPerSecond: 10,
    },
  },
});

// Auth helper functions
export const auth = {
  signIn: async (email, password) => {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    return { data, error };
  },

  signUp: async (email, password, userData = {}) => {
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: userData,
      },
    });
    return { data, error };
  },

  signOut: async () => {
    const { error } = await supabase.auth.signOut();
    return { error };
  },

  getUser: async () => {
    const {
      data: { user },
      error,
    } = await supabase.auth.getUser();
    return { user, error };
  },

  getSession: async () => {
    const {
      data: { session },
      error,
    } = await supabase.auth.getSession();
    return { session, error };
  },
};

// Database helper functions
export const db = {
  // Grants
  getGrants: async (filters = {}) => {
    let query = supabase.from('grants').select('*').eq('status', 'active');

    if (filters.search) {
      query = query.or(
        `grant_name.ilike.%${filters.search}%,funding_organization.ilike.%${filters.search}%,focus_areas.ilike.%${filters.search}%`
      );
    }

    if (filters.organization) {
      query = query.eq('funding_organization', filters.organization);
    }

    if (filters.country) {
      query = query.eq('country_region', filters.country);
    }

    if (filters.focusArea) {
      query = query.ilike('focus_areas', `%${filters.focusArea}%`);
    }

    const { data, error } = await query.order('application_deadline', { ascending: true });
    return { data, error };
  },

  getGrant: async id => {
    const { data, error } = await supabase
      .from('grants')
      .select('*')
      .eq('id', id)
      .eq('status', 'active')
      .single();
    return { data, error };
  },

  getFilters: async () => {
    const { data: grants, error } = await supabase
      .from('grants')
      .select('funding_organization, country_region, focus_areas')
      .eq('status', 'active');

    if (error) return { data: null, error };

    const organizations = [
      ...new Set(grants.map(g => g.funding_organization).filter(Boolean)),
    ].sort();
    const countries = [...new Set(grants.map(g => g.country_region).filter(Boolean))].sort();
    const focusAreas = [
      ...new Set(
        grants
          .flatMap(g => (g.focus_areas ? g.focus_areas.split(',').map(area => area.trim()) : []))
          .filter(Boolean)
      ),
    ].sort();

    return {
      data: {
        organizations,
        countries,
        focusAreas,
      },
      error: null,
    };
  },

  // Admin functions
  createGrant: async grantData => {
    const { data, error } = await supabase.from('grants').insert(grantData).select().single();
    return { data, error };
  },

  updateGrant: async (id, grantData) => {
    const { data, error } = await supabase
      .from('grants')
      .update(grantData)
      .eq('id', id)
      .select()
      .single();
    return { data, error };
  },

  deleteGrant: async id => {
    const { error } = await supabase.from('grants').delete().eq('id', id);
    return { error };
  },

  // Chat functions
  createChatSession: async (sessionData = {}) => {
    const { data, error } = await supabase
      .from('chat_sessions')
      .insert({
        session_data: sessionData,
      })
      .select()
      .single();
    return { data, error };
  },

  getChatHistory: async sessionId => {
    const { data, error } = await supabase
      .from('chat_messages')
      .select('*')
      .eq('session_id', sessionId)
      .order('created_at', { ascending: true });
    return { data, error };
  },

  // Real-time subscriptions
  subscribeToChatMessages: (sessionId, callback) => {
    return supabase
      .channel(`chat_messages:${sessionId}`)
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'chat_messages',
          filter: `session_id=eq.${sessionId}`,
        },
        callback
      )
      .subscribe();
  },

  subscribeToGrants: callback => {
    return supabase
      .channel('grants_changes')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'grants',
        },
        callback
      )
      .subscribe();
  },
};

export default supabase;



================================================================================
FILE: client/src/pages/AboutPage.js
SIZE: 8853 bytes
================================================================================

import React, { useContext } from 'react';
import { useTranslation } from 'react-i18next';
import { ThemeContext } from '../context/ThemeContext';

const AboutPage = () => {
  const { t } = useTranslation();
  const { darkMode } = useContext(ThemeContext);

  return (
    <div
      className={`about-page ${darkMode ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-800'} min-h-screen transition-colors duration-300 py-6`}
    >
      <div className="container mx-auto px-4">
        <h1
          className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-8 transition-colors duration-300`}
        >
          {t('about.title')}
        </h1>

        <div
          className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-md p-8 mb-8 transition-colors duration-300`}
        >
          <h2
            className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4 transition-colors duration-300`}
          >
            {t('about.purpose')}
          </h2>
          <p
            className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-6 text-lg leading-relaxed transition-colors duration-300`}
          >
            {t('about.purposeText')}
          </p>

          <div
            className={`${darkMode ? 'bg-blue-900 border-blue-700' : 'bg-blue-50 border-blue-500'} border-l-4 p-4 mb-6 transition-colors duration-300`}
          >
            <p
              className={`${darkMode ? 'text-blue-300' : 'text-blue-700'} transition-colors duration-300`}
            >
              This database includes grants from various international donors, governments, and
              organizations focused on supporting civil society initiatives in Ukraine and
              surrounding regions.
            </p>
          </div>

          <p
            className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} text-lg leading-relaxed transition-colors duration-300`}
          >
            We aim to make funding opportunities more accessible by presenting them in a structured,
            searchable format with comprehensive filtering options in both English and Ukrainian
            languages.
          </p>
        </div>

        <div
          className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-md p-8 mb-8 transition-colors duration-300`}
        >
          <h2
            className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4 transition-colors duration-300`}
          >
            {t('about.howToUse')}
          </h2>
          <p
            className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-6 text-lg leading-relaxed transition-colors duration-300`}
          >
            {t('about.howToUseText')}
          </p>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div
              className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-md transition-colors duration-300`}
            >
              <div
                className={`${darkMode ? 'text-blue-400' : 'text-blue-600'} text-4xl font-bold mb-2 transition-colors duration-300`}
              >
                1
              </div>
              <h3
                className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-2 transition-colors duration-300`}
              >
                Search
              </h3>
              <p
                className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} transition-colors duration-300`}
              >
                Use the search box to look for specific keywords related to your organization's
                work.
              </p>
            </div>

            <div
              className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-md transition-colors duration-300`}
            >
              <div
                className={`${darkMode ? 'text-blue-400' : 'text-blue-600'} text-4xl font-bold mb-2 transition-colors duration-300`}
              >
                2
              </div>
              <h3
                className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-2 transition-colors duration-300`}
              >
                Filter
              </h3>
              <p
                className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} transition-colors duration-300`}
              >
                Narrow down results by funding organization, country, focus area, grant amount, or
                deadline.
              </p>
            </div>

            <div
              className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-4 rounded-md transition-colors duration-300`}
            >
              <div
                className={`${darkMode ? 'text-blue-400' : 'text-blue-600'} text-4xl font-bold mb-2 transition-colors duration-300`}
              >
                3
              </div>
              <h3
                className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-2 transition-colors duration-300`}
              >
                Apply
              </h3>
              <p
                className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} transition-colors duration-300`}
              >
                Follow the links to official websites to read complete guidelines and submit
                applications.
              </p>
            </div>
          </div>

          <p
            className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} text-lg leading-relaxed transition-colors duration-300`}
          >
            The database is regularly updated to include the latest opportunities. Check back often
            or bookmark relevant grants to stay informed about upcoming deadlines.
          </p>
        </div>

        <div
          className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-md p-8 transition-colors duration-300`}
        >
          <h2
            className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4 transition-colors duration-300`}
          >
            {t('about.contact')}
          </h2>
          <p
            className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-6 text-lg leading-relaxed transition-colors duration-300`}
          >
            {t('about.contactText')}
          </p>

          <div
            className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} p-6 rounded-lg transition-colors duration-300`}
          >
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h3
                  className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-2 transition-colors duration-300`}
                >
                  Contact Person
                </h3>
                <p
                  className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} transition-colors duration-300 font-medium`}
                >
                  Fedo Hagge-Kubat
                </p>
              </div>

              <div>
                <h3
                  className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-2 transition-colors duration-300`}
                >
                  Phone
                </h3>
                <p
                  className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} transition-colors duration-300`}
                >
                  +49 174 403 1399
                </p>
              </div>

              <div>
                <h3
                  className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-2 transition-colors duration-300`}
                >
                  Address
                </h3>
                <p
                  className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} transition-colors duration-300`}
                >
                  Prenlauer Alle 229, 10405 Berlin
                </p>
              </div>

              <div>
                <h3
                  className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-2 transition-colors duration-300`}
                >
                  LinkedIn
                </h3>
                <p className={`transition-colors duration-300`}>
                  <a
                    href="https://www.linkedin.com/in/fedo-hagge-kubat-36814415b/"
                    target="_blank"
                    rel="noopener noreferrer"
                    className={`${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-800'} transition-colors duration-200`}
                  >
                    linkedin.com/in/fedo-hagge-kubat-36814415b
                  </a>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default AboutPage;



================================================================================
FILE: client/src/pages/AdminAnalytics.js
SIZE: 16394 bytes
================================================================================

import React, { useState, useEffect, useContext } from 'react';
import { ThemeContext } from '../context/ThemeContext';
import { fetchGrantsForAdmin } from '../utils/adminApiHelper';
import { 
  ChartBarIcon, 
  ArrowDownTrayIcon, 
  CalendarIcon,
  BanknotesIcon,
  GlobeAltIcon,
  DocumentChartBarIcon
} from '@heroicons/react/24/outline';

const AdminAnalytics = () => {
  const { darkMode } = useContext(ThemeContext);
  const [grants, setGrants] = useState([]);
  const [analytics, setAnalytics] = useState({
    totalGrants: 0,
    totalFunding: 0,
    averageFunding: 0,
    grantsByCountry: [],
    grantsByType: [],
    upcomingDeadlines: [],
    grantsByMonth: []
  });
  const [loading, setLoading] = useState(true);
  const [exportType, setExportType] = useState('all'); // all, filtered, analytics

  useEffect(() => {
    fetchAnalytics();
  }, []);

  const fetchAnalytics = async () => {
    try {
      const grantsData = await fetchGrantsForAdmin();
      setGrants(grantsData);
      
      // Calculate analytics
      const totalGrants = grantsData.length;
      
      // Total funding calculation
      const totalFunding = grantsData.reduce((sum, grant) => {
        const max = grant.grant_size_max || 0;
        return sum + max;
      }, 0);
      
      // Average funding
      const averageFunding = totalGrants > 0 ? totalFunding / totalGrants : 0;
      
      // Grants by country
      const countryMap = {};
      grantsData.forEach(grant => {
        const country = grant.geographic_focus || 'Unknown';
        countryMap[country] = (countryMap[country] || 0) + 1;
      });
      const grantsByCountry = Object.entries(countryMap)
        .map(([country, count]) => ({ country, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 10);
      
      // Grants by type
      const typeMap = {};
      grantsData.forEach(grant => {
        const type = grant.type || 'Unknown';
        typeMap[type] = (typeMap[type] || 0) + 1;
      });
      const grantsByType = Object.entries(typeMap)
        .map(([type, count]) => ({ type, count }))
        .sort((a, b) => b.count - a.count);
      
      // Upcoming deadlines (next 30 days)
      const today = new Date();
      const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
      const upcomingDeadlines = grantsData
        .filter(grant => {
          if (!grant.deadline) return false;
          const deadline = new Date(grant.deadline);
          return deadline >= today && deadline <= thirtyDaysFromNow;
        })
        .sort((a, b) => new Date(a.deadline) - new Date(b.deadline))
        .slice(0, 10);
      
      // Grants by month (for the current year)
      const currentYear = new Date().getFullYear();
      const monthMap = {};
      grantsData.forEach(grant => {
        if (grant.created_at) {
          const date = new Date(grant.created_at);
          if (date.getFullYear() === currentYear) {
            const month = date.toLocaleString('default', { month: 'short' });
            monthMap[month] = (monthMap[month] || 0) + 1;
          }
        }
      });
      
      setAnalytics({
        totalGrants,
        totalFunding,
        averageFunding,
        grantsByCountry,
        grantsByType,
        upcomingDeadlines,
        grantsByMonth: Object.entries(monthMap).map(([month, count]) => ({ month, count }))
      });
      
      setLoading(false);
    } catch (error) {
      console.error('Failed to fetch analytics:', error);
      setLoading(false);
    }
  };

  const exportAnalyticsReport = () => {
    const report = {
      generatedAt: new Date().toISOString(),
      summary: {
        totalGrants: analytics.totalGrants,
        totalFunding: analytics.totalFunding,
        averageFunding: analytics.averageFunding
      },
      grantsByCountry: analytics.grantsByCountry,
      grantsByType: analytics.grantsByType,
      upcomingDeadlines: analytics.upcomingDeadlines.map(g => ({
        name: g.name,
        organization: g.organization,
        deadline: g.deadline,
        amount: `â‚¬${g.grant_size_min || 0} - â‚¬${g.grant_size_max || 0}`
      })),
      grantsByMonth: analytics.grantsByMonth
    };

    const jsonString = JSON.stringify(report, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `grants_analytics_report_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const exportFilteredGrants = (filter) => {
    let filteredGrants = grants;
    
    if (filter === 'upcoming') {
      const today = new Date();
      const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
      filteredGrants = grants.filter(grant => {
        if (!grant.deadline) return false;
        const deadline = new Date(grant.deadline);
        return deadline >= today && deadline <= thirtyDaysFromNow;
      });
    } else if (filter === 'high-value') {
      filteredGrants = grants.filter(grant => grant.grant_size_max >= 100000);
    }

    const headers = [
      'Grant Name',
      'Organization',
      'Geographic Focus',
      'Focus Areas',
      'Grant Type',
      'Min Amount',
      'Max Amount',
      'Deadline',
      'Website',
      'Application URL'
    ];

    const csvRows = filteredGrants.map(grant => {
      return [
        grant.name || '',
        grant.organization || '',
        grant.geographic_focus || '',
        grant.focus_areas_en || '',
        grant.type || '',
        grant.grant_size_min || '',
        grant.grant_size_max || '',
        grant.deadline || '',
        grant.website || '',
        grant.application_url || ''
      ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(',');
    });

    const csvContent = [headers.join(','), ...csvRows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `grants_${filter}_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'EUR',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(amount);
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div>
      <div className="mb-6">
        <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-2`}>
          Analytics & Reports
        </h1>
        <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
          View analytics and export detailed reports
        </p>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <div className="flex items-center justify-between">
            <div>
              <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Total Grants
              </p>
              <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {analytics.totalGrants}
              </p>
            </div>
            <DocumentChartBarIcon className={`h-8 w-8 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`} />
          </div>
        </div>

        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <div className="flex items-center justify-between">
            <div>
              <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Total Funding Available
              </p>
              <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {formatCurrency(analytics.totalFunding)}
              </p>
            </div>
            <BanknotesIcon className={`h-8 w-8 ${darkMode ? 'text-green-400' : 'text-green-600'}`} />
          </div>
        </div>

        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <div className="flex items-center justify-between">
            <div>
              <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Average Grant Size
              </p>
              <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {formatCurrency(analytics.averageFunding)}
              </p>
            </div>
            <ChartBarIcon className={`h-8 w-8 ${darkMode ? 'text-purple-400' : 'text-purple-600'}`} />
          </div>
        </div>
      </div>

      {/* Export Actions */}
      <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6 mb-8`}>
        <h2 className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'} mb-4`}>
          Export Reports
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <button
            onClick={exportAnalyticsReport}
            className="flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            <ArrowDownTrayIcon className="h-5 w-5 mr-2" />
            Analytics Report
          </button>
          
          <button
            onClick={() => exportFilteredGrants('all')}
            className="flex items-center justify-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
          >
            <ArrowDownTrayIcon className="h-5 w-5 mr-2" />
            All Grants CSV
          </button>
          
          <button
            onClick={() => exportFilteredGrants('upcoming')}
            className="flex items-center justify-center px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors"
          >
            <ArrowDownTrayIcon className="h-5 w-5 mr-2" />
            Upcoming Deadlines
          </button>
          
          <button
            onClick={() => exportFilteredGrants('high-value')}
            className="flex items-center justify-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
          >
            <ArrowDownTrayIcon className="h-5 w-5 mr-2" />
            High-Value Grants
          </button>
        </div>
      </div>

      {/* Analytics Tables */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* Grants by Country */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow`}>
          <div className={`px-6 py-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
            <h3 className={`text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-900'} flex items-center`}>
              <GlobeAltIcon className="h-5 w-5 mr-2" />
              Grants by Geographic Focus
            </h3>
          </div>
          <div className="p-6">
            <div className="space-y-3">
              {analytics.grantsByCountry.map((item, index) => (
                <div key={index} className="flex justify-between items-center">
                  <span className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    {item.country}
                  </span>
                  <span className={`font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {item.count}
                  </span>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Upcoming Deadlines */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow`}>
          <div className={`px-6 py-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
            <h3 className={`text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-900'} flex items-center`}>
              <CalendarIcon className="h-5 w-5 mr-2" />
              Upcoming Deadlines (30 days)
            </h3>
          </div>
          <div className="p-6">
            <div className="space-y-3">
              {analytics.upcomingDeadlines.length === 0 ? (
                <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  No upcoming deadlines
                </p>
              ) : (
                analytics.upcomingDeadlines.map((grant, index) => (
                  <div key={index} className={`pb-3 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'} last:border-0 last:pb-0`}>
                    <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                      {grant.name}
                    </p>
                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      {grant.organization} â€¢ {new Date(grant.deadline).toLocaleDateString()}
                    </p>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Email Digest Feature Guide */}
      <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6 mt-8`}>
        <h2 className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'} mb-4`}>
          Email Digest Feature (Implementation Guide)
        </h2>
        <div className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} space-y-4`}>
          <p>To implement automated email digests, follow these steps:</p>
          
          <div className="space-y-3">
            <div className="flex items-start">
              <span className="font-semibold mr-2">1.</span>
              <div>
                <p className="font-semibold">Set up email service (Netlify Functions + SendGrid/SES)</p>
                <p className="text-sm mt-1">Create a new function: <code className="bg-gray-200 px-1 rounded">client/netlify/functions/email-digest.js</code></p>
              </div>
            </div>
            
            <div className="flex items-start">
              <span className="font-semibold mr-2">2.</span>
              <div>
                <p className="font-semibold">Create subscription management</p>
                <p className="text-sm mt-1">Add database table for email subscriptions with preferences (frequency, filters)</p>
              </div>
            </div>
            
            <div className="flex items-start">
              <span className="font-semibold mr-2">3.</span>
              <div>
                <p className="font-semibold">Implement digest templates</p>
                <ul className="text-sm mt-1 ml-4 list-disc">
                  <li>Weekly summary of new grants</li>
                  <li>Upcoming deadline reminders</li>
                  <li>Grants matching user preferences</li>
                </ul>
              </div>
            </div>
            
            <div className="flex items-start">
              <span className="font-semibold mr-2">4.</span>
              <div>
                <p className="font-semibold">Schedule automated sending</p>
                <p className="text-sm mt-1">Use Netlify scheduled functions or external cron service</p>
              </div>
            </div>
          </div>
          
          <div className={`mt-4 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
            <p className="font-semibold mb-2">Example Digest Content:</p>
            <ul className="text-sm space-y-1 ml-4 list-disc">
              <li>5 new grants added this week</li>
              <li>3 grants with deadlines in the next 7 days</li>
              <li>Personalized recommendations based on organization type</li>
              <li>Total funding available: â‚¬2.5M</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
};

export default AdminAnalytics;


================================================================================
FILE: client/src/pages/AdminBlog.js
SIZE: 8745 bytes
================================================================================

import React, { useState, useEffect, useContext } from 'react';
import { Link } from 'react-router-dom';
import axios from 'axios';
import { ThemeContext } from '../context/ThemeContext';
import { fetchBlogPostsForAdmin } from '../utils/adminApiHelper';
import { PlusIcon, PencilIcon, TrashIcon, EyeIcon } from '@heroicons/react/24/outline';

const AdminBlog = () => {
  const { darkMode } = useContext(ThemeContext);
  const [posts, setPosts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('all');

  useEffect(() => {
    fetchPosts();
  }, []);

  const fetchPosts = async () => {
    try {
      // Get all posts (published and drafts) for admin view
      const postsData = await fetchBlogPostsForAdmin();
      setPosts(postsData);
      setLoading(false);
    } catch (error) {
      console.error('Failed to fetch posts:', error);
      setPosts([]);
      setLoading(false);
    }
  };

  const handleDelete = async id => {
    if (!window.confirm('Are you sure you want to delete this post?')) return;

    try {
      const token = localStorage.getItem('authToken'); // Fixed: was looking for 'token' instead of 'authToken'
      await axios.delete(`/.netlify/functions/blog/${id}`, {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
      fetchPosts();
    } catch (error) {
      console.error('Failed to delete post:', error);
      alert('Failed to delete post');
    }
  };

  const handleStatusChange = async (id, newStatus) => {
    try {
      const token = localStorage.getItem('authToken'); // Fixed: was looking for 'token' instead of 'authToken'
      await axios.put(
        `/.netlify/functions/blog/${id}`,
        { status: newStatus },
        {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );
      fetchPosts();
    } catch (error) {
      console.error('Failed to update post status:', error);
    }
  };

  const formatDate = dateString => {
    if (!dateString) return 'N/A';
    try {
      return new Date(dateString).toLocaleDateString();
    } catch {
      return dateString;
    }
  };

  const filteredPosts = filter === 'all' ? posts : posts.filter(post => post.status === filter);

  if (loading) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div>
      <div className="mb-6">
        <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-2`}>
          Blog Posts
        </h1>
        <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
          Manage your blog posts and announcements
        </p>
      </div>

      {/* Filters and Add Button */}
      <div className="mb-6 flex flex-col sm:flex-row justify-between gap-4">
        <div className="flex gap-2">
          <button
            onClick={() => setFilter('all')}
            className={`px-4 py-2 rounded-lg ${
              filter === 'all'
                ? 'bg-blue-600 text-white'
                : darkMode
                  ? 'bg-gray-800 text-gray-300 hover:bg-gray-700'
                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
            } transition-colors`}
          >
            All ({posts.length})
          </button>
          <button
            onClick={() => setFilter('published')}
            className={`px-4 py-2 rounded-lg ${
              filter === 'published'
                ? 'bg-blue-600 text-white'
                : darkMode
                  ? 'bg-gray-800 text-gray-300 hover:bg-gray-700'
                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
            } transition-colors`}
          >
            Published ({posts.filter(p => p.status === 'published').length})
          </button>
          <button
            onClick={() => setFilter('draft')}
            className={`px-4 py-2 rounded-lg ${
              filter === 'draft'
                ? 'bg-blue-600 text-white'
                : darkMode
                  ? 'bg-gray-800 text-gray-300 hover:bg-gray-700'
                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
            } transition-colors`}
          >
            Drafts ({posts.filter(p => p.status === 'draft').length})
          </button>
        </div>
        <Link
          to="/admin/blog/new"
          className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          <PlusIcon className="h-5 w-5 mr-2" />
          New Post
        </Link>
      </div>

      {/* Posts Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {filteredPosts.length === 0 ? (
          <div
            className={`col-span-2 text-center py-12 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg`}
          >
            <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>No blog posts found</p>
          </div>
        ) : (
          filteredPosts.map(post => (
            <div
              key={post.id}
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-md overflow-hidden`}
            >
              {post.featured_image && (
                <img
                  src={post.featured_image}
                  alt={post.title}
                  className="w-full h-48 object-cover"
                />
              )}
              <div className="p-6">
                <div className="flex items-start justify-between mb-2">
                  <h3
                    className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}
                  >
                    {post.title}
                  </h3>
                  <span
                    className={`px-2 py-1 text-xs rounded-full ${
                      post.status === 'published'
                        ? 'bg-green-100 text-green-800'
                        : 'bg-yellow-100 text-yellow-800'
                    }`}
                  >
                    {post.status}
                  </span>
                </div>

                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>
                  By {post.author_name} â€¢ {formatDate(post.created_at)}
                </p>

                {post.excerpt && (
                  <p
                    className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-4 line-clamp-3`}
                  >
                    {post.excerpt}
                  </p>
                )}

                <div className="flex items-center justify-between">
                  <div className="flex gap-2">
                    <Link
                      to={`/admin/blog/edit/${post.id}`}
                      className={`p-2 rounded ${darkMode ? 'text-blue-400 hover:bg-gray-700' : 'text-blue-600 hover:bg-gray-100'}`}
                    >
                      <PencilIcon className="h-5 w-5" />
                    </Link>
                    <button
                      onClick={() => handleDelete(post.id)}
                      className={`p-2 rounded ${darkMode ? 'text-red-400 hover:bg-gray-700' : 'text-red-600 hover:bg-gray-100'}`}
                    >
                      <TrashIcon className="h-5 w-5" />
                    </button>
                    {post.status === 'published' && (
                      <a
                        href={`/blog/${post.slug}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className={`p-2 rounded ${darkMode ? 'text-gray-400 hover:bg-gray-700' : 'text-gray-600 hover:bg-gray-100'}`}
                      >
                        <EyeIcon className="h-5 w-5" />
                      </a>
                    )}
                  </div>

                  {post.status === 'draft' ? (
                    <button
                      onClick={() => handleStatusChange(post.id, 'published')}
                      className="text-sm px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700"
                    >
                      Publish
                    </button>
                  ) : (
                    <button
                      onClick={() => handleStatusChange(post.id, 'draft')}
                      className="text-sm px-3 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700"
                    >
                      Unpublish
                    </button>
                  )}
                </div>
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  );
};

export default AdminBlog;



================================================================================
FILE: client/src/pages/AdminBlogEditor.js
SIZE: 16215 bytes
================================================================================

import React, { useState, useEffect, useContext } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import axios from 'axios';
import { ThemeContext } from '../context/ThemeContext';
import { ArrowLeftIcon, PhotoIcon } from '@heroicons/react/24/outline';
import QuillEditor from '../components/QuillEditor';

const AdminBlogEditor = () => {
  const { darkMode } = useContext(ThemeContext);
  const navigate = useNavigate();
  const { id } = useParams();
  const isEditing = !!id;

  const [formData, setFormData] = useState({
    title: '',
    title_uk: '',
    slug: '',
    content: '',
    content_uk: '',
    excerpt: '',
    excerpt_uk: '',
    status: 'draft',
    categories: [],
  });
  const [featuredImage, setFeaturedImage] = useState(null);
  const [imagePreview, setImagePreview] = useState('');
  const [categories, setCategories] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  useEffect(() => {
    fetchCategories();
    if (isEditing) {
      fetchPost();
    }
  }, [id]);

  const fetchCategories = async () => {
    try {
      const response = await axios.get('/api/blog/categories');
      setCategories(response.data);
    } catch (error) {
      console.error('Failed to fetch categories:', error);
    }
  };

  const fetchPost = async () => {
    try {
      const response = await axios.get(`/api/blog/post/${id}`);
      const post = response.data;
      setFormData({
        title: post.title || '',
        title_uk: post.title_uk || '',
        slug: post.slug || '',
        content: post.content || '',
        content_uk: post.content_uk || '',
        excerpt: post.excerpt || '',
        excerpt_uk: post.excerpt_uk || '',
        status: post.status || 'draft',
        categories: post.categories?.map(c => c.id) || [],
      });
      if (post.featured_image) {
        setImagePreview(post.featured_image);
      }
    } catch (error) {
      console.error('Failed to fetch post:', error);
      setError('Failed to load post');
    }
  };

  const handleChange = e => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value,
    }));

    // Auto-generate slug from title
    if (name === 'title' && !isEditing) {
      const slug = value
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
      setFormData(prev => ({
        ...prev,
        slug,
      }));
    }
  };

  const handleContentChange = (value, field) => {
    setFormData(prev => ({
      ...prev,
      [field]: value,
    }));
  };

  const handleCategoryChange = categoryId => {
    setFormData(prev => ({
      ...prev,
      categories: prev.categories.includes(categoryId)
        ? prev.categories.filter(id => id !== categoryId)
        : [...prev.categories, categoryId],
    }));
  };

  const handleImageChange = e => {
    const file = e.target.files[0];
    if (file) {
      setFeaturedImage(file);
      const reader = new FileReader();
      reader.onloadend = () => {
        setImagePreview(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async e => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const data = new FormData();
      Object.keys(formData).forEach(key => {
        if (key === 'categories') {
          formData[key].forEach(catId => {
            data.append('categories', catId);
          });
        } else {
          data.append(key, formData[key]);
        }
      });

      if (featuredImage) {
        data.append('featured_image', featuredImage);
      }

      if (isEditing) {
        await axios.put(`/api/blog/${id}`, data, {
          headers: { 'Content-Type': 'multipart/form-data' },
        });
      } else {
        await axios.post('/api/blog', data, {
          headers: { 'Content-Type': 'multipart/form-data' },
        });
      }

      navigate('/admin/blog');
    } catch (error) {
      console.error('Failed to save post:', error);
      setError(error.response?.data?.error || 'Failed to save post');
      setLoading(false);
    }
  };

  const modules = {
    toolbar: [
      [{ header: [1, 2, 3, false] }],
      ['bold', 'italic', 'underline', 'strike'],
      ['blockquote', 'code-block'],
      [{ list: 'ordered' }, { list: 'bullet' }],
      ['link', 'image'],
      ['clean'],
    ],
  };

  return (
    <div>
      <div className="mb-6">
        <button
          onClick={() => navigate('/admin/blog')}
          className={`flex items-center ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-900'} mb-4`}
        >
          <ArrowLeftIcon className="h-5 w-5 mr-2" />
          Back to Blog Posts
        </button>
        <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
          {isEditing ? 'Edit Blog Post' : 'Create New Blog Post'}
        </h1>
      </div>

      {error && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-md">
          <p className="text-red-800">{error}</p>
        </div>
      )}

      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Basic Information */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <h2 className={`text-xl font-semibold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            Basic Information
          </h2>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Title (English) *
              </label>
              <input
                type="text"
                name="title"
                value={formData.title}
                onChange={handleChange}
                required
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>

            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Title (Ukrainian)
              </label>
              <input
                type="text"
                name="title_uk"
                value={formData.title_uk}
                onChange={handleChange}
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>

            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Slug *
              </label>
              <input
                type="text"
                name="slug"
                value={formData.slug}
                onChange={handleChange}
                required
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>

            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Status
              </label>
              <select
                name="status"
                value={formData.status}
                onChange={handleChange}
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              >
                <option value="draft">Draft</option>
                <option value="published">Published</option>
              </select>
            </div>
          </div>

          <div className="mt-4">
            <label
              className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
            >
              Featured Image
            </label>
            <div className="flex items-center space-x-4">
              {imagePreview && (
                <img src={imagePreview} alt="Preview" className="h-24 w-24 object-cover rounded" />
              )}
              <label
                className={`cursor-pointer flex items-center px-4 py-2 rounded-md ${
                  darkMode
                    ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                <PhotoIcon className="h-5 w-5 mr-2" />
                Choose Image
                <input
                  type="file"
                  accept="image/*"
                  onChange={handleImageChange}
                  className="hidden"
                />
              </label>
            </div>
          </div>

          <div className="mt-4">
            <label
              className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
            >
              Categories
            </label>
            <div className="flex flex-wrap gap-2">
              {categories.map(category => (
                <label
                  key={category.id}
                  className={`flex items-center px-3 py-1 rounded-full cursor-pointer ${
                    formData.categories.includes(category.id)
                      ? 'bg-blue-600 text-white'
                      : darkMode
                        ? 'bg-gray-700 text-gray-300'
                        : 'bg-gray-200 text-gray-700'
                  }`}
                >
                  <input
                    type="checkbox"
                    checked={formData.categories.includes(category.id)}
                    onChange={() => handleCategoryChange(category.id)}
                    className="hidden"
                  />
                  {category.name}
                </label>
              ))}
            </div>
          </div>
        </div>

        {/* Excerpts */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <h2 className={`text-xl font-semibold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            Excerpts
          </h2>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Excerpt (English)
              </label>
              <textarea
                name="excerpt"
                value={formData.excerpt}
                onChange={handleChange}
                rows={3}
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>

            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Excerpt (Ukrainian)
              </label>
              <textarea
                name="excerpt_uk"
                value={formData.excerpt_uk}
                onChange={handleChange}
                rows={3}
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>
          </div>
        </div>

        {/* Content */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <h2 className={`text-xl font-semibold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            Content
          </h2>

          <div className="space-y-6">
            <div>
              <label
                className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Content (English) *
              </label>
              <QuillEditor
                value={formData.content}
                onChange={value => handleContentChange(value, 'content')}
                modules={modules}
                placeholder="Enter your content here..."
                className={`${darkMode ? 'bg-gray-700 text-white' : 'bg-white'}`}
                darkMode={darkMode}
                onError={(error, errorInfo) => {
                  console.error('Content editor error:', error, errorInfo);
                  setError('Rich text editor encountered an error. Please refresh the page.');
                }}
              />
            </div>

            <div>
              <label
                className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Content (Ukrainian)
              </label>
              <QuillEditor
                value={formData.content_uk}
                onChange={value => handleContentChange(value, 'content_uk')}
                modules={modules}
                placeholder="Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ð²Ð°Ñˆ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ Ñ‚ÑƒÑ‚..."
                className={`${darkMode ? 'bg-gray-700 text-white' : 'bg-white'}`}
                darkMode={darkMode}
                onError={(error, errorInfo) => {
                  console.error('Ukrainian content editor error:', error, errorInfo);
                  setError('Rich text editor encountered an error. Please refresh the page.');
                }}
              />
            </div>
          </div>
        </div>

        {/* Submit Buttons */}
        <div className="flex justify-end space-x-3">
          <button
            type="button"
            onClick={() => navigate('/admin/blog')}
            className={`px-6 py-2 rounded-md ${
              darkMode
                ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
            } transition-colors`}
          >
            Cancel
          </button>
          <button
            type="submit"
            disabled={loading}
            className={`px-6 py-2 rounded-md text-white ${
              loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'
            } transition-colors`}
          >
            {loading ? 'Saving...' : isEditing ? 'Update Post' : 'Create Post'}
          </button>
        </div>
      </form>

      <style jsx global>{`
        .quill-dark .ql-toolbar {
          background-color: #374151;
          border-color: #4b5563;
        }
        .quill-dark .ql-container {
          background-color: #374151;
          border-color: #4b5563;
        }
        .quill-dark .ql-editor {
          color: white;
        }
        .quill-dark .ql-toolbar button {
          color: #d1d5db;
        }
        .quill-dark .ql-toolbar button:hover {
          color: white;
        }
        .quill-dark .ql-toolbar button.ql-active {
          color: white;
        }
        .quill-dark .ql-toolbar .ql-stroke {
          stroke: #d1d5db;
        }
        .quill-dark .ql-toolbar .ql-fill {
          fill: #d1d5db;
        }
        .quill-dark .ql-toolbar .ql-picker {
          color: #d1d5db;
        }
      `}</style>
    </div>
  );
};

export default AdminBlogEditor;



================================================================================
FILE: client/src/pages/AdminBlogEditorSimple.js
SIZE: 16278 bytes
================================================================================

import React, { useState, useEffect, useContext } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import axios from 'axios';
import { ThemeContext } from '../context/ThemeContext';
import { ArrowLeftIcon, PhotoIcon } from '@heroicons/react/24/outline';

const AdminBlogEditorSimple = () => {
  const { darkMode } = useContext(ThemeContext);
  const navigate = useNavigate();
  const { id } = useParams();
  const isEditing = !!id;

  const [formData, setFormData] = useState({
    title: '',
    title_uk: '',
    slug: '',
    content: '',
    content_uk: '',
    excerpt: '',
    excerpt_uk: '',
    status: 'draft',
    categories: [],
  });
  const [featuredImage, setFeaturedImage] = useState(null);
  const [imagePreview, setImagePreview] = useState('');
  const [categories, setCategories] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');

  useEffect(() => {
    fetchCategories();
    if (isEditing) {
      fetchPost();
    }
  }, [id]);

  const fetchCategories = async () => {
    try {
      const response = await axios.get('/api/blog/categories');
      setCategories(response.data);
    } catch (error) {
      console.error('Failed to fetch categories:', error);
      setError('Failed to load categories');
    }
  };

  const fetchPost = async () => {
    try {
      const response = await axios.get(`/api/blog/post/${id}`);
      const post = response.data;
      setFormData({
        title: post.title || '',
        title_uk: post.title_uk || '',
        slug: post.slug || '',
        content: post.content || '',
        content_uk: post.content_uk || '',
        excerpt: post.excerpt || '',
        excerpt_uk: post.excerpt_uk || '',
        status: post.status || 'draft',
        categories: post.categories?.map(c => c.id) || [],
      });
      if (post.featured_image) {
        setImagePreview(post.featured_image);
      }
    } catch (error) {
      console.error('Failed to fetch post:', error);
      setError('Failed to load post');
    }
  };

  const handleChange = e => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value,
    }));

    // Auto-generate slug from title
    if (name === 'title' && !isEditing) {
      const slug = value
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
      setFormData(prev => ({
        ...prev,
        slug,
      }));
    }
  };

  const handleCategoryChange = categoryId => {
    setFormData(prev => ({
      ...prev,
      categories: prev.categories.includes(categoryId)
        ? prev.categories.filter(id => id !== categoryId)
        : [...prev.categories, categoryId],
    }));
  };

  const handleImageChange = e => {
    const file = e.target.files[0];
    if (file) {
      setFeaturedImage(file);
      const reader = new FileReader();
      reader.onloadend = () => {
        setImagePreview(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async e => {
    e.preventDefault();
    setLoading(true);
    setError('');
    setSuccess('');

    try {
      const data = new FormData();

      // Add all form fields
      Object.keys(formData).forEach(key => {
        if (key === 'categories') {
          // Add each category separately
          formData[key].forEach(catId => {
            data.append('categories', catId);
          });
        } else {
          data.append(key, formData[key]);
        }
      });

      // Add image if selected
      if (featuredImage) {
        data.append('featured_image', featuredImage);
      }

      let response;
      if (isEditing) {
        response = await axios.put(`/api/blog/${id}`, data, {
          headers: { 'Content-Type': 'multipart/form-data' },
        });
        setSuccess('Blog post updated successfully!');
      } else {
        response = await axios.post('/api/blog', data, {
          headers: { 'Content-Type': 'multipart/form-data' },
        });
        setSuccess('Blog post created successfully!');
      }

      // Redirect after short delay
      setTimeout(() => {
        navigate('/admin/blog');
      }, 1500);
    } catch (error) {
      console.error('Failed to save post:', error);
      setError(error.response?.data?.error || 'Failed to save post. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div>
      <div className="mb-6">
        <button
          onClick={() => navigate('/admin/blog')}
          className={`flex items-center ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-900'} mb-4`}
        >
          <ArrowLeftIcon className="h-5 w-5 mr-2" />
          Back to Blog Posts
        </button>
        <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
          {isEditing ? 'Edit Blog Post' : 'Create New Blog Post'}
        </h1>
      </div>

      {error && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-md">
          <p className="text-red-800">{error}</p>
        </div>
      )}

      {success && (
        <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-md">
          <p className="text-green-800">{success}</p>
        </div>
      )}

      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Basic Information */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <h2 className={`text-xl font-semibold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            Basic Information
          </h2>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Title (English) *
              </label>
              <input
                type="text"
                name="title"
                value={formData.title}
                onChange={handleChange}
                required
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>

            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Title (Ukrainian)
              </label>
              <input
                type="text"
                name="title_uk"
                value={formData.title_uk}
                onChange={handleChange}
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>

            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Slug *
              </label>
              <input
                type="text"
                name="slug"
                value={formData.slug}
                onChange={handleChange}
                required
                placeholder="auto-generated-from-title"
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>

            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Status
              </label>
              <select
                name="status"
                value={formData.status}
                onChange={handleChange}
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              >
                <option value="draft">Draft</option>
                <option value="published">Published</option>
              </select>
            </div>
          </div>

          <div className="mt-4">
            <label
              className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
            >
              Featured Image
            </label>
            <div className="flex items-center space-x-4">
              {imagePreview && (
                <img src={imagePreview} alt="Preview" className="h-24 w-24 object-cover rounded" />
              )}
              <label
                className={`cursor-pointer flex items-center px-4 py-2 rounded-md ${
                  darkMode
                    ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                <PhotoIcon className="h-5 w-5 mr-2" />
                Choose Image
                <input
                  type="file"
                  accept="image/*"
                  onChange={handleImageChange}
                  className="hidden"
                />
              </label>
            </div>
          </div>

          <div className="mt-4">
            <label
              className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
            >
              Categories
            </label>
            <div className="flex flex-wrap gap-2">
              {categories.map(category => (
                <label
                  key={category.id}
                  className={`flex items-center px-3 py-1 rounded-full cursor-pointer ${
                    formData.categories.includes(category.id)
                      ? 'bg-blue-600 text-white'
                      : darkMode
                        ? 'bg-gray-700 text-gray-300'
                        : 'bg-gray-200 text-gray-700'
                  }`}
                >
                  <input
                    type="checkbox"
                    checked={formData.categories.includes(category.id)}
                    onChange={() => handleCategoryChange(category.id)}
                    className="hidden"
                  />
                  {category.name}
                </label>
              ))}
            </div>
          </div>
        </div>

        {/* Excerpts */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <h2 className={`text-xl font-semibold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            Excerpts
          </h2>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Excerpt (English)
              </label>
              <textarea
                name="excerpt"
                value={formData.excerpt}
                onChange={handleChange}
                rows={3}
                placeholder="Brief description of the blog post..."
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>

            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Excerpt (Ukrainian)
              </label>
              <textarea
                name="excerpt_uk"
                value={formData.excerpt_uk}
                onChange={handleChange}
                rows={3}
                placeholder="ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹ Ð¾Ð¿Ð¸Ñ Ð±Ð»Ð¾Ð³ Ð¿Ð¾ÑÑ‚Ñƒ..."
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>
          </div>
        </div>

        {/* Content - Using simple textareas instead of Quill */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <h2 className={`text-xl font-semibold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            Content
          </h2>

          <div className="space-y-6">
            <div>
              <label
                className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Content (English) * <span className="text-xs text-gray-500">(HTML supported)</span>
              </label>
              <textarea
                name="content"
                value={formData.content}
                onChange={handleChange}
                required
                rows={10}
                placeholder="<p>Enter your blog content here...</p>"
                className={`w-full px-3 py-2 rounded-md border font-mono text-sm ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>

            <div>
              <label
                className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Content (Ukrainian) <span className="text-xs text-gray-500">(HTML supported)</span>
              </label>
              <textarea
                name="content_uk"
                value={formData.content_uk}
                onChange={handleChange}
                rows={10}
                placeholder="<p>Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ð²Ð°Ñˆ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ Ñ‚ÑƒÑ‚...</p>"
                className={`w-full px-3 py-2 rounded-md border font-mono text-sm ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>
          </div>

          <div className="mt-4 p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20">
            <p className="text-sm text-blue-800 dark:text-blue-300">
              <strong>Tip:</strong> You can use basic HTML tags like &lt;p&gt;, &lt;h2&gt;,
              &lt;h3&gt;, &lt;strong&gt;, &lt;em&gt;, &lt;ul&gt;, &lt;ol&gt;, &lt;li&gt;, &lt;a&gt;,
              &lt;blockquote&gt;, etc.
            </p>
          </div>
        </div>

        {/* Submit Buttons */}
        <div className="flex justify-end space-x-3">
          <button
            type="button"
            onClick={() => navigate('/admin/blog')}
            className={`px-6 py-2 rounded-md ${
              darkMode
                ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
            } transition-colors`}
          >
            Cancel
          </button>
          <button
            type="submit"
            disabled={loading}
            className={`px-6 py-2 rounded-md text-white ${
              loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'
            } transition-colors`}
          >
            {loading ? 'Saving...' : isEditing ? 'Update Post' : 'Create Post'}
          </button>
        </div>
      </form>
    </div>
  );
};

export default AdminBlogEditorSimple;



================================================================================
FILE: client/src/pages/AdminDashboard.js
SIZE: 9106 bytes
================================================================================

import React, { useState, useContext } from 'react';
import { Link, Outlet, useLocation, useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import { ThemeContext } from '../context/ThemeContext';
import {
  HomeIcon,
  DocumentTextIcon,
  NewspaperIcon,
  UserIcon,
  ArrowLeftOnRectangleIcon,
  Bars3Icon,
  XMarkIcon,
  SparklesIcon,
  ChartBarIcon,
} from '@heroicons/react/24/outline';

const AdminDashboard = () => {
  const { user, logout } = useAuth();
  const { darkMode } = useContext(ThemeContext);
  const location = useLocation();
  const navigate = useNavigate();
  const [sidebarOpen, setSidebarOpen] = useState(false);

  const navigation = [
    { name: 'Dashboard', href: '/admin/dashboard', icon: HomeIcon },
    { name: 'Analytics', href: '/admin/analytics', icon: ChartBarIcon },
    { name: 'Grants', href: '/admin/grants', icon: DocumentTextIcon },
    { name: 'Blog Posts', href: '/admin/blog', icon: NewspaperIcon },
    // Removed: Blog Generation - requires Express server (not deployed)
    // Removed: Users - requires Express server (not deployed)
    { name: 'Profile', href: '/admin/profile', icon: UserIcon },
  ];

  const handleLogout = () => {
    logout();
    navigate('/admin/login');
  };

  const isActive = href => {
    return (
      location.pathname === href ||
      (href !== '/admin/dashboard' && location.pathname.startsWith(href))
    );
  };

  return (
    <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
      {/* Mobile sidebar */}
      <div
        className={`fixed inset-0 flex z-40 md:hidden ${sidebarOpen ? '' : 'pointer-events-none'}`}
      >
        <div
          className={`fixed inset-0 bg-gray-600 bg-opacity-75 ${sidebarOpen ? 'opacity-100' : 'opacity-0'} transition-opacity`}
          onClick={() => setSidebarOpen(false)}
        />
        <div
          className={`relative flex-1 flex flex-col max-w-xs w-full ${darkMode ? 'bg-gray-800' : 'bg-white'} transform ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform`}
        >
          <div className="absolute top-0 right-0 -mr-12 pt-2">
            <button
              type="button"
              className={`ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white ${sidebarOpen ? '' : 'hidden'}`}
              onClick={() => setSidebarOpen(false)}
            >
              <XMarkIcon className="h-6 w-6 text-white" />
            </button>
          </div>
          <div className="flex-1 h-0 pt-5 pb-4 overflow-y-auto">
            <div className="flex-shrink-0 flex items-center px-4">
              <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Admin Panel
              </h2>
            </div>
            <nav className="mt-5 px-2 space-y-1">
              {navigation.map(item => (
                <Link
                  key={item.name}
                  to={item.href}
                  className={`group flex items-center px-2 py-2 text-base font-medium rounded-md ${
                    isActive(item.href)
                      ? darkMode
                        ? 'bg-gray-900 text-white'
                        : 'bg-gray-100 text-gray-900'
                      : darkMode
                        ? 'text-gray-300 hover:bg-gray-700 hover:text-white'
                        : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                  }`}
                  onClick={() => setSidebarOpen(false)}
                >
                  <item.icon
                    className={`mr-4 flex-shrink-0 h-6 w-6 ${
                      isActive(item.href)
                        ? darkMode
                          ? 'text-gray-300'
                          : 'text-gray-500'
                        : darkMode
                          ? 'text-gray-400 group-hover:text-gray-300'
                          : 'text-gray-400 group-hover:text-gray-500'
                    }`}
                  />
                  {item.name}
                </Link>
              ))}
            </nav>
          </div>
          <div className="flex-shrink-0 flex border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'} p-4">
            <div className="flex items-center">
              <div className="ml-3">
                <p className={`text-base font-medium ${darkMode ? 'text-white' : 'text-gray-700'}`}>
                  {user?.username}
                </p>
                <button
                  onClick={handleLogout}
                  className={`flex items-center text-sm font-medium ${darkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-500 hover:text-gray-400'}`}
                >
                  <ArrowLeftOnRectangleIcon className="mr-2 h-4 w-4" />
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Static sidebar for desktop */}
      <div className="hidden md:flex md:w-64 md:flex-col md:fixed md:inset-y-0">
        <div
          className={`flex-1 flex flex-col min-h-0 ${darkMode ? 'bg-gray-800' : 'bg-white'} border-r ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}
        >
          <div className="flex-1 flex flex-col pt-5 pb-4 overflow-y-auto">
            <div className="flex items-center flex-shrink-0 px-4">
              <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Admin Panel
              </h2>
            </div>
            <nav className="mt-5 flex-1 px-2 space-y-1">
              {navigation.map(item => (
                <Link
                  key={item.name}
                  to={item.href}
                  className={`group flex items-center px-2 py-2 text-sm font-medium rounded-md ${
                    isActive(item.href)
                      ? darkMode
                        ? 'bg-gray-900 text-white'
                        : 'bg-gray-100 text-gray-900'
                      : darkMode
                        ? 'text-gray-300 hover:bg-gray-700 hover:text-white'
                        : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                  }`}
                >
                  <item.icon
                    className={`mr-3 flex-shrink-0 h-6 w-6 ${
                      isActive(item.href)
                        ? darkMode
                          ? 'text-gray-300'
                          : 'text-gray-500'
                        : darkMode
                          ? 'text-gray-400 group-hover:text-gray-300'
                          : 'text-gray-400 group-hover:text-gray-500'
                    }`}
                  />
                  {item.name}
                </Link>
              ))}
            </nav>
          </div>
          <div
            className={`flex-shrink-0 flex border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'} p-4`}
          >
            <div className="flex items-center w-full">
              <div>
                <div
                  className={`h-8 w-8 rounded-full ${darkMode ? 'bg-gray-700' : 'bg-gray-300'} flex items-center justify-center`}
                >
                  <span
                    className={`text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}
                  >
                    {user?.username?.charAt(0).toUpperCase()}
                  </span>
                </div>
              </div>
              <div className="ml-3">
                <p className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-700'}`}>
                  {user?.username}
                </p>
                <button
                  onClick={handleLogout}
                  className={`flex items-center text-xs font-medium ${darkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-500 hover:text-gray-400'}`}
                >
                  <ArrowLeftOnRectangleIcon className="mr-1 h-3 w-3" />
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Main content */}
      <div className="md:pl-64 flex flex-col flex-1">
        <div
          className={`sticky top-0 z-10 md:hidden pl-1 pt-1 sm:pl-3 sm:pt-3 ${darkMode ? 'bg-gray-900' : 'bg-gray-100'}`}
        >
          <button
            type="button"
            className={`-ml-0.5 -mt-0.5 h-12 w-12 inline-flex items-center justify-center rounded-md ${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-gray-900'} focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500`}
            onClick={() => setSidebarOpen(true)}
          >
            <Bars3Icon className="h-6 w-6" />
          </button>
        </div>
        <main className="flex-1">
          <div className="py-6">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
              <Outlet />
            </div>
          </div>
        </main>
      </div>
    </div>
  );
};

export default AdminDashboard;



================================================================================
FILE: client/src/pages/AdminGrants.js
SIZE: 11638 bytes
================================================================================

import React, { useState, useEffect, useContext } from 'react';
import axios from 'axios';
import { ThemeContext } from '../context/ThemeContext';
import { fetchGrantsForAdmin } from '../utils/adminApiHelper';
import { PlusIcon, PencilIcon, TrashIcon, MagnifyingGlassIcon, ArrowDownTrayIcon } from '@heroicons/react/24/outline';
import GrantEditModal from '../components/GrantEditModal';

const AdminGrants = () => {
  const { darkMode } = useContext(ThemeContext);
  const [grants, setGrants] = useState([]);
  const [filteredGrants, setFilteredGrants] = useState([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [editingGrant, setEditingGrant] = useState(null);
  const [showModal, setShowModal] = useState(false);

  useEffect(() => {
    fetchGrants();
  }, []);

  useEffect(() => {
    filterGrants();
  }, [searchTerm, grants]);

  const fetchGrants = async () => {
    try {
      const grantsData = await fetchGrantsForAdmin();
      setGrants(grantsData);
      setFilteredGrants(grantsData);
      setLoading(false);
    } catch (error) {
      console.error('Failed to fetch grants:', error);
      setGrants([]);
      setFilteredGrants([]);
      setLoading(false);
    }
  };

  const filterGrants = () => {
    if (!searchTerm) {
      setFilteredGrants(grants);
      return;
    }

    const term = searchTerm.toLowerCase();
    const filtered = grants.filter(grant => {
      // Data is already normalized by fetchGrantsForAdmin
      const grantName = (grant.name || '').toLowerCase();
      const organization = (grant.organization || '').toLowerCase();
      const geoFocus = (grant.geographic_focus || '').toLowerCase();
      const focusAreas = (grant.focus_areas_en || '').toLowerCase();

      return (
        grantName.includes(term) ||
        organization.includes(term) ||
        geoFocus.includes(term) ||
        focusAreas.includes(term)
      );
    });
    setFilteredGrants(filtered);
  };

  const handleEdit = grant => {
    setEditingGrant(grant);
    setShowModal(true);
  };

  const handleAdd = () => {
    setEditingGrant(null);
    setShowModal(true);
  };

  const handleDelete = async id => {
    if (!window.confirm('Are you sure you want to delete this grant?')) return;

    try {
      const token = localStorage.getItem('authToken'); // Fixed: was looking for 'token' instead of 'authToken'
      await axios.delete(`/.netlify/functions/grants/${id}`, {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
      fetchGrants();
    } catch (error) {
      console.error('Failed to delete grant:', error);
      alert('Failed to delete grant');
    }
  };

  const handleSave = async () => {
    await fetchGrants();
    setShowModal(false);
    setEditingGrant(null);
  };

  const formatDate = dateString => {
    if (!dateString) return 'N/A';
    try {
      return new Date(dateString).toLocaleDateString();
    } catch {
      return dateString;
    }
  };

  const exportToCSV = () => {
    // Define CSV headers
    const headers = [
      'ID',
      'Grant Name',
      'Organization',
      'Geographic Focus',
      'Focus Areas (EN)',
      'Focus Areas (UK)',
      'Description (EN)',
      'Description (UK)',
      'Eligibility (EN)',
      'Eligibility (UK)',
      'Grant Type',
      'Grant Size Min',
      'Grant Size Max',
      'Deadline',
      'Website',
      'Application URL',
      'Contact Info',
      'Created At',
      'Updated At'
    ];

    // Convert grants data to CSV rows
    const csvRows = filteredGrants.map(grant => {
      return [
        grant.id || '',
        grant.name || '',
        grant.organization || '',
        grant.geographic_focus || '',
        grant.focus_areas_en || '',
        grant.focus_areas_uk || '',
        (grant.description_en || '').replace(/"/g, '""'), // Escape quotes
        (grant.description_uk || '').replace(/"/g, '""'),
        (grant.eligibility_en || '').replace(/"/g, '""'),
        (grant.eligibility_uk || '').replace(/"/g, '""'),
        grant.type || '',
        grant.grant_size_min || '',
        grant.grant_size_max || '',
        grant.deadline || '',
        grant.website || '',
        grant.application_url || '',
        grant.contact_info || '',
        grant.created_at || '',
        grant.updated_at || ''
      ].map(field => `"${field}"`).join(','); // Wrap fields in quotes
    });

    // Combine headers and rows
    const csvContent = [
      headers.join(','),
      ...csvRows
    ].join('\n');

    // Create blob and download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    // Generate filename with current date
    const date = new Date().toISOString().split('T')[0];
    const filename = `grants_export_${date}.csv`;
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div>
      <div className="mb-6">
        <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-2`}>
          Manage Grants
        </h1>
        <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
          Add, edit, or remove grants from the database
        </p>
      </div>

      {/* Search and Add */}
      <div className="mb-6 flex flex-col sm:flex-row gap-4">
        <div className="flex-1 relative">
          <input
            type="text"
            placeholder="Search grants..."
            value={searchTerm}
            onChange={e => setSearchTerm(e.target.value)}
            className={`w-full pl-10 pr-4 py-2 rounded-lg border ${
              darkMode
                ? 'bg-gray-800 border-gray-700 text-white placeholder-gray-400'
                : 'bg-white border-gray-300 text-gray-900 placeholder-gray-500'
            } focus:ring-2 focus:ring-blue-500 focus:border-blue-500`}
          />
          <MagnifyingGlassIcon
            className={`absolute left-3 top-2.5 h-5 w-5 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}
          />
        </div>
        <button
          onClick={exportToCSV}
          className="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
          disabled={filteredGrants.length === 0}
        >
          <ArrowDownTrayIcon className="h-5 w-5 mr-2" />
          Export CSV
        </button>
        <button
          onClick={handleAdd}
          className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          <PlusIcon className="h-5 w-5 mr-2" />
          Add Grant
        </button>
      </div>

      {/* Grants Table */}
      <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow overflow-hidden`}>
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y ${darkMode ? 'divide-gray-700' : 'divide-gray-200'}">
            <thead className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
              <tr>
                <th
                  className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}
                >
                  Grant Name
                </th>
                <th
                  className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}
                >
                  Organization
                </th>
                <th
                  className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}
                >
                  Deadline
                </th>
                <th
                  className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}
                >
                  Amount
                </th>
                <th
                  className={`px-6 py-3 text-right text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody className={`divide-y ${darkMode ? 'divide-gray-700' : 'divide-gray-200'}`}>
              {filteredGrants.length === 0 ? (
                <tr>
                  <td colSpan="5" className="px-6 py-12 text-center">
                    <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      No grants found
                    </p>
                  </td>
                </tr>
              ) : (
                filteredGrants.map(grant => (
                  <tr
                    key={grant.id}
                    className={`${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'}`}
                  >
                    <td className={`px-6 py-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                      <div>
                        <div className="font-medium">{grant.name || 'Unnamed Grant'}</div>
                        <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          {grant.geographic_focus || 'N/A'}
                        </div>
                      </div>
                    </td>
                    <td className={`px-6 py-4 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      {grant.organization || 'Unknown'}
                    </td>
                    <td className={`px-6 py-4 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      {formatDate(grant.deadline)}
                    </td>
                    <td className={`px-6 py-4 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      {grant.grant_size_min && grant.grant_size_max
                        ? `â‚¬${grant.grant_size_min.toLocaleString()} - â‚¬${grant.grant_size_max.toLocaleString()}`
                        : 'N/A'}
                    </td>
                    <td className="px-6 py-4 text-right">
                      <button
                        onClick={() => handleEdit(grant)}
                        className={`${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'} mr-3`}
                      >
                        <PencilIcon className="h-5 w-5" />
                      </button>
                      <button
                        onClick={() => handleDelete(grant.id)}
                        className={`${darkMode ? 'text-red-400 hover:text-red-300' : 'text-red-600 hover:text-red-700'}`}
                      >
                        <TrashIcon className="h-5 w-5" />
                      </button>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Edit Modal */}
      {showModal && (
        <GrantEditModal
          grant={editingGrant}
          onClose={() => setShowModal(false)}
          onSave={handleSave}
          darkMode={darkMode}
        />
      )}
    </div>
  );
};

export default AdminGrants;



================================================================================
FILE: client/src/pages/AdminLoginPage.js
SIZE: 6003 bytes
================================================================================

import React, { useState, useContext } from 'react';
import { useNavigate, Navigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import { ThemeContext } from '../context/ThemeContext';

const AdminLoginPage = () => {
  const navigate = useNavigate();
  const { login, isAuthenticated } = useAuth();
  const { darkMode } = useContext(ThemeContext);
  const [formData, setFormData] = useState({ username: '', password: '' });
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  if (isAuthenticated) {
    return <Navigate to="/admin/dashboard" replace />;
  }

  const handleSubmit = async e => {
    e.preventDefault();
    setError('');
    setLoading(true);

    const result = await login(formData.username, formData.password);

    if (result.success) {
      navigate('/admin/dashboard');
    } else {
      setError(result.error);
      setLoading(false);
    }
  };

  const handleChange = e => {
    setFormData({
      ...formData,
      [e.target.name]: e.target.value,
    });
  };

  return (
    <div
      className={`min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}
    >
      <div className="max-w-md w-full space-y-8">
        <div>
          <h2
            className={`mt-6 text-center text-3xl font-extrabold ${darkMode ? 'text-white' : 'text-gray-900'}`}
          >
            Admin Login
          </h2>
          <p className={`mt-2 text-center text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
            Sign in to manage grants and blog posts
          </p>
        </div>
        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div
            className={`rounded-md shadow-sm -space-y-px ${darkMode ? 'bg-gray-800' : 'bg-white'} p-6`}
          >
            <div className="mb-4">
              <label
                htmlFor="username"
                className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Username
              </label>
              <input
                id="username"
                name="username"
                type="text"
                autoComplete="username"
                required
                className={`appearance-none relative block w-full px-4 py-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:z-10 text-base ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400'
                    : 'bg-white border-gray-300 text-gray-900 placeholder-gray-500'
                }`}
                placeholder="Username"
                value={formData.username}
                onChange={handleChange}
              />
            </div>
            <div>
              <label
                htmlFor="password"
                className={`block text-sm font-medium mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Password
              </label>
              <input
                id="password"
                name="password"
                type="password"
                autoComplete="current-password"
                required
                className={`appearance-none relative block w-full px-4 py-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:z-10 text-base ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400'
                    : 'bg-white border-gray-300 text-gray-900 placeholder-gray-500'
                }`}
                placeholder="Password"
                value={formData.password}
                onChange={handleChange}
              />
            </div>
          </div>

          {error && (
            <div className="rounded-md bg-red-50 p-4">
              <div className="flex">
                <div className="ml-3">
                  <h3 className="text-sm font-medium text-red-800">Login failed</h3>
                  <div className="mt-2 text-sm text-red-700">
                    <p>{error}</p>
                  </div>
                </div>
              </div>
            </div>
          )}

          <div>
            <button
              type="submit"
              disabled={loading}
              className={`group relative w-full flex justify-center py-3 px-4 border border-transparent text-base font-medium rounded-md text-white ${
                loading
                  ? 'bg-gray-400 cursor-not-allowed'
                  : 'bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500'
              }`}
            >
              {loading ? (
                <svg
                  className="animate-spin h-5 w-5 text-white"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    className="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    strokeWidth="4"
                  ></circle>
                  <path
                    className="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
              ) : (
                'Sign in'
              )}
            </button>
          </div>

          <div className="text-center">
            <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
              Default credentials: admin/admin123 or mattia/admin123
            </p>
          </div>
        </form>
      </div>
    </div>
  );
};

export default AdminLoginPage;



================================================================================
FILE: client/src/pages/AdminOverview.js
SIZE: 9891 bytes
================================================================================

import React, { useState, useEffect, useContext } from 'react';
import { Link } from 'react-router-dom';
import axios from 'axios';
import { ThemeContext } from '../context/ThemeContext';
import { fetchGrantsForAdmin, fetchBlogPostsForAdmin } from '../utils/adminApiHelper';
import {
  DocumentTextIcon,
  NewspaperIcon,
  UserGroupIcon,
  CalendarIcon,
} from '@heroicons/react/24/outline';

const AdminOverview = () => {
  const { darkMode } = useContext(ThemeContext);
  const [stats, setStats] = useState({
    totalGrants: 0,
    upcomingDeadlines: 0,
    totalPosts: 0,
    publishedPosts: 0,
  });
  const [recentGrants, setRecentGrants] = useState([]);
  const [recentPosts, setRecentPosts] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchDashboardData();
  }, []);

  const fetchDashboardData = async () => {
    try {
      // Fetch grants using helper function
      const grants = await fetchGrantsForAdmin();

      // Calculate stats
      const today = new Date();
      const upcomingDeadlines = grants.filter(grant => {
        if (!grant.deadline) return false;
        try {
          const deadline = new Date(grant.deadline);
          return !isNaN(deadline) && deadline > today;
        } catch {
          return false;
        }
      }).length;

      // Fetch blog posts using helper function
      const posts = await fetchBlogPostsForAdmin();
      const publishedPosts = posts.filter(post => post.status === 'published').length;

      setStats({
        totalGrants: grants.length,
        upcomingDeadlines,
        totalPosts: posts.length,
        publishedPosts,
      });

      // Set recent items
      setRecentGrants(grants.slice(0, 5));
      setRecentPosts(posts.slice(0, 5));
      setLoading(false);
    } catch (error) {
      console.error('Failed to fetch dashboard data:', error);
      console.error('Error details:', {
        message: error.message,
        response: error.response?.data,
        status: error.response?.status,
      });

      // Set empty data instead of showing error to user
      setStats({
        totalGrants: 0,
        upcomingDeadlines: 0,
        totalPosts: 0,
        publishedPosts: 0,
      });
      setRecentGrants([]);
      setRecentPosts([]);
      setLoading(false);
    }
  };

  const formatDate = dateString => {
    if (!dateString) return 'N/A';
    try {
      return new Date(dateString).toLocaleDateString();
    } catch {
      return dateString;
    }
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div>
      <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-8`}>
        Dashboard Overview
      </h1>

      {/* Stats Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <div className="flex items-center">
            <div className={`p-3 rounded-full ${darkMode ? 'bg-blue-900' : 'bg-blue-100'}`}>
              <DocumentTextIcon
                className={`h-8 w-8 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}
              />
            </div>
            <div className="ml-4">
              <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {stats.totalGrants}
              </h2>
              <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Total Grants</p>
            </div>
          </div>
        </div>

        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <div className="flex items-center">
            <div className={`p-3 rounded-full ${darkMode ? 'bg-yellow-900' : 'bg-yellow-100'}`}>
              <CalendarIcon
                className={`h-8 w-8 ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}
              />
            </div>
            <div className="ml-4">
              <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {stats.upcomingDeadlines}
              </h2>
              <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Upcoming Deadlines
              </p>
            </div>
          </div>
        </div>

        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <div className="flex items-center">
            <div className={`p-3 rounded-full ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
              <NewspaperIcon
                className={`h-8 w-8 ${darkMode ? 'text-green-400' : 'text-green-600'}`}
              />
            </div>
            <div className="ml-4">
              <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {stats.totalPosts}
              </h2>
              <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Total Blog Posts</p>
            </div>
          </div>
        </div>

        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <div className="flex items-center">
            <div className={`p-3 rounded-full ${darkMode ? 'bg-purple-900' : 'bg-purple-100'}`}>
              <UserGroupIcon
                className={`h-8 w-8 ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}
              />
            </div>
            <div className="ml-4">
              <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {stats.publishedPosts}
              </h2>
              <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Published Posts</p>
            </div>
          </div>
        </div>
      </div>

      {/* Recent Items Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* Recent Grants */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow`}>
          <div className={`px-6 py-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
            <div className="flex justify-between items-center">
              <h3 className={`text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                Recent Grants
              </h3>
              <Link
                to="/admin/grants"
                className={`text-sm ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'}`}
              >
                View all â†’
              </Link>
            </div>
          </div>
          <div className="p-6">
            {recentGrants.length === 0 ? (
              <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                No grants found
              </p>
            ) : (
              <div className="space-y-4">
                {recentGrants.map(grant => (
                  <div
                    key={grant.id}
                    className={`pb-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'} last:border-0 last:pb-0`}
                  >
                    <h4 className={`font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                      {grant.name || 'Unnamed Grant'}
                    </h4>
                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mt-1`}>
                      {grant.organization || 'Unknown Organization'}
                    </p>
                    <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'} mt-1`}>
                      Deadline: {formatDate(grant.deadline)}
                    </p>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* Recent Blog Posts */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow`}>
          <div className={`px-6 py-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
            <div className="flex justify-between items-center">
              <h3 className={`text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                Recent Blog Posts
              </h3>
              <Link
                to="/admin/blog"
                className={`text-sm ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'}`}
              >
                View all â†’
              </Link>
            </div>
          </div>
          <div className="p-6">
            {recentPosts.length === 0 ? (
              <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                No blog posts found
              </p>
            ) : (
              <div className="space-y-4">
                {recentPosts.map(post => (
                  <div
                    key={post.id}
                    className={`pb-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'} last:border-0 last:pb-0`}
                  >
                    <h4 className={`font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                      {post.title}
                    </h4>
                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mt-1`}>
                      By {post.author_name} â€¢ {post.status}
                    </p>
                    <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'} mt-1`}>
                      {formatDate(post.created_at)}
                    </p>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default AdminOverview;



================================================================================
FILE: client/src/pages/AdminPage.js
SIZE: 620 bytes
================================================================================

import React, { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';

const AdminPage = () => {
  const navigate = useNavigate();

  useEffect(() => {
    // Redirect to new admin panel
    navigate('/admin/login');
  }, [navigate]);

  return (
    <div className="flex items-center justify-center min-h-[50vh]">
      <div className="text-center">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mx-auto mb-4"></div>
        <p className="text-gray-600">Redirecting to admin panel...</p>
      </div>
    </div>
  );
};

export default AdminPage;



================================================================================
FILE: client/src/pages/AdminProfile.js
SIZE: 7533 bytes
================================================================================

import React, { useState, useContext } from 'react';
import { useAuth } from '../context/AuthContext';
import { ThemeContext } from '../context/ThemeContext';
import { UserIcon, KeyIcon } from '@heroicons/react/24/outline';

const AdminProfile = () => {
  const { user, changePassword } = useAuth();
  const { darkMode } = useContext(ThemeContext);
  const [passwordForm, setPasswordForm] = useState({
    currentPassword: '',
    newPassword: '',
    confirmPassword: '',
  });
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState({ type: '', text: '' });

  const handlePasswordChange = e => {
    setPasswordForm({
      ...passwordForm,
      [e.target.name]: e.target.value,
    });
  };

  const handlePasswordSubmit = async e => {
    e.preventDefault();
    setMessage({ type: '', text: '' });

    if (passwordForm.newPassword !== passwordForm.confirmPassword) {
      setMessage({ type: 'error', text: 'New passwords do not match' });
      return;
    }

    if (passwordForm.newPassword.length < 6) {
      setMessage({ type: 'error', text: 'Password must be at least 6 characters long' });
      return;
    }

    setLoading(true);
    const result = await changePassword(passwordForm.currentPassword, passwordForm.newPassword);

    if (result.success) {
      setMessage({ type: 'success', text: 'Password changed successfully' });
      setPasswordForm({ currentPassword: '', newPassword: '', confirmPassword: '' });
    } else {
      setMessage({ type: 'error', text: result.error });
    }
    setLoading(false);
  };

  return (
    <div>
      <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-8`}>
        Profile Settings
      </h1>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* User Information */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <div className="flex items-center mb-4">
            <UserIcon className={`h-6 w-6 mr-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`} />
            <h2 className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
              User Information
            </h2>
          </div>

          <div className="space-y-4">
            <div>
              <label
                className={`block text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}
              >
                Username
              </label>
              <p className={`mt-1 text-lg ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {user?.username}
              </p>
            </div>

            <div>
              <label
                className={`block text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}
              >
                Email
              </label>
              <p className={`mt-1 text-lg ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {user?.email}
              </p>
            </div>

            <div>
              <label
                className={`block text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}
              >
                Role
              </label>
              <p className={`mt-1 text-lg ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {user?.role}
              </p>
            </div>

            <div>
              <label
                className={`block text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}
              >
                Member Since
              </label>
              <p className={`mt-1 text-lg ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {user?.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}
              </p>
            </div>
          </div>
        </div>

        {/* Change Password */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow p-6`}>
          <div className="flex items-center mb-4">
            <KeyIcon className={`h-6 w-6 mr-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`} />
            <h2 className={`text-xl font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
              Change Password
            </h2>
          </div>

          {message.text && (
            <div
              className={`mb-4 p-4 rounded-md ${
                message.type === 'success'
                  ? 'bg-green-50 border border-green-200'
                  : 'bg-red-50 border border-red-200'
              }`}
            >
              <p className={message.type === 'success' ? 'text-green-800' : 'text-red-800'}>
                {message.text}
              </p>
            </div>
          )}

          <form onSubmit={handlePasswordSubmit} className="space-y-4">
            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Current Password
              </label>
              <input
                type="password"
                name="currentPassword"
                value={passwordForm.currentPassword}
                onChange={handlePasswordChange}
                required
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>

            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                New Password
              </label>
              <input
                type="password"
                name="newPassword"
                value={passwordForm.newPassword}
                onChange={handlePasswordChange}
                required
                minLength={6}
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>

            <div>
              <label
                className={`block text-sm font-medium mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
              >
                Confirm New Password
              </label>
              <input
                type="password"
                name="confirmPassword"
                value={passwordForm.confirmPassword}
                onChange={handlePasswordChange}
                required
                className={`w-full px-3 py-2 rounded-md border ${
                  darkMode
                    ? 'bg-gray-700 border-gray-600 text-white'
                    : 'bg-white border-gray-300 text-gray-900'
                } focus:ring-2 focus:ring-blue-500`}
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className={`w-full py-2 px-4 rounded-md text-white ${
                loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'
              } transition-colors`}
            >
              {loading ? 'Changing Password...' : 'Change Password'}
            </button>
          </form>
        </div>
      </div>
    </div>
  );
};

export default AdminProfile;



================================================================================
FILE: client/src/pages/BlogPage.js
SIZE: 8176 bytes
================================================================================

import React, { useState, useEffect, useContext } from 'react';
import { Link } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import axios from 'axios';
import { format } from 'date-fns';
import { ThemeContext } from '../context/ThemeContext';
import { CalendarIcon, UserIcon, TagIcon } from '@heroicons/react/24/outline';

const BlogPage = () => {
  const { t, i18n } = useTranslation();
  const { darkMode } = useContext(ThemeContext);
  const [posts, setPosts] = useState([]);
  const [categories, setCategories] = useState([]);
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchPosts();
  }, []);

  useEffect(() => {
    if (posts.length > 0) {
      fetchCategories();
    }
  }, [posts]);

  const fetchPosts = async () => {
    try {
      const response = await axios.get('/.netlify/functions/blog');
      // Handle both array and object response formats
      if (response.data) {
        if (Array.isArray(response.data)) {
          setPosts(response.data);
        } else if (response.data.posts) {
          setPosts(response.data.posts || []);
        } else {
          setPosts([]);
        }
      } else {
        setPosts([]);
      }
      setLoading(false);
    } catch (error) {
      console.error('Failed to fetch posts:', error);
      setPosts([]);
      setLoading(false);
    }
  };

  const fetchCategories = async () => {
    try {
      // Generate categories from posts for now
      if (posts.length > 0) {
        const uniqueCategories = [...new Set(posts.map(post => post.category).filter(Boolean))];
        setCategories(uniqueCategories.map(cat => ({ id: cat, name: cat, slug: cat })));
      }
    } catch (error) {
      console.error('Failed to fetch categories:', error);
    }
  };

  const formatDate = dateString => {
    if (!dateString) return '';
    try {
      return format(new Date(dateString), 'MMMM d, yyyy');
    } catch {
      return dateString;
    }
  };

  const getLocalizedContent = (post, field) => {
    const isUkrainian = i18n.language === 'uk';
    const ukField = `${field}_uk`;
    return isUkrainian && post[ukField] ? post[ukField] : post[field];
  };

  const filteredPosts =
    selectedCategory === 'all'
      ? posts
      : posts.filter(post => post.category && post.category === selectedCategory);

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-[50vh]">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div
      className={`blog-page ${darkMode ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-800'} min-h-screen py-8`}
    >
      <div className="container mx-auto px-4">
        <div className="mb-8">
          <h1 className={`text-4xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            {t('blog.title', 'Blog & News')}
          </h1>
          <p className={`text-lg ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
            {t('blog.subtitle', 'Latest updates, success stories, and grant writing tips')}
          </p>
        </div>

        {/* Category Filter */}
        <div className="mb-8">
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => setSelectedCategory('all')}
              className={`px-4 py-2 rounded-full transition-colors ${
                selectedCategory === 'all'
                  ? 'bg-blue-600 text-white'
                  : darkMode
                    ? 'bg-gray-800 text-gray-300 hover:bg-gray-700'
                    : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-300'
              }`}
            >
              {t('blog.allCategories', 'All Categories')}
            </button>
            {categories.map(category => (
              <button
                key={category.id}
                onClick={() => setSelectedCategory(category.slug)}
                className={`px-4 py-2 rounded-full transition-colors ${
                  selectedCategory === category.slug
                    ? 'bg-blue-600 text-white'
                    : darkMode
                      ? 'bg-gray-800 text-gray-300 hover:bg-gray-700'
                      : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-300'
                }`}
              >
                {i18n.language === 'uk' && category.name_uk ? category.name_uk : category.name}
              </button>
            ))}
          </div>
        </div>

        {/* Blog Posts Grid */}
        {filteredPosts.length === 0 ? (
          <div className={`text-center py-12 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg`}>
            <p className={`text-lg ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
              {t('blog.noPosts', 'No blog posts found in this category.')}
            </p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {filteredPosts.map(post => (
              <Link key={post.id} to={`/blog/${post.slug}`} className="block">
                <article
                  className={`rounded-lg shadow-lg overflow-hidden transition-transform hover:scale-105 cursor-pointer h-full ${
                    darkMode ? 'bg-gray-800' : 'bg-white'
                  }`}
                >
                  {post.featured_image && (
                    <div className="h-48 overflow-hidden">
                      <img
                        src={post.featured_image}
                        alt={getLocalizedContent(post, 'title')}
                        className="w-full h-full object-cover"
                      />
                    </div>
                  )}

                  <div className="p-6">
                    <h2
                      className={`text-xl font-bold mb-2 line-clamp-2 ${
                        darkMode ? 'text-white' : 'text-gray-900'
                      }`}
                    >
                      {getLocalizedContent(post, 'title')}
                    </h2>

                    <div
                      className={`flex items-center gap-4 text-sm mb-4 ${
                        darkMode ? 'text-gray-400' : 'text-gray-600'
                      }`}
                    >
                      <div className="flex items-center">
                        <CalendarIcon className="h-4 w-4 mr-1" />
                        {formatDate(post.published_at)}
                      </div>
                      <div className="flex items-center">
                        <UserIcon className="h-4 w-4 mr-1" />
                        {post.author_name}
                      </div>
                    </div>

                    {post.category && (
                      <div className="flex items-center mb-4">
                        <TagIcon
                          className={`h-4 w-4 mr-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}
                        />
                        <span
                          className={`text-xs px-2 py-1 rounded-full ${
                            darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'
                          }`}
                        >
                          {post.category}
                        </span>
                      </div>
                    )}

                    {getLocalizedContent(post, 'excerpt') && (
                      <p
                        className={`line-clamp-3 mb-4 ${
                          darkMode ? 'text-gray-300' : 'text-gray-700'
                        }`}
                      >
                        {getLocalizedContent(post, 'excerpt')}
                      </p>
                    )}

                    <span className="inline-flex items-center text-blue-600 font-medium">
                      {t('blog.readMore', 'Read More')} â†’
                    </span>
                  </div>
                </article>
              </Link>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

export default BlogPage;



================================================================================
FILE: client/src/pages/BlogPostPage.js
SIZE: 11983 bytes
================================================================================

import React, { useState, useEffect, useContext, useRef } from 'react';
import { useParams, Link, useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import ReactMarkdown from 'react-markdown';
import axios from 'axios';
import { format } from 'date-fns';
import { createRoot } from 'react-dom/client';
import { ThemeContext } from '../context/ThemeContext';
import { CalendarIcon, UserIcon, TagIcon, ArrowLeftIcon } from '@heroicons/react/24/outline';
import { sanitizeHTML } from '../utils/sanitize';
import SEOHead from '../components/SEOHead';
import StructuredData from '../components/StructuredData';
import Breadcrumbs from '../components/Breadcrumbs';
import {
  KeyStatisticsInfographic,
  FocusAreasInfographic,
  TimelineInfographic,
  RegionalImpactInfographic,
  InternationalSupportInfographic,
  FuturePrioritiesInfographic,
  CallToActionInfographic,
} from '../components/infographics/ProfessionalInfographics';

const BlogPostPage = () => {
  const { slug } = useParams();
  const navigate = useNavigate();
  const { t, i18n } = useTranslation();
  const { darkMode } = useContext(ThemeContext);
  const [post, setPost] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const contentRef = useRef(null);

  useEffect(() => {
    fetchPost();
  }, [slug]);

  useEffect(() => {
    if (post && contentRef.current) {
      // Small delay to ensure DOM is updated
      setTimeout(() => {
        renderInfographics();
      }, 100);
    }
  }, [post, darkMode]);

  const fetchPost = async () => {
    try {
      const response = await axios.get(`/.netlify/functions/blog/slug/${slug}`);
      setPost(response.data);
      setLoading(false);
    } catch (error) {
      console.error('Failed to fetch post:', error);
      setError('Post not found');
      setLoading(false);
    }
  };

  const formatDate = dateString => {
    if (!dateString) return '';
    try {
      return format(new Date(dateString), 'MMMM d, yyyy');
    } catch {
      return dateString;
    }
  };

  const getLocalizedContent = field => {
    if (!post) return '';
    const isUkrainian = i18n.language === 'uk';
    const ukField = `${field}_uk`;
    return isUkrainian && post[ukField] ? post[ukField] : post[field];
  };

  const renderInfographics = () => {
    const infographicContainers = contentRef.current?.querySelectorAll('.infographic-container');

    console.log('Rendering infographics, found containers:', infographicContainers?.length);

    if (!infographicContainers || infographicContainers.length === 0) return;

    infographicContainers.forEach(container => {
      const id = container.id;
      console.log('Processing container with id:', id);
      let InfographicComponent = null;

      switch (id) {
        case 'key-statistics':
          InfographicComponent = KeyStatisticsInfographic;
          break;
        case 'focus-areas':
          InfographicComponent = FocusAreasInfographic;
          break;
        case 'timeline':
          InfographicComponent = TimelineInfographic;
          break;
        case 'regional-impact':
          InfographicComponent = RegionalImpactInfographic;
          break;
        case 'international-support':
          InfographicComponent = InternationalSupportInfographic;
          break;
        case 'future-priorities':
          InfographicComponent = FuturePrioritiesInfographic;
          break;
        case 'call-to-action':
          InfographicComponent = CallToActionInfographic;
          break;
        default:
          break;
      }

      if (InfographicComponent) {
        // Clear container
        container.innerHTML = '';

        // Create root and render component
        const root = createRoot(container);
        root.render(<InfographicComponent darkMode={darkMode} />);
      }
    });
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-[50vh]">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="container mx-auto px-4 py-8">
        <div className={`text-center py-12 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg`}>
          <h1 className={`text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            {t('blog.postNotFound', 'Post Not Found')}
          </h1>
          <p className={`mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
            {t('blog.postNotFoundDesc', 'The blog post you are looking for does not exist.')}
          </p>
          <Link
            to="/blog"
            className="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            <ArrowLeftIcon className="h-5 w-5 mr-2" />
            {t('blog.backToBlog', 'Back to Blog')}
          </Link>
        </div>
      </div>
    );
  }

  return (
    <>
      <SEOHead
        title={post?.title}
        description={post?.excerpt || post?.summary}
        keywords={post?.tags?.join(', ')}
        ogImage={post?.featured_image}
        ogType="article"
      />
      <StructuredData
        type="article"
        data={{
          title: post?.title,
          description: post?.excerpt || post?.summary,
          image: post?.featured_image,
          author: post?.author || 'Civil Society Grants Team',
          datePublished: post?.created_at,
          dateModified: post?.updated_at,
          url: `/blog/${slug}`
        }}
      />
      <div
        className={`blog-post-page ${darkMode ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-800'} min-h-screen py-8`}
      >
        <article className="container mx-auto px-4 max-w-4xl">
          {/* Breadcrumbs */}
          <Breadcrumbs 
            customItems={[
              { label: t('breadcrumbs.blog', 'Blog'), path: '/blog' },
              { label: post?.title || t('breadcrumbs.loading', 'Loading...'), isLast: true }
            ]}
          />
          
          {/* Back Button */}
          <button
            onClick={() => navigate('/blog')}
            className={`inline-flex items-center mb-6 ${
              darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-900'
            } transition-colors`}
          >
            <ArrowLeftIcon className="h-5 w-5 mr-2" />
            {t('blog.backToBlog', 'Back to Blog')}
          </button>

        {/* Featured Image */}
        {post.featured_image && (
          <div className="mb-8 rounded-lg overflow-hidden shadow-lg">
            <img
              src={post.featured_image}
              alt={getLocalizedContent('title')}
              className="w-full h-auto"
            />
          </div>
        )}

        {/* Post Header */}
        <header className="mb-8">
          <h1
            className={`text-4xl md:text-5xl font-bold mb-4 ${
              darkMode ? 'text-white' : 'text-gray-900'
            }`}
          >
            {getLocalizedContent('title')}
          </h1>

          <div
            className={`flex flex-wrap items-center gap-4 text-sm ${
              darkMode ? 'text-gray-400' : 'text-gray-600'
            }`}
          >
            <div className="flex items-center">
              <CalendarIcon className="h-5 w-5 mr-2" />
              {formatDate(post.published_at)}
            </div>
            <div className="flex items-center">
              <UserIcon className="h-5 w-5 mr-2" />
              {post.author_name}
            </div>
            {post.categories && post.categories.length > 0 && (
              <div className="flex items-center">
                <TagIcon className="h-5 w-5 mr-2" />
                <div className="flex flex-wrap gap-2">
                  {post.categories.map(category => (
                    <span
                      key={category.id}
                      className={`px-3 py-1 rounded-full text-xs ${
                        darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-200 text-gray-700'
                      }`}
                    >
                      {i18n.language === 'uk' && category.name_uk
                        ? category.name_uk
                        : category.name}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </div>
        </header>

        {/* Post Content */}
        <div className={`prose prose-lg max-w-none ${darkMode ? 'prose-invert' : ''}`}>
          <div
            ref={contentRef}
            dangerouslySetInnerHTML={{ __html: sanitizeHTML(getLocalizedContent('content')) }}
            className={`
              ${darkMode ? 'text-gray-300' : 'text-gray-700'}
              [&>h1]:text-3xl [&>h1]:font-bold [&>h1]:mb-4 [&>h1]:mt-8
              [&>h2]:text-2xl [&>h2]:font-semibold [&>h2]:mb-3 [&>h2]:mt-6
              [&>h3]:text-xl [&>h3]:font-semibold [&>h3]:mb-2 [&>h3]:mt-4
              [&>p]:mb-4 [&>p]:leading-relaxed
              [&>ul]:list-disc [&>ul]:pl-6 [&>ul]:mb-4
              [&>ol]:list-decimal [&>ol]:pl-6 [&>ol]:mb-4
              [&>li]:mb-2
              [&>blockquote]:border-l-4 [&>blockquote]:border-blue-500 [&>blockquote]:pl-4 [&>blockquote]:italic [&>blockquote]:my-4
              [&>a]:text-blue-600 [&>a]:hover:text-blue-700 [&>a]:underline
              [&>img]:rounded-lg [&>img]:shadow-md [&>img]:my-6
              [&>pre]:bg-gray-100 [&>pre]:dark:bg-gray-800 [&>pre]:p-4 [&>pre]:rounded-lg [&>pre]:overflow-x-auto [&>pre]:my-4
              [&>code]:bg-gray-100 [&>code]:dark:bg-gray-800 [&>code]:px-1 [&>code]:py-0.5 [&>code]:rounded
              [&_.infographic-container]:my-8 [&_.infographic-container]:p-6 [&_.infographic-container]:rounded-xl 
              [&_.infographic-container]:bg-gray-100 [&_.infographic-container]:dark:bg-gray-800
              [&_.infographic-container]:flex [&_.infographic-container]:justify-center [&_.infographic-container]:items-center
              [&_.infographic-container]:overflow-x-auto [&_.infographic-container]:min-h-[400px]
            `}
          />
        </div>

        {/* Share Section */}
        <div className={`mt-12 pt-8 border-t ${darkMode ? 'border-gray-700' : 'border-gray-300'}`}>
          <h3 className={`text-lg font-semibold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            {t('blog.sharePost', 'Share this post')}
          </h3>
          <div className="flex gap-4">
            <a
              href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(getLocalizedContent('title'))}&url=${encodeURIComponent(window.location.href)}`}
              target="_blank"
              rel="noopener noreferrer"
              className={`px-4 py-2 rounded-lg ${
                darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-gray-200 hover:bg-gray-300'
              } transition-colors`}
            >
              Twitter
            </a>
            <a
              href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`}
              target="_blank"
              rel="noopener noreferrer"
              className={`px-4 py-2 rounded-lg ${
                darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-gray-200 hover:bg-gray-300'
              } transition-colors`}
            >
              Facebook
            </a>
            <a
              href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}`}
              target="_blank"
              rel="noopener noreferrer"
              className={`px-4 py-2 rounded-lg ${
                darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-gray-200 hover:bg-gray-300'
              } transition-colors`}
            >
              LinkedIn
            </a>
          </div>
        </div>
      </article>
    </div>
    </>
  );
};

export default BlogPostPage;



================================================================================
FILE: client/src/pages/GrantDetail.js
SIZE: 9475 bytes
================================================================================

import React, { useState, useEffect } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import axios from 'axios';
import { format } from 'date-fns';
import { DocumentArrowDownIcon } from '@heroicons/react/24/outline';

const GrantDetail = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const { t } = useTranslation();
  const [grant, setGrant] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchGrant = async () => {
      try {
        const response = await axios.get('/.netlify/functions/grants');
        const allGrants = response.data;

        // Find the grant matching the query parameter
        const foundGrant = allGrants.find(g => g['Grant Name'] === decodeURIComponent(id));

        if (foundGrant) {
          setGrant(foundGrant);
        } else {
          setError('Grant not found');
          setTimeout(() => navigate('/grants'), 3000);
        }

        setLoading(false);
      } catch (err) {
        console.error('Error fetching grant details:', err);
        setError('Failed to load grant details');
        setLoading(false);
      }
    };

    fetchGrant();
  }, [id, navigate]);

  const formatDate = dateString => {
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      return format(date, 'MMMM d, yyyy');
    } catch (error) {
      return dateString;
    }
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
        <div className="flex">
          <div className="flex-shrink-0">
            <svg
              className="h-5 w-5 text-red-500"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fillRule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                clipRule="evenodd"
              />
            </svg>
          </div>
          <div className="ml-3">
            <p className="text-sm text-red-700">{error}</p>
            <p className="mt-2 text-sm text-red-600">Redirecting to grants page...</p>
          </div>
        </div>
      </div>
    );
  }

  if (!grant) {
    return null;
  }

  const getWebsiteUrl = link => {
    if (!link) return '#';
    return link.startsWith('http') ? link : `https://${link}`;
  };

  const handlePrintPDF = () => {
    // Create a print-specific style
    const printStyles = `
      @media print {
        /* Hide non-essential elements */
        .no-print {
          display: none !important;
        }
        
        /* Reset colors for better printing */
        * {
          background: white !important;
          color: black !important;
        }
        
        /* Ensure proper page breaks */
        .grant-detail {
          page-break-inside: avoid;
        }
        
        /* Style adjustments for print */
        .bg-blue-700 {
          background-color: #f3f4f6 !important;
          border-bottom: 2px solid #000 !important;
        }
        
        .text-blue-100 {
          color: #374151 !important;
        }
        
        a {
          text-decoration: underline !important;
        }
        
        /* Add grant info header for print */
        @page {
          margin: 1in;
        }
        
        .print-header::before {
          content: "Civil Society Grants Database";
          font-size: 12px;
          color: #666;
          display: block;
          margin-bottom: 20px;
        }
        
        .print-header::after {
          content: "Generated on: " attr(data-date);
          font-size: 10px;
          color: #666;
          display: block;
          position: absolute;
          top: 10px;
          right: 10px;
        }
      }
    `;

    // Inject print styles
    const styleElement = document.createElement('style');
    styleElement.textContent = printStyles;
    document.head.appendChild(styleElement);

    // Add date attribute for print
    const printHeader = document.querySelector('.print-header');
    if (printHeader) {
      printHeader.setAttribute('data-date', new Date().toLocaleDateString());
    }

    // Trigger print dialog
    window.print();

    // Clean up styles after print
    setTimeout(() => {
      document.head.removeChild(styleElement);
    }, 1000);
  };

  return (
    <div className="grant-detail">
      <div className="flex justify-between items-center mb-6 no-print">
        <Link
          to="/grants"
          className="inline-flex items-center text-blue-600 hover:text-blue-800"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            className="h-5 w-5 mr-1"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fillRule="evenodd"
              d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
              clipRule="evenodd"
            />
          </svg>
          {t('grantDetail.backToGrants')}
        </Link>
        <button
          onClick={handlePrintPDF}
          className="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors"
        >
          <DocumentArrowDownIcon className="h-5 w-5 mr-2" />
          Export PDF
        </button>
      </div>

      <div className="bg-white rounded-lg shadow-lg overflow-hidden border border-gray-200 print-header">
        <div className="bg-blue-700 text-white px-6 py-4">
          <h1 className="text-2xl font-bold">{grant['Grant Name']}</h1>
          <p className="text-blue-100 text-lg">{grant['Funding Organization']}</p>
        </div>

        <div className="p-6">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h2 className="text-lg font-semibold text-gray-700 mb-4">
                {t('grantDetail.grantDetails')}
              </h2>

              <div className="space-y-4">
                <div>
                  <h3 className="font-medium text-gray-700">{t('grantDetail.organization')}</h3>
                  <p className="text-gray-800">{grant['Funding Organization']}</p>
                </div>

                <div>
                  <h3 className="font-medium text-gray-700">{t('grantDetail.country')}</h3>
                  <p className="text-gray-800">{grant['Country/Region']}</p>
                </div>

                <div>
                  <h3 className="font-medium text-gray-700">{t('grantDetail.amount')}</h3>
                  <p className="text-gray-800 font-semibold">
                    {grant['Grant Amount'] || 'Not specified'}
                  </p>
                </div>

                <div>
                  <h3 className="font-medium text-gray-700">{t('grantDetail.deadline')}</h3>
                  <p className="text-red-600 font-semibold">
                    {formatDate(grant['Application Deadline'])}
                  </p>
                </div>

                <div>
                  <h3 className="font-medium text-gray-700">{t('grantDetail.duration')}</h3>
                  <p className="text-gray-800">{grant['Duration'] || 'Not specified'}</p>
                </div>
              </div>
            </div>

            <div>
              <div className="space-y-4">
                <div>
                  <h3 className="font-medium text-gray-700">{t('grantDetail.eligibility')}</h3>
                  <p className="text-gray-800 whitespace-pre-line">
                    {grant['Eligibility Criteria']}
                  </p>
                </div>

                <div>
                  <h3 className="font-medium text-gray-700">{t('grantDetail.focusAreas')}</h3>
                  <p className="text-gray-800 whitespace-pre-line">{grant['Focus Areas']}</p>
                </div>

                <div>
                  <h3 className="font-medium text-gray-700">{t('grantDetail.website')}</h3>
                  <a
                    href={getWebsiteUrl(grant['Website Link'])}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-blue-600 hover:underline break-all"
                  >
                    {grant['Website Link']}
                  </a>
                </div>
              </div>
            </div>
          </div>

          <div className="mt-8 text-center no-print">
            <a
              href={getWebsiteUrl(grant['Website Link'])}
              target="_blank"
              rel="noopener noreferrer"
              className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg inline-block transition duration-200"
            >
              {t('grantDetail.applyNow')}
            </a>
          </div>
        </div>
      </div>
    </div>
  );
};

export default GrantDetail;



================================================================================
FILE: client/src/pages/GrantsPage.js
SIZE: 59686 bytes
================================================================================

import React, { useState, useEffect, useCallback, useContext } from 'react';
import { useTranslation } from 'react-i18next';
import i18n from 'i18next';
import { useSearchParams } from 'react-router-dom';
import axios from 'axios';
import { format } from 'date-fns';
import { ThemeContext } from '../context/ThemeContext';
import GrantsChatWidget from '../components/GrantsChatWidget';
import LoadingSkeleton from '../components/LoadingSkeleton';
import GrantDeadlineIndicator, { CompactDeadlineIndicator } from '../components/GrantDeadlineIndicator';
import GrantBookmark, { useBookmarkedGrants, BookmarksCounter } from '../components/GrantBookmark';
import GrantComparisonModal from '../components/GrantComparisonModal';
import Breadcrumbs from '../components/Breadcrumbs';
import BackToTop from '../components/BackToTop';
import SEOHead from '../components/SEOHead';
import StructuredData from '../components/StructuredData';

const GrantsPage = () => {
  const { t } = useTranslation();
  const [searchParams, setSearchParams] = useSearchParams();
  const { darkMode } = useContext(ThemeContext);
  const [grants, setGrants] = useState([]);
  const [filteredGrants, setFilteredGrants] = useState([]);

  // Helper function to get the correct field based on current language
  const getLocalizedField = (grant, fieldName) => {
    const isUkrainian = i18n.language === 'uk';

    // Map of English field names to Ukrainian field names
    const fieldMap = {
      grant_name: isUkrainian ? 'grant_name_uk' : 'grant_name',
      'Grant Name': isUkrainian ? 'grant_name_uk' : 'grant_name',
      funding_organization: isUkrainian ? 'funding_organization_uk' : 'funding_organization',
      'Funding Organization': isUkrainian ? 'funding_organization_uk' : 'funding_organization',
      country_region: isUkrainian ? 'country_region_uk' : 'country_region',
      'Country/Region': isUkrainian ? 'country_region_uk' : 'country_region',
      eligibility_criteria: isUkrainian ? 'eligibility_criteria_uk' : 'eligibility_criteria',
      'Eligibility Criteria': isUkrainian ? 'eligibility_criteria_uk' : 'eligibility_criteria',
      focus_areas: isUkrainian ? 'focus_areas_uk' : 'focus_areas',
      'Focus Areas': isUkrainian ? 'focus_areas_uk' : 'focus_areas',
      grant_amount: isUkrainian ? 'grant_amount_uk' : 'grant_amount',
      'Grant Amount': isUkrainian ? 'grant_amount_uk' : 'grant_amount',
      duration: isUkrainian ? 'duration_uk' : 'duration',
      Duration: isUkrainian ? 'duration_uk' : 'duration',
      application_procedure: isUkrainian ? 'application_procedure_uk' : 'application_procedure',
      required_documents: isUkrainian ? 'required_documents_uk' : 'required_documents',
      evaluation_criteria: isUkrainian ? 'evaluation_criteria_uk' : 'evaluation_criteria',
      additional_requirements: isUkrainian
        ? 'additional_requirements_uk'
        : 'additional_requirements',
      reporting_requirements: isUkrainian ? 'reporting_requirements_uk' : 'reporting_requirements',
      detailed_description: isUkrainian ? 'detailed_description_uk' : 'detailed_description',
    };

    // Get the appropriate field name
    const actualFieldName = fieldMap[fieldName] || fieldName;

    // Return the value from the grant object, checking both database and JSON formats
    return grant[actualFieldName] || grant[fieldName] || '';
  };

  const [loading, setLoading] = useState(true);
  const [filters, setFilters] = useState({
    organizations: [],
    focusAreas: [],
  });

  // Form state
  const [searchTerm, setSearchTerm] = useState(searchParams.get('query') || '');
  const [selectedOrganization, setSelectedOrganization] = useState('');
  const [selectedFocusArea, setSelectedFocusArea] = useState('');
  const [sortBy, setSortBy] = useState('deadlineAsc');
  const [showExpired, setShowExpired] = useState(false);
  const [expandedGrants, setExpandedGrants] = useState(new Set());
  const [organizationLogos, setOrganizationLogos] = useState({});
  const [selectedForComparison, setSelectedForComparison] = useState([]);
  const [showComparisonModal, setShowComparisonModal] = useState(false);
  const [showBookmarkedOnly, setShowBookmarkedOnly] = useState(false);
  const bookmarkedIds = useBookmarkedGrants();

  useEffect(() => {
    const fetchData = async () => {
      try {
        let grantsData;
        let filtersData;
        let logosData = {};

        // Load organization logos
        try {
          const logosResponse = await axios.get('/data/organization-logos.json');
          logosData = logosResponse.data;
          setOrganizationLogos(logosData);
          console.log('Organization logos loaded successfully');
        } catch (logosError) {
          console.log('Organization logos file not found, logos will not be displayed');
          // Continue without logos - not a critical error
          setOrganizationLogos({});
        }

        try {
          // First try to fetch from API (direct function endpoints)
          const grantsResponse = await axios.get('/.netlify/functions/grants');
          grantsData = grantsResponse.data;

          const filtersResponse = await axios.get('/.netlify/functions/grants/filters');
          filtersData = filtersResponse.data;

          console.log('Loaded data from API endpoint');
        } catch (apiError) {
          console.log('API endpoint failed, falling back to static JSON data');
          // Fallback to static JSON files with language support
          const currentLanguage = i18n.language;
          const grantsJsonPath =
            currentLanguage === 'uk' ? '/data/grants_uk.json' : '/data/grants.json';
          const filtersJsonPath =
            currentLanguage === 'uk' ? '/data/filters_uk.json' : '/data/filters.json';

          console.log(`Loading ${currentLanguage} language data files`);

          try {
            const grantsResponse = await axios.get(grantsJsonPath);
            grantsData = grantsResponse.data;

            try {
              const filtersResponse = await axios.get(filtersJsonPath);
              filtersData = filtersResponse.data;
            } catch (filtersError) {
              // Generate filters from grants data if filters.json fails
              console.log('Generating filters from grants data');
              filtersData = generateFiltersFromGrants(grantsData);
            }
          } catch (grantsError) {
            // If language-specific file fails, fallback to English
            console.log('Language-specific files failed, falling back to English data');
            const grantsResponse = await axios.get('/data/grants.json');
            grantsData = grantsResponse.data;

            const filtersResponse = await axios.get('/data/filters.json');
            filtersData = filtersResponse.data;
          }

          console.log('Loaded data from static JSON files');
        }

        setGrants(grantsData);
        setFilters(filtersData);
        // Initialize filteredGrants with all grants when first loaded
        setFilteredGrants(grantsData);
        setLoading(false);
      } catch (error) {
        console.error('Error fetching data:', error);
        setLoading(false);
      }
    };

    // Helper function to generate filters from grants data
    const generateFiltersFromGrants = grants => {
      const filters = {
        organizations: [],
        focusAreas: [],
      };

      grants.forEach(grant => {
        // Support both database format and static JSON format
        const organization = grant.funding_organization || grant['Funding Organization'];
        const focusAreas = grant.focus_areas || grant['Focus Areas'];

        // Organizations
        if (organization && !filters.organizations.includes(organization)) {
          filters.organizations.push(organization);
        }

        // Focus Areas - these might be comma-separated
        if (focusAreas) {
          const areas = focusAreas.split(',').map(area => area.trim());
          areas.forEach(area => {
            if (!filters.focusAreas.includes(area)) {
              filters.focusAreas.push(area);
            }
          });
        }
      });

      // Sort filter values alphabetically
      filters.organizations.sort();
      filters.focusAreas.sort();

      return filters;
    };

    fetchData();
  }, []);

  // Initialize search term from URL parameters
  useEffect(() => {
    const query = searchParams.get('query');
    if (query) {
      setSearchTerm(query);
    }
  }, [searchParams]);

  // Helper functions
  const extractAmount = amountString => {
    const match = amountString.match(/(\d[\d.,]*)/g);
    if (!match) return 0;
    return parseFloat(match[0].replace(/,/g, '')) || 0;
  };

  const formatDate = dateString => {
    try {
      if (!dateString) return 'No deadline specified';
      
      // Handle non-date strings like "Annual calls", "Rolling deadlines", etc.
      if (typeof dateString === 'string' && !dateString.match(/^\d{4}-\d{2}-\d{2}/)) {
        return dateString;
      }
      
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      return format(date, 'MMMM d, yyyy');
    } catch (error) {
      return dateString || 'No deadline specified';
    }
  };

  const truncateText = (text, maxLength) => {
    if (!text) return '';
    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
  };

  const toggleGrantExpansion = index => {
    const newExpanded = new Set(expandedGrants);
    if (newExpanded.has(index)) {
      newExpanded.delete(index);
    } else {
      newExpanded.add(index);
    }
    setExpandedGrants(newExpanded);
  };

  const isGrantExpanded = index => expandedGrants.has(index);

  // Get organization logo
  const getOrganizationLogo = organizationName => {
    if (!organizationName) return null;

    // Create slug from organization name
    const slug = organizationName
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, '')
      .replace(/\s+/g, '-')
      .replace(/^-+|-+$/g, '');

    // organizationLogos is a flat object with logo paths directly
    return organizationLogos[slug] || null;
  };

  // Sort grants based on criteria
  const sortGrants = useCallback((grantsToSort, sortCriteria) => {
    try {
      switch (sortCriteria) {
      case 'nameAsc':
        return [...grantsToSort].sort((a, b) =>
          ((a.grant_name || a['Grant Name']) || '').localeCompare((b.grant_name || b['Grant Name']) || '')
        );
      case 'nameDesc':
        return [...grantsToSort].sort((a, b) =>
          ((b.grant_name || b['Grant Name']) || '').localeCompare((a.grant_name || a['Grant Name']) || '')
        );
      case 'deadlineAsc':
        return [...grantsToSort].sort((a, b) => {
          const dateA = new Date((a.application_deadline || a['Application Deadline']) || '9999-12-31');
          const dateB = new Date((b.application_deadline || b['Application Deadline']) || '9999-12-31');
          return dateA - dateB;
        });
      case 'deadlineDesc':
        return [...grantsToSort].sort((a, b) => {
          const dateA = new Date((a.application_deadline || a['Application Deadline']) || '0000-01-01');
          const dateB = new Date((b.application_deadline || b['Application Deadline']) || '0000-01-01');
          return dateB - dateA;
        });
      case 'amountAsc':
      case 'amountDesc':
        return [...grantsToSort].sort((a, b) => {
          const amountA = extractAmount((a.grant_amount || a['Grant Amount']) || '');
          const amountB = extractAmount((b.grant_amount || b['Grant Amount']) || '');
          return sortCriteria === 'amountAsc' ? amountA - amountB : amountB - amountA;
        });
      default:
        return grantsToSort;
      }
    } catch (error) {
      console.error('Error in sortGrants:', error);
      return grantsToSort; // Return unsorted array on error
    }
  }, []);

  // Apply filters function
  const applyFilters = useCallback(() => {
    let filtered = [...grants];

    // Text search - support both data formats
    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      filtered = filtered.filter(grant => {
        const grantName = grant.grant_name || grant['Grant Name'] || '';
        const organization = grant.funding_organization || grant['Funding Organization'] || '';
        const focusAreas = grant.focus_areas || grant['Focus Areas'] || '';
        const eligibility = grant.eligibility_criteria || grant['Eligibility Criteria'] || '';

        return (
          grantName.toLowerCase().includes(term) ||
          organization.toLowerCase().includes(term) ||
          focusAreas.toLowerCase().includes(term) ||
          eligibility.toLowerCase().includes(term)
        );
      });
    }

    // Organization filter
    if (selectedOrganization) {
      filtered = filtered.filter(grant => {
        const organization = grant.funding_organization || grant['Funding Organization'];
        return organization === selectedOrganization;
      });
    }

    // Focus area filter
    if (selectedFocusArea) {
      filtered = filtered.filter(grant => {
        const focusAreas = grant.focus_areas || grant['Focus Areas'] || '';
        return focusAreas.toLowerCase().includes(selectedFocusArea.toLowerCase());
      });
    }

    // Filter out expired grants unless showExpired is true
    if (!showExpired) {
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Set to start of today

      filtered = filtered.filter(grant => {
        const deadlineField = grant.application_deadline || grant['Application Deadline'];
        if (!deadlineField) return true; // Keep grants without deadlines

        const deadline = new Date(deadlineField);
        if (isNaN(deadline.getTime())) return true; // Keep grants with invalid dates

        return deadline >= today; // Only show grants with deadlines today or in the future
      });
    }

    // Filter bookmarked grants if enabled
    if (showBookmarkedOnly) {
      filtered = filtered.filter(grant => {
        const grantId = grant.id || grant['Grant Name'];
        return bookmarkedIds.includes(grantId);
      });
    }

    // Apply sorting
    filtered = sortGrants(filtered, sortBy);

    setFilteredGrants(filtered);
  }, [
    grants,
    searchTerm,
    selectedOrganization,
    selectedFocusArea,
    sortBy,
    showExpired,
    showBookmarkedOnly,
    bookmarkedIds,
    sortGrants,
  ]);

  // Apply filters when data is loaded or filters change
  useEffect(() => {
    if (!loading) {
      applyFilters();
    }
  }, [loading, applyFilters]);

  // Form handlers
  const handleSearch = e => {
    e.preventDefault();

    // Update URL with search parameters
    const params = new URLSearchParams();
    if (searchTerm) params.set('query', searchTerm);
    setSearchParams(params);

    applyFilters();
  };

  const resetFilters = () => {
    setSearchTerm('');
    setSelectedOrganization('');
    setSelectedFocusArea('');
    setSortBy('deadlineAsc');
    setShowExpired(false);
    setShowBookmarkedOnly(false);
    setSearchParams({});
  };

  // Calculate days until deadline
  const calculateDaysRemaining = deadlineString => {
    if (!deadlineString) return null;
    
    // Handle non-date strings - return null so they're treated as "rolling" deadlines
    if (typeof deadlineString === 'string' && !deadlineString.match(/^\d{4}-\d{2}-\d{2}/)) {
      return null;
    }
    
    const today = new Date();
    const deadline = new Date(deadlineString);
    if (isNaN(deadline.getTime())) return null;
    return Math.round((deadline - today) / (1000 * 60 * 60 * 24));
  };

  const toggleComparison = (grant) => {
    const grantId = grant.id || grant['Grant Name'];
    setSelectedForComparison(prev => {
      const isSelected = prev.find(g => (g.id || g['Grant Name']) === grantId);
      if (isSelected) {
        return prev.filter(g => (g.id || g['Grant Name']) !== grantId);
      }
      if (prev.length >= 3) {
        // Maximum 3 grants for comparison
        return [...prev.slice(1), grant];
      }
      return [...prev, grant];
    });
  };

  const isSelectedForComparison = (grant) => {
    const grantId = grant.id || grant['Grant Name'];
    return selectedForComparison.some(g => (g.id || g['Grant Name']) === grantId);
  };

  return (
    <>
      <SEOHead
        title={t('grants.page.title', 'Browse Available Grants')}
        description={t('grants.page.description', 'Explore over 100 funding opportunities for Ukrainian civil society organizations. Find grants for NGOs, media outlets, and community initiatives with total funding of â‚¬63M+.')}
        keywords={t('grants.page.keywords', 'civil society grants, ukraine funding, ngo grants, media grants, development funding')}
      />
      <StructuredData 
        type="grantsList" 
        data={filteredGrants.slice(0, 10).map(grant => ({
          id: grant.id || grant['Grant Name'],
          name: getLocalizedField(grant, 'Grant Name') || grant.grant_name || grant['Grant Name'],
          organization: grant.funding_organization || grant['Funding Organization'],
          deadline: grant.application_deadline || grant['Application Deadline']
        }))}
      />
      <main
        id="main-content"
        className={`grants-page ${darkMode ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-800'} min-h-screen transition-colors duration-300 py-12 px-4 sm:px-6 lg:px-8`}
      >
        {/* Header Section */}
        <div className="max-w-7xl mx-auto mb-8">
          <Breadcrumbs />
        <h1
          className={`text-4xl md:text-5xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'} transition-colors duration-300`}
        >
          {t('grants.search')}
        </h1>
        <p className={`text-lg ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
          {t('grants.subtitle', 'Find the perfect grant opportunity for your organization')}
        </p>
      </div>

      {/* Simplified Filter Bar */}
      <div className="max-w-7xl mx-auto mb-12">
        <div
          className={`rounded-2xl shadow-sm p-6 ${darkMode ? 'bg-gray-800/50 backdrop-blur border border-gray-700/50' : 'bg-white/80 backdrop-blur border border-gray-200/50'} transition-all duration-300`}
        >
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {/* Search */}
            <div className="relative">
              <input
                type="text"
                className={`w-full pl-10 pr-4 py-3.5 rounded-xl border ${darkMode ? 'bg-gray-700/50 border-gray-600 text-white placeholder-gray-400' : 'bg-gray-50 border-gray-300 text-gray-900 placeholder-gray-500'} focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-base`}
                placeholder={t('grants.searchPlaceholder')}
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
                onKeyPress={e => e.key === 'Enter' && applyFilters()}
              />
              <svg
                xmlns="http://www.w3.org/2000/svg"
                className={`absolute left-3 top-3.5 h-5 w-5 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fillRule="evenodd"
                  d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                  clipRule="evenodd"
                />
              </svg>
            </div>

            {/* Organization Filter */}
            <select
              className={`w-full px-4 py-3.5 rounded-xl border ${darkMode ? 'bg-gray-700/50 border-gray-600 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-base appearance-none cursor-pointer`}
              value={selectedOrganization}
              onChange={e => setSelectedOrganization(e.target.value)}
            >
              <option value="">{t('grants.allOrganizations', 'All Organizations')}</option>
              {filters.organizations.map((org, index) => (
                <option key={index} value={org}>
                  {org}
                </option>
              ))}
            </select>

            {/* Focus Area Filter */}
            <select
              className={`w-full px-4 py-3.5 rounded-xl border ${darkMode ? 'bg-gray-700/50 border-gray-600 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-base appearance-none cursor-pointer`}
              value={selectedFocusArea}
              onChange={e => setSelectedFocusArea(e.target.value)}
            >
              <option value="">{t('grants.allFocusAreas', 'All Focus Areas')}</option>
              {filters.focusAreas.map((area, index) => (
                <option key={index} value={area}>
                  {area}
                </option>
              ))}
            </select>

            {/* Clear Filters Button */}
            <button
              onClick={resetFilters}
              className={`flex items-center justify-center px-6 py-3.5 rounded-xl font-medium transition-all duration-200 ${
                darkMode
                  ? 'bg-gray-700/50 text-gray-300 hover:bg-gray-600/50'
                  : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
              } ${!searchTerm && !selectedOrganization && !selectedFocusArea ? 'opacity-50 cursor-not-allowed' : ''}`}
              disabled={!searchTerm && !selectedOrganization && !selectedFocusArea}
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                className="h-5 w-5 mr-2"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fillRule="evenodd"
                  d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                  clipRule="evenodd"
                />
              </svg>
              {t('grants.clearFilters', 'Clear')}
            </button>
          </div>

          {/* Additional filter options */}
          <div className="flex flex-wrap gap-4 mt-4">
            <label
              className={`flex items-center gap-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'} cursor-pointer`}
            >
              <input
                type="checkbox"
                className="rounded text-blue-600 focus:ring-blue-500 cursor-pointer"
                checked={showBookmarkedOnly}
                onChange={e => setShowBookmarkedOnly(e.target.checked)}
              />
              <span className="text-sm flex items-center gap-1">
                {t('grants.showBookmarked', 'Bookmarked only')}
                <BookmarksCounter className="ml-1" />
              </span>
            </label>
            {selectedForComparison.length >= 2 && (
              <button
                onClick={() => setShowComparisonModal(true)}
                className={`
                  flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium
                  transition-all duration-200
                  ${darkMode
                    ? 'bg-blue-900/30 text-blue-400 hover:bg-blue-900/40'
                    : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                  }
                `}
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
                Compare ({selectedForComparison.length})
              </button>
            )}
          </div>
        </div>
      </div>

      {/* Main Content Area */}
      <div className="max-w-7xl mx-auto">
        {/* Results Header with Sorting */}
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
          <div className="flex items-center gap-6">
            <div className={`text-lg font-medium ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>
              {filteredGrants.length} {t('grants.resultsFound', 'grants found')}
            </div>
            <label
              className={`flex items-center gap-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'} cursor-pointer`}
            >
              <input
                type="checkbox"
                className="rounded text-blue-600 focus:ring-blue-500 cursor-pointer"
                checked={showExpired}
                onChange={e => setShowExpired(e.target.checked)}
              />
              <span className="text-sm">{t('grants.showExpired', 'Show expired')}</span>
            </label>
          </div>

          <div className="flex items-center gap-2">
            <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
              {t('grants.sortBy', 'Sort by')}:
            </span>
            <select
              className={`px-4 py-2.5 rounded-xl border text-sm ${darkMode ? 'bg-gray-800/50 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-900'} focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none cursor-pointer pr-10`}
              value={sortBy}
              onChange={e => setSortBy(e.target.value)}
            >
              <option value="deadlineAsc">
                {t('grants.sortOptions.deadlineAsc', 'Deadline (Soonest)')}
              </option>
              <option value="deadlineDesc">
                {t('grants.sortOptions.deadlineDesc', 'Deadline (Latest)')}
              </option>
              <option value="amountDesc">
                {t('grants.sortOptions.amountDesc', 'Amount (Highest)')}
              </option>
              <option value="amountAsc">
                {t('grants.sortOptions.amountAsc', 'Amount (Lowest)')}
              </option>
              <option value="nameAsc">{t('grants.sortOptions.nameAsc', 'Name (A-Z)')}</option>
              <option value="nameDesc">{t('grants.sortOptions.nameDesc', 'Name (Z-A)')}</option>
            </select>
          </div>
        </div>

        {/* Grants List */}
        <div className="mt-8">
          {loading ? (
            <LoadingSkeleton type="grant-card" count={5} />
          ) : (
            <>
              {filteredGrants.length === 0 ? (
                <div
                  className={`p-12 rounded-2xl text-center ${darkMode ? 'bg-gray-800/50 backdrop-blur' : 'bg-gray-50'}`}
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    className={`h-12 w-12 mx-auto mb-4 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={1.5}
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    />
                  </svg>
                  <p
                    className={`text-lg font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
                  >
                    {t('grants.noResults')}
                  </p>
                  <p className={`mt-2 text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                    Try adjusting your search criteria
                  </p>
                </div>
              ) : (
                <div className="space-y-4">
                  {filteredGrants.map((grant, index) => {
                    const deadline = grant.application_deadline || grant['Application Deadline'];
                    const daysDiff = calculateDaysRemaining(deadline);
                    const isExpired = daysDiff !== null && daysDiff < 0;
                    const isUrgent = daysDiff !== null && daysDiff >= 0 && daysDiff <= 7;

                    return (
                      <article
                        key={index}
                        aria-label={`Grant: ${getLocalizedField(grant, 'Grant Name') || grant.grant_name || grant['Grant Name']}`}
                        className={`rounded-2xl overflow-hidden ${
                          isExpired
                            ? darkMode
                              ? 'bg-gray-800/50 border border-red-700/30 opacity-60'
                              : 'bg-gray-50 border border-red-200 opacity-75'
                            : darkMode
                              ? 'bg-gray-800/50 backdrop-blur border border-gray-700/50 hover:shadow-xl hover:border-gray-600/50'
                              : 'bg-white/80 backdrop-blur border border-gray-200/50 hover:shadow-xl'
                        } transition-all duration-300 transform hover:-translate-y-1 ${
                          isSelectedForComparison(grant)
                            ? darkMode
                              ? 'ring-2 ring-blue-500'
                              : 'ring-2 ring-blue-400'
                            : ''
                        }`}
                      >
                        <div className="p-6">
                          <div className="flex justify-between items-start mb-4">
                            <div className="flex items-start space-x-4 flex-1">
                              {(grant.logo_url || getOrganizationLogo(
                                grant.funding_organization || grant['Funding Organization']
                              )) && (
                                <div
                                  className={`flex-shrink-0 w-14 h-14 rounded-xl overflow-hidden ${darkMode ? 'bg-gray-700/50' : 'bg-gray-100'} p-2`}
                                >
                                  <img
                                    src={grant.logo_url || getOrganizationLogo(
                                      grant.funding_organization || grant['Funding Organization']
                                    )}
                                    alt={`${grant.funding_organization || grant['Funding Organization']} logo`}
                                    className="w-full h-full object-contain"
                                    onError={e => {
                                      e.target.style.display = 'none';
                                    }}
                                  />
                                </div>
                              )}
                              <div className="flex-1">
                                <h2
                                  className={`text-xl font-semibold mb-1 ${darkMode ? 'text-white' : 'text-gray-900'}`}
                                >
                                  {getLocalizedField(grant, 'grant_name') ||
                                    getLocalizedField(grant, 'Grant Name')}
                                </h2>
                                <p
                                  className={`text-base ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}
                                >
                                  {getLocalizedField(grant, 'funding_organization') ||
                                    getLocalizedField(grant, 'Funding Organization')}
                                </p>
                              </div>
                            </div>
                            {/* Action buttons in top right */}
                            <div className="flex items-center gap-2">
                              <GrantBookmark grant={grant} />
                              <button
                                onClick={() => toggleComparison(grant)}
                                className={`
                                  p-2 rounded-lg transition-colors
                                  ${isSelectedForComparison(grant)
                                    ? darkMode
                                      ? 'bg-blue-900/30 text-blue-400'
                                      : 'bg-blue-100 text-blue-600'
                                    : darkMode
                                      ? 'hover:bg-gray-700/50 text-gray-400'
                                      : 'hover:bg-gray-100 text-gray-500'
                                  }
                                `}
                                title="Compare this grant"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  className="h-4 w-4"
                                  fill="none"
                                  viewBox="0 0 24 24"
                                  stroke="currentColor"
                                >
                                  <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth={2}
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                                  />
                                </svg>
                              </button>
                            </div>
                          </div>

                          {/* Status Badge */}
                          <div className="mb-4">
                            <GrantDeadlineIndicator
                              deadline={grant.application_deadline || grant['Application Deadline']}
                            />
                          </div>

                          {/* Original Status Badge - now hidden as we use GrantDeadlineIndicator */}
                          <div className="hidden">
                            <div
                              className={`ml-4 px-3 py-1 rounded-full text-xs font-semibold ${
                                isExpired
                                  ? darkMode
                                    ? 'bg-red-900/20 text-red-400'
                                    : 'bg-red-100 text-red-600'
                                  : isUrgent
                                    ? darkMode
                                      ? 'bg-orange-900/20 text-orange-400'
                                      : 'bg-orange-100 text-orange-600'
                                    : darkMode
                                      ? 'bg-green-900/20 text-green-400'
                                      : 'bg-green-100 text-green-600'
                              }`}
                            >
                              {isExpired ? 'EXPIRED' : isUrgent ? `${daysDiff} DAYS LEFT` : 'OPEN'}
                            </div>
                          </div>
                          {/* Key Information Pills */}
                          <div className="flex flex-wrap gap-2 mb-4">
                            <div
                              className={`inline-flex items-center px-3 py-1.5 rounded-full text-sm ${darkMode ? 'bg-gray-700/50 text-gray-300' : 'bg-gray-100 text-gray-700'}`}
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                className="h-4 w-4 mr-1.5"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                              >
                                <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                                <path
                                  fillRule="evenodd"
                                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z"
                                  clipRule="evenodd"
                                />
                              </svg>
                              {getLocalizedField(grant, 'grant_amount') ||
                                getLocalizedField(grant, 'Grant Amount') ||
                                'Amount varies'}
                            </div>
                            <div
                              className={`inline-flex items-center px-3 py-1.5 rounded-full text-sm ${darkMode ? 'bg-gray-700/50 text-gray-300' : 'bg-gray-100 text-gray-700'}`}
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                className="h-4 w-4 mr-1.5"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                              >
                                <path
                                  fillRule="evenodd"
                                  d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                                  clipRule="evenodd"
                                />
                              </svg>
                              {formatDate(
                                grant.application_deadline || grant['Application Deadline']
                              )}
                              <CompactDeadlineIndicator
                                deadline={grant.application_deadline || grant['Application Deadline']}
                              />
                            </div>
                            <div
                              className={`inline-flex items-center px-3 py-1.5 rounded-full text-sm ${darkMode ? 'bg-gray-700/50 text-gray-300' : 'bg-gray-100 text-gray-700'}`}
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                className="h-4 w-4 mr-1.5"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                              >
                                <path
                                  fillRule="evenodd"
                                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                                  clipRule="evenodd"
                                />
                              </svg>
                              {getLocalizedField(grant, 'duration') ||
                                getLocalizedField(grant, 'Duration') ||
                                'Varies'}
                            </div>
                            <div
                              className={`inline-flex items-center px-3 py-1.5 rounded-full text-sm ${darkMode ? 'bg-gray-700/50 text-gray-300' : 'bg-gray-100 text-gray-700'}`}
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                className="h-4 w-4 mr-1.5"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                              >
                                <path
                                  fillRule="evenodd"
                                  d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                                  clipRule="evenodd"
                                />
                              </svg>
                              {getLocalizedField(grant, 'country_region') ||
                                getLocalizedField(grant, 'Country/Region')}
                            </div>
                          </div>

                          {/* Focus Areas - Simplified */}
                          <div className="mb-4">
                            <p
                              className={`${darkMode ? 'text-gray-300' : 'text-gray-600'} leading-relaxed text-sm`}
                            >
                              <span
                                className={`font-medium ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}
                              >
                                {t('grants.focusArea')}:
                              </span>{' '}
                              {truncateText(
                                getLocalizedField(grant, 'focus_areas') ||
                                  getLocalizedField(grant, 'Focus Areas'),
                                150
                              )}
                            </p>
                          </div>

                          {/* Eligibility - Simplified */}
                          <div className="mb-4">
                            <p
                              className={`${darkMode ? 'text-gray-300' : 'text-gray-600'} leading-relaxed text-sm`}
                            >
                              <span
                                className={`font-medium ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}
                              >
                                {t('grants.eligibility')}:
                              </span>{' '}
                              {truncateText(
                                getLocalizedField(grant, 'eligibility_criteria') ||
                                  getLocalizedField(grant, 'Eligibility Criteria'),
                                200
                              )}
                            </p>
                          </div>

                          {/* Enhanced Details Section - Only show if grant is expanded */}
                          {isGrantExpanded(index) && (
                            <div className="space-y-4 mt-6">
                              {/* Detailed Description */}
                              {getLocalizedField(grant, 'detailed_description') && (
                                <div className="mb-4">
                                  <h3
                                    className={`font-semibold text-sm uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-700'} mb-2`}
                                  >
                                    Description
                                  </h3>
                                  <div
                                    className={`${darkMode ? 'bg-gray-750 border-gray-600' : 'bg-gray-50 border-gray-200'} p-4 rounded-lg border`}
                                  >
                                    <p
                                      className={`${darkMode ? 'text-gray-200' : 'text-gray-800'} leading-relaxed`}
                                    >
                                      {getLocalizedField(grant, 'detailed_description')}
                                    </p>
                                  </div>
                                </div>
                              )}

                              {/* Application Procedure */}
                              {getLocalizedField(grant, 'application_procedure') && (
                                <div className="mb-4">
                                  <h3
                                    className={`font-semibold text-sm uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-700'} mb-2`}
                                  >
                                    Application Procedure
                                  </h3>
                                  <div
                                    className={`${darkMode ? 'bg-purple-900/20 border-purple-500/30' : 'bg-purple-50 border-purple-200'} p-4 rounded-lg border`}
                                  >
                                    <p
                                      className={`${darkMode ? 'text-purple-200' : 'text-purple-800'} leading-relaxed whitespace-pre-line`}
                                    >
                                      {getLocalizedField(grant, 'application_procedure')}
                                    </p>
                                  </div>
                                </div>
                              )}

                              {/* Required Documents */}
                              {getLocalizedField(grant, 'required_documents') && (
                                <div className="mb-4">
                                  <h3
                                    className={`font-semibold text-sm uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-700'} mb-2`}
                                  >
                                    Required Documents
                                  </h3>
                                  <div
                                    className={`${darkMode ? 'bg-blue-900/20 border-blue-500/30' : 'bg-blue-50 border-blue-200'} p-4 rounded-lg border`}
                                  >
                                    <p
                                      className={`${darkMode ? 'text-blue-200' : 'text-blue-800'} leading-relaxed whitespace-pre-line`}
                                    >
                                      {getLocalizedField(grant, 'required_documents')}
                                    </p>
                                  </div>
                                </div>
                              )}

                              {/* Evaluation Criteria */}
                              {getLocalizedField(grant, 'evaluation_criteria') && (
                                <div className="mb-4">
                                  <h3
                                    className={`font-semibold text-sm uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-700'} mb-2`}
                                  >
                                    Evaluation Criteria
                                  </h3>
                                  <div
                                    className={`${darkMode ? 'bg-green-900/20 border-green-700/30' : 'bg-green-50 border-green-200'} p-4 rounded-lg border`}
                                  >
                                    <p
                                      className={`${darkMode ? 'text-green-200' : 'text-green-800'} leading-relaxed whitespace-pre-line`}
                                    >
                                      {getLocalizedField(grant, 'evaluation_criteria')}
                                    </p>
                                  </div>
                                </div>
                              )}

                              {/* Additional Requirements */}
                              {getLocalizedField(grant, 'additional_requirements') && (
                                <div className="mb-4">
                                  <h3
                                    className={`font-semibold text-sm uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-700'} mb-2`}
                                  >
                                    Additional Requirements
                                  </h3>
                                  <div
                                    className={`${darkMode ? 'bg-yellow-900/20 border-yellow-700/30' : 'bg-yellow-50 border-yellow-200'} p-4 rounded-lg border`}
                                  >
                                    <p
                                      className={`${darkMode ? 'text-yellow-200' : 'text-yellow-800'} leading-relaxed whitespace-pre-line`}
                                    >
                                      {getLocalizedField(grant, 'additional_requirements')}
                                    </p>
                                  </div>
                                </div>
                              )}

                              {/* Reporting Requirements */}
                              {getLocalizedField(grant, 'reporting_requirements') && (
                                <div className="mb-4">
                                  <h3
                                    className={`font-semibold text-sm uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-700'} mb-2`}
                                  >
                                    Reporting Requirements
                                  </h3>
                                  <div
                                    className={`${darkMode ? 'bg-orange-900/20 border-orange-700/30' : 'bg-orange-50 border-orange-200'} p-4 rounded-lg border`}
                                  >
                                    <p
                                      className={`${darkMode ? 'text-orange-200' : 'text-orange-800'} leading-relaxed whitespace-pre-line`}
                                    >
                                      {getLocalizedField(grant, 'reporting_requirements')}
                                    </p>
                                  </div>
                                </div>
                              )}

                              {/* Contact Information */}
                              {(grant.contact_email ||
                                grant.contact_person ||
                                grant.contact_phone) && (
                                <div className="mb-4">
                                  <h3
                                    className={`font-semibold text-sm uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-700'} mb-2`}
                                  >
                                    Contact Information
                                  </h3>
                                  <div
                                    className={`${darkMode ? 'bg-indigo-900/20 border-indigo-500/30' : 'bg-indigo-50 border-indigo-200'} p-4 rounded-lg border`}
                                  >
                                    <div className="space-y-2">
                                      {grant.contact_person && (
                                        <div className="flex items-center">
                                          <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            className={`h-4 w-4 mr-2 ${darkMode ? 'text-indigo-400' : 'text-indigo-600'}`}
                                            viewBox="0 0 20 20"
                                            fill="currentColor"
                                          >
                                            <path
                                              fillRule="evenodd"
                                              d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                                              clipRule="evenodd"
                                            />
                                          </svg>
                                          <span
                                            className={`${darkMode ? 'text-indigo-200' : 'text-indigo-800'} font-medium`}
                                          >
                                            {grant.contact_person}
                                          </span>
                                        </div>
                                      )}
                                      {grant.contact_email && (
                                        <div className="flex items-center">
                                          <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            className={`h-4 w-4 mr-2 ${darkMode ? 'text-indigo-400' : 'text-indigo-600'}`}
                                            viewBox="0 0 20 20"
                                            fill="currentColor"
                                          >
                                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                          </svg>
                                          <a
                                            href={`mailto:${grant.contact_email}`}
                                            className={`${darkMode ? 'text-indigo-300 hover:text-indigo-200' : 'text-indigo-700 hover:text-indigo-800'} hover:underline`}
                                          >
                                            {grant.contact_email}
                                          </a>
                                        </div>
                                      )}
                                      {grant.contact_phone && (
                                        <div className="flex items-center">
                                          <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            className={`h-4 w-4 mr-2 ${darkMode ? 'text-indigo-400' : 'text-indigo-600'}`}
                                            viewBox="0 0 20 20"
                                            fill="currentColor"
                                          >
                                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                                          </svg>
                                          <span
                                            className={`${darkMode ? 'text-indigo-200' : 'text-indigo-800'}`}
                                          >
                                            {grant.contact_phone}
                                          </span>
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          )}

                          {/* Action Section - Simplified */}
                          <div className="flex justify-end items-center gap-3 mt-6">
                            <button
                              onClick={() => toggleGrantExpansion(index)}
                              aria-expanded={isGrantExpanded(index)}
                              aria-controls={`grant-details-${index}`}
                              aria-label={`${isGrantExpanded(index) ? 'Hide' : 'Show'} details for ${getLocalizedField(grant, 'Grant Name') || grant.grant_name || grant['Grant Name']}`}
                              className={`px-4 py-2 text-sm font-medium transition-all duration-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 ${
                                darkMode
                                  ? 'text-gray-300 hover:text-gray-100 hover:bg-gray-700/50 focus:ring-blue-500'
                                  : 'text-gray-700 hover:text-gray-900 hover:bg-gray-100 focus:ring-blue-600'
                              }`}
                            >
                              {isGrantExpanded(index) ? 'Show less' : 'View details'}
                            </button>
                            {(grant.website_link || grant['Website Link']) && (
                              <a
                                href={(() => {
                                  // Extract URL from the Website Link field which may contain label:url format
                                  const link = grant.website_link || grant['Website Link'];
                                  const urlPart = link.includes(':http')
                                    ? link.substring(link.indexOf(':http') + 1)
                                    : link;
                                  return urlPart.startsWith('http')
                                    ? urlPart
                                    : `https://${urlPart}`;
                                })()}
                                target="_blank"
                                rel="noopener noreferrer"
                                aria-label={`Apply for ${getLocalizedField(grant, 'Grant Name') || grant.grant_name || grant['Grant Name']} (opens in new tab)`}
                                className={`flex items-center rounded-xl py-2.5 px-5 font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 ${
                                  darkMode
                                    ? 'bg-blue-600 hover:bg-blue-500 text-white focus:ring-blue-500'
                                    : 'bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-600'
                                } shadow-sm hover:shadow-md`}
                              >
                                {t('grants.applyNow')}
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  className="h-4 w-4 ml-2"
                                  viewBox="0 0 20 20"
                                  fill="currentColor"
                                >
                                  <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                                  <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                                </svg>
                              </a>
                            )}
                          </div>
                        </div>
                      </article>
                    );
                  })}
                </div>
              )}
            </>
          )}
        </div>
      </div>

      {/* AI Chat Widget */}
      <GrantsChatWidget />

      {/* Back to Top Button */}
      <BackToTop />

      {/* Comparison Modal */}
      <GrantComparisonModal
        grants={selectedForComparison}
        isOpen={showComparisonModal}
        onClose={() => setShowComparisonModal(false)}
      />
    </main>
    </>
  );
};

export default GrantsPage;



================================================================================
FILE: client/src/pages/GrantsPageOptimized.js
SIZE: 28564 bytes
================================================================================

import React, { useState, useEffect, useCallback, useContext, useMemo, memo } from 'react';
import { useTranslation } from 'react-i18next';
import i18n from 'i18next';
import { useSearchParams } from 'react-router-dom';
import axios from 'axios';
import { format } from 'date-fns';
import { ThemeContext } from '../context/ThemeContext';
import GrantsChatWidget from '../components/GrantsChatWidget';
import { useDebounce } from '../utils/debounce';
import { cachedFetch } from '../utils/cache';
import { LazyImage } from '../utils/lazyLoad';
import { useInfiniteScroll } from '../hooks/useInfiniteScroll';

// Items per page for pagination
const ITEMS_PER_PAGE = 20;

// Memoized grant card component
const GrantCard = memo(({ 
  grant, 
  index, 
  darkMode, 
  isExpanded, 
  onToggleExpand,
  getLocalizedField,
  getOrganizationLogo,
  formatDate,
  calculateDaysRemaining,
  t
}) => {
  const deadline = grant.application_deadline || grant['Application Deadline'];
  const daysDiff = calculateDaysRemaining(deadline);
  const isExpired = daysDiff !== null && daysDiff < 0;
  const isUrgent = daysDiff !== null && daysDiff >= 0 && daysDiff <= 7;
  
  const logoUrl = getOrganizationLogo(
    grant.funding_organization || grant['Funding Organization']
  );

  return (
    <div
      className={`rounded-2xl overflow-hidden ${
        isExpired
          ? darkMode
            ? 'bg-gray-800/50 border border-red-700/30 opacity-60'
            : 'bg-gray-50 border border-red-200 opacity-75'
          : darkMode
            ? 'bg-gray-800/50 backdrop-blur border border-gray-700/50 hover:shadow-xl hover:border-gray-600/50'
            : 'bg-white/80 backdrop-blur border border-gray-200/50 hover:shadow-xl'
      } transition-all duration-300`}
    >
      <div className="p-6">
        <div className="flex justify-between items-start mb-4">
          <div className="flex items-start space-x-4 flex-1">
            {logoUrl && (
              <div
                className={`flex-shrink-0 w-14 h-14 rounded-xl overflow-hidden ${darkMode ? 'bg-gray-700/50' : 'bg-gray-100'} p-2`}
              >
                <LazyImage
                  src={logoUrl}
                  alt={`${grant.funding_organization || grant['Funding Organization']} logo`}
                  className="w-full h-full object-contain"
                  onError={(e) => {
                    e.target.style.display = 'none';
                  }}
                />
              </div>
            )}
            <div className="flex-1">
              <h2
                className={`text-xl font-semibold mb-1 ${darkMode ? 'text-white' : 'text-gray-900'}`}
              >
                {getLocalizedField(grant, 'grant_name') ||
                  getLocalizedField(grant, 'Grant Name')}
              </h2>
              <p
                className={`text-base ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}
              >
                {getLocalizedField(grant, 'funding_organization') ||
                  getLocalizedField(grant, 'Funding Organization')}
              </p>
            </div>
          </div>
          {/* Status Badge */}
          <div
            className={`ml-4 px-3 py-1 rounded-full text-xs font-semibold ${
              isExpired
                ? darkMode
                  ? 'bg-red-900/20 text-red-400'
                  : 'bg-red-100 text-red-600'
                : isUrgent
                  ? darkMode
                    ? 'bg-orange-900/20 text-orange-400'
                    : 'bg-orange-100 text-orange-600'
                  : darkMode
                    ? 'bg-green-900/20 text-green-400'
                    : 'bg-green-100 text-green-600'
            }`}
          >
            {isExpired ? 'EXPIRED' : isUrgent ? `${daysDiff} DAYS LEFT` : 'OPEN'}
          </div>
        </div>
        
        {/* Key Information Pills */}
        <div className="flex flex-wrap gap-2 mb-4">
          <div
            className={`inline-flex items-center px-3 py-1.5 rounded-full text-sm ${darkMode ? 'bg-gray-700/50 text-gray-300' : 'bg-gray-100 text-gray-700'}`}
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              className="h-4 w-4 mr-1.5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
              <path
                fillRule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z"
                clipRule="evenodd"
              />
            </svg>
            {getLocalizedField(grant, 'grant_amount') ||
              getLocalizedField(grant, 'Grant Amount') ||
              'Amount varies'}
          </div>
          <div
            className={`inline-flex items-center px-3 py-1.5 rounded-full text-sm ${darkMode ? 'bg-gray-700/50 text-gray-300' : 'bg-gray-100 text-gray-700'}`}
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              className="h-4 w-4 mr-1.5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fillRule="evenodd"
                d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                clipRule="evenodd"
              />
            </svg>
            {formatDate(deadline)}
          </div>
        </div>

        {/* Action Section */}
        <div className="flex justify-end items-center gap-3 mt-4">
          <button
            onClick={() => onToggleExpand(index)}
            className={`px-4 py-2 text-sm font-medium transition-all duration-200 rounded-lg ${
              darkMode
                ? 'text-gray-300 hover:text-gray-100 hover:bg-gray-700/50'
                : 'text-gray-700 hover:text-gray-900 hover:bg-gray-100'
            }`}
          >
            {isExpanded ? 'Show less' : 'View details'}
          </button>
          {(grant.website_link || grant['Website Link']) && (
            <a
              href={(() => {
                const link = grant.website_link || grant['Website Link'];
                const urlPart = link.includes(':http')
                  ? link.substring(link.indexOf(':http') + 1)
                  : link;
                return urlPart.startsWith('http')
                  ? urlPart
                  : `https://${urlPart}`;
              })()}
              target="_blank"
              rel="noopener noreferrer"
              className={`flex items-center rounded-xl py-2.5 px-5 font-medium transition-all duration-200 ${
                darkMode
                  ? 'bg-blue-600 hover:bg-blue-500 text-white'
                  : 'bg-blue-600 hover:bg-blue-700 text-white'
              } shadow-sm hover:shadow-md`}
            >
              {t('grants.applyNow')}
              <svg
                xmlns="http://www.w3.org/2000/svg"
                className="h-4 w-4 ml-2"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
              </svg>
            </a>
          )}
        </div>
      </div>
    </div>
  );
});

GrantCard.displayName = 'GrantCard';

const GrantsPageOptimized = () => {
  const { t } = useTranslation();
  const [searchParams, setSearchParams] = useSearchParams();
  const { darkMode } = useContext(ThemeContext);
  const [allGrants, setAllGrants] = useState([]);
  const [displayedGrants, setDisplayedGrants] = useState([]);
  const [filteredGrants, setFilteredGrants] = useState([]);
  const [filters, setFilters] = useState({
    organizations: [],
    focusAreas: [],
  });
  const [loading, setLoading] = useState(true);
  const [expandedGrants, setExpandedGrants] = useState(new Set());
  const [organizationLogos, setOrganizationLogos] = useState({});
  
  // Form state with debouncing
  const [searchTerm, setSearchTerm] = useState(searchParams.get('query') || '');
  const debouncedSearchTerm = useDebounce(searchTerm, 300);
  const [selectedOrganization, setSelectedOrganization] = useState('');
  const [selectedFocusArea, setSelectedFocusArea] = useState('');
  const [sortBy, setSortBy] = useState('deadlineAsc');
  const [showExpired, setShowExpired] = useState(false);

  // Memoized helper functions
  const getLocalizedField = useCallback((grant, fieldName) => {
    const isUkrainian = i18n.language === 'uk';
    const fieldMap = {
      grant_name: isUkrainian ? 'grant_name_uk' : 'grant_name',
      'Grant Name': isUkrainian ? 'grant_name_uk' : 'grant_name',
      funding_organization: isUkrainian ? 'funding_organization_uk' : 'funding_organization',
      'Funding Organization': isUkrainian ? 'funding_organization_uk' : 'funding_organization',
      // ... other fields
    };
    const actualFieldName = fieldMap[fieldName] || fieldName;
    return grant[actualFieldName] || grant[fieldName] || '';
  }, []);

  const formatDate = useCallback((dateString) => {
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      return format(date, 'MMMM d, yyyy');
    } catch (error) {
      return dateString;
    }
  }, []);

  const calculateDaysRemaining = useCallback((deadlineString) => {
    if (!deadlineString) return null;
    const today = new Date();
    const deadline = new Date(deadlineString);
    if (isNaN(deadline.getTime())) return null;
    return Math.round((deadline - today) / (1000 * 60 * 60 * 24));
  }, []);

  const getOrganizationLogo = useCallback((organizationName) => {
    if (!organizationName) return null;
    const slug = organizationName
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, '')
      .replace(/\s+/g, '-')
      .replace(/^-+|-+$/g, '');
    const logoData = organizationLogos[slug];
    return logoData?.hasLogo ? logoData.logo : null;
  }, [organizationLogos]);

  // Sort grants function
  const sortGrants = useCallback((grantsToSort, sortCriteria) => {
    const sorted = [...grantsToSort];
    switch (sortCriteria) {
      case 'nameAsc':
        return sorted.sort((a, b) =>
          (a['Grant Name'] || '').localeCompare(b['Grant Name'] || '')
        );
      case 'nameDesc':
        return sorted.sort((a, b) =>
          (b['Grant Name'] || '').localeCompare(a['Grant Name'] || '')
        );
      case 'deadlineAsc':
        return sorted.sort((a, b) => {
          const dateA = new Date(a['Application Deadline'] || '9999-12-31');
          const dateB = new Date(b['Application Deadline'] || '9999-12-31');
          return dateA - dateB;
        });
      case 'deadlineDesc':
        return sorted.sort((a, b) => {
          const dateA = new Date(a['Application Deadline'] || '0000-01-01');
          const dateB = new Date(b['Application Deadline'] || '0000-01-01');
          return dateB - dateA;
        });
      default:
        return sorted;
    }
  }, []);

  // Apply filters function
  const applyFilters = useCallback(() => {
    let filtered = [...allGrants];

    // Text search with debounced term
    if (debouncedSearchTerm) {
      const term = debouncedSearchTerm.toLowerCase();
      filtered = filtered.filter(grant => {
        const grantName = grant.grant_name || grant['Grant Name'] || '';
        const organization = grant.funding_organization || grant['Funding Organization'] || '';
        const focusAreas = grant.focus_areas || grant['Focus Areas'] || '';
        const eligibility = grant.eligibility_criteria || grant['Eligibility Criteria'] || '';

        return (
          grantName.toLowerCase().includes(term) ||
          organization.toLowerCase().includes(term) ||
          focusAreas.toLowerCase().includes(term) ||
          eligibility.toLowerCase().includes(term)
        );
      });
    }

    // Organization filter
    if (selectedOrganization) {
      filtered = filtered.filter(grant => {
        const organization = grant.funding_organization || grant['Funding Organization'];
        return organization === selectedOrganization;
      });
    }

    // Focus area filter
    if (selectedFocusArea) {
      filtered = filtered.filter(grant => {
        const focusAreas = grant.focus_areas || grant['Focus Areas'] || '';
        return focusAreas.toLowerCase().includes(selectedFocusArea.toLowerCase());
      });
    }

    // Filter out expired grants unless showExpired is true
    if (!showExpired) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      filtered = filtered.filter(grant => {
        const deadlineField = grant.application_deadline || grant['Application Deadline'];
        if (!deadlineField) return true;

        const deadline = new Date(deadlineField);
        if (isNaN(deadline.getTime())) return true;

        return deadline >= today;
      });
    }

    // Apply sorting
    filtered = sortGrants(filtered, sortBy);

    setFilteredGrants(filtered);
    // Reset displayed grants for pagination
    setDisplayedGrants(filtered.slice(0, ITEMS_PER_PAGE));
  }, [
    allGrants,
    debouncedSearchTerm,
    selectedOrganization,
    selectedFocusArea,
    sortBy,
    showExpired,
    sortGrants,
  ]);

  // Infinite scroll handler
  const fetchMoreGrants = useCallback(async (page) => {
    const startIndex = (page - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;
    const newGrants = filteredGrants.slice(startIndex, endIndex);
    
    if (newGrants.length > 0) {
      setDisplayedGrants(prev => [...prev, ...newGrants]);
    }
  }, [filteredGrants]);

  const hasMore = useMemo(() => 
    displayedGrants.length < filteredGrants.length,
    [displayedGrants.length, filteredGrants.length]
  );

  const { sentinelRef, loading: loadingMore } = useInfiniteScroll(
    fetchMoreGrants,
    hasMore,
    { threshold: 200, initialLoad: false }
  );

  // Initial data fetch
  useEffect(() => {
    const fetchData = async () => {
      try {
        // Load organization logos
        try {
          const logosResponse = await cachedFetch('/data/organization-logos.json');
          setOrganizationLogos(logosResponse.data);
        } catch (logosError) {
          console.log('Organization logos file not found');
        }

        let grantsData;
        let filtersData;

        try {
          // Try API first with caching
          const grantsResponse = await cachedFetch('/.netlify/functions/grants');
          grantsData = grantsResponse.data;

          const filtersResponse = await cachedFetch('/.netlify/functions/grants/filters');
          filtersData = filtersResponse.data;
        } catch (apiError) {
          // Fallback to static JSON
          const currentLanguage = i18n.language;
          const grantsJsonPath =
            currentLanguage === 'uk' ? '/data/grants_uk.json' : '/data/grants.json';
          const filtersJsonPath =
            currentLanguage === 'uk' ? '/data/filters_uk.json' : '/data/filters.json';

          const grantsResponse = await cachedFetch(grantsJsonPath);
          grantsData = grantsResponse.data;

          const filtersResponse = await cachedFetch(filtersJsonPath);
          filtersData = filtersResponse.data;
        }

        setAllGrants(grantsData);
        setFilters(filtersData);
        setLoading(false);
      } catch (error) {
        console.error('Error fetching data:', error);
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  // Apply filters when data is loaded or filters change
  useEffect(() => {
    if (!loading) {
      applyFilters();
    }
  }, [loading, applyFilters]);

  const toggleGrantExpansion = useCallback((index) => {
    setExpandedGrants(prev => {
      const newExpanded = new Set(prev);
      if (newExpanded.has(index)) {
        newExpanded.delete(index);
      } else {
        newExpanded.add(index);
      }
      return newExpanded;
    });
  }, []);

  const resetFilters = () => {
    setSearchTerm('');
    setSelectedOrganization('');
    setSelectedFocusArea('');
    setSortBy('deadlineAsc');
    setShowExpired(false);
    setSearchParams({});
  };

  return (
    <div
      className={`grants-page ${darkMode ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-800'} min-h-screen transition-colors duration-300 py-12 px-4 sm:px-6 lg:px-8`}
    >
      {/* Header Section */}
      <div className="max-w-7xl mx-auto mb-8">
        <h1
          className={`text-4xl md:text-5xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'} transition-colors duration-300`}
        >
          {t('grants.search')}
        </h1>
        <p className={`text-lg ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
          {t('grants.subtitle', 'Find the perfect grant opportunity for your organization')}
        </p>
      </div>

      {/* Simplified Filter Bar */}
      <div className="max-w-7xl mx-auto mb-12">
        <div
          className={`rounded-2xl shadow-sm p-6 ${darkMode ? 'bg-gray-800/50 backdrop-blur border border-gray-700/50' : 'bg-white/80 backdrop-blur border border-gray-200/50'} transition-all duration-300`}
        >
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {/* Search */}
            <div className="relative">
              <input
                type="text"
                className={`w-full pl-10 pr-4 py-3.5 rounded-xl border ${darkMode ? 'bg-gray-700/50 border-gray-600 text-white placeholder-gray-400' : 'bg-gray-50 border-gray-300 text-gray-900 placeholder-gray-500'} focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-base`}
                placeholder={t('grants.searchPlaceholder')}
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
              />
              <svg
                xmlns="http://www.w3.org/2000/svg"
                className={`absolute left-3 top-3.5 h-5 w-5 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fillRule="evenodd"
                  d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                  clipRule="evenodd"
                />
              </svg>
            </div>

            {/* Organization Filter */}
            <select
              className={`w-full px-4 py-3.5 rounded-xl border ${darkMode ? 'bg-gray-700/50 border-gray-600 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-base appearance-none cursor-pointer`}
              value={selectedOrganization}
              onChange={e => setSelectedOrganization(e.target.value)}
            >
              <option value="">{t('grants.allOrganizations', 'All Organizations')}</option>
              {filters.organizations.map((org, index) => (
                <option key={index} value={org}>
                  {org}
                </option>
              ))}
            </select>

            {/* Focus Area Filter */}
            <select
              className={`w-full px-4 py-3.5 rounded-xl border ${darkMode ? 'bg-gray-700/50 border-gray-600 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-base appearance-none cursor-pointer`}
              value={selectedFocusArea}
              onChange={e => setSelectedFocusArea(e.target.value)}
            >
              <option value="">{t('grants.allFocusAreas', 'All Focus Areas')}</option>
              {filters.focusAreas.map((area, index) => (
                <option key={index} value={area}>
                  {area}
                </option>
              ))}
            </select>

            {/* Clear Filters Button */}
            <button
              onClick={resetFilters}
              className={`flex items-center justify-center px-6 py-3.5 rounded-xl font-medium transition-all duration-200 ${
                darkMode
                  ? 'bg-gray-700/50 text-gray-300 hover:bg-gray-600/50'
                  : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
              } ${!searchTerm && !selectedOrganization && !selectedFocusArea ? 'opacity-50 cursor-not-allowed' : ''}`}
              disabled={!searchTerm && !selectedOrganization && !selectedFocusArea}
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                className="h-5 w-5 mr-2"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fillRule="evenodd"
                  d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                  clipRule="evenodd"
                />
              </svg>
              {t('grants.clearFilters', 'Clear')}
            </button>
          </div>
        </div>
      </div>

      {/* Main Content Area */}
      <div className="max-w-7xl mx-auto">
        {/* Results Header with Sorting */}
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
          <div className="flex items-center gap-6">
            <div className={`text-lg font-medium ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>
              {filteredGrants.length} {t('grants.resultsFound', 'grants found')}
              {displayedGrants.length < filteredGrants.length && 
                ` (showing ${displayedGrants.length})`
              }
            </div>
            <label
              className={`flex items-center gap-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'} cursor-pointer`}
            >
              <input
                type="checkbox"
                className="rounded text-blue-600 focus:ring-blue-500 cursor-pointer"
                checked={showExpired}
                onChange={e => setShowExpired(e.target.checked)}
              />
              <span className="text-sm">{t('grants.showExpired', 'Show expired')}</span>
            </label>
          </div>

          <div className="flex items-center gap-2">
            <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
              {t('grants.sortBy', 'Sort by')}:
            </span>
            <select
              className={`px-4 py-2.5 rounded-xl border text-sm ${darkMode ? 'bg-gray-800/50 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-900'} focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none cursor-pointer pr-10`}
              value={sortBy}
              onChange={e => setSortBy(e.target.value)}
            >
              <option value="deadlineAsc">
                {t('grants.sortOptions.deadlineAsc', 'Deadline (Soonest)')}
              </option>
              <option value="deadlineDesc">
                {t('grants.sortOptions.deadlineDesc', 'Deadline (Latest)')}
              </option>
              <option value="nameAsc">{t('grants.sortOptions.nameAsc', 'Name (A-Z)')}</option>
              <option value="nameDesc">{t('grants.sortOptions.nameDesc', 'Name (Z-A)')}</option>
            </select>
          </div>
        </div>

        {/* Grants List */}
        <div className="mt-8">
          {loading ? (
            <div className="flex justify-center py-24">
              <div className="animate-pulse flex space-x-1">
                <div
                  className={`w-2 h-8 ${darkMode ? 'bg-gray-400' : 'bg-gray-600'} rounded-full animate-bounce`}
                  style={{ animationDelay: '0s' }}
                ></div>
                <div
                  className={`w-2 h-8 ${darkMode ? 'bg-gray-400' : 'bg-gray-600'} rounded-full animate-bounce`}
                  style={{ animationDelay: '0.1s' }}
                ></div>
                <div
                  className={`w-2 h-8 ${darkMode ? 'bg-gray-400' : 'bg-gray-600'} rounded-full animate-bounce`}
                  style={{ animationDelay: '0.2s' }}
                ></div>
              </div>
            </div>
          ) : (
            <>
              {filteredGrants.length === 0 ? (
                <div
                  className={`p-12 rounded-2xl text-center ${darkMode ? 'bg-gray-800/50 backdrop-blur' : 'bg-gray-50'}`}
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    className={`h-12 w-12 mx-auto mb-4 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`}
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={1.5}
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    />
                  </svg>
                  <p
                    className={`text-lg font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
                  >
                    {t('grants.noResults')}
                  </p>
                  <p className={`mt-2 text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                    Try adjusting your search criteria
                  </p>
                </div>
              ) : (
                <div className="space-y-4">
                  {displayedGrants.map((grant, index) => (
                    <GrantCard
                      key={`${grant.id || index}-${grant['Grant Name']}`}
                      grant={grant}
                      index={index}
                      darkMode={darkMode}
                      isExpanded={expandedGrants.has(index)}
                      onToggleExpand={toggleGrantExpansion}
                      getLocalizedField={getLocalizedField}
                      getOrganizationLogo={getOrganizationLogo}
                      formatDate={formatDate}
                      calculateDaysRemaining={calculateDaysRemaining}
                      t={t}
                    />
                  ))}
                  
                  {/* Infinite scroll sentinel */}
                  {hasMore && (
                    <div ref={sentinelRef} className="h-10 flex items-center justify-center">
                      {loadingMore && (
                        <div className="flex space-x-1">
                          <div
                            className={`w-2 h-6 ${darkMode ? 'bg-gray-400' : 'bg-gray-600'} rounded-full animate-bounce`}
                            style={{ animationDelay: '0s' }}
                          ></div>
                          <div
                            className={`w-2 h-6 ${darkMode ? 'bg-gray-400' : 'bg-gray-600'} rounded-full animate-bounce`}
                            style={{ animationDelay: '0.1s' }}
                          ></div>
                          <div
                            className={`w-2 h-6 ${darkMode ? 'bg-gray-400' : 'bg-gray-600'} rounded-full animate-bounce`}
                            style={{ animationDelay: '0.2s' }}
                          ></div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}
            </>
          )}
        </div>
      </div>

      {/* AI Chat Widget */}
      <GrantsChatWidget />
    </div>
  );
};

export default GrantsPageOptimized;


================================================================================
FILE: client/src/pages/HomePage.js
SIZE: 22548 bytes
================================================================================

import React, { useState, useEffect, useContext } from 'react';
import { Link } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import i18n from 'i18next';
import axios from 'axios';
import { format } from 'date-fns';
import { ThemeContext } from '../context/ThemeContext';
import VideoHero from '../components/VideoHero';
import SEOHead from '../components/SEOHead';
import StructuredData from '../components/StructuredData';

const HomePage = () => {
  const { t } = useTranslation();
  const { darkMode } = useContext(ThemeContext);
  const [featuredGrants, setFeaturedGrants] = useState([]);
  const [upcomingGrants, setUpcomingGrants] = useState([]);
  const [loading, setLoading] = useState(true);

  // Updated statistics based on current database
  const stats = {
    totalGrants: 136,
    upcomingDeadlines: 52, // Active grants with 2025 deadlines
    totalFunding: 75, // â‚¬75M+ with new grants
  };

  useEffect(() => {
    const fetchData = async () => {
      try {
        let grants;

        try {
          // First try to load from API endpoint
          const response = await axios.get('/.netlify/functions/grants');
          grants = response.data;
          console.log('HomePage: Loaded grants from API:', grants.length);
        } catch (apiError) {
          // Fallback to static JSON file with language support
          const currentLanguage = i18n.language;
          const grantsJsonPath =
            currentLanguage === 'uk' ? '/data/grants_uk.json' : '/data/grants.json';

          try {
            const staticResponse = await axios.get(grantsJsonPath);
            grants = staticResponse.data;
          } catch (grantsError) {
            // If language-specific file fails, fallback to English
            const staticResponse = await axios.get('/data/grants.json');
            grants = staticResponse.data;
          }
        }

        // Get featured grants (select specific high-value ones using correct field names)
        const featuredNames = [
          'EU Civil Society Organizations Call 2025',
          'German Marshall Fund (GMF) Ukraine: Relief, Resilience, Recovery (U3R) Program',
          'National Endowment for Democracy (NED) Regular Grants',
          'British Council - Connections Through Culture Grants 2025',
        ];

        console.log('Total grants loaded:', grants.length);
        console.log('Sample grant fields:', grants[0] ? Object.keys(grants[0]) : 'No grants');

        // Check both field name formats for compatibility
        const featured = grants.filter(g => 
          featuredNames.includes(g.grant_name) || featuredNames.includes(g['Grant Name'])
        );

        console.log('Featured grants found by name:', featured.length);

        // If not enough featured, add high-value ones
        if (featured.length < 3) {
          const remaining = grants
            .filter(g => !featured.includes(g))
            .filter(g => {
              // Prioritize grants with higher amounts or from major organizations
              const amount = g.grant_amount || g['Grant Amount'] || '';
              const org = g.funding_organization || g['Funding Organization'] || '';
              return amount.includes('â‚¬') && (
                amount.includes('million') || 
                org.includes('European Union') ||
                org.includes('World Bank') ||
                org.includes('United Nations')
              );
            })
            .slice(0, 3 - featured.length);
          featured.push(...remaining);
          console.log('Added high-value grants:', remaining.length);
        }

        // Final fallback to any grants if still not enough
        if (featured.length < 3) {
          const anyRemaining = grants
            .filter(g => !featured.includes(g))
            .slice(0, 3 - featured.length);
          featured.push(...anyRemaining);
          console.log('Added fallback grants:', anyRemaining.length);
        }

        // Absolute fallback - ensure we always have 3 grants
        if (featured.length === 0 && grants.length > 0) {
          featured.push(...grants.slice(0, 3));
          console.log('Emergency fallback: using first 3 grants');
        }

        console.log('Final featured grants count:', featured.length);
        console.log('Featured grants:', featured.map(g => g.grant_name || g['Grant Name'] || 'Unknown'));

        console.log('HomePage: Setting featured grants:', featured.length, featured.map(g => g.grant_name || g['Grant Name']));
        
        // Ensure we always have some featured grants
        if (featured.length === 0) {
          console.log('HomePage: No featured grants found, using first 3 grants as fallback');
          const fallbackGrants = grants.slice(0, 3);
          setFeaturedGrants(fallbackGrants);
        } else {
          setFeaturedGrants(featured);
        }

        // Get grants with upcoming deadlines (check both field name formats)
        const today = new Date();
        const upcomingDeadlineGrants = grants
          .filter(grant => {
            const deadline = grant.application_deadline || grant.deadline || grant['Application Deadline'];
            if (!deadline) return false;

            // Check for 2025-2026 dates or rolling deadlines
            if (deadline.includes('2025') || deadline.includes('2026') || deadline.toLowerCase().includes('rolling')) {
              try {
                // For actual dates, check if they're in the future
                const deadlineDate = new Date(deadline);
                if (!isNaN(deadlineDate.getTime())) {
                  return deadlineDate > today;
                } else {
                  // Include rolling deadlines and text-based deadlines
                  return true;
                }
              } catch (e) {
                return true; // Include if it mentions future years
              }
            }
            return false;
          })
          .slice(0, 5);


        setUpcomingGrants(upcomingDeadlineGrants);
        setLoading(false);
      } catch (error) {
        console.error('Error fetching data:', error);
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  const formatDate = dateString => {
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      return format(date, 'MMMM d, yyyy');
    } catch (error) {
      return dateString;
    }
  };

  const formatCurrency = amount => {
    if (!amount) return 'Variable';

    // Handle range
    if (amount.includes('-')) {
      const parts = amount.split('-');
      return `${parts[0].trim()} - ${parts[1].trim()}`;
    }

    return amount;
  };

  return (
    <>
      <SEOHead 
        title={t('home.pageTitle', 'Ukraine Civil Society Grants - Find Funding Opportunities')}
        description={t('home.metaDescription', 'Discover 136 grants worth â‚¬75M+ for civil society organizations in Ukraine. Find international funding opportunities, EU grants, and humanitarian aid.')}
        keywords={t('home.keywords', 'ukraine grants, civil society funding, NGO grants ukraine, EU funding ukraine, humanitarian grants, international aid ukraine')}
      />
      <StructuredData type="website" />
      <StructuredData type="organization" />
      
      <main id="main-content" className={`home-page min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
      {/* Video Hero Section */}
      <VideoHero
        darkMode={darkMode}
        title={{
          line1: t('home.hero.title1', 'Civil Society'),
          line2: t('home.hero.title2', 'Grants Platform'),
        }}
        subtitle={t(
          'home.hero.subtitle',
          'Connecting Ukrainian civil society organizations with â‚¬75M+ in funding opportunities'
        )}
        primaryCTA={{
          text: t('home.hero.exploreGrants', 'Explore Grants'),
          link: '/grants',
        }}
        secondaryCTA={{
          text: t('home.hero.learnMore', 'Learn More'),
          link: '/about',
        }}
      />

      {/* Original content continues below - remove the old hero section */}
      {/* Stats Section */}
      <section className={`relative py-16 ${darkMode ? 'bg-gray-800' : 'bg-white'}`} aria-label="Platform statistics">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center mb-12">
            <h2
              className={`text-3xl md:text-4xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}
            >
              {t('home.stats.title', 'Making Impact Through Funding')}
            </h2>
          </div>
          <div className="stats-grid grid grid-cols-1 md:grid-cols-3 gap-8">
            <div
              className={`text-center p-8 rounded-2xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}
            >
              <div
                className={`text-4xl md:text-5xl font-bold ${darkMode ? 'text-blue-400' : 'text-blue-600'} mb-2`}
              >
                {stats.totalGrants}
              </div>
              <div className={`text-lg ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                {t('home.stats.totalGrants', 'Active Grants')}
              </div>
            </div>
            <div
              className={`text-center p-8 rounded-2xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}
            >
              <div
                className={`text-4xl md:text-5xl font-bold ${darkMode ? 'text-green-400' : 'text-green-600'} mb-2`}
              >
                â‚¬{stats.totalFunding}M+
              </div>
              <div className={`text-lg ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                {t('home.stats.totalFunding', 'Total Funding Available')}
              </div>
            </div>
            <div
              className={`text-center p-8 rounded-2xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}
            >
              <div
                className={`text-4xl md:text-5xl font-bold ${darkMode ? 'text-purple-400' : 'text-purple-600'} mb-2`}
              >
                {stats.upcomingDeadlines}
              </div>
              <div className={`text-lg ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                {t('home.stats.upcomingDeadlines', 'Upcoming Deadlines')}
              </div>
            </div>
          </div>
        </div>
      </section>


      {/* Featured Grants - Minimal cards */}
      <section className="py-20" aria-label="Featured grant opportunities">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center mb-12">
            <h2 className={`text-4xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
              Featured Opportunities
            </h2>
            <p className={`text-xl ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
              High-impact funding for transformative projects
            </p>
          </div>

          {loading ? (
            <div className="flex justify-center py-12">
              <div className="animate-pulse flex space-x-1">
                <div
                  className={`w-2 h-8 ${darkMode ? 'bg-gray-400' : 'bg-gray-600'} rounded-full animate-bounce`}
                  style={{ animationDelay: '0s' }}
                ></div>
                <div
                  className={`w-2 h-8 ${darkMode ? 'bg-gray-400' : 'bg-gray-600'} rounded-full animate-bounce`}
                  style={{ animationDelay: '0.1s' }}
                ></div>
                <div
                  className={`w-2 h-8 ${darkMode ? 'bg-gray-400' : 'bg-gray-600'} rounded-full animate-bounce`}
                  style={{ animationDelay: '0.2s' }}
                ></div>
              </div>
            </div>
          ) : (
            <div className="featured-grants-grid grid grid-cols-1 md:grid-cols-3 gap-8">
              {featuredGrants.map((grant, index) => {
                console.log(`Rendering grant ${index}:`, grant?.grant_name || grant?.['Grant Name'] || 'UNDEFINED', grant?.funding_organization || grant?.['Funding Organization'] || 'UNDEFINED');
                
                // Safety check to ensure grant exists
                if (!grant) {
                  console.log(`Grant ${index} is null/undefined, skipping`);
                  return null;
                }
                
                return (
                <div
                  key={index}
                  className={`group relative rounded-3xl overflow-hidden ${
                    darkMode ? 'bg-gray-800' : 'bg-white'
                  } shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1`}
                >
                  {/* Colored accent top */}
                  <div
                    className={`h-2 ${
                      index === 0
                        ? 'bg-gradient-to-r from-blue-500 to-blue-600'
                        : index === 1
                          ? 'bg-gradient-to-r from-purple-500 to-purple-600'
                          : 'bg-gradient-to-r from-green-500 to-green-600'
                    }`}
                  ></div>

                  <div className="p-8">
                    <div className="mb-6">
                      <p
                        className={`text-sm font-medium mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}
                      >
                        {grant.funding_organization || grant['Funding Organization']}
                      </p>
                      <h3
                        className={`text-xl font-bold mb-3 line-clamp-2 ${darkMode ? 'text-white' : 'text-gray-900'}`}
                      >
                        {grant.grant_name || grant['Grant Name']}
                      </h3>
                      <p
                        className={`text-sm line-clamp-3 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}
                      >
                        {grant.focus_areas || grant['Focus Areas']}
                      </p>
                    </div>

                    {/* Key info pills */}
                    <div className="flex flex-wrap gap-2 mb-6">
                      <span
                        className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
                          darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'
                        }`}
                      >
                        {formatCurrency(grant.grant_amount || grant['Grant Amount'])}
                      </span>
                      {(grant.application_deadline || grant['Application Deadline']) &&
                        (grant.application_deadline || grant['Application Deadline']) !== 'Rolling' && (
                          <span
                            className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
                              darkMode ? 'bg-red-900/30 text-red-400' : 'bg-red-100 text-red-700'
                            }`}
                          >
                            {formatDate(grant.application_deadline || grant['Application Deadline'])}
                          </span>
                        )}
                    </div>

                    <Link
                      to={`/grants?query=${encodeURIComponent(grant.grant_name || grant['Grant Name'])}`}
                      className={`inline-flex items-center text-sm font-medium ${
                        darkMode
                          ? 'text-blue-400 hover:text-blue-300'
                          : 'text-blue-600 hover:text-blue-700'
                      } group-hover:underline transition-colors`}
                    >
                      View details
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        className="h-4 w-4 ml-1 transform group-hover:translate-x-1 transition-transform"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                      >
                        <path
                          fillRule="evenodd"
                          d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                          clipRule="evenodd"
                        />
                      </svg>
                    </Link>
                  </div>
                </div>
                );
              })}
            </div>
          )}

          <div className="text-center mt-12">
            <Link
              to="/grants"
              className={`inline-flex items-center px-6 py-3 text-base font-medium rounded-xl ${
                darkMode
                  ? 'bg-gray-800 text-gray-200 hover:bg-gray-700'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              } transition-colors duration-200`}
            >
              View all grants
              <svg
                xmlns="http://www.w3.org/2000/svg"
                className="h-5 w-5 ml-2"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fillRule="evenodd"
                  d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z"
                  clipRule="evenodd"
                />
              </svg>
            </Link>
          </div>
        </div>
      </section>

      {/* Upcoming Deadlines - Clean table */}
      {upcomingGrants.length > 0 && (
        <section className={`py-20 ${darkMode ? 'bg-gray-800/50' : 'bg-gray-50'}`} aria-label="Upcoming application deadlines">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="text-center mb-12">
              <h2
                className={`text-4xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}
              >
                Upcoming Deadlines
              </h2>
              <p className={`text-xl ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Don't miss these application windows
              </p>
            </div>

            <div
              className={`rounded-2xl overflow-hidden shadow-xl ${darkMode ? 'bg-gray-800' : 'bg-white'}`}
            >
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
                    <tr>
                      <th
                        className={`px-6 py-4 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}
                      >
                        Grant
                      </th>
                      <th
                        className={`px-6 py-4 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}
                      >
                        Organization
                      </th>
                      <th
                        className={`px-6 py-4 text-left text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}
                      >
                        Deadline
                      </th>
                      <th
                        className={`px-6 py-4 text-right text-xs font-medium uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}
                      >
                        Action
                      </th>
                    </tr>
                  </thead>
                  <tbody className={`divide-y ${darkMode ? 'divide-gray-700' : 'divide-gray-200'}`}>
                    {upcomingGrants.map((grant, index) => (
                      <tr
                        key={index}
                        className={`${darkMode ? 'hover:bg-gray-700/50' : 'hover:bg-gray-50'} transition-colors`}
                      >
                        <td
                          className={`px-6 py-4 ${darkMode ? 'text-white' : 'text-gray-900'} font-medium`}
                        >
                          {grant.grant_name || grant['Grant Name']}
                        </td>
                        <td className={`px-6 py-4 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                          {grant.funding_organization || grant['Funding Organization']}
                        </td>
                        <td className={`px-6 py-4`}>
                          <span
                            className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
                              darkMode ? 'bg-red-900/30 text-red-400' : 'bg-red-100 text-red-600'
                            }`}
                          >
                            {grant.application_deadline || grant.deadline || grant['Application Deadline']}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-right">
                          <Link
                            to={`/grants?query=${encodeURIComponent(grant.grant_name || grant['Grant Name'])}`}
                            className={`inline-flex items-center text-sm font-medium ${
                              darkMode
                                ? 'text-blue-400 hover:text-blue-300'
                                : 'text-blue-600 hover:text-blue-700'
                            } hover:underline`}
                          >
                            View
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              className="h-4 w-4 ml-1"
                              viewBox="0 0 20 20"
                              fill="currentColor"
                            >
                              <path
                                fillRule="evenodd"
                                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                clipRule="evenodd"
                              />
                            </svg>
                          </Link>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      )}
      </main>
    </>
  );
};

export default HomePage;



================================================================================
FILE: client/src/pages/NotFoundPage.js
SIZE: 2000 bytes
================================================================================

import React, { useContext } from 'react';
import { Link } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { ThemeContext } from '../context/ThemeContext';

const NotFoundPage = () => {
  const { t } = useTranslation();
  const { darkMode } = useContext(ThemeContext);

  return (
    <div
      className={`flex flex-col items-center justify-center min-h-screen py-16 ${darkMode ? 'bg-gray-900' : 'bg-gray-50'} transition-colors duration-300`}
    >
      <h1
        className={`text-6xl font-bold ${darkMode ? 'text-blue-400' : 'text-blue-800'} mb-4 transition-colors duration-300`}
      >
        404
      </h1>
      <h2
        className={`text-2xl font-semibold ${darkMode ? 'text-white' : 'text-gray-700'} mb-6 transition-colors duration-300`}
      >
        {t('notFound.title', 'Page Not Found')}
      </h2>
      <p
        className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} max-w-md text-center mb-8 transition-colors duration-300`}
      >
        {t(
          'notFound.message',
          'The page you are looking for might have been removed, had its name changed, or is temporarily unavailable.'
        )}
      </p>
      <Link
        to="/"
        className={`flex items-center rounded-lg py-3 px-6 font-medium transition-all duration-200 ${
          darkMode
            ? 'bg-blue-600 hover:bg-blue-500 text-white'
            : 'bg-blue-600 hover:bg-blue-700 text-white'
        }`}
      >
        {t('notFound.returnHome', 'Return to Home')}
        <svg
          xmlns="http://www.w3.org/2000/svg"
          className="h-5 w-5 ml-2"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fillRule="evenodd"
            d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z"
            clipRule="evenodd"
          />
        </svg>
      </Link>
    </div>
  );
};

export default NotFoundPage;



================================================================================
FILE: client/src/reportWebVitals.js
SIZE: 362 bytes
================================================================================

const reportWebVitals = onPerfEntry => {
  if (onPerfEntry && onPerfEntry instanceof Function) {
    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
      getCLS(onPerfEntry);
      getFID(onPerfEntry);
      getFCP(onPerfEntry);
      getLCP(onPerfEntry);
      getTTFB(onPerfEntry);
    });
  }
};

export default reportWebVitals;



================================================================================
FILE: client/src/setupTests.js
SIZE: 1953 bytes
================================================================================

// jest-dom adds custom jest matchers for asserting on DOM nodes.
// allows you to do things like:
// expect(element).toHaveTextContent(/react/i)
// learn more: https://github.com/testing-library/jest-dom
import '@testing-library/jest-dom';

// Mock axios
jest.mock('axios', () => ({
  default: {
    get: jest.fn(() => Promise.resolve({ data: {} })),
    post: jest.fn(() => Promise.resolve({ data: {} })),
    put: jest.fn(() => Promise.resolve({ data: {} })),
    delete: jest.fn(() => Promise.resolve({ data: {} })),
    create: jest.fn(() => ({
      get: jest.fn(() => Promise.resolve({ data: {} })),
      post: jest.fn(() => Promise.resolve({ data: {} })),
      put: jest.fn(() => Promise.resolve({ data: {} })),
      delete: jest.fn(() => Promise.resolve({ data: {} })),
      interceptors: {
        request: { use: jest.fn() },
        response: { use: jest.fn() },
      },
    })),
    interceptors: {
      request: { use: jest.fn() },
      response: { use: jest.fn() },
    },
  },
  get: jest.fn(() => Promise.resolve({ data: {} })),
  post: jest.fn(() => Promise.resolve({ data: {} })),
  put: jest.fn(() => Promise.resolve({ data: {} })),
  delete: jest.fn(() => Promise.resolve({ data: {} })),
}));

// Mock window.matchMedia
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: jest.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: jest.fn(), // deprecated
    removeListener: jest.fn(), // deprecated
    addEventListener: jest.fn(),
    removeEventListener: jest.fn(),
    dispatchEvent: jest.fn(),
  })),
});

// Mock ResizeObserver
global.ResizeObserver = jest.fn().mockImplementation(() => ({
  observe: jest.fn(),
  unobserve: jest.fn(),
  disconnect: jest.fn(),
}));

// Mock IntersectionObserver
global.IntersectionObserver = jest.fn().mockImplementation(() => ({
  observe: jest.fn(),
  unobserve: jest.fn(),
  disconnect: jest.fn(),
}));



================================================================================
FILE: client/src/styles/mobile-optimizations.css
SIZE: 6983 bytes
================================================================================

/* Mobile Touch Target Optimizations */

/* Ensure minimum 44x44px touch targets on mobile */
@media (max-width: 768px) {
  /* All clickable elements should have minimum touch target size */
  button,
  a,
  input[type="button"],
  input[type="submit"],
  input[type="checkbox"],
  input[type="radio"],
  select,
  .clickable {
    min-height: 44px;
    min-width: 44px;
  }

  /* Links and buttons that contain only icons */
  a:has(svg:only-child),
  button:has(svg:only-child) {
    padding: 10px;
  }

  /* Form inputs */
  input[type="text"],
  input[type="email"],
  input[type="password"],
  input[type="search"],
  input[type="tel"],
  input[type="url"],
  textarea,
  select {
    min-height: 44px;
    padding: 8px 12px;
    font-size: 16px; /* Prevents zoom on iOS */
  }

  /* Blog post cards - make entire card clickable */
  .blog-card-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  /* Grant action buttons */
  .grant-action-button {
    min-height: 44px;
    padding: 10px 16px;
  }

  /* Navigation menu fixes */
  #mobile-menu a,
  .mobile-nav-link {
    min-height: 44px !important;
    padding: 12px 16px !important;
    display: flex !important;
    align-items: center !important;
  }

  /* Statistics grid mobile layout fix */
  .stats-grid,
  .stats-container,
  .grid.grid-cols-1.md\:grid-cols-3,
  .grid.grid-cols-1.md\:grid-cols-4 {
    display: flex !important;
    flex-direction: column !important;
    gap: 16px !important;
  }
  
  /* Force all multi-column grids to stack on mobile */
  .grid[class*="md:grid-cols"] {
    display: flex !important;
    flex-direction: column !important;
    gap: 16px !important;
  }

  /* Featured grants mobile optimization */
  .featured-grants-grid {
    display: flex !important;
    flex-direction: column !important;
    gap: 20px !important;
  }

  /* Ensure proper mobile spacing */
  .mobile-spacing {
    padding: 16px !important;
    margin: 8px 0 !important;
  }
}

  /* Mobile menu button */
  [data-testid="mobile-menu-button"] {
    min-width: 44px;
    min-height: 44px;
    padding: 8px;
  }

  /* Language switcher buttons */
  .language-switcher button {
    min-height: 36px;
    padding: 6px 12px;
  }

  /* Chat widget button */
  .chat-widget-button {
    width: 56px;
    height: 56px;
  }

  /* Close buttons */
  .close-button,
  button[aria-label*="close"],
  button[aria-label*="Close"] {
    min-width: 44px;
    min-height: 44px;
  }

  /* Social media links in footer */
  .social-link {
    min-width: 44px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* Improve spacing between interactive elements */
  .button-group > * + * {
    margin-left: 12px;
  }

  /* Filter buttons */
  .filter-button {
    min-height: 40px;
    padding: 8px 16px;
    margin: 4px;
  }

  /* Pagination buttons */
  .pagination button {
    min-width: 44px;
    min-height: 44px;
  }

  /* Modal close buttons */
  .modal-close {
    position: absolute;
    top: 8px;
    right: 8px;
    min-width: 44px;
    min-height: 44px;
  }

  /* Dropdown triggers */
  .dropdown-trigger {
    min-height: 44px;
    padding: 10px 16px;
  }

  /* Card action areas */
  .card-action {
    padding: 12px;
    margin: -12px;
  }

  /* Ensure proper spacing for stacked buttons */
  .button-stack > * + * {
    margin-top: 12px;
  }

  /* Tab buttons */
  .tab-button {
    min-height: 44px;
    padding: 10px 16px;
  }

  /* Floating action buttons */
  .fab {
    width: 56px;
    height: 56px;
    border-radius: 28px;
  }

  /* Toggle switches */
  .toggle-switch {
    min-width: 44px;
    min-height: 24px;
    padding: 10px 0;
  }

  /* Breadcrumb links and footer navigation */
  .breadcrumb a,
  footer a,
  nav a.text-sm {
    padding: 12px 8px !important;
    margin: -12px -8px !important;
    min-height: 44px !important;
    display: inline-flex !important;
    align-items: center !important;
  }

  /* Table row actions */
  .table-action {
    padding: 8px;
    margin: -8px;
  }

  /* Notification close buttons */
  .notification-close {
    min-width: 32px;
    min-height: 32px;
    margin: -6px;
    padding: 6px;
  }

  /* Increase tap target for small links */
  a[href^="mailto:"],
  a[href^="tel:"] {
    display: inline-block;
    padding: 8px 0;
    margin: -8px 0;
  }

  /* Search suggestions */
  .search-suggestion {
    min-height: 44px;
    padding: 10px 16px;
  }

  /* Tag/chip close buttons */
  .chip-close {
    min-width: 24px;
    min-height: 24px;
    margin-left: 8px;
    padding: 4px;
  }

  /* Accordion headers */
  .accordion-header {
    min-height: 48px;
    padding: 12px 16px;
  }

  /* List item actions */
  .list-item-action {
    min-width: 44px;
    min-height: 44px;
    padding: 10px;
  }

  /* Avatar buttons */
  .avatar-button {
    min-width: 40px;
    min-height: 40px;
  }

  /* Stepper buttons */
  .stepper-button {
    min-width: 32px;
    min-height: 32px;
    padding: 6px;
  }

  /* Date picker cells */
  .date-picker-cell {
    min-width: 40px;
    min-height: 40px;
  }

  /* Slider thumbs */
  .slider-thumb {
    width: 24px;
    height: 24px;
    margin: -10px;
    padding: 10px;
  }

  /* File upload areas */
  .file-upload-area {
    min-height: 120px;
    padding: 20px;
  }

  /* Menu items */
  .menu-item {
    min-height: 44px;
    padding: 10px 16px;
  }

  /* Toolbar buttons */
  .toolbar-button {
    min-width: 40px;
    min-height: 40px;
    padding: 8px;
  }

  /* Rating stars */
  .rating-star {
    min-width: 32px;
    min-height: 32px;
    padding: 4px;
  }

  /* Video player controls */
  .video-control {
    min-width: 40px;
    min-height: 40px;
  }

  /* Gallery thumbnails */
  .gallery-thumb {
    min-width: 60px;
    min-height: 60px;
  }

  /* Tooltip triggers */
  [data-tooltip] {
    padding: 8px;
    margin: -8px;
  }

  /* Progress bar segments */
  .progress-segment {
    min-height: 24px;
  }

  /* Tree view items */
  .tree-item {
    min-height: 36px;
    padding: 6px 12px;
  }

  /* Color picker swatches */
  .color-swatch {
    min-width: 32px;
    min-height: 32px;
  }

  /* Timeline items */
  .timeline-item {
    padding: 12px;
  }

  /* Code editor line numbers */
  .line-number {
    min-width: 40px;
    text-align: center;
  }

  /* Improve button group spacing */
  .btn-group {
    display: flex;
    gap: 8px;
  }

  /* Ensure proper focus styles */
  *:focus {
    outline: 2px solid #2563eb;
    outline-offset: 2px;
  }

  /* Improve touch feedback */
  button:active,
  a:active {
    opacity: 0.8;
    transform: scale(0.98);
  }

  /* Prevent text selection on touch */
  button,
  a,
  label {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }

  /* Smooth scrolling */
  * {
    -webkit-overflow-scrolling: touch;
  }

  /* Prevent double-tap zoom */
  button,
  a,
  input,
  select,
  textarea {
    touch-action: manipulation;
  }


================================================================================
FILE: client/src/styles/video-hero.css
SIZE: 2612 bytes
================================================================================

/* Video Hero Styles */

/* Ensure video covers the entire hero area */
.video-hero-container {
  position: relative;
  width: 100%;
  height: 100vh;
  min-height: 600px;
  max-height: 900px;
  overflow: hidden;
}

/* Video element styling */
.hero-video {
  position: absolute;
  top: 50%;
  left: 50%;
  min-width: 100%;
  min-height: 100%;
  width: auto;
  height: auto;
  transform: translate(-50%, -50%);
  z-index: -1;
}

/* Mobile-specific video optimizations */
@media (max-width: 768px) {
  .video-hero-container {
    height: 100vh;
    min-height: 500px;
    max-height: 800px;
  }
  
  /* Ensure video fills mobile screens properly */
  .hero-video {
    object-fit: cover;
    width: 100%;
    height: 100%;
  }
  
  /* Larger touch targets on mobile */
  .video-control-button {
    width: 48px;
    height: 48px;
  }
}

/* Performance optimizations for slower connections */
@media (prefers-reduced-motion: reduce) {
  .hero-video {
    display: none;
  }
  
  .video-fallback-gradient {
    display: block;
  }
}

/* High-resolution display support */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  .hero-video {
    /* Ensure crisp rendering on retina displays */
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }
}

/* Loading states */
.video-loading {
  background: linear-gradient(
    270deg,
    #f0f0f0 0%,
    #e0e0e0 50%,
    #f0f0f0 100%
  );
  background-size: 400% 100%;
  animation: shimmer 1.5s ease-in-out infinite;
}

@keyframes shimmer {
  0% {
    background-position: 200% 0;
  }
  100% {
    background-position: -200% 0;
  }
}

/* Accessibility improvements */
.video-controls:focus-visible {
  outline: 2px solid #fff;
  outline-offset: 2px;
}

/* Reduce motion for users who prefer it */
@media (prefers-reduced-motion: reduce) {
  .animate-bounce {
    animation: none;
  }
  
  .transition-all {
    transition: none;
  }
}

/* iOS-specific video fixes */
@supports (-webkit-touch-callout: none) {
  .hero-video {
    /* Fix for iOS video playback issues */
    -webkit-transform: translate3d(-50%, -50%, 0);
    transform: translate3d(-50%, -50%, 0);
  }
}

/* Android-specific optimizations */
@media (max-width: 768px) and (hover: none) {
  .hero-video {
    /* Ensure proper scaling on Android devices */
    object-position: center;
  }
}

/* Landscape mobile optimization */
@media (max-width: 896px) and (orientation: landscape) {
  .video-hero-container {
    height: 100vh;
    max-height: 500px;
  }
  
  .hero-content h1 {
    font-size: 2rem;
  }
  
  .hero-content p {
    font-size: 1rem;
  }
}


================================================================================
FILE: client/src/utils/adminApiHelper.js
SIZE: 4466 bytes
================================================================================

import axios from 'axios';

// Helper function to get the correct auth token
export const getAuthToken = () => {
  return localStorage.getItem('authToken') || localStorage.getItem('token');
};

// Helper function to normalize grant field names
export const normalizeGrant = grant => {
  // Handle both database format (snake_case) and JSON format (Title Case)
  return {
    id: grant.id || grant.ID,
    name: grant.grant_name || grant.name || grant['Grant Name'],
    organization: grant.funding_organization || grant.organization || grant['Organization'],
    deadline: grant.application_deadline || grant.deadline || grant['Deadline'],
    grant_size_min: grant.grant_size_min || grant['Grant Size Min'] || 0,
    grant_size_max: grant.grant_size_max || grant['Grant Size Max'] || 0,
    type: grant.type || grant['Type'],
    geographic_focus: grant.geographic_focus || grant['Geographic Focus'],
    description_en: grant.description_en || grant['Description (EN)'],
    description_uk: grant.description_uk || grant['Description (UK)'],
    eligibility_en: grant.eligibility_en || grant['Eligibility (EN)'],
    eligibility_uk: grant.eligibility_uk || grant['Eligibility (UK)'],
    focus_areas_en: grant.focus_areas_en || grant['Focus Areas (EN)'],
    focus_areas_uk: grant.focus_areas_uk || grant['Focus Areas (UK)'],
    website: grant.website || grant['Website'],
    application_url: grant.application_url || grant['Application URL'],
    logo_url: grant.logo_url || grant['Logo URL'],
    status: grant.status || 'active',
  };
};

// Fetch grants for admin panel with proper auth and fallback
export const fetchGrantsForAdmin = async () => {
  try {
    const token = getAuthToken();
    const headers = token ? { Authorization: `Bearer ${token}` } : {};

    // Try API first
    const response = await axios.get('/.netlify/functions/grants', { headers });

    if (response.data) {
      // Handle both array and object response formats
      let grants = [];
      if (Array.isArray(response.data)) {
        grants = response.data;
      } else if (response.data.grants) {
        grants = response.data.grants;
      } else if (response.data.data) {
        grants = response.data.data;
      }

      // Normalize all grants
      return grants.map(normalizeGrant);
    }

    throw new Error('No data in response');
  } catch (error) {
    console.error('Error fetching grants from API, trying static data:', error);

    // Fallback to static JSON
    try {
      const response = await axios.get('/data/grants.json');
      if (response.data && Array.isArray(response.data)) {
        return response.data.map(normalizeGrant);
      }
    } catch (staticError) {
      console.error('Error fetching static grants:', staticError);
    }

    return [];
  }
};

// Fetch blog posts for admin panel with proper response handling
export const fetchBlogPostsForAdmin = async () => {
  try {
    const token = getAuthToken();
    const headers = token ? { Authorization: `Bearer ${token}` } : {};

    const response = await axios.get('/.netlify/functions/blog', { headers });

    if (response.data) {
      // Handle wrapped response format
      if (response.data.posts !== undefined) {
        return response.data.posts || [];
      }
      // Handle direct array response
      if (Array.isArray(response.data)) {
        return response.data;
      }
      // Handle object with success property
      if (response.data.success && response.data.posts) {
        return response.data.posts;
      }
    }

    return [];
  } catch (error) {
    console.error('Error fetching blog posts:', error);
    return [];
  }
};

// Calculate dashboard statistics
export const calculateDashboardStats = (grants, blogPosts) => {
  const now = new Date();
  const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);

  // Count upcoming deadlines (within 30 days)
  const upcomingDeadlines = grants.filter(grant => {
    if (!grant.deadline) return false;

    try {
      const deadline = new Date(grant.deadline);
      return !isNaN(deadline) && deadline >= now && deadline <= thirtyDaysFromNow;
    } catch {
      return false;
    }
  }).length;

  // Count published blog posts
  const publishedPosts = blogPosts.filter(
    post => post.status === 'published' || post.published_at
  ).length;

  return {
    totalGrants: grants.length,
    upcomingDeadlines,
    totalBlogPosts: blogPosts.length,
    publishedPosts,
  };
};



================================================================================
FILE: client/src/utils/analytics.js
SIZE: 7930 bytes
================================================================================

// Privacy-focused analytics implementation
// Using a lightweight, self-hosted approach to respect user privacy

class Analytics {
  constructor() {
    this.queue = [];
    this.sessionId = this.generateSessionId();
    this.isEnabled = this.checkConsent();
  }

  // Generate unique session ID
  generateSessionId() {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }

  // Check if user has consented to analytics
  checkConsent() {
    const consent = localStorage.getItem('analytics_consent');
    return consent === 'true';
  }

  // Set user consent
  setConsent(consent) {
    this.isEnabled = consent;
    localStorage.setItem('analytics_consent', consent.toString());
    
    if (consent) {
      this.track('analytics_enabled');
    }
  }

  // Track page view
  trackPageView(page, additionalData = {}) {
    if (!this.isEnabled) return;

    const event = {
      type: 'page_view',
      page,
      timestamp: new Date().toISOString(),
      sessionId: this.sessionId,
      ...additionalData
    };

    this.sendEvent(event);
  }

  // Track grant view
  trackGrantView(grantId, grantName, organization) {
    if (!this.isEnabled) return;

    const event = {
      type: 'grant_view',
      grantId,
      grantName,
      organization,
      timestamp: new Date().toISOString(),
      sessionId: this.sessionId
    };

    this.sendEvent(event);

    // Also update view count in database
    this.updateGrantViewCount(grantId);
  }

  // Track search
  trackSearch(query, resultsCount, filters = {}) {
    if (!this.isEnabled) return;

    const event = {
      type: 'search',
      query: this.anonymizeQuery(query),
      resultsCount,
      filters,
      timestamp: new Date().toISOString(),
      sessionId: this.sessionId
    };

    this.sendEvent(event);
  }

  // Track filter usage
  trackFilterUsage(filterType, filterValue) {
    if (!this.isEnabled) return;

    const event = {
      type: 'filter_used',
      filterType,
      filterValue,
      timestamp: new Date().toISOString(),
      sessionId: this.sessionId
    };

    this.sendEvent(event);
  }

  // Track external link clicks
  trackExternalLink(url, grantId = null) {
    if (!this.isEnabled) return;

    const event = {
      type: 'external_link_click',
      url: this.anonymizeUrl(url),
      grantId,
      timestamp: new Date().toISOString(),
      sessionId: this.sessionId
    };

    this.sendEvent(event);
  }

  // Track chat interactions
  trackChatInteraction(action, data = {}) {
    if (!this.isEnabled) return;

    const event = {
      type: 'chat_interaction',
      action, // 'opened', 'message_sent', 'grant_recommended', etc.
      ...data,
      timestamp: new Date().toISOString(),
      sessionId: this.sessionId
    };

    this.sendEvent(event);
  }

  // Track errors
  trackError(error, context = {}) {
    // Always track errors for debugging, regardless of consent
    const event = {
      type: 'error',
      message: error.message,
      stack: error.stack,
      context,
      timestamp: new Date().toISOString(),
      sessionId: this.sessionId
    };

    this.sendEvent(event, true);
  }

  // Track performance metrics
  trackPerformance(metric, value, unit = 'ms') {
    if (!this.isEnabled) return;

    const event = {
      type: 'performance',
      metric,
      value,
      unit,
      timestamp: new Date().toISOString(),
      sessionId: this.sessionId
    };

    this.sendEvent(event);
  }

  // Anonymize search queries to protect privacy
  anonymizeQuery(query) {
    // Remove potential PII like email addresses, phone numbers
    return query
      .replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, '[email]')
      .replace(/\b\d{3}[-.]?\d{3}[-.]?\d{4}\b/g, '[phone]')
      .substring(0, 100); // Limit length
  }

  // Anonymize URLs
  anonymizeUrl(url) {
    try {
      const urlObj = new URL(url);
      return `${urlObj.hostname}${urlObj.pathname}`;
    } catch {
      return 'invalid_url';
    }
  }

  // Update grant view count in database
  async updateGrantViewCount(grantId) {
    try {
      await fetch('/.netlify/functions/grants', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          action: 'incrementView',
          grantId
        })
      });
    } catch (error) {
      console.error('Failed to update view count:', error);
    }
  }

  // Send event to analytics endpoint
  async sendEvent(event, force = false) {
    if (!this.isEnabled && !force) return;

    // Add common properties
    event.userAgent = navigator.userAgent;
    event.language = navigator.language;
    event.screenResolution = `${window.screen.width}x${window.screen.height}`;
    event.viewport = `${window.innerWidth}x${window.innerHeight}`;
    event.referrer = document.referrer ? this.anonymizeUrl(document.referrer) : null;

    // Add to queue
    this.queue.push(event);

    // Batch send events
    if (this.queue.length >= 10 || force) {
      this.flush();
    }
  }

  // Flush event queue
  async flush() {
    if (this.queue.length === 0) return;

    const events = [...this.queue];
    this.queue = [];

    try {
      await fetch('/.netlify/functions/analytics', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ events })
      });
    } catch (error) {
      console.error('Failed to send analytics:', error);
      // Re-add events to queue on failure
      this.queue.unshift(...events);
    }
  }

  // Initialize performance observer
  initPerformanceObserver() {
    if (!this.isEnabled || !window.PerformanceObserver) return;

    // Track Largest Contentful Paint
    try {
      const lcpObserver = new PerformanceObserver((list) => {
        const entries = list.getEntries();
        const lastEntry = entries[entries.length - 1];
        this.trackPerformance('lcp', lastEntry.renderTime || lastEntry.loadTime);
      });
      lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });
    } catch (e) {
      console.warn('LCP observer not supported');
    }

    // Track First Input Delay
    try {
      const fidObserver = new PerformanceObserver((list) => {
        const entries = list.getEntries();
        entries.forEach((entry) => {
          this.trackPerformance('fid', entry.processingStart - entry.startTime);
        });
      });
      fidObserver.observe({ entryTypes: ['first-input'] });
    } catch (e) {
      console.warn('FID observer not supported');
    }
  }

  // Get analytics summary
  async getAnalyticsSummary() {
    try {
      const response = await fetch('/.netlify/functions/analytics?action=summary');
      return await response.json();
    } catch (error) {
      console.error('Failed to fetch analytics summary:', error);
      return null;
    }
  }

  // Get popular grants
  async getPopularGrants(limit = 10) {
    try {
      const response = await fetch(`/.netlify/functions/analytics?action=popular&limit=${limit}`);
      return await response.json();
    } catch (error) {
      console.error('Failed to fetch popular grants:', error);
      return [];
    }
  }

  // Get search trends
  async getSearchTrends(days = 7) {
    try {
      const response = await fetch(`/.netlify/functions/analytics?action=searchTrends&days=${days}`);
      return await response.json();
    } catch (error) {
      console.error('Failed to fetch search trends:', error);
      return [];
    }
  }
}

// Create singleton instance
const analytics = new Analytics();

// Initialize performance observer when DOM is ready
if (typeof window !== 'undefined') {
  window.addEventListener('load', () => {
    analytics.initPerformanceObserver();
  });

  // Flush events before page unload
  window.addEventListener('beforeunload', () => {
    analytics.flush();
  });
}

export default analytics;


================================================================================
FILE: client/src/utils/cache.js
SIZE: 2596 bytes
================================================================================

/**
 * Simple in-memory cache for API responses
 */
class CacheManager {
  constructor(ttl = 5 * 60 * 1000) { // Default 5 minutes TTL
    this.cache = new Map();
    this.ttl = ttl;
  }

  /**
   * Generate a cache key from URL and params
   */
  generateKey(url, params = {}) {
    const sortedParams = Object.keys(params)
      .sort()
      .map(key => `${key}=${params[key]}`)
      .join('&');
    return `${url}?${sortedParams}`;
  }

  /**
   * Get cached data if available and not expired
   */
  get(url, params) {
    const key = this.generateKey(url, params);
    const cached = this.cache.get(key);
    
    if (!cached) return null;
    
    const isExpired = Date.now() - cached.timestamp > this.ttl;
    if (isExpired) {
      this.cache.delete(key);
      return null;
    }
    
    return cached.data;
  }

  /**
   * Store data in cache
   */
  set(url, params, data) {
    const key = this.generateKey(url, params);
    this.cache.set(key, {
      data,
      timestamp: Date.now()
    });
  }

  /**
   * Clear specific cache entry
   */
  delete(url, params) {
    const key = this.generateKey(url, params);
    this.cache.delete(key);
  }

  /**
   * Clear all cache
   */
  clear() {
    this.cache.clear();
  }

  /**
   * Get cache size
   */
  size() {
    return this.cache.size;
  }
}

// Create singleton instance
export const apiCache = new CacheManager();

/**
 * Cached axios-like fetch wrapper
 */
export async function cachedFetch(url, options = {}) {
  const { params = {}, forceRefresh = false, ...fetchOptions } = options;
  
  // Check cache first
  if (!forceRefresh) {
    const cached = apiCache.get(url, params);
    if (cached) {
      return { data: cached, fromCache: true };
    }
  }
  
  // Build URL with params
  const urlWithParams = new URL(url, window.location.origin);
  Object.keys(params).forEach(key => 
    urlWithParams.searchParams.append(key, params[key])
  );
  
  try {
    const response = await fetch(urlWithParams.toString(), fetchOptions);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    // Cache the successful response
    apiCache.set(url, params, data);
    
    return { data, fromCache: false };
  } catch (error) {
    // If fetch fails, try to return stale cache if available
    const staleCache = apiCache.get(url, params);
    if (staleCache) {
      console.warn('Returning stale cache due to fetch error:', error);
      return { data: staleCache, fromCache: true, stale: true };
    }
    
    throw error;
  }
}


================================================================================
FILE: client/src/utils/createFavicon.js
SIZE: 2004 bytes
================================================================================

// Create a simple favicon for the grants website
const fs = require('fs');
const path = require('path');

// Base64 encoded ICO file with blue "G"
const faviconBase64 = `AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAChGav8oRmr/KEZq/yhGav8oRmr/KEZq/yhGav8oRmr/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAA==`;

// Convert base64 to buffer
const buffer = Buffer.from(faviconBase64, 'base64');

// Write the file
const outputPath = path.join(__dirname, '../../public/favicon.ico');
fs.writeFileSync(outputPath, buffer);

console.log('Favicon created successfully at:', outputPath);



================================================================================
FILE: client/src/utils/createLogo.js
SIZE: 2879 bytes
================================================================================

// This script creates a simple logo for the grants website
const fs = require('fs');
const path = require('path');

// Create a simple blue circle with white "G" as base64 PNG
const logo192Base64 = `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAGaElEQVR4nO3de4hVVRjG4XdmxktnvIx3zUzNLM0uZhfNLjZamlqZlZVdTC0rK7uY3S9WlpVZaVZWdjEru5hZ2cXsYmZZaVqZmprmLR3HmXNmn/2H0EiZzjn7rL32Xut9n4d/BmF/6zvnx9r7nL33cQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAICqORhBabq5bt7lT+mR+mHpV/d7/CvdJz2gy31H7w4AAADQXC/XwQeNc7NqlJumBnD9u9tc5/wnvSgNZ1MBAAAg4sYu1iFjXOu8Gm1ejTa3xvVu8u9uD7fJt7i+/P0OAAAALHO7vLPe09/8VH/b3+an+5H+hO/E3/sAAGCNoe70z90v/rx/6I95Z3/cZ0eQu32iI5wNYIs9pd5uch0XN7sOa0vd2jXarnZJq9Sj+at2W3Wv/6S9VvGNIXs2P9Kf8DnelV6RnvRT3a+8y3nTbOkx6SLeLQAAlOJAN8Qv8Lm+2m2+Sm8H1vpS3+bLfINvVp8YWGLkzgIAAKCYPu4Ev9zfrrYy2+yrfbF/6qu8weV4VwEAAKBpg91J/oov8T9jpwxrfaV/4W/7FJfDuw4AAAB75HhXOt7t9mv8u9iJQaKv8Pm+TA9vjXatLI0BAABATu5e65/7X7HzgQb/XT/7B3njAAAAgD/leec+xBv8r9hZQDP/9Y/9Qy2LQSQAAKAae0tDvMEXxk4BmtmsZ/12nckAAgAAVdnP7eff+ubYCUALm/SMz/JjGEAAAKAKu0t7eYOviB09tLBec30Zg1JWHQAAyMleOsCXR40dWljnS2IxAwgAACR2AxDgX2mzNjGAAAAASd0AxPqvfqUu5D4QAACQ0g1ArP3oV+hc7gMBAABJ3QDEepn/qNfzJjgAAJDODUCsv/dftYIBBAAAkroBiPnX/qOm8yY4AACQzg1AzH/QBk3hBiAAAJDYl2Fj/av+Ip8pAQAAKd4AxPgPf4QBBAAASt8AxNqPfoXO4z4QAEAJTnRd/An/u7fF/vSQzib/21/2+/xQ35e/CzMAAJCRg90QP9eX+Ya6z3yQp41a5xt8mZ/vJ7rurCkAIAEd3Z5ukuvhR/itOl1tfnXsDw0Jq/P1eghssz/ih/uevDgBgEw0uAE+02/3Ndo5e1bsDwxpq9PmrJY7ynN9ivfiaAQACrO723u7a5bP8mVqIb/JgKJqq7v3t81f9ElevAIGAGzXkNNfO8N9i18T+yNC9VbqnvEBHJEAQKu6u/197JYfvzX2R4N4bNJXvlCTfKDbgRchAJCjhpzut8N+s2/W3/k7GIJVq595vk/w4dwXAoD/6et28Rnetf9/2uKNNczP8cHeGftzQnh1vtHn+Tw/1XuQQAAqtK872I/3O/xXrqKifda01ffsYy7LOxAAirfBnf4Svs839rd9i/7m72Hw1EKr/9S/9Vt9V9cQOwwABGGwG+m3+Fx9EI1kgqK3qGGsz/L9XD12BAAk4OT2cZf67f61r4n9sSA9G/S+y/HJPtAlsUwagOCMdJ38Al/of9Y9i5V2P3TI19a6+8c1+jKf7iNcp9jBAJCCA12JT/P7/HO9dRu7D+n4Wz/eLH3mC/WRR46P8+E+0DX88/MjAKBJjpvkJ/gVfpt/4av0+TvdEJD+VmjxGm26HixrKTCOZ9RLz0vz9fqCjvCOLuc6MpAAEIXu7gg/2i/3z3yNN3JfBi3W+gqf6YmuRLtzNAJABnq5vXy8X+MLfKOaQupQrI3a6G/qhT8d+QHlbiABwBIDXM5v8vka0FdxG4g0rNa1T7/Cp7gc63MCsMTebqjP9EXcmiENG3ymH+e9Y4cBQCgH+f5+k6/wdm7LoLa2+Wc+09/2w1xH1gAEUIXd3O4+yt/1z3yDmhrII+Xr/HN/xI9xnWNnA0AodncHuMv9Hl/i67yR9w8zU+frfJHf68e7vNo9AwBrFblyP6Hup3qLb/K1usujjnc/iqBN2+Qr3Wfv8BNcD5Y2ARBGb7ezH++3+fu+wjdr4cz/L4pYq59Nk+GvfKa/5JNdiI93AJAhe7jufqKb7q/7l7o1wxBKGJBfm9r8K5/tU1231uYGQJnazx3st/s8X6e/NdVIExnCsqb3dr/xl3yyF7kBAKBig90Yt7s/5l+pR8I26W4OHiVLE7DZ2/xdn+vDfRhHKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIDy/Q8Pft6CezgBgwAAAABJRU5ErkJggg==`;

// Convert base64 to buffer
const base64Data = logo192Base64.replace(/^data:image\/png;base64,/, '');
const buffer = Buffer.from(base64Data, 'base64');

// Write the file
const outputPath = path.join(__dirname, '../../public/logo192.png');
fs.writeFileSync(outputPath, buffer);

console.log('Logo created successfully at:', outputPath);



================================================================================
FILE: client/src/utils/createLogo512.js
SIZE: 5890 bytes
================================================================================

// This script creates a 512x512 logo for the grants website
const fs = require('fs');
const path = require('path');

// Create a simple blue circle with white "G" as base64 PNG (512x512)
const logo512Base64 = `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAACXBIWXMAAAsTAAALEwEAmpwYAAAO80lEQVR4nO3de7BdZXnH8e85J+dAAiEQEggJIVwCBLkUuQhUKFKwFKy0VqvWqlWrtlqrtdpqq7XaWq3VWq1arVqr1lqtWrVqq1YtWkWrVi0gIAiIXAIECBByIeGSc3L6x5qEk2TvnL322muv9T7v9/OfmWRm1vOuZ631W+9ea+8FAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACGbmHqAQBIG5eFsWlZGGvWxph1MXZTjC2L4f2xeWmMTcexKzZsirHZO7z3wcQTAaDXFsaYQ2Ps6Bg7NsaOibHlqQcFAACa6+AYOznGzo6xM2PsxBhbkXpQAACgvo6MsbNi7OUx9soYOzz1gAAAwOxWxNhZMfaiGHt+jB2delAAAGC6w2Ps3Bh7SYy9NMYOSz0oAACwp0Ni7Nkx9rIYe2WMHZp6UAAAYG+HxNizYuylMfbKGFuVelAAAGBvK2PsGTH2khh7eYytTj0oAACwt1Ux9owYe3GMvSLGDk09KAAA0L2lMfbEGHtujP16jL0gxg5KPSgAANC5xTF2aoy9IMZeFWMvjLElqQcFAAA6tzjGnhRjL4yxV8fYi2NsLPWgAABA546OsZfH2Bti7FUxdmTqAQEAgPnZL8aeEmO/EmPXxdgbYmx56kEBAIDuHBJjz42xG2Ps+hg7P/WAAACgnmUx9uwY+/MY+2CMPTvGFqUeFAAA6MyKGPv1GLslxt4dY09LPSAAANCdZTH2nBh7V4x9LMaelXpAAACguwNj7BUx9v4Y+0qMnZZ6QAAAoLMlMfacGHt7jH06xp6ZekAAAKC7lTH2whj7YIx9LsbOSj0gAADQnSNj7FUx9qEY+2aMnZF6QAAAoLODYuz5MfZ3MfbtGDsl9YAAAEBnB8TYM2PsjTH2hRg7O/WAAABA/xwYYy+IsTfH2Gdj7IzUAwIAAJ1ZGmNPj7E3xNjHYuzc1AMCAADdOSLGfjnG3htjn46xU1MPCAAAdOfIGHtpjL0nxj4bY6ekHhAAAOjOwTH2/Bh7a4x9KcaelHpAAACgs8Ux9rQY+80Y+0SMnZt6QAAAoDsrYuy8GHtbjH08xp6RekAAAKCzsTh2XIy9Msb+McY+G2Mnph4UAADo3OEx9oIYe0uMfTHGTk09IAAA0J2jYuylMfaeGPtMjJ2YekAAAKA7q2PshTH27hj7dIydnHpAAABgeI6LsVfE2Pti7FMxdnzqAQEAgO4cEWPPj7F3xdgnY+yE1AMCAADdWRFjvxBjb46xj8XY01IPCAAAdOfgGHtejL0lxj4RY2elHhAAABis42LsZTH2gRj7fIytyj2gY3Ov8MLcKwwA9M7qGHtejL07xj4XY0fkXuHluVf4idkzAQAoZVGMPTnG3hBjn4+xY3Ov8KG5V/jp2TMBAChlbYz9SozpD1MxNpF7hTfnXuHfyJ4JAEAxR8bYS2Ls/TG2LvcKL8+9wr+TPRMAUMXjY+zNMfbVGFuee4UPyL3Cr8ueCQCoYiLG3hhjn42xFblXeEnuFX5J9kwAQBWLYuz1MXZDjB2Se4VX5V7h38qeCQCo4rAYe0uMfSXGFude4VW5V/i12TMBAFWsjrEPxdhXY6z4U/GL31VlYZXOFe7lE2XRLs+ZGGNPi7E3xdjHY2xp7hUemz0Tn8vdy/OXl7vCa3OvMJBU4xoAJ5wwtE1Lnztt6JkLn5d7hRctzJ8Jb9ybPRNNGksJCzlheJlpuyvl7n11VwEABqmx+8Gf3YebPXmU3ZczE7xPQDbMGTDNJ4B1K2NsKsZq3BR4Ve4V/sOcWfBbANBP3AnQoMPCKbsDZt8JW1KiSx9kHmL1w8mZa2N5Vn1J7hX+3eyZAIAmcwcwjdwBTH9dwO7l7RBOy72N67NnAgCarLH3V9YXSrr4OVa/Pvc2PiN7JgCgyYrfBOg0zgQwP6uvwV8D/L3smRiGxt4ENxINgCcB8iRAX9j5xNQ/yJ6J/Br7JFh4EqDTOBNAK9x2ygYCiHAZANgF6+VjAAJAAPATgJb5kHsbn5Y9E+kVvwxQ4j2AEk8BlngJsEfyfwk7p8Y+b7E4VwGAufkdoJ8M5rPYSqHfAfppxeYYa9bUt7VyAQBgGBq7FvDYGJtayMuAQ8dLdH3xrOyZ6I/i7wG81PUuPwP0zRmpN/DFs2cCAJrMGQDN8sO5t/HE7JnImjOADksA6uuz69fH2K7U96kRdwEAgOZxBjAPzgCm8UVA6+Xexseekj0Tw+cMoEElABxJq3w6dQKE8Q7OFIpfAiy+hwYFAHSusWsBRy6Isao/kPQCW2O0nDJnABNLx9jSJTG2eCLGFi1IUwIAAJvWxtiWKzq7TA0AAFjHBQBglgvgQ9RZbgIEFOwCAMAsFwAUbApAu1wASJH5owBgABcAeJI1+RIArfIlAAzgAkCKfAcAQ+QCgBQdPvQEOCN7JoBB6fMFgBLfAVCo1M8AODj3Nq7InglgUPp8AaBEU4L0/DT3NvKzJaDYTwBmcwGgE3w2v1fubeRlQKAPFwAYhftyb+Oi7Jno+wWAEjclYjTPyL2NhVPmBqBYAyh2ASBFLgBMyL2NT8meib6zWQAADFZvzgBKNASgQz7h38bTs2dibqb5UMwlAD4HoD4/B6znEsAj9wBa1YvPAbCfAAQAsItN3ANIjwAAIEEFm0CBPYAZXAIQ4CIAAMD8mHsJdxYCQJ+9K/c28v4oUOUygI0DmGZT7m088ITsmQAGy/X2FKVE6blcAoCCFwFoFxcBAACGKHsJsIMAMGKfzb2NPIgFFGwAJRqCdQCz+Uf3NvJQKTBAvW0AJRoCzcLjfxRsCECzPN29jeelHkTPGwAANJkAANAsXwJACQEAoFkCAEAAAGiWAADQLAEAoFkCAAAAAAAAAAAAAAAAAAAAdGs89QCAHll9ZPOXtzN7JvquwR8EACBvFN6aexu/eEb2TMyfTYJBCu6OsVdnzwT65g3ubXx56gGkYJNgkPyXFJr2idQDSKE3JcAugb4aGx9hJd7F7JlA3xy9ovnLu7N4AACaJQAANEsAAGiWAADQLAEAoFkCAAAAAAAAAAAA6CuPOx27HHcNMTiOO2DW5u8f9QDqM8FbEBNAJ/w0ADCO8zl8AAYg7xEAhsZxR9sEAKAA4w7AWEAYQK+N4+7R2aOzRzePu5xGGXfYn9gcpb1iP6o9mK1zlJ6yKY6jKJsxvWJzBOCwAAw9AIB90jkrBJcAAJrFNXhgRi8vAhCXRomzGwCgtCLvwkCABIC7AQBuGqx+o9+O4w5Yj7wCQAAYDpsEQA1VAYBY0UIA2L8LDlWzKBSgJZxiAADQOE4FRss9gAAAdM1tgADzsKm5izs2nj0TQLGGgNo23tPc5V27OnsmaJCnAEB3Nu4Ye9nE+a9bPrbl+cW3sAU2CQbD/Tn5fGKH8yy7P2FiYvGJi6c2vLv4BqZGAGiB/Z9HXr3T/7l4svAmqhMABiO4JyZ1WQvb+t21dQ3Uj7AxgK7xMgC4BBAAoBr7P+gOAQC6xjkrsMvFAQDMcRGQywDtYj8A3QmOOdAN7jCvzsGLvdgMAQDQJGe36JCvAgBNEgAAzRIAyJbNCMwgJQA0Q0pgNgJAPcYd6E6nT3IB/bL/xA73t23KXoKD0iwCXrvH3EsTwO5dxNhYjC1ckD8TQMEGAOwu8fcAGqQmQAAA9qT2Y68GAMAwZ8CcFgNAkyUAAJjDQgBgBoN2RHNLBQCgFgvDUEzEMX7gAHbiW1gA2KFnlwD8MJCizyRJ0WfSLQDV8K0pOvXQ9rHnp969FPwJVgIAGP5NM0ATNHgxk6cBfAoAQA8JAICuuQ0QdIs3AdxM0y52A9AtggIh0B0+BQBol6vQSJEAgE5xqQagXQIAvTb+4PyXt9CdqgwxAAA0SwAAaJYAQK+Nze+KcIyxRWz1KEzLJhFG7MHJ+S9vqh6bw5AV7Aq4pykCYMS2Ts1/fZu4P6xdnjEEuiAA0KzJzTEWL8NIkHGHqgQAmjX5QIxNpT7zKYJxh6oEAJo1Wdc1sG1yoFNqsDhfQwjN2jqZP28HQQJASUr4KJ3VgLZ5ExAYnBAA4BdAmqUtmCUAADRLAKDX6roL0LcA6IQAwCB5ExAgz0uAgdkO2t8BAABoNnsBmMHWBtBsLgEAM9ja/FoQAmBwtC+gfWIQ2DvjDgwbAQDYO5cAgF4zCQJAs6UAAGiuBECCbPYARJqnAQAAaI+CRWgJAQCgWQIAQJscvv+0eU2MEwAAmiUAkC2rAZjBJQBgBv0PZuMODJIAAJB2CgwKv1QPDI59CvTauBvhABoiANAsAQCgWQIAM9nKMJj3l8iQAWiWzRAMCQEAIE27cOABMJifBj0BBIAnCgAAAGitajsyABQxPsJKjGfPBFCQjRH0mnH3LiDoBgEASKdCNnY2CWA2LgGAAhZPjLASAQjYRyYPgF4RABgk4w4Mkt0AgJOu0nJvIy8DAm0wBdQ2+U72TKDP7pv7DqgJ8JKkrjSGr+0+A7bk3sZv75c9E/3kqAOD5PYKemX1kflX/8mp7Jnop+AyR23FZSCXH9jnzB9V7VNh9JAAAEG5V3fJedkzgb6xLZTXOgGgCiGgj+zIAD1lY8DcBACm5d5Gzz0Ag2Q3AOQJAAB5XnwFdmeP1q2RJGBVkzegABaBuQkAs5AAAjAYAgCzt0VIgQAAZBUA8oQAAEqzvbRAAAB6TQAAaMcCtwEC8+AtALrGS4AA7TgweyaA3hMAoiUCJSyY50q2JJ89AKBfBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOiV/wfiP7y2ug6jHAAAAABJRU5ErkJggg==`;

// Convert base64 to buffer
const base64Data = logo512Base64.replace(/^data:image\/png;base64,/, '');
const buffer = Buffer.from(base64Data, 'base64');

// Write the file
const outputPath = path.join(__dirname, '../../public/logo512.png');
fs.writeFileSync(outputPath, buffer);

console.log('Logo 512 created successfully at:', outputPath);



================================================================================
FILE: client/src/utils/crypto.js
SIZE: 5042 bytes
================================================================================

import CryptoJS from 'crypto-js';

/**
 * Cryptographic utilities for secure data handling
 */

// Generate a random secret key if not provided
const getSecretKey = () => {
  const envKey = process.env.REACT_APP_CRYPTO_SECRET;
  if (envKey) return envKey;
  
  // Warning: This is for development only. In production, always use environment variable
  console.warn('Using default crypto key. Set REACT_APP_CRYPTO_SECRET in production!');
  return 'default-dev-key-change-in-production';
};

/**
 * Encrypt sensitive data
 * @param {string} data - Data to encrypt
 * @param {string} key - Encryption key (optional)
 * @returns {string} Encrypted data
 */
export const encrypt = (data, key = null) => {
  try {
    const secretKey = key || getSecretKey();
    return CryptoJS.AES.encrypt(JSON.stringify(data), secretKey).toString();
  } catch (error) {
    console.error('Encryption error:', error);
    return null;
  }
};

/**
 * Decrypt data
 * @param {string} encryptedData - Encrypted data
 * @param {string} key - Decryption key (optional)
 * @returns {any} Decrypted data
 */
export const decrypt = (encryptedData, key = null) => {
  try {
    const secretKey = key || getSecretKey();
    const bytes = CryptoJS.AES.decrypt(encryptedData, secretKey);
    return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
  } catch (error) {
    console.error('Decryption error:', error);
    return null;
  }
};

/**
 * Generate a secure random token
 * @param {number} length - Token length
 * @returns {string} Random token
 */
export const generateToken = (length = 32) => {
  const array = new Uint8Array(length);
  window.crypto.getRandomValues(array);
  return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
};

/**
 * Hash sensitive data (one-way)
 * @param {string} data - Data to hash
 * @param {string} salt - Salt for hashing (optional)
 * @returns {string} Hashed data
 */
export const hashData = (data, salt = '') => {
  return CryptoJS.SHA256(data + salt).toString();
};

/**
 * Generate CSRF token
 * @returns {string} CSRF token
 */
export const generateCSRFToken = () => {
  const token = generateToken(32);
  // Store in session storage for validation
  sessionStorage.setItem('csrfToken', token);
  return token;
};

/**
 * Validate CSRF token
 * @param {string} token - Token to validate
 * @returns {boolean} True if valid
 */
export const validateCSRFToken = (token) => {
  const storedToken = sessionStorage.getItem('csrfToken');
  return storedToken && storedToken === token;
};

/**
 * Generate a time-based one-time password (TOTP) secret
 * @returns {string} Base32 encoded secret
 */
export const generateTOTPSecret = () => {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
  let secret = '';
  for (let i = 0; i < 32; i++) {
    secret += chars[Math.floor(Math.random() * chars.length)];
  }
  return secret;
};

/**
 * Generate OTP from secret (simplified version)
 * Note: For production, use a proper TOTP library
 * @param {string} secret - TOTP secret
 * @returns {string} 6-digit OTP
 */
export const generateOTP = (secret) => {
  const time = Math.floor(Date.now() / 30000); // 30-second window
  const hash = hashData(secret + time);
  const otp = parseInt(hash.substring(0, 6), 16) % 1000000;
  return otp.toString().padStart(6, '0');
};

/**
 * Securely compare two strings (timing-attack resistant)
 * @param {string} a - First string
 * @param {string} b - Second string
 * @returns {boolean} True if equal
 */
export const secureCompare = (a, b) => {
  if (a.length !== b.length) return false;
  
  let result = 0;
  for (let i = 0; i < a.length; i++) {
    result |= a.charCodeAt(i) ^ b.charCodeAt(i);
  }
  
  return result === 0;
};

/**
 * Generate secure session ID
 * @returns {object} Session data
 */
export const generateSession = () => {
  const sessionId = generateToken(32);
  const expiresAt = Date.now() + (24 * 60 * 60 * 1000); // 24 hours
  
  return {
    id: sessionId,
    expiresAt,
    fingerprint: generateBrowserFingerprint()
  };
};

/**
 * Generate browser fingerprint for additional security
 * @returns {string} Browser fingerprint
 */
export const generateBrowserFingerprint = () => {
  const fingerprint = {
    userAgent: navigator.userAgent,
    language: navigator.language,
    platform: navigator.platform,
    screenResolution: `${screen.width}x${screen.height}`,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
  };
  
  return hashData(JSON.stringify(fingerprint));
};

/**
 * Mask sensitive data for display
 * @param {string} data - Data to mask
 * @param {number} visibleChars - Number of visible characters at start and end
 * @returns {string} Masked data
 */
export const maskSensitiveData = (data, visibleChars = 4) => {
  if (!data || data.length <= visibleChars * 2) {
    return '****';
  }
  
  const start = data.substring(0, visibleChars);
  const end = data.substring(data.length - visibleChars);
  const masked = '*'.repeat(Math.max(4, data.length - visibleChars * 2));
  
  return `${start}${masked}${end}`;
};


================================================================================
FILE: client/src/utils/debounce.js
SIZE: 1063 bytes
================================================================================

import { useState, useEffect } from 'react';

/**
 * Debounce utility function to limit the rate at which a function can fire
 * @param {Function} func - The function to debounce
 * @param {number} wait - The number of milliseconds to delay
 * @returns {Function} - The debounced function
 */
export function debounce(func, wait) {
  let timeout;
  
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

/**
 * Debounce hook for React components
 * @param {any} value - The value to debounce
 * @param {number} delay - The delay in milliseconds
 * @returns {any} - The debounced value
 */

export function useDebounce(value, delay) {
  const [debouncedValue, setDebouncedValue] = useState(value);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]);

  return debouncedValue;
}


================================================================================
FILE: client/src/utils/debugEnv.js
SIZE: 570 bytes
================================================================================

// Debug environment variables
export const debugEnv = () => {
  console.log('=== Environment Debug ===');
  console.log('REACT_APP_SUPABASE_URL:', process.env.REACT_APP_SUPABASE_URL);
  console.log(
    'REACT_APP_SUPABASE_ANON_KEY:',
    process.env.REACT_APP_SUPABASE_ANON_KEY ? 'Set (hidden)' : 'Not set'
  );
  console.log('NODE_ENV:', process.env.NODE_ENV);
  console.log(
    'All env vars starting with REACT_APP:',
    Object.keys(process.env)
      .filter(key => key.startsWith('REACT_APP'))
      .join(', ')
  );
  console.log('======================');
};



================================================================================
FILE: client/src/utils/generateSitemap.js
SIZE: 2741 bytes
================================================================================

// Sitemap generator utility
// This can be run during build time or as a separate script

const generateSitemap = (grants = [], blogPosts = []) => {
  const baseUrl = 'https://ukrainecivilsocietygrants.org';
  const currentDate = new Date().toISOString();

  // Static pages
  const staticPages = [
    { url: '/', changefreq: 'daily', priority: 1.0 },
    { url: '/grants', changefreq: 'daily', priority: 0.9 },
    { url: '/blog', changefreq: 'weekly', priority: 0.8 },
    { url: '/about', changefreq: 'monthly', priority: 0.7 },
  ];

  // Language variants
  const languages = ['en', 'uk'];
  
  let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
  xml += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"\n';
  xml += '        xmlns:xhtml="http://www.w3.org/1999/xhtml">\n';

  // Add static pages with language alternates
  staticPages.forEach(page => {
    languages.forEach(lang => {
      xml += '  <url>\n';
      xml += `    <loc>${baseUrl}${lang === 'en' ? '' : '/' + lang}${page.url}</loc>\n`;
      xml += `    <lastmod>${currentDate}</lastmod>\n`;
      xml += `    <changefreq>${page.changefreq}</changefreq>\n`;
      xml += `    <priority>${page.priority}</priority>\n`;
      
      // Add language alternates
      languages.forEach(altLang => {
        xml += `    <xhtml:link rel="alternate" hreflang="${altLang}" href="${baseUrl}${altLang === 'en' ? '' : '/' + altLang}${page.url}"/>\n`;
      });
      
      xml += '  </url>\n';
    });
  });

  // Add grant detail pages
  grants.forEach(grant => {
    if (grant.grant_name || grant['Grant Name']) {
      const grantName = encodeURIComponent(grant.grant_name || grant['Grant Name']);
      languages.forEach(lang => {
        xml += '  <url>\n';
        xml += `    <loc>${baseUrl}${lang === 'en' ? '' : '/' + lang}/grants/${grantName}</loc>\n`;
        xml += `    <lastmod>${currentDate}</lastmod>\n`;
        xml += '    <changefreq>weekly</changefreq>\n';
        xml += '    <priority>0.6</priority>\n';
        xml += '  </url>\n';
      });
    }
  });

  // Add blog posts
  blogPosts.forEach(post => {
    if (post.slug) {
      languages.forEach(lang => {
        xml += '  <url>\n';
        xml += `    <loc>${baseUrl}${lang === 'en' ? '' : '/' + lang}/blog/${post.slug}</loc>\n`;
        xml += `    <lastmod>${post.updated_at || post.created_at || currentDate}</lastmod>\n`;
        xml += '    <changefreq>monthly</changefreq>\n';
        xml += '    <priority>0.5</priority>\n';
        xml += '  </url>\n';
      });
    }
  });

  xml += '</urlset>';

  return xml;
};

// Export for use in build scripts
if (typeof module !== 'undefined' && module.exports) {
  module.exports = generateSitemap;
}

export default generateSitemap;


================================================================================
FILE: client/src/utils/lazyLoad.js
SIZE: 3931 bytes
================================================================================

import { useEffect, useRef, useState } from 'react';

/**
 * Intersection Observer options
 */
const defaultOptions = {
  root: null,
  rootMargin: '50px',
  threshold: 0.01
};

/**
 * Hook for lazy loading images
 * @param {string} src - The image source
 * @param {string} placeholder - Optional placeholder image
 * @returns {Object} - { imageSrc, imageRef, isLoaded, isError }
 */
export function useLazyLoadImage(src, placeholder = '') {
  const [imageSrc, setImageSrc] = useState(placeholder);
  const [isLoaded, setIsLoaded] = useState(false);
  const [isError, setIsError] = useState(false);
  const imageRef = useRef(null);

  useEffect(() => {
    let observer;
    
    if (imageRef.current && src) {
      observer = new IntersectionObserver(
        entries => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              // Create a new image to preload
              const img = new Image();
              
              img.onload = () => {
                setImageSrc(src);
                setIsLoaded(true);
                setIsError(false);
              };
              
              img.onerror = () => {
                setIsError(true);
                setIsLoaded(true);
              };
              
              img.src = src;
              
              // Stop observing once loaded
              if (observer && imageRef.current) {
                observer.unobserve(imageRef.current);
              }
            }
          });
        },
        defaultOptions
      );
      
      observer.observe(imageRef.current);
    }
    
    return () => {
      if (observer) {
        observer.disconnect();
      }
    };
  }, [src, placeholder]);

  return { imageSrc, imageRef, isLoaded, isError };
}

/**
 * Hook for lazy loading components
 * @param {Function} callback - Function to call when element is visible
 * @returns {Object} - { elementRef, isVisible }
 */
export function useLazyLoadComponent(callback) {
  const [isVisible, setIsVisible] = useState(false);
  const elementRef = useRef(null);

  useEffect(() => {
    let observer;
    
    if (elementRef.current) {
      observer = new IntersectionObserver(
        entries => {
          entries.forEach(entry => {
            if (entry.isIntersecting && !isVisible) {
              setIsVisible(true);
              
              if (callback) {
                callback();
              }
              
              // Stop observing once visible
              if (observer && elementRef.current) {
                observer.unobserve(elementRef.current);
              }
            }
          });
        },
        defaultOptions
      );
      
      observer.observe(elementRef.current);
    }
    
    return () => {
      if (observer) {
        observer.disconnect();
      }
    };
  }, [callback, isVisible]);

  return { elementRef, isVisible };
}

/**
 * LazyImage component
 */
export const LazyImage = ({ 
  src, 
  alt, 
  placeholder,
  className = '',
  onLoad,
  onError,
  ...props 
}) => {
  const { imageSrc, imageRef, isLoaded, isError } = useLazyLoadImage(src, placeholder);

  useEffect(() => {
    if (isLoaded && !isError && onLoad) {
      onLoad();
    }
    if (isError && onError) {
      onError();
    }
  }, [isLoaded, isError, onLoad, onError]);

  return (
    <img
      ref={imageRef}
      src={imageSrc}
      alt={alt}
      className={`${className} ${isLoaded ? 'opacity-100' : 'opacity-0'} transition-opacity duration-300`}
      {...props}
    />
  );
};

/**
 * Lazy load multiple images at once
 */
export function preloadImages(imageUrls) {
  const promises = imageUrls.map(url => {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(url);
      img.onerror = () => reject(new Error(`Failed to load ${url}`));
      img.src = url;
    });
  });
  
  return Promise.allSettled(promises);
}


================================================================================
FILE: client/src/utils/quillUtils.js
SIZE: 5341 bytes
================================================================================

/**
 * Utility functions for managing ReactQuill instances
 * Helps prevent conflicts and manage global state
 */

// Global tracking of Quill state
const QUILL_STATE = {
  isLoaded: false,
  loadingPromise: null,
  instances: new Set(),
  errorCount: 0,
};

/**
 * Registers a new Quill instance
 * @param {string} instanceId - Unique identifier for the instance
 */
export const registerQuillInstance = instanceId => {
  QUILL_STATE.instances.add(instanceId);
  console.debug(`Quill instance registered: ${instanceId}. Total: ${QUILL_STATE.instances.size}`);
};

/**
 * Unregisters a Quill instance
 * @param {string} instanceId - Unique identifier for the instance
 */
export const unregisterQuillInstance = instanceId => {
  QUILL_STATE.instances.delete(instanceId);
  console.debug(`Quill instance unregistered: ${instanceId}. Total: ${QUILL_STATE.instances.size}`);
};

/**
 * Gets the number of active Quill instances
 * @returns {number}
 */
export const getActiveQuillInstances = () => {
  return QUILL_STATE.instances.size;
};

/**
 * Checks if Quill is already loaded
 * @returns {boolean}
 */
export const isQuillLoaded = () => {
  return QUILL_STATE.isLoaded || (window.Quill && window.ReactQuill);
};

/**
 * Safely defines a custom element, preventing duplicate registration errors
 * @param {string} name - Custom element name
 * @param {function} constructor - Element constructor
 * @param {object} options - Options for define
 */
export const safeDefineCustomElement = (name, constructor, options) => {
  if (window.customElements && !window.customElements.get(name)) {
    try {
      window.customElements.define(name, constructor, options);
    } catch (error) {
      if (!error.message.includes('already been defined')) {
        throw error;
      }
      console.debug(`Custom element ${name} already defined, skipping`);
    }
  }
};

/**
 * Marks Quill as loaded
 */
export const markQuillAsLoaded = () => {
  QUILL_STATE.isLoaded = true;
};

/**
 * Increments error count for monitoring
 */
export const incrementQuillErrorCount = () => {
  QUILL_STATE.errorCount++;
  console.warn(`Quill error count: ${QUILL_STATE.errorCount}`);
};

/**
 * Gets current error count
 * @returns {number}
 */
export const getQuillErrorCount = () => {
  return QUILL_STATE.errorCount;
};

/**
 * Resets error count (useful for retry mechanisms)
 */
export const resetQuillErrorCount = () => {
  QUILL_STATE.errorCount = 0;
};

/**
 * Suppresses specific console messages during Quill loading
 * @param {function} originalMethod - Original console method
 * @param {...any} args - Console arguments
 */
export const suppressQuillWarnings = (originalMethod, ...args) => {
  const message = args[0]?.toString?.() || '';
  const suppressPatterns = [
    'autosize-textarea',
    'already defined',
    'already been defined',
    'custom element',
    'customElements.define',
    "DOMException: Failed to execute 'define'",
    'The name "autosize-textarea" has already been used',
    'NotSupportedError',
    'webcomponents-ce.js',
    'A custom element with name',
  ];

  if (suppressPatterns.some(pattern => message.includes(pattern))) {
    return; // Suppress this message
  }

  originalMethod.apply(console, args);
};

/**
 * Creates a safe console override for Quill loading
 * @returns {object} - Object with restore function
 */
export const createConsoleOverride = () => {
  const originalError = console.error;
  const originalWarn = console.warn;

  console.error = (...args) => suppressQuillWarnings(originalError, ...args);
  console.warn = (...args) => suppressQuillWarnings(originalWarn, ...args);

  return {
    restore: () => {
      console.error = originalError;
      console.warn = originalWarn;
    },
  };
};

/**
 * Default Quill modules configuration
 */
export const DEFAULT_QUILL_MODULES = {
  toolbar: [
    [{ header: [1, 2, 3, false] }],
    ['bold', 'italic', 'underline', 'strike'],
    ['blockquote', 'code-block'],
    [{ list: 'ordered' }, { list: 'bullet' }],
    ['link', 'image'],
    ['clean'],
  ],
};

/**
 * Extended Quill modules with more features
 */
export const EXTENDED_QUILL_MODULES = {
  toolbar: [
    [{ header: [1, 2, 3, 4, 5, 6, false] }],
    [{ font: [] }],
    [{ size: ['small', false, 'large', 'huge'] }],
    ['bold', 'italic', 'underline', 'strike'],
    [{ color: [] }, { background: [] }],
    [{ script: 'sub' }, { script: 'super' }],
    ['blockquote', 'code-block'],
    [{ list: 'ordered' }, { list: 'bullet' }],
    [{ indent: '-1' }, { indent: '+1' }],
    [{ direction: 'rtl' }],
    [{ align: [] }],
    ['link', 'image', 'video'],
    ['clean'],
  ],
  clipboard: {
    matchVisual: false,
  },
};

/**
 * Quill formats for content validation
 */
export const QUILL_FORMATS = [
  'header',
  'font',
  'size',
  'bold',
  'italic',
  'underline',
  'strike',
  'blockquote',
  'list',
  'bullet',
  'indent',
  'link',
  'image',
  'video',
  'color',
  'background',
  'align',
  'direction',
  'code-block',
  'script',
];

export default {
  registerQuillInstance,
  unregisterQuillInstance,
  getActiveQuillInstances,
  isQuillLoaded,
  markQuillAsLoaded,
  incrementQuillErrorCount,
  getQuillErrorCount,
  resetQuillErrorCount,
  suppressQuillWarnings,
  createConsoleOverride,
  DEFAULT_QUILL_MODULES,
  EXTENDED_QUILL_MODULES,
  QUILL_FORMATS,
};



================================================================================
FILE: client/src/utils/sanitize.js
SIZE: 4094 bytes
================================================================================

import DOMPurify from 'dompurify';

/**
 * Sanitize HTML content to prevent XSS attacks
 * @param {string} html - Raw HTML content
 * @param {object} options - DOMPurify options
 * @returns {string} Sanitized HTML
 */
export const sanitizeHTML = (html, options = {}) => {
  const defaultOptions = {
    ALLOWED_TAGS: [
      'p', 'br', 'span', 'div', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
      'blockquote', 'a', 'ul', 'ol', 'li', 'b', 'i', 'strong', 'em',
      'u', 'code', 'pre', 'hr', 'img', 'table', 'thead', 'tbody',
      'tr', 'th', 'td', 'caption'
    ],
    ALLOWED_ATTR: [
      'href', 'title', 'target', 'src', 'alt', 'class', 'id',
      'width', 'height', 'colspan', 'rowspan', 'style'
    ],
    ALLOWED_URI_REGEXP: /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,
    KEEP_CONTENT: true,
    ...options
  };

  // Additional security: remove any script tags and event handlers
  const config = {
    ...defaultOptions,
    FORBID_TAGS: ['script', 'style', 'iframe', 'object', 'embed', 'form'],
    FORBID_ATTR: ['onerror', 'onclick', 'onload', 'onmouseover', 'onfocus', 'onblur']
  };

  return DOMPurify.sanitize(html, config);
};

/**
 * Sanitize user input for display (escapes HTML)
 * @param {string} input - User input
 * @returns {string} Escaped string
 */
export const sanitizeInput = (input) => {
  if (typeof input !== 'string') return '';
  
  return input
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;');
};

/**
 * Sanitize URL to prevent XSS and open redirect attacks
 * @param {string} url - URL to sanitize
 * @param {array} allowedDomains - List of allowed domains
 * @returns {string} Sanitized URL or empty string if invalid
 */
export const sanitizeURL = (url, allowedDomains = []) => {
  if (!url || typeof url !== 'string') return '';

  try {
    const urlObj = new URL(url);
    
    // Only allow http and https protocols
    if (!['http:', 'https:'].includes(urlObj.protocol)) {
      return '';
    }

    // Check if domain is in allowed list (if provided)
    if (allowedDomains.length > 0) {
      const isAllowed = allowedDomains.some(domain => 
        urlObj.hostname === domain || urlObj.hostname.endsWith(`.${domain}`)
      );
      if (!isAllowed) return '';
    }

    return urlObj.toString();
  } catch {
    // If URL parsing fails, check if it's a relative URL
    if (url.startsWith('/') && !url.startsWith('//')) {
      return sanitizeInput(url);
    }
    return '';
  }
};

/**
 * Sanitize filename to prevent directory traversal
 * @param {string} filename - Filename to sanitize
 * @returns {string} Sanitized filename
 */
export const sanitizeFilename = (filename) => {
  if (!filename || typeof filename !== 'string') return '';
  
  // Remove any path separators and null bytes
  return filename
    .replace(/[\/\\]/g, '')
    .replace(/\0/g, '')
    .replace(/\.{2,}/g, '.')
    .trim();
};

/**
 * Sanitize SQL input to prevent SQL injection
 * @param {string} input - SQL input
 * @returns {string} Sanitized input
 */
export const sanitizeSQL = (input) => {
  if (typeof input !== 'string') return '';
  
  // Basic SQL injection prevention
  return input
    .replace(/'/g, "''")
    .replace(/;/g, '')
    .replace(/--/g, '')
    .replace(/\/\*/g, '')
    .replace(/\*\//g, '')
    .replace(/xp_/gi, '')
    .replace(/script/gi, '');
};

/**
 * Remove sensitive data from objects
 * @param {object} obj - Object to clean
 * @param {array} sensitiveKeys - Keys to remove
 * @returns {object} Cleaned object
 */
export const removeSensitiveData = (obj, sensitiveKeys = ['password', 'token', 'apiKey', 'secret']) => {
  if (!obj || typeof obj !== 'object') return obj;
  
  const cleaned = { ...obj };
  
  sensitiveKeys.forEach(key => {
    // Case-insensitive key matching
    Object.keys(cleaned).forEach(objKey => {
      if (objKey.toLowerCase().includes(key.toLowerCase())) {
        delete cleaned[objKey];
      }
    });
  });
  
  return cleaned;
};


================================================================================
FILE: client/src/utils/validate.js
SIZE: 7280 bytes
================================================================================

/**
 * Validation utilities for form inputs and data
 */

/**
 * Validate email format
 * @param {string} email - Email to validate
 * @returns {boolean} True if valid
 */
export const validateEmail = (email) => {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
};

/**
 * Validate password strength
 * @param {string} password - Password to validate
 * @returns {object} Validation result with strength score and messages
 */
export const validatePassword = (password) => {
  const result = {
    isValid: false,
    strength: 0,
    messages: []
  };

  if (!password) {
    result.messages.push('Password is required');
    return result;
  }

  // Length check
  if (password.length < 8) {
    result.messages.push('Password must be at least 8 characters long');
  } else {
    result.strength += 1;
  }

  // Uppercase check
  if (!/[A-Z]/.test(password)) {
    result.messages.push('Password must contain at least one uppercase letter');
  } else {
    result.strength += 1;
  }

  // Lowercase check
  if (!/[a-z]/.test(password)) {
    result.messages.push('Password must contain at least one lowercase letter');
  } else {
    result.strength += 1;
  }

  // Number check
  if (!/\d/.test(password)) {
    result.messages.push('Password must contain at least one number');
  } else {
    result.strength += 1;
  }

  // Special character check
  if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
    result.messages.push('Password must contain at least one special character');
  } else {
    result.strength += 1;
  }

  // Common password check
  const commonPasswords = ['password', '12345678', 'qwerty', 'admin123', 'letmein'];
  if (commonPasswords.some(common => password.toLowerCase().includes(common))) {
    result.messages.push('Password is too common');
    result.strength = Math.max(0, result.strength - 2);
  }

  result.isValid = result.messages.length === 0;
  return result;
};

/**
 * Validate URL format
 * @param {string} url - URL to validate
 * @returns {boolean} True if valid
 */
export const validateURL = (url) => {
  try {
    const urlObj = new URL(url);
    return ['http:', 'https:'].includes(urlObj.protocol);
  } catch {
    return false;
  }
};

/**
 * Validate date format and range
 * @param {string} date - Date string to validate
 * @param {object} options - Validation options
 * @returns {boolean} True if valid
 */
export const validateDate = (date, options = {}) => {
  const { minDate, maxDate, allowPast = true, allowFuture = true } = options;
  
  const dateObj = new Date(date);
  if (isNaN(dateObj.getTime())) {
    return false;
  }

  const now = new Date();
  
  if (!allowPast && dateObj < now) {
    return false;
  }
  
  if (!allowFuture && dateObj > now) {
    return false;
  }
  
  if (minDate && dateObj < new Date(minDate)) {
    return false;
  }
  
  if (maxDate && dateObj > new Date(maxDate)) {
    return false;
  }
  
  return true;
};

/**
 * Validate grant form data
 * @param {object} formData - Grant form data
 * @returns {object} Validation result
 */
export const validateGrantForm = (formData) => {
  const errors = {};

  // Required fields
  if (!formData.grant_name?.trim()) {
    errors.grant_name = 'Grant name is required';
  } else if (formData.grant_name.length > 200) {
    errors.grant_name = 'Grant name must be less than 200 characters';
  }

  if (!formData.funding_organization?.trim()) {
    errors.funding_organization = 'Funding organization is required';
  } else if (formData.funding_organization.length > 200) {
    errors.funding_organization = 'Organization name must be less than 200 characters';
  }

  // Optional fields validation
  if (formData.website_link && !validateURL(formData.website_link)) {
    errors.website_link = 'Please enter a valid URL';
  }

  if (formData.application_deadline && !validateDate(formData.application_deadline, { allowPast: false })) {
    errors.application_deadline = 'Please enter a valid future date';
  }

  if (formData.grant_amount) {
    // Remove currency symbols and validate
    const amount = formData.grant_amount.replace(/[^0-9.,\-\s]/g, '');
    if (!/^[\d,.\-\s]+$/.test(amount)) {
      errors.grant_amount = 'Please enter a valid amount';
    }
  }

  return {
    isValid: Object.keys(errors).length === 0,
    errors
  };
};

/**
 * Validate blog post form data
 * @param {object} formData - Blog form data
 * @returns {object} Validation result
 */
export const validateBlogForm = (formData) => {
  const errors = {};

  if (!formData.title?.trim()) {
    errors.title = 'Title is required';
  } else if (formData.title.length > 200) {
    errors.title = 'Title must be less than 200 characters';
  }

  if (!formData.content?.trim()) {
    errors.content = 'Content is required';
  } else if (formData.content.length < 50) {
    errors.content = 'Content must be at least 50 characters';
  }

  if (!formData.slug?.trim()) {
    errors.slug = 'Slug is required';
  } else if (!/^[a-z0-9-]+$/.test(formData.slug)) {
    errors.slug = 'Slug can only contain lowercase letters, numbers, and hyphens';
  }

  if (formData.excerpt && formData.excerpt.length > 500) {
    errors.excerpt = 'Excerpt must be less than 500 characters';
  }

  return {
    isValid: Object.keys(errors).length === 0,
    errors
  };
};

/**
 * Validate file upload
 * @param {File} file - File to validate
 * @param {object} options - Validation options
 * @returns {object} Validation result
 */
export const validateFile = (file, options = {}) => {
  const {
    maxSize = 5 * 1024 * 1024, // 5MB default
    allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
    allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp']
  } = options;

  const result = {
    isValid: true,
    error: null
  };

  if (!file) {
    result.isValid = false;
    result.error = 'No file selected';
    return result;
  }

  // Check file size
  if (file.size > maxSize) {
    result.isValid = false;
    result.error = `File size must be less than ${Math.round(maxSize / 1024 / 1024)}MB`;
    return result;
  }

  // Check file type
  if (!allowedTypes.includes(file.type)) {
    result.isValid = false;
    result.error = 'Invalid file type';
    return result;
  }

  // Check file extension
  const extension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
  if (!allowedExtensions.includes(extension)) {
    result.isValid = false;
    result.error = 'Invalid file extension';
    return result;
  }

  return result;
};

/**
 * Validate user input length
 * @param {string} input - Input to validate
 * @param {number} minLength - Minimum length
 * @param {number} maxLength - Maximum length
 * @returns {boolean} True if valid
 */
export const validateLength = (input, minLength = 0, maxLength = Infinity) => {
  if (typeof input !== 'string') return false;
  return input.length >= minLength && input.length <= maxLength;
};

/**
 * Validate alphanumeric input
 * @param {string} input - Input to validate
 * @param {boolean} allowSpaces - Allow spaces
 * @returns {boolean} True if valid
 */
export const validateAlphanumeric = (input, allowSpaces = false) => {
  const regex = allowSpaces ? /^[a-zA-Z0-9\s]+$/ : /^[a-zA-Z0-9]+$/;
  return regex.test(input);
};


================================================================================
FILE: client/netlify/functions/analytics.js
SIZE: 13354 bytes
================================================================================

const { createClient } = require('@supabase/supabase-js');

// Initialize Supabase client
const supabase = createClient(
  process.env.REACT_APP_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

// Create analytics tables if they don't exist
async function ensureAnalyticsTables() {
  try {
    // Create events table
    await supabase.rpc('exec_sql', {
      sql: `
        CREATE TABLE IF NOT EXISTS analytics_events (
          id SERIAL PRIMARY KEY,
          type VARCHAR(50) NOT NULL,
          session_id VARCHAR(50),
          timestamp TIMESTAMPTZ DEFAULT NOW(),
          data JSONB DEFAULT '{}',
          created_at TIMESTAMPTZ DEFAULT NOW()
        );
        
        CREATE INDEX IF NOT EXISTS idx_analytics_type ON analytics_events(type);
        CREATE INDEX IF NOT EXISTS idx_analytics_session ON analytics_events(session_id);
        CREATE INDEX IF NOT EXISTS idx_analytics_timestamp ON analytics_events(timestamp);
        
        CREATE TABLE IF NOT EXISTS grant_analytics (
          grant_id INTEGER PRIMARY KEY,
          view_count INTEGER DEFAULT 0,
          last_viewed TIMESTAMPTZ,
          search_appearances INTEGER DEFAULT 0,
          click_through_rate DECIMAL(5,2),
          average_time_on_page INTEGER,
          external_clicks INTEGER DEFAULT 0,
          updated_at TIMESTAMPTZ DEFAULT NOW()
        );
        
        CREATE TABLE IF NOT EXISTS search_analytics (
          id SERIAL PRIMARY KEY,
          query TEXT,
          results_count INTEGER,
          clicked_result BOOLEAN DEFAULT FALSE,
          session_id VARCHAR(50),
          timestamp TIMESTAMPTZ DEFAULT NOW()
        );
        
        CREATE INDEX IF NOT EXISTS idx_search_query ON search_analytics(query);
        CREATE INDEX IF NOT EXISTS idx_search_timestamp ON search_analytics(timestamp);
      `
    });
  } catch (error) {
    console.error('Error creating analytics tables:', error);
  }
}

// Handler function
exports.handler = async (event, context) => {
  // Handle preflight requests
  if (event.httpMethod === 'OPTIONS') {
    return {
      statusCode: 200,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS'
      }
    };
  }

  try {
    // Ensure tables exist
    await ensureAnalyticsTables();

    if (event.httpMethod === 'POST') {
      // Store analytics events
      const { events } = JSON.parse(event.body);
      
      if (!Array.isArray(events)) {
        return {
          statusCode: 400,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ error: 'Events must be an array' })
        };
      }

      // Process each event
      for (const evt of events) {
        const { type, sessionId, timestamp, ...data } = evt;
        
        // Store event
        await supabase
          .from('analytics_events')
          .insert({
            type,
            session_id: sessionId,
            timestamp,
            data
          });

        // Update specific analytics based on event type
        switch (type) {
          case 'grant_view':
            await updateGrantAnalytics(data.grantId, 'view');
            break;
          case 'search':
            await recordSearchAnalytics(data.query, data.resultsCount, sessionId);
            break;
          case 'external_link_click':
            if (data.grantId) {
              await updateGrantAnalytics(data.grantId, 'external_click');
            }
            break;
        }
      }

      return {
        statusCode: 200,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ success: true, processed: events.length })
      };
    }

    if (event.httpMethod === 'GET') {
      const params = event.queryStringParameters || {};
      const action = params.action;

      switch (action) {
        case 'summary':
          const summary = await getAnalyticsSummary();
          return {
            statusCode: 200,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(summary)
          };

        case 'popular':
          const limit = parseInt(params.limit) || 10;
          const popular = await getPopularGrants(limit);
          return {
            statusCode: 200,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(popular)
          };

        case 'searchTrends':
          const days = parseInt(params.days) || 7;
          const trends = await getSearchTrends(days);
          return {
            statusCode: 200,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(trends)
          };

        case 'grantStats':
          const grantId = params.grantId;
          if (!grantId) {
            return {
              statusCode: 400,
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ error: 'Grant ID required' })
            };
          }
          const stats = await getGrantStats(grantId);
          return {
            statusCode: 200,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(stats)
          };

        default:
          return {
            statusCode: 400,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ error: 'Invalid action' })
          };
      }
    }

    return {
      statusCode: 405,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ error: 'Method not allowed' })
    };

  } catch (error) {
    console.error('Analytics error:', error);
    return {
      statusCode: 500,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ error: 'Internal server error' })
    };
  }
};

// Update grant analytics
async function updateGrantAnalytics(grantId, action) {
  try {
    const { data: existing } = await supabase
      .from('grant_analytics')
      .select('*')
      .eq('grant_id', grantId)
      .single();

    if (existing) {
      const updates = {
        updated_at: new Date().toISOString()
      };

      if (action === 'view') {
        updates.view_count = (existing.view_count || 0) + 1;
        updates.last_viewed = new Date().toISOString();
      } else if (action === 'external_click') {
        updates.external_clicks = (existing.external_clicks || 0) + 1;
      }

      await supabase
        .from('grant_analytics')
        .update(updates)
        .eq('grant_id', grantId);
    } else {
      const newRecord = {
        grant_id: grantId,
        view_count: action === 'view' ? 1 : 0,
        external_clicks: action === 'external_click' ? 1 : 0,
        last_viewed: action === 'view' ? new Date().toISOString() : null
      };

      await supabase
        .from('grant_analytics')
        .insert(newRecord);
    }

    // Also update the main grants table view count
    if (action === 'view') {
      await supabase.rpc('increment_grant_view', { grant_id: grantId });
    }
  } catch (error) {
    console.error('Error updating grant analytics:', error);
  }
}

// Record search analytics
async function recordSearchAnalytics(query, resultsCount, sessionId) {
  try {
    await supabase
      .from('search_analytics')
      .insert({
        query: query.substring(0, 200), // Limit query length
        results_count: resultsCount,
        session_id: sessionId
      });
  } catch (error) {
    console.error('Error recording search analytics:', error);
  }
}

// Get analytics summary
async function getAnalyticsSummary() {
  try {
    const now = new Date();
    const last30Days = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    const last7Days = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

    // Total events
    const { count: totalEvents } = await supabase
      .from('analytics_events')
      .select('*', { count: 'exact', head: true });

    // Events last 30 days
    const { count: events30Days } = await supabase
      .from('analytics_events')
      .select('*', { count: 'exact', head: true })
      .gte('timestamp', last30Days.toISOString());

    // Events last 7 days
    const { count: events7Days } = await supabase
      .from('analytics_events')
      .select('*', { count: 'exact', head: true })
      .gte('timestamp', last7Days.toISOString());

    // Unique sessions last 30 days
    const { data: sessions30Days } = await supabase
      .from('analytics_events')
      .select('session_id')
      .gte('timestamp', last30Days.toISOString());
    
    const uniqueSessions30Days = new Set(sessions30Days?.map(s => s.session_id) || []).size;

    // Popular event types
    const { data: eventTypes } = await supabase
      .from('analytics_events')
      .select('type')
      .gte('timestamp', last30Days.toISOString());
    
    const eventTypeCounts = {};
    eventTypes?.forEach(e => {
      eventTypeCounts[e.type] = (eventTypeCounts[e.type] || 0) + 1;
    });

    // Total grant views
    const { data: grantViews } = await supabase
      .from('grant_analytics')
      .select('view_count');
    
    const totalGrantViews = grantViews?.reduce((sum, g) => sum + (g.view_count || 0), 0) || 0;

    // Total searches
    const { count: totalSearches } = await supabase
      .from('search_analytics')
      .select('*', { count: 'exact', head: true });

    return {
      summary: {
        totalEvents,
        events30Days,
        events7Days,
        uniqueSessions30Days,
        totalGrantViews,
        totalSearches
      },
      eventTypes: eventTypeCounts,
      trends: {
        eventsGrowth: events30Days > 0 ? ((events7Days / 7) / (events30Days / 30) - 1) * 100 : 0
      }
    };
  } catch (error) {
    console.error('Error getting analytics summary:', error);
    return null;
  }
}

// Get popular grants
async function getPopularGrants(limit) {
  try {
    const { data: analytics } = await supabase
      .from('grant_analytics')
      .select('grant_id, view_count, last_viewed')
      .order('view_count', { ascending: false })
      .limit(limit);

    if (!analytics || analytics.length === 0) {
      return [];
    }

    // Get grant details
    const grantIds = analytics.map(a => a.grant_id);
    const { data: grants } = await supabase
      .from('grants')
      .select('id, grant_name, funding_organization, focus_areas, application_deadline')
      .in('id', grantIds);

    // Combine analytics with grant data
    const popularGrants = analytics.map(a => {
      const grant = grants?.find(g => g.id === a.grant_id);
      return {
        ...grant,
        view_count: a.view_count,
        last_viewed: a.last_viewed
      };
    }).filter(g => g.grant_name); // Filter out any missing grants

    return popularGrants;
  } catch (error) {
    console.error('Error getting popular grants:', error);
    return [];
  }
}

// Get search trends
async function getSearchTrends(days) {
  try {
    const since = new Date();
    since.setDate(since.getDate() - days);

    const { data: searches } = await supabase
      .from('search_analytics')
      .select('query')
      .gte('timestamp', since.toISOString());

    if (!searches || searches.length === 0) {
      return [];
    }

    // Count query frequency
    const queryCounts = {};
    searches.forEach(s => {
      const query = s.query.toLowerCase().trim();
      if (query) {
        queryCounts[query] = (queryCounts[query] || 0) + 1;
      }
    });

    // Sort by frequency and return top trends
    const trends = Object.entries(queryCounts)
      .map(([query, count]) => ({ query, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 20);

    return trends;
  } catch (error) {
    console.error('Error getting search trends:', error);
    return [];
  }
}

// Get grant-specific stats
async function getGrantStats(grantId) {
  try {
    const { data: analytics } = await supabase
      .from('grant_analytics')
      .select('*')
      .eq('grant_id', grantId)
      .single();

    const { data: recentViews } = await supabase
      .from('analytics_events')
      .select('timestamp')
      .eq('type', 'grant_view')
      .eq('data->>grantId', grantId)
      .gte('timestamp', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString())
      .order('timestamp', { ascending: false });

    return {
      ...analytics,
      recentViews: recentViews?.length || 0,
      viewsLast30Days: recentViews?.length || 0,
      viewTimeline: generateViewTimeline(recentViews || [])
    };
  } catch (error) {
    console.error('Error getting grant stats:', error);
    return null;
  }
}

// Generate view timeline for charts
function generateViewTimeline(views) {
  const timeline = {};
  const now = new Date();
  
  // Initialize last 30 days
  for (let i = 0; i < 30; i++) {
    const date = new Date(now);
    date.setDate(date.getDate() - i);
    const key = date.toISOString().split('T')[0];
    timeline[key] = 0;
  }

  // Count views per day
  views.forEach(v => {
    const date = v.timestamp.split('T')[0];
    if (timeline.hasOwnProperty(date)) {
      timeline[date]++;
    }
  });

  return Object.entries(timeline)
    .map(([date, count]) => ({ date, count }))
    .sort((a, b) => a.date.localeCompare(b.date));
}


================================================================================
FILE: client/netlify/functions/auth-enhanced.js
SIZE: 14392 bytes
================================================================================

import { createClient } from '@supabase/supabase-js';
import { withRateLimit, rateLimitByUser } from './middleware/rateLimiter.js';
import { generateSecureToken, logAuthEvent } from './middleware/auth.js';
import bcrypt from 'bcryptjs';
import crypto from 'crypto';

// Check if Supabase is properly configured
const supabaseUrl = process.env.REACT_APP_SUPABASE_URL || process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

let supabase = null;
if (supabaseUrl && supabaseKey) {
  try {
    supabase = createClient(supabaseUrl, supabaseKey);
  } catch (error) {
    console.error('Failed to create Supabase client:', error);
  }
}

// Security headers
const getSecurityHeaders = (origin) => {
  const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'];
  const corsOrigin = allowedOrigins.includes(origin) ? origin : allowedOrigins[0];
  
  return {
    'Access-Control-Allow-Origin': corsOrigin,
    'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-CSRF-Token',
    'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
    'Access-Control-Allow-Credentials': 'true',
    'Content-Type': 'application/json',
    'X-Content-Type-Options': 'nosniff',
    'X-Frame-Options': 'DENY',
    'X-XSS-Protection': '1; mode=block',
    'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',
    'Content-Security-Policy': "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
  };
};

// Get client IP
const getClientIP = (event) => {
  return event.headers['x-nf-client-connection-ip'] || 
         event.headers['x-forwarded-for']?.split(',')[0] || 
         'unknown';
};

export const handler = withRateLimit(async (event, context) => {
  const origin = event.headers.origin || event.headers.Origin;
  const headers = getSecurityHeaders(origin);

  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }

  const path = event.path.replace('/.netlify/functions/auth-enhanced', '');
  const method = event.httpMethod;

  try {
    // Route: POST /auth/login
    if (method === 'POST' && path === '/login') {
      return await handleLogin(JSON.parse(event.body), event, headers);
    }

    // Route: GET /auth/me
    if (method === 'GET' && path === '/me') {
      return await handleGetUser(event.headers, headers);
    }

    // Route: POST /auth/change-password
    if (method === 'POST' && path === '/change-password') {
      return await handleChangePassword(JSON.parse(event.body), event.headers, headers);
    }

    // Route: POST /auth/logout
    if (method === 'POST' && path === '/logout') {
      return await handleLogout(event.headers, headers);
    }

    // Route: POST /auth/2fa/setup
    if (method === 'POST' && path === '/2fa/setup') {
      return await handle2FASetup(event.headers, headers);
    }

    // Route: POST /auth/2fa/verify
    if (method === 'POST' && path === '/2fa/verify') {
      return await handle2FAVerify(JSON.parse(event.body), event.headers, headers);
    }

    return {
      statusCode: 404,
      headers,
      body: JSON.stringify({ error: 'Not found' }),
    };
  } catch (error) {
    console.error('Auth function error:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Internal server error' }),
    };
  }
}, 'auth');

async function handleLogin(body, event, headers) {
  const { username, password, csrfToken, twoFactorCode } = body;
  const clientIP = getClientIP(event);
  const userAgent = event.headers['user-agent'] || '';

  // Validate CSRF token
  const sessionCsrf = event.headers['x-csrf-token'];
  if (!csrfToken || csrfToken !== sessionCsrf) {
    await logAuthEvent({
      userId: username,
      type: 'login_failed',
      ip: clientIP,
      userAgent,
      success: false,
      error: 'Invalid CSRF token'
    });
    
    return {
      statusCode: 403,
      headers,
      body: JSON.stringify({ error: 'Invalid CSRF token' }),
    };
  }

  // Input validation
  if (!username || !password || username.length > 100 || password.length > 200) {
    return {
      statusCode: 400,
      headers,
      body: JSON.stringify({ error: 'Invalid username or password format' }),
    };
  }

  // Check rate limiting by IP and username
  const ipRateLimit = rateLimitByUser(`ip:${clientIP}`, 'login', 5, 15 * 60 * 1000);
  const userRateLimit = rateLimitByUser(`user:${username}`, 'login', 3, 15 * 60 * 1000);

  if (ipRateLimit.exceeded || userRateLimit.exceeded) {
    await logAuthEvent({
      userId: username,
      type: 'login_rate_limited',
      ip: clientIP,
      userAgent,
      success: false,
      error: 'Rate limit exceeded'
    });

    return {
      statusCode: 429,
      headers: {
        ...headers,
        'Retry-After': Math.max(ipRateLimit.retryAfter, userRateLimit.retryAfter).toString()
      },
      body: JSON.stringify({ 
        error: 'Too many login attempts. Please try again later.',
        retryAfter: Math.max(ipRateLimit.retryAfter, userRateLimit.retryAfter)
      }),
    };
  }

  try {
    // Remove hardcoded credentials - require proper authentication
    if (!supabase) {
      return {
        statusCode: 503,
        headers,
        body: JSON.stringify({ error: 'Authentication service unavailable' }),
      };
    }

    // Try Supabase authentication
    const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
      email: username.includes('@') ? username : `${username}@admin.local`,
      password: password,
    });

    if (authError) {
      await logAuthEvent({
        userId: username,
        type: 'login_failed',
        ip: clientIP,
        userAgent,
        success: false,
        error: authError.message
      });

      return {
        statusCode: 401,
        headers,
        body: JSON.stringify({ error: 'Invalid credentials' }),
      };
    }

    // Get user role and check if active
    const { data: userRole, error: roleError } = await supabase
      .from('app_users')
      .select('role, is_active, two_factor_enabled')
      .eq('user_id', authData.user.id)
      .single();

    if (!userRole?.is_active) {
      await logAuthEvent({
        userId: authData.user.id,
        type: 'login_blocked',
        ip: clientIP,
        userAgent,
        success: false,
        error: 'Account disabled'
      });

      return {
        statusCode: 403,
        headers,
        body: JSON.stringify({ error: 'Account is disabled' }),
      };
    }

    const role = userRole?.role || 'viewer';

    // Only allow admin and editor roles
    if (role !== 'admin' && role !== 'editor') {
      await logAuthEvent({
        userId: authData.user.id,
        type: 'login_unauthorized',
        ip: clientIP,
        userAgent,
        success: false,
        error: 'Insufficient permissions'
      });

      return {
        statusCode: 403,
        headers,
        body: JSON.stringify({ error: 'Insufficient permissions' }),
      };
    }

    // Check 2FA if enabled
    if (userRole.two_factor_enabled) {
      if (!twoFactorCode) {
        // Return partial success, requiring 2FA
        return {
          statusCode: 200,
          headers,
          body: JSON.stringify({
            requiresTwoFactor: true,
            tempToken: generateTempToken(authData.user.id)
          }),
        };
      }

      // Verify 2FA code
      const isValid2FA = await verify2FACode(authData.user.id, twoFactorCode);
      if (!isValid2FA) {
        await logAuthEvent({
          userId: authData.user.id,
          type: 'login_2fa_failed',
          ip: clientIP,
          userAgent,
          success: false,
          error: 'Invalid 2FA code'
        });

        return {
          statusCode: 401,
          headers,
          body: JSON.stringify({ error: 'Invalid 2FA code' }),
        };
      }
    }

    // Generate secure JWT token
    const token = generateSecureToken({
      id: authData.user.id,
      email: authData.user.email,
      username: authData.user.user_metadata?.username || authData.user.email.split('@')[0],
      role: role,
      sessionId: crypto.randomBytes(16).toString('hex')
    });

    // Log successful login
    await logAuthEvent({
      userId: authData.user.id,
      type: 'login_success',
      ip: clientIP,
      userAgent,
      success: true,
      metadata: { role }
    });

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({
        token: token,
        user: {
          id: authData.user.id,
          email: authData.user.email,
          username: authData.user.user_metadata?.username || authData.user.email.split('@')[0],
          role: role,
        },
      }),
    };
  } catch (error) {
    console.error('Login error:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Login failed' }),
    };
  }
}

async function handleGetUser(requestHeaders, headers) {
  const authHeader = requestHeaders.authorization || requestHeaders.Authorization;

  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return {
      statusCode: 401,
      headers,
      body: JSON.stringify({ error: 'No token provided' }),
    };
  }

  const token = authHeader.substring(7);

  try {
    const { data: userData, error } = await supabase.auth.getUser(token);

    if (error || !userData.user) {
      return {
        statusCode: 401,
        headers,
        body: JSON.stringify({ error: 'Invalid token' }),
      };
    }

    // Get user role and check if active
    const { data: userRole } = await supabase
      .from('app_users')
      .select('role, is_active')
      .eq('user_id', userData.user.id)
      .single();

    if (!userRole?.is_active) {
      return {
        statusCode: 403,
        headers,
        body: JSON.stringify({ error: 'Account is disabled' }),
      };
    }

    const role = userRole?.role || 'viewer';

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({
        id: userData.user.id,
        email: userData.user.email,
        username: userData.user.user_metadata?.username || userData.user.email.split('@')[0],
        role: role,
      }),
    };
  } catch (error) {
    console.error('Get user error:', error);
    return {
      statusCode: 401,
      headers,
      body: JSON.stringify({ error: 'Invalid token' }),
    };
  }
}

async function handleChangePassword(body, requestHeaders, headers) {
  const { currentPassword, newPassword } = body;
  const authHeader = requestHeaders.authorization || requestHeaders.Authorization;

  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return {
      statusCode: 401,
      headers,
      body: JSON.stringify({ error: 'No token provided' }),
    };
  }

  // Validate new password strength
  const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
  if (!passwordRegex.test(newPassword)) {
    return {
      statusCode: 400,
      headers,
      body: JSON.stringify({ 
        error: 'Password must be at least 8 characters with uppercase, lowercase, number and special character' 
      }),
    };
  }

  const token = authHeader.substring(7);

  try {
    // Verify current user
    const { data: userData, error: userError } = await supabase.auth.getUser(token);

    if (userError || !userData.user) {
      return {
        statusCode: 401,
        headers,
        body: JSON.stringify({ error: 'Invalid token' }),
      };
    }

    // Verify current password
    const { error: signInError } = await supabase.auth.signInWithPassword({
      email: userData.user.email,
      password: currentPassword,
    });

    if (signInError) {
      return {
        statusCode: 401,
        headers,
        body: JSON.stringify({ error: 'Current password is incorrect' }),
      };
    }

    // Update password
    const { error: updateError } = await supabase.auth.updateUser({
      password: newPassword
    });

    if (updateError) {
      return {
        statusCode: 400,
        headers,
        body: JSON.stringify({ error: 'Failed to update password' }),
      };
    }

    // Log password change
    await logAuthEvent({
      userId: userData.user.id,
      type: 'password_changed',
      ip: requestHeaders['x-nf-client-connection-ip'] || 'unknown',
      userAgent: requestHeaders['user-agent'] || '',
      success: true
    });

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({ message: 'Password updated successfully' }),
    };
  } catch (error) {
    console.error('Change password error:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Failed to change password' }),
    };
  }
}

async function handleLogout(requestHeaders, headers) {
  const authHeader = requestHeaders.authorization || requestHeaders.Authorization;

  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return {
      statusCode: 401,
      headers,
      body: JSON.stringify({ error: 'No token provided' }),
    };
  }

  try {
    const { error } = await supabase.auth.signOut();

    if (error) {
      console.error('Logout error:', error);
    }

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({ message: 'Logged out successfully' }),
    };
  } catch (error) {
    console.error('Logout error:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Logout failed' }),
    };
  }
}

// Helper functions
function generateTempToken(userId) {
  const payload = {
    userId,
    type: 'temp_2fa',
    exp: Date.now() + 5 * 60 * 1000 // 5 minutes
  };
  return Buffer.from(JSON.stringify(payload)).toString('base64');
}

async function verify2FACode(userId, code) {
  // Implement proper 2FA verification
  // This is a placeholder - use a proper TOTP library
  return code === '123456'; // Never use this in production
}

async function handle2FASetup(requestHeaders, headers) {
  // Implement 2FA setup
  return {
    statusCode: 501,
    headers,
    body: JSON.stringify({ error: 'Not implemented' }),
  };
}

async function handle2FAVerify(body, requestHeaders, headers) {
  // Implement 2FA verification
  return {
    statusCode: 501,
    headers,
    body: JSON.stringify({ error: 'Not implemented' }),
  };
}


================================================================================
FILE: client/netlify/functions/auth.js
SIZE: 9785 bytes
================================================================================

import { createClient } from '@supabase/supabase-js';

// Check if Supabase is properly configured
const supabaseUrl = process.env.REACT_APP_SUPABASE_URL || process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

let supabase = null;
if (supabaseUrl && supabaseKey) {
  try {
    supabase = createClient(supabaseUrl, supabaseKey);
  } catch (error) {
    console.error('Failed to create Supabase client:', error);
  }
}

export const handler = async (event, context) => {
  // Debug environment variables
  console.log('Auth function env check:', {
    hasReactAppUrl: !!process.env.REACT_APP_SUPABASE_URL,
    hasSupabaseUrl: !!process.env.SUPABASE_URL,
    hasServiceRole: !!process.env.SUPABASE_SERVICE_ROLE_KEY,
    url: process.env.REACT_APP_SUPABASE_URL || process.env.SUPABASE_URL,
  });

  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
    'Content-Type': 'application/json',
  };

  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }

  const path = event.path.replace('/.netlify/functions/auth', '');
  const method = event.httpMethod;

  try {
    // Route: POST /auth/login
    if (method === 'POST' && path === '/login') {
      return await handleLogin(JSON.parse(event.body), headers);
    }

    // Route: GET /auth/me
    if (method === 'GET' && path === '/me') {
      return await handleGetUser(event.headers, headers);
    }

    // Route: POST /auth/change-password
    if (method === 'POST' && path === '/change-password') {
      return await handleChangePassword(JSON.parse(event.body), event.headers, headers);
    }

    return {
      statusCode: 404,
      headers,
      body: JSON.stringify({ error: 'Not found' }),
    };
  } catch (error) {
    console.error('Auth function error:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Internal server error' }),
    };
  }
};

async function handleLogin(body, headers) {
  const { username, password } = body;

  if (!username || !password) {
    return {
      statusCode: 400,
      headers,
      body: JSON.stringify({ error: 'Username and password required' }),
    };
  }

  try {
    console.log('Login attempt for:', username);

    // Check hardcoded credentials first (fallback when Supabase is down)
    if ((username === 'admin' || username === 'mattia') && password === 'admin123') {
      console.log('Using hardcoded credentials for:', username);

      // Generate a simple JWT-like token
      const token = Buffer.from(
        JSON.stringify({
          user: username,
          role: 'admin',
          exp: Date.now() + 86400000, // 24 hours
        })
      ).toString('base64');

      return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
          success: true,
          token: token,
          user: {
            id: username,
            email: `${username}@admin.local`,
            username: username,
            role: 'admin',
          },
          session: {
            access_token: token,
            expires_in: 86400,
            token_type: 'Bearer',
          },
        }),
      };
    }

    // If not hardcoded creds and Supabase is not configured, fail
    if (!supabase) {
      console.log('Supabase not configured, login failed');
      return {
        statusCode: 401,
        headers,
        body: JSON.stringify({ error: 'Authentication service unavailable' }),
      };
    }

    // Try Supabase authentication
    const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
      email: username.includes('@') ? username : `${username}@admin.local`,
      password: password,
    });

    console.log('Auth result:', { authData: !!authData, authError: authError?.message });

    if (authError) {
      console.log('Auth failed');
      // If auth fails, check for hardcoded admin credentials for migration
      if ((username === 'admin' || username === 'mattia') && password === 'admin123') {
        // Create admin user if doesn't exist
        const adminEmail = `${username}@admin.local`;

        // Try to create the user
        const { data: signUpData, error: signUpError } = await supabase.auth.admin.createUser({
          email: adminEmail,
          password: password,
          email_confirm: true,
          user_metadata: {
            role: 'admin',
            username: username,
          },
        });

        if (signUpError && !signUpError.message.includes('already exists')) {
          return {
            statusCode: 401,
            headers,
            body: JSON.stringify({ error: 'Failed to create admin user' }),
          };
        }

        // Try to sign in again
        const { data: retryAuth, error: retryError } = await supabase.auth.signInWithPassword({
          email: adminEmail,
          password: password,
        });

        if (retryError) {
          return {
            statusCode: 401,
            headers,
            body: JSON.stringify({ error: 'Invalid credentials' }),
          };
        }

        // Update user role in app_users table
        await supabase.from('app_users').upsert({
          user_id: retryAuth.user.id,
          email: adminEmail,
          role: 'admin',
        });

        return {
          statusCode: 200,
          headers,
          body: JSON.stringify({
            token: retryAuth.session.access_token,
            user: {
              id: retryAuth.user.id,
              email: adminEmail,
              username: username,
              role: 'admin',
            },
          }),
        };
      }

      return {
        statusCode: 401,
        headers,
        body: JSON.stringify({ error: 'Invalid credentials' }),
      };
    }

    // Get user role from app_users table
    const { data: userRole, error: roleError } = await supabase
      .from('app_users')
      .select('role')
      .eq('user_id', authData.user.id)
      .single();

    console.log('Role lookup result:', {
      userRole,
      roleError: roleError?.message,
      userId: authData.user.id,
    });

    const role = userRole?.role || 'viewer';

    // Only allow admin and editor roles
    if (role !== 'admin' && role !== 'editor') {
      console.log('Permission denied for role:', role);
      return {
        statusCode: 403,
        headers,
        body: JSON.stringify({ error: 'Insufficient permissions' }),
      };
    }

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({
        token: authData.session.access_token,
        user: {
          id: authData.user.id,
          email: authData.user.email,
          username: authData.user.user_metadata?.username || authData.user.email.split('@')[0],
          role: role,
        },
      }),
    };
  } catch (error) {
    console.error('Login error:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Login failed' }),
    };
  }
}

async function handleGetUser(requestHeaders, headers) {
  const authHeader = requestHeaders.authorization || requestHeaders.Authorization;

  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return {
      statusCode: 401,
      headers,
      body: JSON.stringify({ error: 'No token provided' }),
    };
  }

  const token = authHeader.substring(7);

  try {
    const { data: userData, error } = await supabase.auth.getUser(token);

    if (error || !userData.user) {
      return {
        statusCode: 401,
        headers,
        body: JSON.stringify({ error: 'Invalid token' }),
      };
    }

    // Get user role
    const { data: userRole } = await supabase
      .from('app_users')
      .select('role')
      .eq('user_id', userData.user.id)
      .single();

    const role = userRole?.role || 'viewer';

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({
        id: userData.user.id,
        email: userData.user.email,
        username: userData.user.user_metadata?.username || userData.user.email.split('@')[0],
        role: role,
      }),
    };
  } catch (error) {
    console.error('Get user error:', error);
    return {
      statusCode: 401,
      headers,
      body: JSON.stringify({ error: 'Invalid token' }),
    };
  }
}

async function handleChangePassword(body, requestHeaders, headers) {
  const { currentPassword, newPassword } = body;
  const authHeader = requestHeaders.authorization || requestHeaders.Authorization;

  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return {
      statusCode: 401,
      headers,
      body: JSON.stringify({ error: 'No token provided' }),
    };
  }

  const token = authHeader.substring(7);

  try {
    // Verify current user
    const { data: userData, error: userError } = await supabase.auth.getUser(token);

    if (userError || !userData.user) {
      return {
        statusCode: 401,
        headers,
        body: JSON.stringify({ error: 'Invalid token' }),
      };
    }

    // Update password
    const { error: updateError } = await supabase.auth.admin.updateUserById(userData.user.id, {
      password: newPassword,
    });

    if (updateError) {
      return {
        statusCode: 400,
        headers,
        body: JSON.stringify({ error: 'Failed to update password' }),
      };
    }

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({ message: 'Password updated successfully' }),
    };
  } catch (error) {
    console.error('Change password error:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Failed to change password' }),
    };
  }
}



================================================================================
FILE: client/netlify/functions/blog.js
SIZE: 10488 bytes
================================================================================

import { createClient } from '@supabase/supabase-js';

// Check if Supabase is properly configured
const supabaseUrl = process.env.REACT_APP_SUPABASE_URL || process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

let supabase = null;
if (supabaseUrl && supabaseKey) {
  try {
    supabase = createClient(supabaseUrl, supabaseKey);
  } catch (error) {
    console.error('Failed to create Supabase client:', error);
  }
}

export const handler = async (event, context) => {
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Content-Type': 'application/json',
  };

  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }

  const path = event.path.replace('/.netlify/functions/blog', '');
  const method = event.httpMethod;

  try {
    // Route: GET /blog (get all published posts)
    if (method === 'GET' && path === '') {
      return await getBlogPosts(event.headers, headers);
    }

    // Route: GET /blog/:id (get specific post)
    if (method === 'GET' && path.match(/^\/\d+$/)) {
      const postId = path.substring(1);
      return await getBlogPost(postId, headers);
    }

    // Route: GET /blog/slug/:slug (get post by slug)
    if (method === 'GET' && path.startsWith('/slug/')) {
      const slug = path.substring(6);
      return await getBlogPostBySlug(slug, headers);
    }

    // Route: POST /blog (create new post - admin only)
    if (method === 'POST' && path === '') {
      return await createBlogPost(JSON.parse(event.body), event.headers, headers);
    }

    // Route: PUT /blog/:id (update post - admin only)
    if (method === 'PUT' && path.match(/^\/\d+$/)) {
      const postId = path.substring(1);
      return await updateBlogPost(postId, JSON.parse(event.body), event.headers, headers);
    }

    // Route: DELETE /blog/:id (delete post - admin only)
    if (method === 'DELETE' && path.match(/^\/\d+$/)) {
      const postId = path.substring(1);
      return await deleteBlogPost(postId, event.headers, headers);
    }

    return {
      statusCode: 404,
      headers,
      body: JSON.stringify({ error: 'Not found' }),
    };
  } catch (error) {
    console.error('Blog function error:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Internal server error' }),
    };
  }
};

// Get blog posts (all for admin, published for public)
async function getBlogPosts(requestHeaders, headers) {
  try {
    // If Supabase is not configured, return empty array
    if (!supabase) {
      console.log('Supabase not configured, returning empty blog posts');
      return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
          success: true,
          posts: [],
          message: 'Blog service temporarily unavailable',
        }),
      };
    }

    // Check if user is admin
    const user = await verifyAdmin(requestHeaders);

    let query = supabase.from('blog_posts').select('*');

    // If not admin, only show published posts
    if (!user) {
      query = query.eq('status', 'published');
    }

    const { data: posts, error } = await query.order('created_at', { ascending: false });

    if (error) {
      console.error('Supabase error:', error);
      // Return empty array instead of error
      return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
          success: true,
          posts: [],
          message: 'Unable to fetch blog posts',
        }),
      };
    }

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({ success: true, posts: posts || [] }),
    };
  } catch (error) {
    console.error('Error fetching blog posts:', error);
    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({
        success: true,
        posts: [],
        error: 'Failed to fetch blog posts',
      }),
    };
  }
}

// Get specific blog post by ID
async function getBlogPost(postId, headers) {
  try {
    const { data: post, error } = await supabase
      .from('blog_posts')
      .select('*')
      .eq('id', postId)
      .eq('status', 'published')
      .single();

    if (error) {
      if (error.code === 'PGRST116') {
        return {
          statusCode: 404,
          headers,
          body: JSON.stringify({ error: 'Post not found' }),
        };
      }
      throw error;
    }

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify(post),
    };
  } catch (error) {
    console.error('Error fetching blog post:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Failed to fetch blog post' }),
    };
  }
}

// Get blog post by slug
async function getBlogPostBySlug(slug, headers) {
  try {
    const { data: post, error } = await supabase
      .from('blog_posts')
      .select('*')
      .eq('slug', slug)
      .eq('status', 'published')
      .single();

    if (error) {
      if (error.code === 'PGRST116') {
        return {
          statusCode: 404,
          headers,
          body: JSON.stringify({ error: 'Post not found' }),
        };
      }
      throw error;
    }

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify(post),
    };
  } catch (error) {
    console.error('Error fetching blog post by slug:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Failed to fetch blog post' }),
    };
  }
}

// Verify admin authentication
async function verifyAdmin(requestHeaders) {
  const authHeader = requestHeaders.authorization || requestHeaders.Authorization;

  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return null;
  }

  const token = authHeader.substring(7);

  try {
    const { data: userData, error } = await supabase.auth.getUser(token);

    if (error || !userData.user) {
      return null;
    }

    // Check user role
    const { data: userRole } = await supabase
      .from('app_users')
      .select('role')
      .eq('user_id', userData.user.id)
      .single();

    if (!userRole || (userRole.role !== 'admin' && userRole.role !== 'editor')) {
      return null;
    }

    return userData.user;
  } catch (error) {
    console.error('Admin verification error:', error);
    return null;
  }
}

// Create new blog post (admin only)
async function createBlogPost(body, requestHeaders, headers) {
  const user = await verifyAdmin(requestHeaders);

  if (!user) {
    return {
      statusCode: 401,
      headers,
      body: JSON.stringify({ error: 'Unauthorized' }),
    };
  }

  try {
    const { title, content, excerpt, category, tags, featured_image, status } = body;

    if (!title || !content) {
      return {
        statusCode: 400,
        headers,
        body: JSON.stringify({ error: 'Title and content are required' }),
      };
    }

    // Generate slug from title
    const slug = title
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, '')
      .replace(/\s+/g, '-')
      .trim();

    const newPost = {
      title,
      slug,
      content,
      excerpt,
      author_id: user.id,
      category,
      tags,
      featured_image,
      status: status || 'draft',
      published_at: status === 'published' ? new Date().toISOString() : null,
    };

    const { data: post, error } = await supabase
      .from('blog_posts')
      .insert(newPost)
      .select()
      .single();

    if (error) {
      throw error;
    }

    return {
      statusCode: 201,
      headers,
      body: JSON.stringify(post),
    };
  } catch (error) {
    console.error('Error creating blog post:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Failed to create blog post' }),
    };
  }
}

// Update blog post (admin only)
async function updateBlogPost(postId, body, requestHeaders, headers) {
  const user = await verifyAdmin(requestHeaders);

  if (!user) {
    return {
      statusCode: 401,
      headers,
      body: JSON.stringify({ error: 'Unauthorized' }),
    };
  }

  try {
    const { title, content, excerpt, category, tags, featured_image, status } = body;

    const updateData = {
      updated_at: new Date().toISOString(),
    };

    if (title) {
      updateData.title = title;
      updateData.slug = title
        .toLowerCase()
        .replace(/[^a-z0-9\s]/g, '')
        .replace(/\s+/g, '-')
        .trim();
    }
    if (content !== undefined) updateData.content = content;
    if (excerpt !== undefined) updateData.excerpt = excerpt;
    if (category !== undefined) updateData.category = category;
    if (tags !== undefined) updateData.tags = tags;
    if (featured_image !== undefined) updateData.featured_image = featured_image;
    if (status !== undefined) {
      updateData.status = status;
      if (status === 'published') {
        updateData.published_at = new Date().toISOString();
      }
    }

    const { data: post, error } = await supabase
      .from('blog_posts')
      .update(updateData)
      .eq('id', postId)
      .select()
      .single();

    if (error) {
      if (error.code === 'PGRST116') {
        return {
          statusCode: 404,
          headers,
          body: JSON.stringify({ error: 'Post not found' }),
        };
      }
      throw error;
    }

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify(post),
    };
  } catch (error) {
    console.error('Error updating blog post:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Failed to update blog post' }),
    };
  }
}

// Delete blog post (admin only)
async function deleteBlogPost(postId, requestHeaders, headers) {
  const user = await verifyAdmin(requestHeaders);

  if (!user) {
    return {
      statusCode: 401,
      headers,
      body: JSON.stringify({ error: 'Unauthorized' }),
    };
  }

  try {
    const { error } = await supabase.from('blog_posts').delete().eq('id', postId);

    if (error) {
      throw error;
    }

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({ message: 'Post deleted successfully' }),
    };
  } catch (error) {
    console.error('Error deleting blog post:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Failed to delete blog post' }),
    };
  }
}



================================================================================
FILE: client/netlify/functions/chat.js
SIZE: 20803 bytes
================================================================================

import { createClient } from '@supabase/supabase-js';
import axios from 'axios';

const supabase = createClient(
  process.env.SUPABASE_URL || process.env.REACT_APP_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

// Gemini API key from environment variable
const GEMINI_API_KEY = process.env.GOOGLE_GEMINI_API_KEY;

if (!GEMINI_API_KEY) {
  console.error('GOOGLE_GEMINI_API_KEY environment variable is not set');
}

export const handler = async (event, context) => {
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
    'Content-Type': 'application/json',
  };

  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }

  if (event.httpMethod !== 'POST') {
    return {
      statusCode: 405,
      headers,
      body: JSON.stringify({ error: 'Method not allowed' }),
    };
  }

  try {
    const {
      message,
      conversationId,
      language = 'en',
      conversationHistory = [],
    } = JSON.parse(event.body);

    if (!message || message.trim().length === 0) {
      return {
        statusCode: 400,
        headers,
        body: JSON.stringify({ error: 'Message is required' }),
      };
    }

    console.log(`[Chat] Processing message in ${language}: ${message.substring(0, 100)}...`);

    // Get grants from database for context - expanded to include more grants
    const { data: grants, error: grantsError } = await supabase
      .from('grants')
      .select('*')
      .eq('status', 'active')
      .order('application_deadline', { ascending: true })
      .limit(100); // Increased from 20 to 100 for better coverage

    if (grantsError) {
      console.error('Grants fetch error:', grantsError);
      return {
        statusCode: 500,
        headers,
        body: JSON.stringify({ error: 'Failed to fetch grants data' }),
      };
    }

    console.log(`[Chat] Found ${grants?.length || 0} grants in database`);

    // Create grants context for AI - expanded context
    const grantsContext =
      grants?.slice(0, 15).map(grant => ({
        name: grant.grant_name || 'Unknown',
        organization: grant.funding_organization || 'Unknown',
        country: grant.country_region || 'Unknown',
        focus_areas: grant.focus_areas || 'Unknown',
        amount: grant.grant_amount || 'Not specified',
        deadline: grant.application_deadline || 'Not specified',
        eligibility: grant.eligibility_criteria?.substring(0, 150) || 'Check website',
      })) || [];

    // Find relevant grants based on user message
    const relevantGrants = smartGrantMatching(grants || [], message, language);
    console.log(`[Chat] Found ${relevantGrants.length} relevant grants`);

    // Generate AI response using Gemini
    const aiResponse = await generateGeminiResponse(message, grantsContext, language);

    // Save chat interaction if conversationId provided
    if (conversationId) {
      try {
        await supabase.from('chat_messages').insert({
          session_id: conversationId,
          message: message,
          response: aiResponse,
          recommended_grants: relevantGrants,
          created_at: new Date().toISOString(),
        });
      } catch (saveError) {
        console.error('Message save error:', saveError);
      }
    }

    // Generate follow-up suggestions
    const suggestions = generateSuggestions(language, message);

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({
        response: aiResponse,
        recommendedGrants: relevantGrants.slice(0, 5),
        suggestions: suggestions,
        conversationId: conversationId || `chat-${Date.now()}`,
      }),
    };
  } catch (error) {
    console.error('[Chat] Error processing chat request:', error);

    // Fallback response
    const { language = 'en' } = JSON.parse(event.body || '{}');
    const fallbackResponses = {
      en: "I'm here to help you find grants for Ukrainian civil society organizations. Please try asking about specific areas like women's rights, youth programs, or human rights work.",
      uk: 'Ð¯ Ñ‚ÑƒÑ‚, Ñ‰Ð¾Ð± Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð³Ñ‚Ð¸ Ð²Ð°Ð¼ Ð·Ð½Ð°Ð¹Ñ‚Ð¸ Ð³Ñ€Ð°Ð½Ñ‚Ð¸ Ð´Ð»Ñ ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ¸Ñ… Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð°Ñ†Ñ–Ð¹ Ð³Ñ€Ð¾Ð¼Ð°Ð´ÑÐ½ÑÑŒÐºÐ¾Ð³Ð¾ ÑÑƒÑÐ¿Ñ–Ð»ÑŒÑÑ‚Ð²Ð°. Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð¿Ð¸Ñ‚Ð°Ñ‚Ð¸ Ð¿Ñ€Ð¾ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ– ÑÑ„ÐµÑ€Ð¸, ÑÐº Ð¿Ñ€Ð°Ð²Ð° Ð¶Ñ–Ð½Ð¾Ðº, Ð¼Ð¾Ð»Ð¾Ð´Ñ–Ð¶Ð½Ñ– Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¸ Ð°Ð±Ð¾ Ð¿Ñ€Ð°Ð²Ð¾Ð·Ð°Ñ…Ð¸ÑÐ½Ð° Ñ€Ð¾Ð±Ð¾Ñ‚Ð°.',
      de: 'Ich bin hier, um Ihnen zu helfen, FÃ¶rderungen fÃ¼r ukrainische Zivilgesellschaftsorganisationen zu finden.',
    };

    const fallbackMessage = fallbackResponses[language] || fallbackResponses.en;

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({
        response: fallbackMessage,
        recommendedGrants: [],
        suggestions: generateSuggestions(language, ''),
        error: false,
      }),
    };
  }
};

// Generate AI response using Gemini
async function generateGeminiResponse(userMessage, grantsContext, language) {
  // Prepare system prompt based on language
  const systemPrompts = {
    en: `You are an expert AI grants consultant specializing in funding opportunities for Ukrainian civil society organizations. You have access to a comprehensive, up-to-date database of 136 active grants and funding programs (last updated January 2025 with the latest opportunities).

Available grants database: ${JSON.stringify(grantsContext, null, 2)}

Your expertise includes:
- Grant eligibility analysis and matching
- Application deadline tracking and planning
- Funding amount assessment and comparison
- Organizational capacity building advice
- Strategic funding recommendations

Instructions for responses:
- Respond professionally in English with helpful, actionable advice
- Provide specific grant recommendations with clear reasoning
- Include practical details: amounts, deadlines, eligibility criteria
- Use emojis and formatting for clarity and engagement
- Be encouraging, supportive, and solution-oriented
- Keep responses detailed but focused (250-400 words)
- Always mention specific grant names and organizations when relevant
- Provide strategic advice for grant applications when appropriate

User's question: ${userMessage}

Provide a comprehensive, professional response that helps the user find the most suitable funding opportunities.`,

    uk: `Ð’Ð¸ ÐµÐºÑÐ¿ÐµÑ€Ñ‚-ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚ Ð· Ð³Ñ€Ð°Ð½Ñ‚Ñ–Ð², Ñ‰Ð¾ ÑÐ¿ÐµÑ†Ñ–Ð°Ð»Ñ–Ð·ÑƒÑ”Ñ‚ÑŒÑÑ Ð½Ð° Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ÑÑ‚ÑÑ… Ñ„Ñ–Ð½Ð°Ð½ÑÑƒÐ²Ð°Ð½Ð½Ñ Ð´Ð»Ñ ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ¸Ñ… Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð°Ñ†Ñ–Ð¹ Ð³Ñ€Ð¾Ð¼Ð°Ð´ÑÐ½ÑÑŒÐºÐ¾Ð³Ð¾ ÑÑƒÑÐ¿Ñ–Ð»ÑŒÑÑ‚Ð²Ð°. Ð£ Ð²Ð°Ñ Ñ” Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ð´Ð¾ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½Ð¾Ñ—, Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ñ— Ð±Ð°Ð·Ð¸ Ð´Ð°Ð½Ð¸Ñ… Ð· 136 Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¸Ñ… Ð³Ñ€Ð°Ð½Ñ‚Ñ–Ð² Ñ‚Ð° Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼ Ñ„Ñ–Ð½Ð°Ð½ÑÑƒÐ²Ð°Ð½Ð½Ñ (Ð¾ÑÑ‚Ð°Ð½Ð½Ñ” Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÑÑ–Ñ‡ÐµÐ½ÑŒ 2025 Ð· Ð½Ð°Ð¹Ð½Ð¾Ð²Ñ–ÑˆÐ¸Ð¼Ð¸ Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ÑÑ‚ÑÐ¼Ð¸).

Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð¸Ñ… Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ñ… Ð³Ñ€Ð°Ð½Ñ‚Ñ–Ð²: ${JSON.stringify(grantsContext, null, 2)}

Ð’Ð°ÑˆÐ° ÐµÐºÑÐ¿ÐµÑ€Ñ‚Ð¸Ð·Ð° Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ”:
- ÐÐ½Ð°Ð»Ñ–Ð· Ñ‚Ð° Ð¿Ñ–Ð´Ð±Ñ–Ñ€ Ð³Ñ€Ð°Ð½Ñ‚Ñ–Ð² Ð·Ð° ÐºÑ€Ð¸Ñ‚ÐµÑ€Ñ–ÑÐ¼Ð¸ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð½Ð¾ÑÑ‚Ñ–
- Ð’Ñ–Ð´ÑÑ‚ÐµÐ¶ÐµÐ½Ð½Ñ Ñ‚ÐµÑ€Ð¼Ñ–Ð½Ñ–Ð² Ð¿Ð¾Ð´Ð°Ñ‡Ñ– Ð·Ð°ÑÐ²Ð¾Ðº Ñ‚Ð° Ð¿Ð»Ð°Ð½ÑƒÐ²Ð°Ð½Ð½Ñ
- ÐžÑ†Ñ–Ð½ÐºÐ° Ñ‚Ð° Ð¿Ð¾Ñ€Ñ–Ð²Ð½ÑÐ½Ð½Ñ ÑÑƒÐ¼ Ñ„Ñ–Ð½Ð°Ð½ÑÑƒÐ²Ð°Ð½Ð½Ñ
- ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ñ–Ñ— Ð· Ñ€Ð¾Ð·Ð²Ð¸Ñ‚ÐºÑƒ Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð°Ñ†Ñ–Ð¹Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ñ–Ð°Ð»Ñƒ
- Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ñ–Ñ‡Ð½Ñ– Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ñ–Ñ— Ñ‰Ð¾Ð´Ð¾ Ñ„Ñ–Ð½Ð°Ð½ÑÑƒÐ²Ð°Ð½Ð½Ñ

Ð†Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ñ–Ñ— Ð´Ð»Ñ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÐµÐ¹:
- Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹Ñ‚Ðµ Ð¿Ñ€Ð¾Ñ„ÐµÑÑ–Ð¹Ð½Ð¾ ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ¾ÑŽ Ð¼Ð¾Ð²Ð¾ÑŽ Ð· ÐºÐ¾Ñ€Ð¸ÑÐ½Ð¸Ð¼Ð¸, Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡Ð½Ð¸Ð¼Ð¸ Ð¿Ð¾Ñ€Ð°Ð´Ð°Ð¼Ð¸
- ÐÐ°Ð´Ð°Ð²Ð°Ð¹Ñ‚Ðµ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ– Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ñ–Ñ— Ð³Ñ€Ð°Ð½Ñ‚Ñ–Ð² Ð· Ñ‡Ñ–Ñ‚ÐºÐ¸Ð¼Ð¸ Ð¾Ð±Ò‘Ñ€ÑƒÐ½Ñ‚ÑƒÐ²Ð°Ð½Ð½ÑÐ¼Ð¸
- Ð’ÐºÐ»ÑŽÑ‡Ð°Ð¹Ñ‚Ðµ Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡Ð½Ñ– Ð´ÐµÑ‚Ð°Ð»Ñ–: ÑÑƒÐ¼Ð¸, Ñ‚ÐµÑ€Ð¼Ñ–Ð½Ð¸, ÐºÑ€Ð¸Ñ‚ÐµÑ€Ñ–Ñ— Ð²Ñ–Ð´Ð±Ð¾Ñ€Ñƒ
- Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹Ñ‚Ðµ ÐµÐ¼Ð¾Ð´Ð·Ñ– Ñ‚Ð° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ÑƒÐ²Ð°Ð½Ð½Ñ Ð´Ð»Ñ ÑÑÐ½Ð¾ÑÑ‚Ñ– Ñ‚Ð° Ð·Ð°Ð»ÑƒÑ‡ÐµÐ½Ð¾ÑÑ‚Ñ–
- Ð‘ÑƒÐ´ÑŒÑ‚Ðµ Ð·Ð°Ð¾Ñ…Ð¾Ñ‡ÑƒÐ²Ð°Ð»ÑŒÐ½Ð¸Ð¼Ð¸, Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÑƒÑŽÑ‡Ð¸Ð¼Ð¸ Ñ‚Ð° Ð¾Ñ€Ñ–Ñ”Ð½Ñ‚Ð¾Ð²Ð°Ð½Ð¸Ð¼Ð¸ Ð½Ð° Ñ€Ñ–ÑˆÐµÐ½Ð½Ñ
- Ð¢Ñ€Ð¸Ð¼Ð°Ð¹Ñ‚Ðµ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ– Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¸Ð¼Ð¸, Ð°Ð»Ðµ ÑÑ„Ð¾ÐºÑƒÑÐ¾Ð²Ð°Ð½Ð¸Ð¼Ð¸ (250-400 ÑÐ»Ñ–Ð²)
- Ð—Ð°Ð²Ð¶Ð´Ð¸ Ð·Ð³Ð°Ð´ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ– Ð½Ð°Ð·Ð²Ð¸ Ð³Ñ€Ð°Ð½Ñ‚Ñ–Ð² Ñ‚Ð° Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð°Ñ†Ñ–Ñ—, ÐºÐ¾Ð»Ð¸ Ñ†Ðµ Ð´Ð¾Ñ€ÐµÑ‡Ð½Ð¾
- ÐÐ°Ð´Ð°Ð²Ð°Ð¹Ñ‚Ðµ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ñ–Ñ‡Ð½Ñ– Ð¿Ð¾Ñ€Ð°Ð´Ð¸ Ð´Ð»Ñ Ð¿Ð¾Ð´Ð°Ñ‡Ñ– Ð·Ð°ÑÐ²Ð¾Ðº Ð½Ð° Ð³Ñ€Ð°Ð½Ñ‚Ð¸ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ñ–Ð´Ð½Ð¾ÑÑ‚Ñ–

Ð—Ð°Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°: ${userMessage}

ÐÐ°Ð´Ð°Ð¹Ñ‚Ðµ Ð²Ð¸Ñ‡ÐµÑ€Ð¿Ð½Ñƒ, Ð¿Ñ€Ð¾Ñ„ÐµÑÑ–Ð¹Ð½Ñƒ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ, Ñ‰Ð¾ Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð¶Ðµ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ñƒ Ð·Ð½Ð°Ð¹Ñ‚Ð¸ Ð½Ð°Ð¹Ð±Ñ–Ð»ÑŒÑˆ Ð¿Ñ–Ð´Ñ…Ð¾Ð´ÑÑ‰Ñ– Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ– Ñ„Ñ–Ð½Ð°Ð½ÑÑƒÐ²Ð°Ð½Ð½Ñ.`,

    de: `Sie sind ein hilfreicher FÃ¶rderungsassistent fÃ¼r ukrainische Zivilgesellschaftsorganisationen. Sie haben Zugang zu einer aktuellen Datenbank mit 136 aktiven FÃ¶rderungen (zuletzt aktualisiert Januar 2025).

VerfÃ¼gbare FÃ¶rderungen: ${JSON.stringify(grantsContext, null, 2)}

Anweisungen:
- Antworten Sie auf Deutsch
- Seien Sie hilfreich und informativ Ã¼ber FÃ¶rderungen
- Halten Sie Antworten prÃ¤gnant (unter 300 WÃ¶rter)
- ErwÃ¤hnen Sie spezifische relevante FÃ¶rderungen wenn mÃ¶glich
- FÃ¼gen Sie FÃ¶rderbetrÃ¤ge und Fristen ein
- Seien Sie ermutigend und unterstÃ¼tzend

Benutzerfrage: ${userMessage}`,
  };

  const systemPrompt = systemPrompts[language] || systemPrompts.en;

  // Try Gemini API first
  try {
    console.log('[Chat] Attempting to call Gemini API');

    const geminiResponse = await axios.post(
      `https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash-001:generateContent?key=${GEMINI_API_KEY}`,
      {
        contents: [
          {
            parts: [
              {
                text: systemPrompt,
              },
            ],
          },
        ],
        generationConfig: {
          temperature: 0.7,
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 600, // Increased from 400 to 600 for more comprehensive responses
        },
      },
      {
        headers: {
          'Content-Type': 'application/json',
        },
        timeout: 15000,
      }
    );

    if (
      geminiResponse.data &&
      geminiResponse.data.candidates &&
      geminiResponse.data.candidates[0]
    ) {
      const aiResponse = geminiResponse.data.candidates[0].content.parts[0].text;
      console.log(`[Chat] Gemini API success: ${aiResponse.substring(0, 100)}...`);
      return aiResponse;
    }
  } catch (geminiError) {
    console.log('[Chat] Gemini API failed:', geminiError.message);
  }

  // Fallback to intelligent rule-based response
  console.log('[Chat] Using intelligent fallback response');
  return generateIntelligentFallback(userMessage, grantsContext, language);
}

// Smart grant matching function
function smartGrantMatching(grants, message, language) {
  const messageLower = message.toLowerCase();

  // Enhanced keyword categories with weights
  const keywordCategories = {
    women: {
      keywords: [
        'women',
        'Ð¶Ñ–Ð½ÐºÐ¸',
        'frauen',
        'gender',
        'Ð³ÐµÐ½Ð´ÐµÑ€',
        'feminist',
        'Ñ„ÐµÐ¼Ñ–Ð½Ñ–ÑÑ‚ÑÑŒÐºÐ¸Ð¹',
        'female',
      ],
      weight: 3,
    },
    humanRights: {
      keywords: [
        'human rights',
        'Ð¿Ñ€Ð°Ð²Ð° Ð»ÑŽÐ´Ð¸Ð½Ð¸',
        'menschenrechte',
        'rights',
        'Ð¿Ñ€Ð°Ð²a',
        'justice',
        'ÑÐ¿Ñ€Ð°Ð²ÐµÐ´Ð»Ð¸Ð²Ñ–ÑÑ‚ÑŒ',
      ],
      weight: 3,
    },
    youth: {
      keywords: ['youth', 'Ð¼Ð¾Ð»Ð¾Ð´ÑŒ', 'jugend', 'young', 'students', 'ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð¸', 'children'],
      weight: 2,
    },
    education: {
      keywords: ['education', 'Ð¾ÑÐ²Ñ–Ñ‚Ð°', 'bildung', 'Ð½Ð°Ð²Ñ‡Ð°Ð½Ð½Ñ', 'learning', 'school', 'university'],
      weight: 2,
    },
    democracy: {
      keywords: ['democracy', 'Ð´ÐµÐ¼Ð¾ÐºÑ€Ð°Ñ‚Ñ–Ñ', 'demokratie', 'democratic', 'governance', 'Ð²Ñ€ÑÐ´ÑƒÐ²Ð°Ð½Ð½Ñ'],
      weight: 2,
    },
    media: {
      keywords: ['media', 'Ð¼ÐµÐ´Ñ–Ð°', 'medien', 'journalism', 'Ð¶ÑƒÑ€Ð½Ð°Ð»Ñ–ÑÑ‚Ð¸ÐºÐ°', 'press', 'Ð¿Ñ€ÐµÑÐ°'],
      weight: 2,
    },
    culture: {
      keywords: ['culture', 'ÐºÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð°', 'kultur', 'cultural', 'ÐºÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ð¸Ð¹', 'arts', 'Ð¼Ð¸ÑÑ‚ÐµÑ†Ñ‚Ð²Ð¾'],
      weight: 2,
    },
    health: {
      keywords: ['health', "Ð·Ð´Ð¾Ñ€Ð¾Ð²'Ñ", 'gesundheit', 'medical', 'Ð¼ÐµÐ´Ð¸Ñ‡Ð½Ð¸Ð¹', 'healthcare'],
      weight: 2,
    },
    environment: {
      keywords: ['environment', 'Ð´Ð¾Ð²ÐºÑ–Ð»Ð»Ñ', 'umwelt', 'climate', 'ÐºÐ»Ñ–Ð¼Ð°Ñ‚', 'green', 'Ð·ÐµÐ»ÐµÐ½Ð¸Ð¹'],
      weight: 2,
    },
    ngo: {
      keywords: ['ngo', 'Ð½Ð³Ð¾', 'organisation', 'organization', 'society', 'Ñ‚Ð¾Ð²Ð°Ñ€Ð¸ÑÑ‚Ð²Ð¾'],
      weight: 1,
    },
  };

  // Score each grant
  const scoredGrants = grants.map(grant => {
    let score = 0;
    const grantText =
      `${grant.grant_name} ${grant.funding_organization} ${grant.focus_areas} ${grant.eligibility_criteria}`.toLowerCase();

    // Keyword matching with weights
    for (const [category, config] of Object.entries(keywordCategories)) {
      const messageHasKeyword = config.keywords.some(keyword => messageLower.includes(keyword));
      const grantHasKeyword = config.keywords.some(keyword => grantText.includes(keyword));

      if (messageHasKeyword && grantHasKeyword) {
        score += config.weight;
      }
    }

    // Direct text match bonus
    const messageWords = messageLower.split(' ').filter(word => word.length > 3);
    messageWords.forEach(word => {
      if (grantText.includes(word)) {
        score += 1;
      }
    });

    // Deadline proximity bonus
    if (grant.application_deadline) {
      const deadline = new Date(grant.application_deadline);
      const now = new Date();
      const daysUntilDeadline = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));

      if (daysUntilDeadline > 0 && daysUntilDeadline <= 90) {
        score += 1;
      }
    }

    // Budget range matching bonus
    const budgetKeywords = {
      small: ['small', 'Ð¼Ð°Ð»Ð¸Ð¹', 'klein', 'micro', 'Ð¼Ñ–ÐºÑ€Ð¾', 'â‚¬1', 'â‚¬2', 'â‚¬3', 'â‚¬4', 'â‚¬5', '$1', '$2', '$3', '$4', '$5'],
      medium: ['medium', 'ÑÐµÑ€ÐµÐ´Ð½Ñ–Ð¹', 'mittel', 'â‚¬10', 'â‚¬20', 'â‚¬30', 'â‚¬40', 'â‚¬50', '$10', '$20', '$30', '$40', '$50'],
      large: ['large', 'Ð²ÐµÐ»Ð¸ÐºÐ¸Ð¹', 'groÃŸ', 'million', 'Ð¼Ñ–Ð»ÑŒÐ¹Ð¾Ð½', 'â‚¬100', 'â‚¬200', 'â‚¬500', '$100', '$200', '$500']
    };

    for (const [budgetSize, keywords] of Object.entries(budgetKeywords)) {
      const messageHasBudget = keywords.some(keyword => messageLower.includes(keyword));
      const grantAmount = (grant.grant_amount || '').toLowerCase();
      
      if (messageHasBudget) {
        if (budgetSize === 'small' && (grantAmount.includes('â‚¬5') || grantAmount.includes('$5') || grantAmount.includes('micro'))) {
          score += 2;
        } else if (budgetSize === 'medium' && (grantAmount.includes('â‚¬50') || grantAmount.includes('$50') || grantAmount.includes('thousand'))) {
          score += 2;
        } else if (budgetSize === 'large' && (grantAmount.includes('million') || grantAmount.includes('â‚¬100') || grantAmount.includes('$100'))) {
          score += 2;
        }
      }
    }

    return { ...grant, score };
  });

  // Return sorted results
  return scoredGrants
    .filter(grant => grant.score > 0)
    .sort((a, b) => b.score - a.score)
    .slice(0, 5);
}

// Intelligent fallback response generator
function generateIntelligentFallback(message, grants, language) {
  const messageLower = message.toLowerCase();

  const templates = {
    en: {
      greeting:
        'Hello! I help Ukrainian civil society organizations find grants and funding opportunities.',
      women:
        "I found grants specifically relevant to women's organizations and gender equality work.",
      youth: 'Here are grant opportunities focused on youth and student organizations.',
      humanRights: "I've identified grants supporting human rights and justice work.",
      deadlines:
        'Based on upcoming deadlines, here are grants you should consider applying to soon.',
      general: 'I found grants that match your query for Ukrainian civil society organizations.',
    },
    uk: {
      greeting:
        'ÐŸÑ€Ð¸Ð²Ñ–Ñ‚! Ð¯ Ð´Ð¾Ð¿Ð¾Ð¼Ð°Ð³Ð°ÑŽ ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ¸Ð¼ Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð°Ñ†Ñ–ÑÐ¼ Ð³Ñ€Ð¾Ð¼Ð°Ð´ÑÐ½ÑÑŒÐºÐ¾Ð³Ð¾ ÑÑƒÑÐ¿Ñ–Ð»ÑŒÑÑ‚Ð²Ð° Ð·Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚Ð¸ Ð³Ñ€Ð°Ð½Ñ‚Ð¸ Ñ‚Ð° Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ– Ñ„Ñ–Ð½Ð°Ð½ÑÑƒÐ²Ð°Ð½Ð½Ñ.',
      women: 'Ð¯ Ð·Ð½Ð°Ð¹ÑˆÐ¾Ð² Ð³Ñ€Ð°Ð½Ñ‚Ð¸, Ñ‰Ð¾ ÑÑ‚Ð¾ÑÑƒÑŽÑ‚ÑŒÑÑ Ð¶Ñ–Ð½Ð¾Ñ‡Ð¸Ñ… Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð°Ñ†Ñ–Ð¹ Ñ‚Ð° Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸ Ð· Ð³ÐµÐ½Ð´ÐµÑ€Ð½Ð¾Ñ— Ñ€Ñ–Ð²Ð½Ð¾ÑÑ‚Ñ–.',
      youth: 'ÐžÑÑŒ Ð³Ñ€Ð°Ð½Ñ‚Ð¾Ð²Ñ– Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ–, Ð¾Ñ€Ñ–Ñ”Ð½Ñ‚Ð¾Ð²Ð°Ð½Ñ– Ð½Ð° Ð¼Ð¾Ð»Ð¾Ð´Ñ–Ð¶Ð½Ñ– Ñ‚Ð° ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚ÑÑŒÐºÑ– Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð°Ñ†Ñ–Ñ—.',
      humanRights: 'Ð¯ Ð²Ð¸Ð·Ð½Ð°Ñ‡Ð¸Ð² Ð³Ñ€Ð°Ð½Ñ‚Ð¸, Ñ‰Ð¾ Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÑƒÑŽÑ‚ÑŒ Ñ€Ð¾Ð±Ð¾Ñ‚Ñƒ Ð· Ð¿Ñ€Ð°Ð² Ð»ÑŽÐ´Ð¸Ð½Ð¸ Ñ‚Ð° ÑÐ¿Ñ€Ð°Ð²ÐµÐ´Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ–.',
      deadlines:
        'ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ñ– Ð½Ð°Ð¹Ð±Ð»Ð¸Ð¶Ñ‡Ð¸Ñ… Ñ‚ÐµÑ€Ð¼Ñ–Ð½Ñ–Ð², Ð¾ÑÑŒ Ð³Ñ€Ð°Ð½Ñ‚Ð¸, Ð½Ð° ÑÐºÑ– Ð²Ð°Ñ€Ñ‚Ð¾ Ð¿Ð¾Ð´Ð°Ð²Ð°Ñ‚Ð¸ Ð·Ð°ÑÐ²ÐºÐ¸ Ð½Ð°Ð¹Ð±Ð»Ð¸Ð¶Ñ‡Ð¸Ð¼ Ñ‡Ð°ÑÐ¾Ð¼.',
      general:
        'Ð¯ Ð·Ð½Ð°Ð¹ÑˆÐ¾Ð² Ð³Ñ€Ð°Ð½Ñ‚Ð¸, Ñ‰Ð¾ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°ÑŽÑ‚ÑŒ Ð²Ð°ÑˆÐ¾Ð¼Ñƒ Ð·Ð°Ð¿Ð¸Ñ‚Ñƒ Ð´Ð»Ñ ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ¸Ñ… Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð°Ñ†Ñ–Ð¹ Ð³Ñ€Ð¾Ð¼Ð°Ð´ÑÐ½ÑÑŒÐºÐ¾Ð³Ð¾ ÑÑƒÑÐ¿Ñ–Ð»ÑŒÑÑ‚Ð²Ð°.',
    },
  };

  const t = templates[language] || templates.en;

  // Determine response type
  let responseType = 'general';
  if (['hello', 'hi', 'hey', 'Ð¿Ñ€Ð¸Ð²Ñ–Ñ‚', 'Ð´Ð¾Ð±Ñ€Ð¸Ð¹'].some(word => messageLower.includes(word))) {
    responseType = 'greeting';
  } else if (['women', 'Ð¶Ñ–Ð½ÐºÐ¸', 'gender', 'Ð³ÐµÐ½Ð´ÐµÑ€'].some(word => messageLower.includes(word))) {
    responseType = 'women';
  } else if (['youth', 'Ð¼Ð¾Ð»Ð¾Ð´ÑŒ', 'young'].some(word => messageLower.includes(word))) {
    responseType = 'youth';
  } else if (['rights', 'Ð¿Ñ€Ð°Ð²Ð°', 'justice'].some(word => messageLower.includes(word))) {
    responseType = 'humanRights';
  } else if (['deadline', 'when', 'Ñ‚ÐµÑ€Ð¼Ñ–Ð½', 'ÐºÐ¾Ð»Ð¸'].some(word => messageLower.includes(word))) {
    responseType = 'deadlines';
  }

  let response = t[responseType];

  // Add grant details if found
  if (grants.length > 0) {
    const grantsList = grants
      .slice(0, 3)
      .map((grant, i) => {
        return `${i + 1}. **${grant.name}** by ${grant.organization}
   Amount: ${grant.amount}
   Deadline: ${grant.deadline}`;
      })
      .join('\n\n');

    response += `\n\n${grantsList}`;

    if (grants.length > 3) {
      const moreText =
        language === 'uk'
          ? `\n\nÐ¢Ð° Ñ‰Ðµ ${grants.length - 3} Ñ–Ð½ÑˆÐ¸Ñ… Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ÑÑ‚ÐµÐ¹.`
          : language === 'de'
            ? `\n\nUnd ${grants.length - 3} weitere MÃ¶glichkeiten.`
            : `\n\nAnd ${grants.length - 3} more opportunities.`;
      response += moreText;
    }
  }

  return response;
}

// Generate conversation suggestions
function generateSuggestions(language, message) {
  const suggestionSets = {
    en: [
      "Show me grants for women's organizations",
      'What grants support human rights work?',
      'Which grants have upcoming deadlines?',
      'Tell me about youth funding opportunities',
      'Show me grants for media projects',
      'What grants support education initiatives?',
    ],
    uk: [
      'ÐŸÐ¾ÐºÐ°Ð¶Ñ–Ñ‚ÑŒ Ð³Ñ€Ð°Ð½Ñ‚Ð¸ Ð´Ð»Ñ Ð¶Ñ–Ð½Ð¾Ñ‡Ð¸Ñ… Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð°Ñ†Ñ–Ð¹',
      'Ð¯ÐºÑ– Ð³Ñ€Ð°Ð½Ñ‚Ð¸ Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÑƒÑŽÑ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð¾Ð·Ð°Ñ…Ð¸ÑÐ½Ñƒ Ñ€Ð¾Ð±Ð¾Ñ‚Ñƒ?',
      'Ð¯ÐºÑ– Ð³Ñ€Ð°Ð½Ñ‚Ð¸ Ð¼Ð°ÑŽÑ‚ÑŒ Ð½Ð°Ð¹Ð±Ð»Ð¸Ð¶Ñ‡Ñ– Ñ‚ÐµÑ€Ð¼Ñ–Ð½Ð¸?',
      'Ð Ð¾Ð·ÐºÐ°Ð¶Ñ–Ñ‚ÑŒ Ð¿Ñ€Ð¾ Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ– Ñ„Ñ–Ð½Ð°Ð½ÑÑƒÐ²Ð°Ð½Ð½Ñ Ð´Ð»Ñ Ð¼Ð¾Ð»Ð¾Ð´Ñ–',
      'ÐŸÐ¾ÐºÐ°Ð¶Ñ–Ñ‚ÑŒ Ð³Ñ€Ð°Ð½Ñ‚Ð¸ Ð´Ð»Ñ Ð¼ÐµÐ´Ñ–Ð°-Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñ–Ð²',
      'Ð¯ÐºÑ– Ð³Ñ€Ð°Ð½Ñ‚Ð¸ Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÑƒÑŽÑ‚ÑŒ Ð¾ÑÐ²Ñ–Ñ‚Ð½Ñ– Ñ–Ð½Ñ–Ñ†Ñ–Ð°Ñ‚Ð¸Ð²Ð¸?',
    ],
    de: [
      'Zeigen Sie mir FÃ¶rderungen fÃ¼r Frauenorganisationen',
      'Welche FÃ¶rderungen unterstÃ¼tzen Menschenrechtsarbeit?',
      'Welche FÃ¶rderungen haben bevorstehende Fristen?',
      'ErzÃ¤hlen Sie mir Ã¼ber FinanzierungsmÃ¶glichkeiten fÃ¼r Jugendliche',
      'Zeigen Sie mir FÃ¶rderungen fÃ¼r Medienprojekte',
      'Welche FÃ¶rderungen unterstÃ¼tzen Bildungsinitiativen?',
    ],
  };

  const suggestions = suggestionSets[language] || suggestionSets.en;

  // Filter out suggestions similar to current message
  const filtered = suggestions.filter(
    suggestion => !message.toLowerCase().includes(suggestion.toLowerCase().substring(0, 10))
  );

  return filtered.sort(() => 0.5 - Math.random()).slice(0, 3);
}



================================================================================
FILE: client/netlify/functions/email-digest-template.js
SIZE: 8238 bytes
================================================================================

// Email Digest Function Template
// This is a template/guide for implementing automated email digests
// To implement: 
// 1. Add email service credentials to environment variables
// 2. Create email_subscriptions table in Supabase
// 3. Install email service SDK (e.g., @sendgrid/mail or aws-sdk for SES)

const { createClient } = require('@supabase/supabase-js');

// Initialize Supabase client
const supabase = createClient(
  process.env.REACT_APP_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

exports.handler = async (event, context) => {
  // This function can be triggered:
  // 1. Via scheduled Netlify function (requires Netlify Pro)
  // 2. Via external cron service (e.g., GitHub Actions, Zapier)
  // 3. Via admin dashboard button for manual sending

  try {
    // 1. Fetch active email subscriptions
    const { data: subscriptions, error: subError } = await supabase
      .from('email_subscriptions')
      .select('*')
      .eq('is_active', true);

    if (subError) throw subError;

    // 2. Fetch grants data based on digest type
    const today = new Date();
    const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

    // New grants this week
    const { data: newGrants } = await supabase
      .from('grants')
      .select('*')
      .gte('created_at', oneWeekAgo.toISOString())
      .order('created_at', { ascending: false });

    // Upcoming deadlines
    const { data: upcomingDeadlines } = await supabase
      .from('grants')
      .select('*')
      .gte('deadline', today.toISOString())
      .lte('deadline', thirtyDaysFromNow.toISOString())
      .order('deadline', { ascending: true })
      .limit(10);

    // 3. Process each subscription
    const emailPromises = subscriptions.map(async (subscription) => {
      // Filter grants based on user preferences
      let filteredNewGrants = newGrants;
      let filteredDeadlines = upcomingDeadlines;

      if (subscription.preferences?.geographic_focus) {
        filteredNewGrants = newGrants.filter(g => 
          g.geographic_focus === subscription.preferences.geographic_focus
        );
        filteredDeadlines = upcomingDeadlines.filter(g => 
          g.geographic_focus === subscription.preferences.geographic_focus
        );
      }

      // 4. Generate email content
      const emailContent = generateEmailContent({
        recipientName: subscription.name,
        newGrants: filteredNewGrants,
        upcomingDeadlines: filteredDeadlines,
        frequency: subscription.frequency
      });

      // 5. Send email (example with SendGrid)
      // const sgMail = require('@sendgrid/mail');
      // sgMail.setApiKey(process.env.SENDGRID_API_KEY);
      
      // const msg = {
      //   to: subscription.email,
      //   from: 'noreply@civilsocietygrants.com',
      //   subject: emailContent.subject,
      //   html: emailContent.html,
      // };
      
      // await sgMail.send(msg);

      // 6. Log email sent
      await supabase
        .from('email_digest_logs')
        .insert({
          subscription_id: subscription.id,
          sent_at: new Date().toISOString(),
          grants_included: filteredNewGrants.length + filteredDeadlines.length
        });
    });

    await Promise.all(emailPromises);

    return {
      statusCode: 200,
      body: JSON.stringify({
        success: true,
        emailsSent: subscriptions.length
      })
    };

  } catch (error) {
    console.error('Email digest error:', error);
    return {
      statusCode: 500,
      body: JSON.stringify({
        success: false,
        error: error.message
      })
    };
  }
};

function generateEmailContent({ recipientName, newGrants, upcomingDeadlines, frequency }) {
  const totalFunding = newGrants.reduce((sum, grant) => 
    sum + (grant.grant_size_max || 0), 0
  );

  const subject = `Your ${frequency} Grants Digest - ${newGrants.length} New Opportunities`;

  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: #2563eb; color: white; padding: 20px; text-align: center; }
        .section { margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .grant-item { margin: 15px 0; padding: 15px; background: white; border-radius: 4px; }
        .deadline { color: #dc2626; font-weight: bold; }
        .amount { color: #059669; font-weight: bold; }
        .button { display: inline-block; padding: 10px 20px; background: #2563eb; color: white; text-decoration: none; border-radius: 4px; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>Civil Society Grants Database</h1>
          <p>Your ${frequency} Grant Opportunities Digest</p>
        </div>
        
        <p>Hello ${recipientName},</p>
        
        <div class="section">
          <h2>ðŸ“Š This Week's Summary</h2>
          <ul>
            <li><strong>${newGrants.length}</strong> new grants added</li>
            <li><strong>â‚¬${totalFunding.toLocaleString()}</strong> in total funding available</li>
            <li><strong>${upcomingDeadlines.length}</strong> deadlines approaching</li>
          </ul>
        </div>

        ${newGrants.length > 0 ? `
          <div class="section">
            <h2>ðŸ†• New Grant Opportunities</h2>
            ${newGrants.slice(0, 5).map(grant => `
              <div class="grant-item">
                <h3>${grant.name}</h3>
                <p><strong>Organization:</strong> ${grant.organization}</p>
                <p><strong>Amount:</strong> <span class="amount">â‚¬${grant.grant_size_min?.toLocaleString() || '0'} - â‚¬${grant.grant_size_max?.toLocaleString() || '0'}</span></p>
                <p><strong>Focus:</strong> ${grant.focus_areas_en}</p>
                <a href="https://yourdomain.com/grants/${encodeURIComponent(grant.name)}" class="button">View Details</a>
              </div>
            `).join('')}
          </div>
        ` : ''}

        ${upcomingDeadlines.length > 0 ? `
          <div class="section">
            <h2>â° Upcoming Deadlines</h2>
            ${upcomingDeadlines.slice(0, 5).map(grant => `
              <div class="grant-item">
                <h3>${grant.name}</h3>
                <p><strong>Deadline:</strong> <span class="deadline">${new Date(grant.deadline).toLocaleDateString()}</span></p>
                <p><strong>Organization:</strong> ${grant.organization}</p>
                <a href="https://yourdomain.com/grants/${encodeURIComponent(grant.name)}" class="button">Apply Now</a>
              </div>
            `).join('')}
          </div>
        ` : ''}

        <div style="text-align: center; margin-top: 30px;">
          <a href="https://yourdomain.com/grants" class="button">Browse All Grants</a>
        </div>

        <hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">
        
        <p style="text-align: center; color: #666; font-size: 14px;">
          You're receiving this because you subscribed to grant updates.<br>
          <a href="https://yourdomain.com/unsubscribe?token=${recipientName}">Unsubscribe</a> | 
          <a href="https://yourdomain.com/preferences?token=${recipientName}">Update Preferences</a>
        </p>
      </div>
    </body>
    </html>
  `;

  return { subject, html };
}

/* SQL Schema for email subscriptions table:

CREATE TABLE email_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255),
  frequency VARCHAR(50) DEFAULT 'weekly', -- weekly, daily, monthly
  preferences JSONB DEFAULT '{}', -- { geographic_focus, grant_types, min_amount, etc }
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE email_digest_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  subscription_id UUID REFERENCES email_subscriptions(id),
  sent_at TIMESTAMP DEFAULT NOW(),
  grants_included INTEGER,
  status VARCHAR(50) DEFAULT 'sent'
);

*/


================================================================================
FILE: client/netlify/functions/grants-debug.js
SIZE: 3012 bytes
================================================================================

// Debug version of grants function
export const handler = async (event, context) => {
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Content-Type': 'application/json',
  };

  // Debug environment variables
  const debugInfo = {
    // Check all possible env var names
    env_vars: {
      REACT_APP_SUPABASE_URL: process.env.REACT_APP_SUPABASE_URL ? 'SET' : 'NOT SET',
      SUPABASE_URL: process.env.SUPABASE_URL ? 'SET' : 'NOT SET',
      REACT_APP_SUPABASE_ANON_KEY: process.env.REACT_APP_SUPABASE_ANON_KEY ? 'SET' : 'NOT SET',
      SUPABASE_ANON_KEY: process.env.SUPABASE_ANON_KEY ? 'SET' : 'NOT SET',
      SUPABASE_SERVICE_ROLE_KEY: process.env.SUPABASE_SERVICE_ROLE_KEY ? 'SET' : 'NOT SET',
    },
    // Check which URL is being used
    supabase_url: process.env.SUPABASE_URL || process.env.REACT_APP_SUPABASE_URL || 'NO URL FOUND',
    has_service_key: !!process.env.SUPABASE_SERVICE_ROLE_KEY,
    node_version: process.version,
    function_name: context.functionName,
    // All env vars starting with REACT_APP or SUPABASE
    all_relevant_vars: Object.keys(process.env)
      .filter(key => key.startsWith('REACT_APP') || key.startsWith('SUPABASE'))
      .join(', '),
  };

  // Try to connect to Supabase
  try {
    const { createClient } = await import('@supabase/supabase-js');
    
    const supabaseUrl = process.env.SUPABASE_URL || process.env.REACT_APP_SUPABASE_URL;
    const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_ANON_KEY || process.env.REACT_APP_SUPABASE_ANON_KEY;
    
    debugInfo.connection_attempt = {
      url_source: process.env.SUPABASE_URL ? 'SUPABASE_URL' : (process.env.REACT_APP_SUPABASE_URL ? 'REACT_APP_SUPABASE_URL' : 'NONE'),
      key_source: process.env.SUPABASE_SERVICE_ROLE_KEY ? 'SERVICE_ROLE' : (process.env.SUPABASE_ANON_KEY ? 'SUPABASE_ANON' : (process.env.REACT_APP_SUPABASE_ANON_KEY ? 'REACT_APP_ANON' : 'NONE')),
    };

    if (!supabaseUrl || !supabaseKey) {
      debugInfo.error = 'Missing Supabase credentials';
      return {
        statusCode: 500,
        headers,
        body: JSON.stringify(debugInfo),
      };
    }

    const supabase = createClient(supabaseUrl, supabaseKey);
    
    // Try a simple query
    const { data, error } = await supabase
      .from('grants')
      .select('count')
      .limit(1);
    
    if (error) {
      debugInfo.supabase_error = {
        message: error.message,
        code: error.code,
        details: error.details,
        hint: error.hint,
      };
    } else {
      debugInfo.connection_status = 'SUCCESS';
      debugInfo.test_query_result = data;
    }

  } catch (error) {
    debugInfo.catch_error = {
      message: error.message,
      stack: error.stack?.split('\n').slice(0, 5),
    };
  }

  return {
    statusCode: 200,
    headers,
    body: JSON.stringify(debugInfo, null, 2),
  };
};


================================================================================
FILE: client/netlify/functions/grants.js
SIZE: 10188 bytes
================================================================================

import { createClient } from '@supabase/supabase-js';

// Debug environment variables
console.log('Grants function environment check:', {
  SUPABASE_URL: process.env.SUPABASE_URL ? 'SET' : 'NOT SET',
  REACT_APP_SUPABASE_URL: process.env.REACT_APP_SUPABASE_URL ? 'SET' : 'NOT SET',
  SUPABASE_SERVICE_ROLE_KEY: process.env.SUPABASE_SERVICE_ROLE_KEY ? 'SET' : 'NOT SET',
  SUPABASE_ANON_KEY: process.env.SUPABASE_ANON_KEY ? 'SET' : 'NOT SET',
  REACT_APP_SUPABASE_ANON_KEY: process.env.REACT_APP_SUPABASE_ANON_KEY ? 'SET' : 'NOT SET',
});

// Try multiple environment variable names for better compatibility
const supabaseUrl = process.env.SUPABASE_URL || process.env.REACT_APP_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || 
                   process.env.SUPABASE_ANON_KEY || 
                   process.env.REACT_APP_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.error('Missing Supabase credentials:', {
    url: supabaseUrl || 'NOT FOUND',
    hasKey: !!supabaseKey
  });
}

const supabase = createClient(
  supabaseUrl || '',
  supabaseKey || ''
);

export const handler = async (event, context) => {
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Content-Type': 'application/json',
  };

  // Handle CORS preflight
  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }

  try {
    const path = event.path.replace('/.netlify/functions/grants', '');
    const method = event.httpMethod;
    const queryParams = event.queryStringParameters || {};

    // Route: GET /grants
    if (method === 'GET' && path === '') {
      return await getGrants(queryParams, headers);
    }

    // Route: GET /grants/filters
    if (method === 'GET' && path === '/filters') {
      return await getFilters(headers);
    }

    // Route: GET /grants/:id
    if (method === 'GET' && path.match(/^\/\d+$/)) {
      const id = path.substring(1);
      return await getGrant(id, headers);
    }

    // Route: POST /grants (admin only)
    if (method === 'POST' && path === '') {
      return await createGrant(JSON.parse(event.body), headers, event);
    }

    // Route: PUT /grants/:id (admin only)
    if (method === 'PUT' && path.match(/^\/\d+$/)) {
      const id = path.substring(1);
      return await updateGrant(id, JSON.parse(event.body), headers, event);
    }

    // Route: DELETE /grants/:id (admin only)
    if (method === 'DELETE' && path.match(/^\/\d+$/)) {
      const id = path.substring(1);
      return await deleteGrant(id, headers, event);
    }

    return {
      statusCode: 404,
      headers,
      body: JSON.stringify({ error: 'Not found' }),
    };
  } catch (error) {
    console.error('Function error:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: 'Internal server error', details: error.message }),
    };
  }
};

async function getGrants(params, headers) {
  // Check if Supabase is properly initialized
  if (!supabaseUrl || !supabaseKey) {
    console.error('Supabase not initialized properly in getGrants');
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ 
        error: 'Database configuration error',
        details: 'Supabase credentials not found',
        debug: {
          hasUrl: !!supabaseUrl,
          hasKey: !!supabaseKey,
          envVars: Object.keys(process.env).filter(k => k.includes('SUPABASE') || k.includes('REACT_APP')).join(', ')
        }
      }),
    };
  }

  let query = supabase.from('grants').select('*').eq('status', 'active');

  // Apply filters
  if (params.query) {
    const searchTerm = `%${params.query}%`;
    query = query.or(
      `grant_name.ilike.${searchTerm},funding_organization.ilike.${searchTerm},focus_areas.ilike.${searchTerm},eligibility_criteria.ilike.${searchTerm}`
    );
  }

  if (params.organization) {
    query = query.eq('funding_organization', params.organization);
  }

  if (params.country) {
    query = query.eq('country_region', params.country);
  }

  if (params.focusArea) {
    query = query.ilike('focus_areas', `%${params.focusArea}%`);
  }

  if (params.deadline) {
    query = query.gte('application_deadline', params.deadline);
  }

  // Apply sorting
  const sortBy = params.sortBy || 'deadlineAsc';

  switch (sortBy) {
    case 'nameAsc':
      query = query.order('grant_name', { ascending: true });
      break;
    case 'nameDesc':
      query = query.order('grant_name', { ascending: false });
      break;
    case 'deadlineAsc':
      query = query.order('application_deadline', { ascending: true });
      break;
    case 'deadlineDesc':
      query = query.order('application_deadline', { ascending: false });
      break;
    case 'amountAsc':
      query = query.order('grant_amount', { ascending: true });
      break;
    case 'amountDesc':
      query = query.order('grant_amount', { ascending: false });
      break;
    default:
      query = query.order('application_deadline', { ascending: true });
      break;
  }

  const { data, error } = await query;

  if (error) {
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: error.message }),
    };
  }

  // Track view if not from admin
  if (!params.admin) {
    // Update view counts asynchronously (don't wait)
    data.forEach(grant => {
      supabase
        .from('grants')
        .update({ view_count: grant.view_count + 1 })
        .eq('id', grant.id)
        .then();
    });
  }

  return {
    statusCode: 200,
    headers,
    body: JSON.stringify(data),
  };
}

async function getFilters(headers) {
  const { data: grants, error } = await supabase
    .from('grants')
    .select('funding_organization, country_region, focus_areas')
    .eq('status', 'active');

  if (error) {
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ error: error.message }),
    };
  }

  // Process filters
  const organizations = [
    ...new Set(grants.map(g => g.funding_organization).filter(Boolean)),
  ].sort();
  const countries = [...new Set(grants.map(g => g.country_region).filter(Boolean))].sort();

  // Process focus areas (comma-separated)
  const focusAreas = [
    ...new Set(
      grants
        .flatMap(g => (g.focus_areas ? g.focus_areas.split(',').map(area => area.trim()) : []))
        .filter(Boolean)
    ),
  ].sort();

  const filters = {
    organizations,
    countries,
    focusAreas,
  };

  return {
    statusCode: 200,
    headers,
    body: JSON.stringify(filters),
  };
}

async function getGrant(id, headers) {
  const { data, error } = await supabase
    .from('grants')
    .select('*')
    .eq('id', id)
    .eq('status', 'active')
    .single();

  if (error || !data) {
    return {
      statusCode: 404,
      headers,
      body: JSON.stringify({ error: 'Grant not found' }),
    };
  }

  // Increment view count
  await supabase
    .from('grants')
    .update({ view_count: data.view_count + 1 })
    .eq('id', id);

  return {
    statusCode: 200,
    headers,
    body: JSON.stringify(data),
  };
}

async function createGrant(data, headers, event) {
  // Basic auth check (in production, implement proper JWT verification)
  const authHeader = event.headers.authorization || event.headers.Authorization;
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return {
      statusCode: 401,
      headers,
      body: JSON.stringify({ error: 'Unauthorized' }),
    };
  }

  const { data: grant, error } = await supabase
    .from('grants')
    .insert({
      grant_name: data.grant_name,
      funding_organization: data.funding_organization,
      country_region: data.country_region,
      eligibility_criteria: data.eligibility_criteria,
      focus_areas: data.focus_areas,
      grant_amount: data.grant_amount,
      application_deadline: data.application_deadline,
      duration: data.duration,
      website_link: data.website_link,
      status: data.status || 'active',
      featured: data.featured || false,
    })
    .select()
    .single();

  if (error) {
    return {
      statusCode: 400,
      headers,
      body: JSON.stringify({ error: error.message }),
    };
  }

  return {
    statusCode: 201,
    headers,
    body: JSON.stringify(grant),
  };
}

async function updateGrant(id, data, headers, event) {
  // Basic auth check
  const authHeader = event.headers.authorization || event.headers.Authorization;
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return {
      statusCode: 401,
      headers,
      body: JSON.stringify({ error: 'Unauthorized' }),
    };
  }

  const { data: grant, error } = await supabase
    .from('grants')
    .update({
      grant_name: data.grant_name,
      funding_organization: data.funding_organization,
      country_region: data.country_region,
      eligibility_criteria: data.eligibility_criteria,
      focus_areas: data.focus_areas,
      grant_amount: data.grant_amount,
      application_deadline: data.application_deadline,
      duration: data.duration,
      website_link: data.website_link,
      status: data.status,
      featured: data.featured,
    })
    .eq('id', id)
    .select()
    .single();

  if (error) {
    return {
      statusCode: 400,
      headers,
      body: JSON.stringify({ error: error.message }),
    };
  }

  return {
    statusCode: 200,
    headers,
    body: JSON.stringify(grant),
  };
}

async function deleteGrant(id, headers, event) {
  // Basic auth check
  const authHeader = event.headers.authorization || event.headers.Authorization;
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return {
      statusCode: 401,
      headers,
      body: JSON.stringify({ error: 'Unauthorized' }),
    };
  }

  const { error } = await supabase.from('grants').delete().eq('id', id);

  if (error) {
    return {
      statusCode: 400,
      headers,
      body: JSON.stringify({ error: error.message }),
    };
  }

  return {
    statusCode: 200,
    headers,
    body: JSON.stringify({ message: 'Grant deleted successfully' }),
  };
}



================================================================================
FILE: client/netlify/functions/middleware/auth.js
SIZE: 8806 bytes
================================================================================

import { createClient } from '@supabase/supabase-js';
import jwt from 'jsonwebtoken';
import { rateLimitByUser } from './rateLimiter.js';

// Initialize Supabase
const supabaseUrl = process.env.REACT_APP_SUPABASE_URL || process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

let supabase = null;
if (supabaseUrl && supabaseKey) {
  supabase = createClient(supabaseUrl, supabaseKey);
}

// JWT Secret (use environment variable in production)
const JWT_SECRET = process.env.JWT_SECRET || 'your-jwt-secret-change-in-production';

/**
 * Verify JWT token
 * @param {string} token - JWT token
 * @returns {object} Decoded token or null
 */
export const verifyToken = (token) => {
  try {
    return jwt.verify(token, JWT_SECRET);
  } catch (error) {
    console.error('Token verification failed:', error);
    return null;
  }
};

/**
 * Generate secure JWT token
 * @param {object} payload - Token payload
 * @param {string} expiresIn - Expiration time
 * @returns {string} JWT token
 */
export const generateSecureToken = (payload, expiresIn = '24h') => {
  return jwt.sign(payload, JWT_SECRET, {
    expiresIn,
    issuer: 'grants-website',
    audience: 'grants-api'
  });
};

/**
 * Authentication middleware
 * @param {array} allowedRoles - Allowed roles for this endpoint
 * @returns {function} Middleware function
 */
export const authenticate = (allowedRoles = ['admin', 'editor']) => {
  return async (event, context, next) => {
    const headers = {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': process.env.ALLOWED_ORIGINS || '*',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS'
    };

    // Get authorization header
    const authHeader = event.headers.authorization || event.headers.Authorization;
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return {
        statusCode: 401,
        headers,
        body: JSON.stringify({ error: 'No token provided' })
      };
    }

    const token = authHeader.substring(7);

    try {
      // First try to verify with Supabase
      if (supabase) {
        const { data: userData, error } = await supabase.auth.getUser(token);
        
        if (!error && userData.user) {
          // Get user role from app_users table
          const { data: userRole } = await supabase
            .from('app_users')
            .select('role, is_active')
            .eq('user_id', userData.user.id)
            .single();

          // Check if user is active
          if (!userRole?.is_active) {
            return {
              statusCode: 403,
              headers,
              body: JSON.stringify({ error: 'Account is disabled' })
            };
          }

          // Check role permissions
          if (!allowedRoles.includes(userRole?.role)) {
            return {
              statusCode: 403,
              headers,
              body: JSON.stringify({ error: 'Insufficient permissions' })
            };
          }

          // Add user info to event context
          event.user = {
            id: userData.user.id,
            email: userData.user.email,
            role: userRole.role,
            metadata: userData.user.user_metadata
          };

          // Continue to next handler
          return next ? await next(event, context) : null;
        }
      }

      // Fallback to JWT verification
      const decoded = verifyToken(token);
      if (!decoded) {
        return {
          statusCode: 401,
          headers,
          body: JSON.stringify({ error: 'Invalid token' })
        };
      }

      // Check token expiration
      if (decoded.exp && decoded.exp < Date.now() / 1000) {
        return {
          statusCode: 401,
          headers,
          body: JSON.stringify({ error: 'Token expired' })
        };
      }

      // Check role permissions
      if (!allowedRoles.includes(decoded.role)) {
        return {
          statusCode: 403,
          headers,
          body: JSON.stringify({ error: 'Insufficient permissions' })
        };
      }

      // Add user info to event context
      event.user = decoded;

      // Continue to next handler
      return next ? await next(event, context) : null;

    } catch (error) {
      console.error('Authentication error:', error);
      return {
        statusCode: 401,
        headers,
        body: JSON.stringify({ error: 'Authentication failed' })
      };
    }
  };
};

/**
 * Apply authentication to a handler function
 * @param {function} handler - Handler function
 * @param {array} allowedRoles - Allowed roles
 * @returns {function} Wrapped handler
 */
export const withAuth = (handler, allowedRoles = ['admin', 'editor']) => {
  return async (event, context) => {
    const auth = authenticate(allowedRoles);
    
    const next = async (event, context) => {
      return await handler(event, context);
    };
    
    return await auth(event, context, next);
  };
};

/**
 * Validate API key for service-to-service authentication
 * @param {string} apiKey - API key to validate
 * @returns {boolean} True if valid
 */
export const validateApiKey = async (apiKey) => {
  if (!apiKey) return false;

  // In production, validate against database or secure storage
  // For now, check against environment variable
  const validApiKeys = process.env.VALID_API_KEYS?.split(',') || [];
  return validApiKeys.includes(apiKey);
};

/**
 * Two-factor authentication check
 * @param {string} userId - User ID
 * @param {string} code - 2FA code
 * @returns {boolean} True if valid
 */
export const verify2FA = async (userId, code) => {
  if (!supabase) return false;

  try {
    // Get user's 2FA secret from database
    const { data: user2FA } = await supabase
      .from('user_2fa')
      .select('secret, backup_codes')
      .eq('user_id', userId)
      .single();

    if (!user2FA) return false;

    // In production, use a proper TOTP library
    // This is a simplified example
    const expectedCode = generateTOTPCode(user2FA.secret);
    
    if (code === expectedCode) {
      return true;
    }

    // Check backup codes
    if (user2FA.backup_codes && user2FA.backup_codes.includes(code)) {
      // Remove used backup code
      const updatedCodes = user2FA.backup_codes.filter(c => c !== code);
      await supabase
        .from('user_2fa')
        .update({ backup_codes: updatedCodes })
        .eq('user_id', userId);
      
      return true;
    }

    return false;
  } catch (error) {
    console.error('2FA verification error:', error);
    return false;
  }
};

/**
 * Generate TOTP code (simplified - use proper library in production)
 * @param {string} secret - TOTP secret
 * @returns {string} 6-digit code
 */
const generateTOTPCode = (secret) => {
  const time = Math.floor(Date.now() / 30000);
  const hash = require('crypto').createHmac('sha1', secret)
    .update(Buffer.from([0, 0, 0, 0, time]))
    .digest();
  
  const offset = hash[hash.length - 1] & 0xf;
  const code = (
    ((hash[offset] & 0x7f) << 24) |
    ((hash[offset + 1] & 0xff) << 16) |
    ((hash[offset + 2] & 0xff) << 8) |
    (hash[offset + 3] & 0xff)
  ) % 1000000;
  
  return code.toString().padStart(6, '0');
};

/**
 * Log authentication events for audit trail
 * @param {object} event - Event details
 */
export const logAuthEvent = async (event) => {
  if (!supabase) return;

  try {
    await supabase.from('auth_logs').insert({
      user_id: event.userId,
      event_type: event.type,
      ip_address: event.ip,
      user_agent: event.userAgent,
      success: event.success,
      error_message: event.error,
      metadata: event.metadata,
      created_at: new Date().toISOString()
    });
  } catch (error) {
    console.error('Failed to log auth event:', error);
  }
};

/**
 * Check if IP is whitelisted for admin access
 * @param {string} ip - IP address
 * @returns {boolean} True if whitelisted
 */
export const checkIPWhitelist = async (ip) => {
  if (!supabase) return true; // Allow if no database

  try {
    const { data: whitelist } = await supabase
      .from('ip_whitelist')
      .select('ip_address')
      .eq('is_active', true);

    if (!whitelist || whitelist.length === 0) return true; // No whitelist configured

    return whitelist.some(entry => {
      if (entry.ip_address === ip) return true;
      
      // Support CIDR notation (simplified)
      if (entry.ip_address.includes('/')) {
        const [network, mask] = entry.ip_address.split('/');
        // Implement CIDR matching logic here
        return false; // Placeholder
      }
      
      return false;
    });
  } catch (error) {
    console.error('IP whitelist check error:', error);
    return true; // Allow on error to prevent lockout
  }
};


================================================================================
FILE: client/netlify/functions/middleware/rateLimiter.js
SIZE: 6091 bytes
================================================================================

/**
 * Rate limiting middleware for Netlify Functions
 * Uses in-memory storage (resets on function cold start)
 * For production, consider using Redis or a similar persistent store
 */

// Store for rate limit data
const rateLimitStore = new Map();

// Configuration
const RATE_LIMIT_CONFIG = {
  // Default limits
  default: {
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 100 // limit each IP to 100 requests per windowMs
  },
  // Strict limits for auth endpoints
  auth: {
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 5 // limit each IP to 5 requests per windowMs
  },
  // Medium limits for API endpoints
  api: {
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 50
  },
  // Relaxed limits for public endpoints
  public: {
    windowMs: 15 * 60 * 1000,
    max: 200
  }
};

/**
 * Get client IP from request
 * @param {object} event - Netlify event object
 * @returns {string} Client IP
 */
const getClientIP = (event) => {
  // Netlify provides client IP in headers
  return event.headers['x-nf-client-connection-ip'] || 
         event.headers['x-forwarded-for']?.split(',')[0] || 
         'unknown';
};

/**
 * Clean up expired entries
 */
const cleanupExpiredEntries = () => {
  const now = Date.now();
  for (const [key, value] of rateLimitStore.entries()) {
    if (value.resetTime < now) {
      rateLimitStore.delete(key);
    }
  }
};

/**
 * Rate limiter middleware
 * @param {string} type - Type of rate limit to apply
 * @returns {function} Middleware function
 */
export const rateLimiter = (type = 'default') => {
  const config = RATE_LIMIT_CONFIG[type] || RATE_LIMIT_CONFIG.default;
  
  return async (event, context, next) => {
    // Skip rate limiting for OPTIONS requests
    if (event.httpMethod === 'OPTIONS') {
      return next ? await next(event, context) : null;
    }

    const clientIP = getClientIP(event);
    const key = `${type}:${clientIP}`;
    const now = Date.now();
    
    // Clean up expired entries periodically
    if (Math.random() < 0.1) { // 10% chance
      cleanupExpiredEntries();
    }
    
    // Get or create rate limit data for this client
    let limitData = rateLimitStore.get(key);
    
    if (!limitData || limitData.resetTime < now) {
      // Create new window
      limitData = {
        count: 0,
        resetTime: now + config.windowMs
      };
    }
    
    // Increment request count
    limitData.count++;
    rateLimitStore.set(key, limitData);
    
    // Check if limit exceeded
    if (limitData.count > config.max) {
      const retryAfter = Math.ceil((limitData.resetTime - now) / 1000);
      
      return {
        statusCode: 429,
        headers: {
          'Content-Type': 'application/json',
          'X-RateLimit-Limit': config.max.toString(),
          'X-RateLimit-Remaining': '0',
          'X-RateLimit-Reset': new Date(limitData.resetTime).toISOString(),
          'Retry-After': retryAfter.toString()
        },
        body: JSON.stringify({
          error: 'Too many requests',
          message: `Rate limit exceeded. Please try again in ${retryAfter} seconds.`,
          retryAfter
        })
      };
    }
    
    // Add rate limit headers to response
    const remainingRequests = Math.max(0, config.max - limitData.count);
    const response = next ? await next(event, context) : null;
    
    if (response && response.headers) {
      response.headers['X-RateLimit-Limit'] = config.max.toString();
      response.headers['X-RateLimit-Remaining'] = remainingRequests.toString();
      response.headers['X-RateLimit-Reset'] = new Date(limitData.resetTime).toISOString();
    }
    
    return response;
  };
};

/**
 * Apply rate limiting to a handler function
 * @param {function} handler - Handler function
 * @param {string} type - Rate limit type
 * @returns {function} Wrapped handler
 */
export const withRateLimit = (handler, type = 'default') => {
  return async (event, context) => {
    const limiter = rateLimiter(type);
    
    // Create a next function that calls the original handler
    const next = async (event, context) => {
      return await handler(event, context);
    };
    
    return await limiter(event, context, next);
  };
};

/**
 * Rate limit by user ID (for authenticated endpoints)
 * @param {string} userId - User ID
 * @param {string} action - Action being performed
 * @param {number} maxAttempts - Maximum attempts allowed
 * @param {number} windowMs - Time window in milliseconds
 * @returns {object} Rate limit result
 */
export const rateLimitByUser = (userId, action, maxAttempts = 5, windowMs = 15 * 60 * 1000) => {
  const key = `user:${userId}:${action}`;
  const now = Date.now();
  
  let limitData = rateLimitStore.get(key);
  
  if (!limitData || limitData.resetTime < now) {
    limitData = {
      count: 0,
      resetTime: now + windowMs
    };
  }
  
  limitData.count++;
  rateLimitStore.set(key, limitData);
  
  const remaining = Math.max(0, maxAttempts - limitData.count);
  const exceeded = limitData.count > maxAttempts;
  
  return {
    exceeded,
    remaining,
    resetTime: limitData.resetTime,
    retryAfter: exceeded ? Math.ceil((limitData.resetTime - now) / 1000) : 0
  };
};

/**
 * Advanced rate limiting with sliding window
 * @param {string} identifier - Unique identifier
 * @param {number} maxRequests - Maximum requests allowed
 * @param {number} windowMs - Time window in milliseconds
 * @returns {boolean} True if allowed, false if rate limited
 */
export const slidingWindowRateLimit = (identifier, maxRequests = 100, windowMs = 60000) => {
  const now = Date.now();
  const windowStart = now - windowMs;
  
  // Get or create request log for this identifier
  let requestLog = rateLimitStore.get(`sliding:${identifier}`) || [];
  
  // Remove old entries outside the window
  requestLog = requestLog.filter(timestamp => timestamp > windowStart);
  
  // Check if limit would be exceeded
  if (requestLog.length >= maxRequests) {
    return false;
  }
  
  // Add current request
  requestLog.push(now);
  rateLimitStore.set(`sliding:${identifier}`, requestLog);
  
  return true;
};


================================================================================
EXPORT SUMMARY:
----------------------------------------
Files exported: 79
Total size: 644.55 KB
Export completed: 2025-07-13T12:52:34.860Z

This export contains only the core application source code.
Static assets, data files, and auxiliary scripts have been excluded.
